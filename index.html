<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#ffffff"/>
<meta name="color-scheme" content="light"/>
<title>Infecciosas ‚Äî Planta ¬∑ Tareas ¬∑ Directorio</title>

<link rel="manifest" href="manifest.webmanifest"/>
<link rel="icon" sizes="192x192" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<style>
  /* ---------- Tokens de dise√±o (paleta premium + neutrales) ---------- */
  :root{
    /* Base pastel (tu paleta) */
    --p-fondo: #F8FFE5;   /* marfil verdoso muy claro */
    --p-mint:  #06D6A0;   /* verde menta (positivo/√©xito) */
    --p-teal:  #1B9AAA;   /* teal sanitario (info) */
    --p-coral: #EF476F;   /* coral (alerta/emergencia) */
    --p-gold:  #FFC43D;   /* dorado (acci√≥n primaria) */

    /* Derivados y tintes */
    --t-mint-10: color-mix(in oklab, var(--p-mint), #fff 88%);
    --t-teal-10: color-mix(in oklab, var(--p-teal), #fff 90%);
    --t-coral-10: color-mix(in oklab, var(--p-coral), #fff 90%);
    --t-gold-10: color-mix(in oklab, var(--p-gold), #fff 88%);

    /* Neutrales */
    --ink: #0B1220;              /* texto principal muy oscuro */
    --muted: #475569;            /* texto secundario */
    --bd: #E7EAF0;               /* borde suave */
    --surface: #ffffff;          /* carta blanca */
    --surface-2:#F6F8FB;         /* carta suave */

    /* Radios / sombras */
    --r: 14px; --r-xl: 20px; --touch: 44px; --app-h: 64px;
    --sh-1: 0 1px 2px rgba(2,6,23,.05), 0 10px 24px rgba(2,6,23,.06);
    --sh-2: 0 2px 6px rgba(2,6,23,.08), 0 18px 36px rgba(2,6,23,.10);
    --rim: 0 0 0 1px rgba(255,255,255,.65) inset;

    /* Gradiente aurora sutil (fondo) */
    --aurora: radial-gradient(1200px 800px at 5% -10%, rgba(255,196,61,.18), transparent 60%),
              radial-gradient(1000px 700px at 90% 10%, rgba(6,214,160,.16), transparent 60%),
              radial-gradient(800px 600px at 20% 110%, rgba(239,71,111,.12), transparent 60%),
              linear-gradient(180deg,#fff, #fff);
  }

  /* ---------- Reset m√≠nimo + tipograf√≠a con legibilidad m√°xima ---------- */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--aurora); color:var(--ink);
    font:400 clamp(15px, 0.9rem + 0.4vw, 18px)/1.7 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-tap-highlight-color:transparent; min-height:100dvh;
  }
  :focus-visible{ outline:3px solid color-mix(in oklab, var(--p-gold), var(--p-teal) 30%); outline-offset:2px; border-radius:10px }

  /* ---------- Layout ---------- */
  .container{ max-width:min(1160px, 98vw); margin:0 auto; padding:12px clamp(12px,4vw,20px); container-type:inline-size }
  header.appbar{
    position:sticky; top:0; z-index:50; min-height:var(--app-h);
    backdrop-filter:saturate(1.05) blur(8px);
    background:linear-gradient(180deg,#ffffff 40%,#f7fbff 100%);
    border-bottom:1px solid var(--bd);
  }
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .grow{flex:1; min-width:0}

  /* ---------- Marca + placa de t√≠tulo con placa (legibilidad) ---------- */
  .brand-chip{
    display:inline-flex; align-items:center; gap:12px; padding:10px 16px;
    border-radius:999px; background:linear-gradient(180deg,#fff, var(--t-gold-10));
    box-shadow: var(--sh-1); border:1px solid var(--bd);
    font-weight:900; letter-spacing:.3px;
  }
  .brand-dot{ width:10px; height:10px; border-radius:50%; background:var(--p-gold); box-shadow:0 0 0 2px rgba(0,0,0,.05) }
  h1{
    margin:0; font-weight:900; letter-spacing:.2px;
    font-size: clamp(22px, 1.4rem + 0.8vw, 32px);
  }
  /* ‚Äúplaca‚Äù bajo textos para contraste AAA en fondos claros */
  .title-plate{
    display:inline-block; padding:6px 12px; border-radius:12px;
    background:linear-gradient(180deg,#fff, #f8fafc); border:1px solid var(--bd);
    box-shadow: var(--sh-1), var(--rim);
  }

  /* ---------- Chips de estado ---------- */
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;font-size:.85rem;background:var(--surface-2)}
  .chip.ok{background:var(--t-mint-10); color:#065F46; border-color: color-mix(in oklab,var(--p-mint),#fff 70%)}
  .chip.bad{background:var(--t-coral-10); color:#8B1231; border-color: color-mix(in oklab,var(--p-coral),#fff 70%)}

  /* ---------- Botones ---------- */
  .btn{appearance:none; border:1px solid var(--bd); background:#fff; color:var(--ink);
       padding:10px 12px; border-radius:12px; min-height:var(--touch); min-width:44px;
       display:inline-flex; align-items:center; justify-content:center; gap:8px;
       box-shadow:var(--sh-1); cursor:pointer; font-weight:700}
  .btn.primary{ background:linear-gradient(180deg, color-mix(in oklab, var(--p-gold), #fff 12%), var(--p-gold)); color:#1a1300; border-color:transparent }
  .btn.ghost{ background:transparent; border-color:transparent; box-shadow:none; color:var(--p-teal) }
  .btn.icon{ min-width:var(--touch); aspect-ratio:1/1; padding:0 10px }

  /* ---------- Iconograf√≠a inline premium ---------- */
  .ic{ width:22px; height:22px; display:inline-block }
  .ic-lg{ width:26px; height:26px }
  .ic-circle{
    width:34px;height:34px;border-radius:50%;
    display:inline-grid;place-items:center;
    background:#fff; box-shadow: 0 2px 8px rgba(2,6,23,.12), 0 0 0 1px rgba(0,0,0,.06);
  }
  .ic-stroke{ stroke: currentColor; stroke-width:2; fill: none }
  .ic-grad{ fill:url(#grad-aur); stroke: none }

  /* ---------- Tarjetas / encabezados con rim light ---------- */
  .card{ background:#fff; border:1px solid var(--bd); border-radius:var(--r-xl); box-shadow:var(--sh-1); overflow:hidden }
  .card-h{ position:relative; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .card-b{ padding:12px }
  .hdr{
    border-bottom:1px solid var(--bd);
    background:
      linear-gradient(180deg, color-mix(in oklab, #fff, var(--p-teal) 10%), #fff);
  }
  .hdr .title-plate{ font-weight:900 }

  /* ---------- Tabs superiores e inferiores ---------- */
  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tab{
    padding:12px 14px;border-radius:14px;border:1px solid var(--bd);background:var(--surface-2);
    cursor:pointer;font-weight:900;letter-spacing:.2px; display:flex; align-items:center; gap:10px; justify-content:center
  }
  .tab[aria-selected="true"]{ background: #fff; border-color: color-mix(in oklab, var(--p-teal), #fff 60%); box-shadow: var(--sh-1) }

  nav.bottom{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--bd) }
  .tabs-bottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; align-items:center; padding:8px 12px }
  .tab-bottom{
    padding:8px 12px; border-radius:14px; border:1px solid var(--bd); background:var(--surface-2);
    font-weight:800; display:flex; flex-direction:column; align-items:center; gap:6px
  }
  .tab-bottom[aria-selected="true"]{ background:#fff; border-color: color-mix(in oklab, var(--p-teal), #fff 60%); box-shadow:var(--sh-1) }
  .tab-bottom span{ font-size:12px }

  /* ---------- Listas ---------- */
  ul.list{ list-style:none; padding:0; margin:0; display:grid; gap:10px; content-visibility:auto; contain-intrinsic-size:600px }
  li.item{ display:grid; grid-template-columns:auto minmax(120px,1fr) auto; gap:12px; align-items:center;
           border:1px solid var(--bd); border-radius:14px; padding:12px; background:#fff }
  .muted{ color:var(--muted) } .text{ min-width:0 } .line{ overflow-wrap:anywhere }
  .strike{text-decoration:line-through; opacity:.9}

  /* ---------- P√≠ldoras (fecha, room, etc) ---------- */
  .pill{ display:inline-flex; align-items:center; justify-content:center; font-weight:800; font-size:13px;
         padding:6px 10px; border-radius:10px; line-height:1; border:1px solid var(--bd); background:var(--surface-2) }
  .pill.date{ background:var(--t-teal-10); border-color: color-mix(in oklab,var(--p-teal),#fff 70%) }
  .pill.room{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
              font-weight:900; letter-spacing:.3px; font-size: clamp(18px,2.4vw,22px); padding:10px 14px; border-radius:12px;
              background:var(--t-mint-10); border-color: color-mix(in oklab, var(--p-mint), #fff 60%); color:#083c2c; box-shadow:inset 0 -1px 0 rgba(0,0,0,.06) }

  /* ---------- Directorio premium ---------- */
  .section-banner{ margin:10px 0 8px; border-radius:16px; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:12px }
  .sb-dir{ background:
      linear-gradient(180deg, color-mix(in oklab, #fff, var(--p-teal) 12%), #fff) }

  /* Encabezado de secci√≥n con inicial visible (dropcap) */
  .dir-section{
    margin-top:14px; border:1px solid var(--bd); border-radius:16px; overflow:hidden; box-shadow:var(--sh-1)
  }
  .dir-section-h{
    display:flex; gap:12px; align-items:center; padding:12px 14px;
    background: linear-gradient(180deg, var(--t-gold-10), #fff);
    border-bottom:1px solid var(--bd)
  }
  .dir-dropcap{
    width:42px;height:42px;border-radius:12px;
    display:grid;place-items:center;
    background:#fff; border:1px solid var(--bd); box-shadow:var(--sh-1);
    font-weight:900; color:var(--p-teal); font-size:20px; letter-spacing:.5px
  }
  .dir-section-title{ font-weight:900; font-size: clamp(18px, 1rem + .5vw, 22px) }
  .dir-section-b{ padding:10px 12px; display:grid; gap:10px }

  /* Fila de contacto (sin repetir secci√≥n) */
  .phone-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
               background:#eef2f7; border:1px solid #d8e0ea; color:#0f172a; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace }

  /* ---------- Inputs ---------- */
  label{ font-size:12px; color: color-mix(in oklab, var(--ink), transparent 40%) }
  input,textarea,select{ width:100%; border:1px solid var(--bd); border-radius:12px; padding:12px; background:#fff; color:var(--ink);
                         font:inherit; min-height:var(--touch) }
  input::placeholder, textarea::placeholder{ color: color-mix(in oklab, var(--muted), transparent 20%) }

  /* ---------- FAB emergencias ---------- */
  .fab{
    position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
    z-index:60; border:none; border-radius:999px; padding:14px 16px; cursor:pointer;
    display:inline-flex; align-items:center; gap:10px; font-weight:900;
    background:linear-gradient(180deg, color-mix(in oklab, var(--p-coral), #fff 10%), var(--p-coral));
    color:#fff; box-shadow:0 10px 24px rgba(239,71,111,.35)
  }
  .fab .ic{ filter: drop-shadow(0 1px 1px rgba(0,0,0,.15)) }

  /* ---------- Banner de aviso y toast ---------- */
  .banner{ display:none; margin:10px 0; padding:10px 12px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:12px }
  .banner[aria-hidden="false"]{ display:flex; gap:10px; align-items:center }
  #toast{ position:fixed; left:50%; bottom:calc(14px + env(safe-area-inset-bottom)); transform:translateX(-50%);
          background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--sh-2); z-index:70 }
  #toast[hidden]{ display:none }

  /* ---------- Utilidades ---------- */
  .grid{display:grid; gap:12px}
  .g3{grid-template-columns:1fr 2fr auto}
  .g2{grid-template-columns:1fr 1fr}
  @container (max-width:700px){ .g3,.g2{ grid-template-columns:1fr } }
  @media (max-width:680px){ .g3,.g2{ grid-template-columns:1fr } }

  @media (prefers-reduced-motion:reduce){
    *{animation:none!important; transition:none!important; scroll-behavior:auto!important}
  }
</style>
</head>
<body>
  <!-- Gradientes para iconos -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="grad-aur" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%"  stop-color="#9be7ff"/>
        <stop offset="50%" stop-color="#a0f1d9"/>
        <stop offset="100%" stop-color="#ffd67a"/>
      </linearGradient>

      <!-- Sprite de iconos lineales premium -->
      <symbol id="ic-hospital" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M3 21h18M6 21V7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v14M9 10h6M12 7v6M9 14h6M8 21v-3m8 3v-3"/>
      </symbol>
      <symbol id="ic-clipboard" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M9 3h6l1 2h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2l1-2zM9 11h6M9 15h6"/>
      </symbol>
      <symbol id="ic-phonebook" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M5 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5zM5 8h14M9 6v12M7 12h2M12 12h5M7 16h2M12 16h5"/>
      </symbol>
      <symbol id="ic-message" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </symbol>
      <symbol id="ic-bell" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M6 8a6 6 0 0 1 12 0v5l1.5 2.5H4.5L6 13z"/>
        <path class="ic-stroke" d="M9 20a3 3 0 0 0 6 0"/>
      </symbol>
      <symbol id="ic-plus" viewBox="0 0 24 24">
        <path class="ic-stroke" d="M12 5v14M5 12h14"/>
      </symbol>
    </defs>
  </svg>

  <header class="appbar" role="banner">
    <div class="container row">
      <div class="row" aria-label="Marca" style="min-width:0">
        <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>Infecciosas</span>
        <h1><span id="title" class="title-plate">Planta ¬∑ Tareas ¬∑ Directorio</span></h1>
      </div>
      <div class="grow"></div>
      <div class="row" aria-live="polite">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>
      <div id="userGroup" class="row">
        <div id="userchip" class="row" style="display:none">
          <span class="ic-circle"><svg class="ic ic-grad"><use href="#ic-hospital"/></svg></span>
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
        </div>
        <button id="installBtn" class="btn ghost" aria-label="Instalar">‚ûï Instalar</button>
        <button id="signin"  class="btn primary"><svg class="ic"><use href="#ic-plus"/></svg> Acceder</button>
        <button id="signout" class="btn" style="display:none">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="updateBanner" class="banner" aria-hidden="true">
      Nueva versi√≥n disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
    </div>
    <div id="installBanner" class="banner" aria-hidden="true">
      Instala la app para acceso m√°s r√°pido. <button id="installAction" class="btn primary">Instalar</button>
    </div>

    <!-- Puerta de acceso -->
    <section id="gate" class="card" role="region" aria-live="polite">
      <div class="card-h hdr"><h2 class="title-plate">Bienvenido</h2><span class="muted">Sincroniza con Google</span></div>
      <div class="card-b">
        <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
        <div class="row"><button id="signin2" class="btn primary">Acceder con Google</button></div>
        <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
      </div>
    </section>

    <section id="app" style="display:none" aria-labelledby="tabsLabel">
      <div class="card" style="margin-bottom:12px">
        <div class="card-b">
          <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
          <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
            <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">
              <span class="ic-circle"><svg class="ic"><use href="#ic-hospital"/></svg></span> Planta
            </button>
            <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">
              <span class="ic-circle"><svg class="ic"><use href="#ic-clipboard"/></svg></span> Tareas
            </button>
            <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">
              <span class="ic-circle"><svg class="ic"><use href="#ic-phonebook"/></svg></span> Directorio
            </button>
          </div>
        </div>
      </div>

      <!-- PANEL PLANTA -->
      <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
        <div class="section-banner" style="background:linear-gradient(180deg, var(--t-mint-10), #fff)">
          <span class="row"><span class="ic-circle"><svg class="ic"><use href="#ic-hospital"/></svg></span>
          <strong>PLANTA</strong></span>
          <span class="pill" style="background:var(--t-gold-10); border-color:color-mix(in oklab,var(--p-gold),#fff 70%)">Ingresos &amp; Interconsultas</span>
        </div>

        <div class="card">
          <div class="card-h hdr"><h2 class="title-plate">A√±adir (Planta/Interconsulta)</h2><span class="muted">Habitaci√≥n ¬∑ Descripci√≥n ¬∑ Pendientes</span></div>
          <div class="card-b grid g3">
            <div><label for="p-room">Habitaci√≥n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
            <div><label for="p-desc">Descripci√≥n</label><input id="p-desc" placeholder="Resumen cl√≠nico, motivo‚Ä¶"></div>
            <div style="align-self:end"><button id="p-add" class="btn primary">A√±adir</button></div>
            <div class="g2" style="grid-column:1/-1;align-items:end">
              <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, anal√≠tica‚Ä¶ (opcional)"></div>
              <div>
                <label>Grupo</label>
                <div class="row" role="group" aria-label="Grupo">
                  <button id="p-group-planta" type="button" class="btn" aria-pressed="true">Planta</button>
                  <button id="p-group-inter"  type="button" class="btn ghost" aria-pressed="false">Interconsulta</button>
                </div>
                <span id="addTarget" class="chip" aria-live="polite">A√±adiendo a: Planta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Planta</h2><span id="p-count-planta" class="chip">0</span></div>
          <div class="card-b"><ul id="p-list-planta" class="list"></ul><p id="p-empty-planta" class="muted">Sin elementos en Planta.</p></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Interconsultas</h2><span id="p-count-inter" class="chip">0</span></div>
          <div class="card-b"><ul id="p-list-inter" class="list"></ul><p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Completadas</h2><span id="p-done-count" class="chip">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="p-done" class="list"></ul>
            <p id="p-done-empty" class="muted">Nada completado.</p>
          </div>
        </div>
      </div>

      <!-- PANEL TAREAS -->
      <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1" style="display:none">
        <div class="section-banner" style="background:linear-gradient(180deg, var(--t-coral-10), #fff)">
          <span class="row"><span class="ic-circle"><svg class="ic"><use href="#ic-clipboard"/></svg></span>
          <strong>TAREAS</strong></span>
          <span class="pill" style="background:var(--t-teal-10); border-color:color-mix(in oklab,var(--p-teal),#fff 70%)">Rojo ‚Üí Verde seg√∫n proximidad</span>
        </div>

        <div class="card">
          <div class="card-h hdr"><h2 class="title-plate">A√±adir tarea</h2><span class="muted" id="t-status">Fecha ‚Üí Descripci√≥n</span></div>
          <div class="card-b">
            <div class="grid g3">
              <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
              <div><label for="t-text">Descripci√≥n</label><input id="t-text" type="text" placeholder="Describe la tarea‚Ä¶" maxlength="400"></div>
              <div style="align-self:end"><button id="t-add" class="btn primary">A√±adir</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Tareas activas</h2><span id="t-count" class="chip">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#fff7ed,transparent)">
            <ul id="t-list" class="list"></ul>
            <p id="t-empty" class="muted">No hay tareas activas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Completadas</h2><span id="t-done-count" class="chip">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="t-done" class="list"></ul>
            <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr"><h2 class="title-plate">Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
          <div class="card-b">
            <div class="row" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
            <ul id="t-trash" class="list"></ul>
            <p id="t-trash-empty" class="muted">Papelera vac√≠a.</p>
          </div>
        </div>
      </div>

      <!-- PANEL DIRECTORIO -->
      <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1" style="display:none">
        <div class="section-banner sb-dir">
          <span class="row"><span class="ic-circle"><svg class="ic"><use href="#ic-phonebook"/></svg></span>
          <strong>DIRECTORIO</strong></span>
          <span class="pill" style="background:var(--t-teal-10); border-color:color-mix(in oklab,var(--p-teal),#fff 70%)">B√∫squeda y JSON</span>
        </div>

        <div class="card">
          <div class="card-h hdr"><h2 class="title-plate">Directorio telef√≥nico</h2><span id="d-count" class="chip">0</span></div>
          <div class="card-b grid g2">
            <div><label for="d-q">B√∫squeda inteligente</label><input id="d-q" type="search" placeholder="Secci√≥n, nombre o extensi√≥n‚Ä¶ (e.g., cardio, uci, parada)"></div>
            <div class="row" style="align-self:end; justify-content:flex-end;flex-wrap:wrap">
              <button id="d-add" class="btn primary">A√±adir</button>
              <button id="d-import" class="btn">Importar JSON</button>
              <button id="d-export" class="btn">Exportar JSON</button>
            </div>
          </div>
        </div>

        <div id="d-wrap" class="card" style="margin-top:12px">
          <div class="card-b" id="d-sections"></div>
        </div>
      </div>

      <!-- Bottom tabs -->
      <nav class="bottom" aria-label="Secciones">
        <div class="tabs-bottom">
          <button class="tab-bottom" id="b-planta" aria-selected="true">
            <svg class="ic ic-grad"><use href="#ic-hospital"/></svg><span>Planta</span>
          </button>
          <button class="tab-bottom" id="b-tareas" aria-selected="false">
            <svg class="ic ic-grad"><use href="#ic-clipboard"/></svg><span>Tareas</span>
          </button>
          <button class="tab-bottom" id="b-directorio" aria-selected="false">
            <svg class="ic ic-grad"><use href="#ic-phonebook"/></svg><span>Directorio</span>
          </button>
        </div>
      </nav>
    </section>
  </main>

  <!-- FAB Emergencias -->
  <button id="panicBtn" class="fab" aria-label="Emergencias">
    <svg class="ic"><use href="#ic-bell"/></svg> Emergencias
  </button>

  <!-- Modal simple reutilizable -->
  <dialog id="modal" class="card" style="padding:0; border:none; max-width:min(560px,92vw)">
    <div class="card-h hdr"><h3 id="modalTitle" class="title-plate" style="margin:0">Editar</h3></div>
    <div id="modalBody" class="card-b"></div>
    <div class="card-b" style="display:flex; gap:8px; justify-content:flex-end">
      <button id="modalCancel" class="btn">Cancelar</button>
      <button id="modalOk" class="btn primary">Guardar</button>
    </div>
  </dialog>

  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

<script type="module">
  /* ========================== Utilidades base ========================== */
  const BASE = new URL('./', location).pathname;
  const $ = (s, r=document)=>r.querySelector(s);
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const idle = (fn)=>('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0);
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.hidden=false; setTimeout(()=>t.hidden=true,2200); };
  const esc = (s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const pillForDate=(iso)=>{ try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,''); }catch{return iso} };

  // Android viewport: fija --vh sin duplicar (evita "Identifier ... declared")
  if(!window.__setVHVar){
    window.__setVHVar = () => { document.documentElement.style.setProperty('--vh', `${Math.max(window.innerHeight, document.documentElement.clientHeight)*0.01}px`); };
    addEventListener('resize', __setVHVar, {passive:true});
    __setVHVar();
  }

  // Orden de tabs & selecci√≥n
  const tabOrder=['planta','tareas','directorio'];
  function setTabA11y(id){
    for(const k of tabOrder){
      const sel = (k===id);
      const el = document.getElementById('tab-'+k);
      el.setAttribute('aria-selected', sel);
      el.setAttribute('tabindex', sel ? '0' : '-1');
    }
  }
  function selectTab(id, focusPanel=false){
    const map={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio']};
    for(const k in map){ const [p,t,b,l]=map[k]; const sel=(k===id);
      document.getElementById(p).style.display = sel ? '' : 'none';
      document.getElementById(t).setAttribute('aria-selected',sel);
      document.getElementById(b).setAttribute('aria-selected',sel);
      if(sel){ $('#title').textContent=l; localStorage.setItem('tab', k); if(focusPanel) document.getElementById(p).focus?.(); }
    }
    setTabA11y(id); location.hash = id;
  }
  $('#tab-planta').onclick =()=>selectTab('planta',true);
  $('#tab-tareas').onclick =()=>selectTab('tareas',true);
  $('#tab-directorio').onclick=()=>selectTab('directorio',true);
  $('#b-planta').onclick =()=>selectTab('planta');
  $('#b-tareas').onclick =()=>selectTab('tareas');
  $('#b-directorio').onclick=()=>selectTab('directorio');

  $('#tablist').addEventListener('keydown', (e)=>{
    const cur = tabOrder.findIndex(k => document.getElementById('tab-'+k).getAttribute('aria-selected')==='true');
    if(e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); const n=(cur+1)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
    if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); const n=(cur-1+tabOrder.length)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
    if(e.key==='Home'){ e.preventDefault(); document.getElementById('tab-'+tabOrder[0]).focus(); document.getElementById('tab-'+tabOrder[0]).click(); }
    if(e.key==='End'){ e.preventDefault(); document.getElementById('tab-'+tabOrder.at(-1)).focus(); document.getElementById('tab-'+tabOrder.at(-1)).click(); }
  });

  // Conectividad
  const setOnline=(on)=>{ const b=$('#badge-online'); b.textContent=on?'Online':'Offline'; b.className='chip '+(on?'ok':'bad'); };
  setOnline(navigator.onLine);
  addEventListener('online', ()=>setOnline(true), {passive:true});
  addEventListener('offline',()=>setOnline(false), {passive:true});

  /* ========================== Firebase ========================== */
  const appMod   = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
  const authMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
  const fsMod    = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
  const { firebaseConfig } = await import(BASE + 'firebase-config.js');

  const fbApp = appMod.initializeApp(firebaseConfig);
  const auth  = authMod.getAuth(fbApp);
  const db    = fsMod.initializeFirestore(fbApp, {
    localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() })
  });
  const serverTS = fsMod.serverTimestamp;

  // Mejora de autenticaci√≥n (persistencia + idioma + redirect en PWA instalada)
  auth.useDeviceLanguage();
  await authMod.setPersistence(auth, authMod.browserLocalPersistence).catch(()=>{});
  const provider = new authMod.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });

  // Intenta resolver devoluci√≥n de redirect (evita quedarse ‚Äúcolgado‚Äù)
  authMod.getRedirectResult(auth).catch(e => { $('#authErr').textContent = e.message || String(e); });

  const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), displayname=$('#displayname');

  const doSignIn=async()=>{ try{
    if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth, provider);
    else await authMod.signInWithPopup(auth, provider);
  }catch(e){ $('#authErr').textContent=e.message||String(e); } };

  $('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; 
  $('#signout').onclick=async()=>authMod.signOut(auth);

  const gate=$('#gate'), appUI=$('#app');

  authMod.onAuthStateChanged(auth, user=>{
    if(user){
      badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
      displayname.textContent=user.displayName||user.email||''; userchip.style.display='inline-flex';
      $('#signout').style.display='inline-flex'; $('#signin').style.display='none'; gate.style.display='none'; appUI.style.display='';
      mountApp(user.uid);
    }else{
      badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
      userchip.style.display='none'; $('#signout').style.display='none'; $('#signin').style.display='inline-flex'; appUI.style.display='none'; gate.style.display='';
      unmountApp();
    }
  });

  /* ========================== Dominio de datos ========================== */
  const col = {
    planta  : (uid)=> fsMod.collection(db,'users',uid,'planta'),
    tareas  : (uid)=> fsMod.collection(db,'users',uid,'tareas'),
    dir     : (uid)=> fsMod.collection(db,'users',uid,'directorio'),
  };
  let unsubs=[]; const currentUid=()=>auth.currentUser?.uid;
  function unmountApp(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

  // --- Planta ---
  let currentGroup='planta';
  function updateAddTarget(){
    const t=$('#addTarget');
    if(currentGroup==='planta'){ t.textContent='A√±adiendo a: Planta'; t.className='chip'; }
    else { t.textContent='A√±adiendo a: Interconsulta'; t.className='chip'; }
  }
  $('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget(); $('#p-group-planta').className='btn'; $('#p-group-inter').className='btn ghost';};
  $('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget(); $('#p-group-inter').className='btn'; $('#p-group-planta').className='btn ghost';};
  updateAddTarget();

  const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(),
    grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });

  const btn = (t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.onclick=(e)=>{e.preventDefault(); fn?.(e)}; b.type='button'; return b;};

  function roomSortKey(s){
    if(!s) return Number.POSITIVE_INFINITY;
    const m = String(s).match(/\d+/g); if(!m) return Number.POSITIVE_INFINITY;
    const first = parseInt(m[0],10); const second = m[1] ? parseInt(m[1],10)/100 : 0; return first + second;
  }

  const docItemBase=(x,done=false)=>{
    const li=document.createElement('li'); li.className='item ' + (x.grupo==='interconsulta'?'ic':'pl');
    const roomClass = 'pill room';
    li.innerHTML=`<span class="${roomClass}">${esc(x.room||'‚Äî')}</span>
      <div class="text">${done?`<div class="line strike">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
      ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
      <div class="row actions"></div>`;
    return li;
  };
  const renderPlantaItem=(x)=>{const li=docItemBase(x); const a=li.querySelector('.actions');
    a.append(btn('‚úì',()=>upd('planta',x.__id,{status:'done'}),'btn icon'),btn('‚úé',()=>editPlanta(x),'btn icon'),btn('üóëÔ∏è',()=>upd('planta',x.__id,{status:'trash'}),'btn icon')); return li;};
  const renderPlantaDone=(x)=>{const li=docItemBase(x,true); const a=li.querySelector('.actions');
    a.append(btn('‚Ü©',()=>upd('planta',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('planta',x.__id),'btn icon')); return li;};

  const val=(id)=>document.getElementById(id)?.value||'';
  const openEdit=(fields,onOk)=>{
    const body=$('#modalBody'); body.innerHTML='';
    for(const f of fields){ const w=document.createElement('div'); w.innerHTML=`<label for="${f.id}">${f.l}</label><input id="${f.id}" value="${esc(f.v||'')}">`; body.append(w); }
    const dlg=$('#modal'); $('#modalTitle').textContent='Editar'; $('#modalOk').textContent='Guardar'; $('#modalCancel').textContent='Cancelar';
    dlg.showModal();
    $('#modalOk').onclick=async e=>{e.preventDefault(); await onOk(); dlg.close();};
    $('#modalCancel').onclick=e=>{e.preventDefault(); dlg.close();};
  };
  const editPlanta=(x)=>openEdit(
    [{l:'Habitaci√≥n',id:'p_room',v:x.room||''},{l:'Descripci√≥n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}],
    async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')})
  );

  function setupPlanta(uid){
    $('#p-add').onclick=async()=>{
      const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup});
      if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(id=>document.getElementById(id).value='');
    };
    const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
    const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));

    const u1=fsMod.onSnapshot(qA,(s)=>{
      const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x);});
      const arrP = all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
      const arrI = all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
      const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
      arrP.forEach(x=>lp.appendChild(renderPlantaItem(x)));
      arrI.forEach(x=>li.appendChild(renderPlantaItem(x)));
      $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
      $('#p-count-planta').textContent=arrP.length; $('#p-count-inter').textContent=arrI.length;
    });

    const u2=fsMod.onSnapshot(qD,(s)=>{
      const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
      arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
      const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(renderPlantaDone(x)));
      $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=arr.length;
    });
    unsubs.push(u1,u2);
  }

  // --- Tareas ---
  const tareaDoc = (d)=>({ date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
  function daysFromToday(iso){ try{ const d = new Date(iso+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch{return 0} }
  function hueForDays(diff){ if(isNaN(diff)) return 205; if(diff <= -7) return 0; if(diff < 0) return 10; const max=30; return Math.round(10 + (Math.min(diff,max)/max)*120); }
  function bgForHue(h){ return `hsl(${h} 90% 92%)`; }
  function renderTareaItem(x){
    const diff = daysFromToday(x.date); const h = hueForDays(diff); const bg = bgForHue(h);
    const li=document.createElement('li'); li.className='item'; li.style.borderLeft = `6px solid hsl(${h} 72% 46%)`;
    li.innerHTML=`<span class="pill date" style="background:${bg};border-color:hsl(${h} 70% 72%)">${pillForDate(x.date)}</span>
      <div class="text"><div class="line">${esc(x.text||'')}</div></div><div class="row actions"></div>`;
    const a=li.querySelector('.actions');
    a.append(btn('‚úì',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'),btn('‚úé',()=>editTarea(x),'btn icon'),btn('üóëÔ∏è',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon'));
    return li;
  }
  function renderTareaDone(x){
    const li=document.createElement('li'); li.className='item'; li.style.borderLeft = `6px solid hsl(150 50% 38%)`;
    li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span>
      <div class="text"><div class="line strike">${esc(x.text||'')}</div></div><div class="row actions"></div>`;
    li.querySelector('.actions').append(btn('‚Ü©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
    return li;
  }
  function renderTareaTrash(x){
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span>
      <div class="text muted"><div class="line">${esc(x.text||'')}</div></div><div class="row actions"></div>`;
    li.querySelector('.actions').append(btn('‚§¥',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
    return li;
  }
  const editTarea=(x)=>openEdit([{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'Descripci√≥n',id:'t_text',v:x.text||''}], async()=>upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')}));
  function setupTareas(uid){
    $('#t-date').value=todayISO();
    $('#t-add').onclick=async ()=>{ const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return;
      await fsMod.addDoc(col.tareas(uid), tareaDoc({date,text})); $('#t-text').value=''; };
    const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
    const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
    const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

    const u1=fsMod.onSnapshot(qA,(snap)=>{
      const arr=[]; snap.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
      arr.sort((a,b)=> daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0) );
      const list=$('#t-list'); list.innerHTML=''; let n=0;
      idle(()=>{arr.forEach(x=>{list.appendChild(renderTareaItem(x)); n++;}); $('#t-count').textContent=n; $('#t-empty').style.display=n?'none':'block'; setNotif(n);});
    });
    const u2=fsMod.onSnapshot(qD,(s)=>{
      const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
      arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
      const l=$('#t-done'); l.innerHTML=''; let n=0;
      idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaDone(x)); n++;}); $('#t-done-empty').style.display=n?'none':'block'; $('#t-done-count').textContent=n;});
    });
    const u3=fsMod.onSnapshot(qT,(s)=>{
      const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
      arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
      const l=$('#t-trash'); l.innerHTML=''; let n=0;
      idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaTrash(x)); n++;}); $('#t-trash-empty').style.display=n?'none':'block'; $('#t-trash-count').textContent=n;});
    });
    $('#t-emptyTrash').onclick=()=>emptyTrash(uid,'tareas');
    unsubs.push(u1,u2,u3);
  }

  // --- Directorio ---
  const dirDoc=(d)=>({ seccion:String(d.seccion||'').trim()||'Sin secci√≥n', nombre:String(d.nombre||'').trim()||'Sin nombre', telefono:String(d.telefono||'').trim(), notas:String(d.notas||'').trim(), createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
  let dirCache=[];
  function telHref(raw){ const s=String(raw||'').replace(/[^\d+]/g,''); return s?`tel:${s}`:null; }
  function phonesToChips(raw){
    const parts = String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
    return parts.map(p=>{ const href = telHref(p); return href?`<a class="phone-chip" href="${href}" dir="ltr">${esc(p)}</a>`:`<span class="phone-chip" dir="ltr">${esc(p)}</span>`; }).join(' ');
  }

  function setupDirectorio(uid){
    $('#d-add').onclick=async()=>{
      const d=dirDoc({seccion:prompt('Secci√≥n')||'',nombre:prompt('Nombre')||'',telefono:prompt('Tel√©fonos (formato libre)')||'',notas:''});
      await fsMod.addDoc(col.dir(uid),d);
    };
    $('#d-import').onclick=importDir(uid); $('#d-export').onclick=exportDir(uid);
    const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{ dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderDir(); });
    $('#d-q').addEventListener('input', renderDir, {passive:true});
    unsubs.push(u);
  }

  function renderDir(){
    const wrap = $('#d-sections'); if(!wrap) return; wrap.innerHTML='';
    const v=($('#d-q')?.value||'').toLowerCase();
    // Group by secci√≥n
    const map = new Map();
    for(const x of dirCache){
      if(v && ![x.seccion,x.nombre,String(x.telefono||''),x.notas].some(y=>String(y||'').toLowerCase().includes(v))) continue;
      const k = x.seccion || 'Sin secci√≥n';
      if(!map.has(k)) map.set(k, []);
      map.get(k).push(x);
    }
    // Sort secciones & nombres
    const sections = [...map.keys()].sort((a,b)=>a.localeCompare(b));
    for(const s of sections){
      const items = map.get(s).sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      // header con inicial
      const sec = document.createElement('section'); sec.className='dir-section';
      const init = (s||'')[0]?.toUpperCase?.() || '‚Ä¢';
      sec.innerHTML = `
        <div class="dir-section-h">
          <div class="dir-dropcap">${esc(init)}</div>
          <div class="dir-section-title">${esc(s)}</div>
        </div>
        <div class="dir-section-b"></div>`;
      const body = sec.querySelector('.dir-section-b');
      for(const x of items){
        const li = document.createElement('div'); li.className='item';
        li.innerHTML = `
          <div class="text">
            <div class="line"><strong>${esc(x.nombre||'')}</strong></div>
            <div class="line">${phonesToChips(x.telefono)}</div>
            ${x.notas?`<div class="muted">${esc(x.notas)}</div>`:''}
          </div>
          <div class="row actions"></div>`;
        // acciones
        const a=li.querySelector('.actions');
        a.append(btn('‚úé',()=>editDir(x),'btn icon'),btn('üóëÔ∏è',()=>del('directorio',x.__id),'btn icon'));
        body.append(li);
      }
      wrap.append(sec);
    }
    $('#d-count').textContent = `${[...map.values()].reduce((n,a)=>n+a.length,0)} registros`;
  }

  const editDir=(x)=>openEdit(
    [{l:'Secci√≥n',id:'d_sec',v:x.seccion||''},{l:'Nombre',id:'d_nom',v:x.nombre||''},{l:'Tel√©fonos',id:'d_tel',v:x.telefono||''},{l:'Notas',id:'d_not',v:x.notas||''}],
    async()=>upd('directorio',x.__id,{seccion:val('d_sec'),nombre:val('d_nom'),telefono:val('d_tel'),notas:val('d_not')})
  );

  function importDir(uid){return async()=>{try{
    const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido');
    const snap=await fsMod.getDocs(col.dir(uid)); const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
    const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[]; for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); }
    await Promise.all(ops); toast('Importado ('+ops.length+')');
  }catch(e){ toast(e.message||String(e)); }}};
  function exportDir(uid){return async()=>{const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()}));
    const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado'); }};

  // Notificador (cuenta tareas activas)
  const setNotif = (n)=>{ const el=document.getElementById('displayname'); el.title = n?`${n} tareas activas`:'Sin avisos'; };

  // Montaje y CRUD comunes
  function mountApp(uid){ setupPlanta(uid); setupTareas(uid); setupDirectorio(uid); selectTab(location.hash?.slice(1) || localStorage.getItem('tab') || 'planta'); }
  async function upd(kind,id,patch){ const ref=fsMod.doc(db,'users',currentUid(),kind,id); await fsMod.updateDoc(ref,{...patch,updatedAt:serverTS()}); }
  async function del(kind,id){ await fsMod.deleteDoc(fsMod.doc(db,'users',currentUid(),kind,id)); }
  async function emptyTrash(uid,kind){ const q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada'); }

  // File pickers
  async function pickReadText(){ if('showOpenFilePicker' in window){ const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const f=await h.getFile(); return await f.text(); }
    return await new Promise((res,rej)=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json';
      i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); }; i.click(); }); }
  async function pickWriteBlob(blob,name){ if('showSaveFilePicker' in window){ const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const w=await h.createWritable(); await w.write(blob); await w.close(); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  /* ========================== Instalaci√≥n PWA & SW ========================== */
  let deferredPrompt=null;
  addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').setAttribute('aria-hidden','false');});
  $('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').setAttribute('aria-hidden','true'); } };
  $('#installBtn').onclick=()=>$('#installAction').click();

  if('serviceWorker' in navigator){
    const reg=await navigator.serviceWorker.register(BASE+'sw.js');
    navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
    const showUpdate=()=>{ $('#updateBanner').setAttribute('aria-hidden','false'); $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'}); };
    if(reg.waiting) showUpdate();
    reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
  }

  // FAB emergencias (lista configurable)
  const EMERGENCY = [
    { name:'Equipo de Parada', tel:'2222' },
    { name:'Seguridad', tel:'3333' },
    { name:'Jefe de Enfermer√≠a', tel:'4444' },
  ];
  $('#panicBtn').onclick=()=>{
    const body=$('#modalBody'); body.innerHTML = `<div class="grid">
      ${EMERGENCY.map(e=>`<div class="item" style="grid-template-columns:1fr auto">
         <div class="text"><div class="line"><strong>${esc(e.name)}</strong></div><div class="line"><span class="phone-chip">${esc(e.tel)}</span></div></div>
         <div class="row"><a class="btn primary" href="tel:${e.tel}">Llamar</a></div>
      </div>`).join('')}
    </div>`;
    $('#modalTitle').textContent='Emergencias'; $('#modalOk').style.display='none'; $('#modalCancel').textContent='Cerrar';
    $('#modal').showModal();
    $('#modalCancel').onclick=(ev)=>{ev.preventDefault(); $('#modal').close(); $('#modalOk').style.display=''; $('#modalCancel').textContent='Cancelar';};
  };

  // Tab inicial
  selectTab((location.hash?.slice(1)) || 'planta');
</script>
</body>
</html>
