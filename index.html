<!doctype html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
Â  <meta name="theme-color" content="#ffffff" />
Â  <meta name="color-scheme" content="light" />
Â  <title>Infecciosas â€” Planta Â· Tareas Â· Directorio</title>

Â  Â  <link rel="manifest" href="manifest.webmanifest" />
Â  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
Â  <link rel="apple-touch-icon" href="icons/icon-192.png" />

Â  <style>
Â  Â  /* ---------- Tokens de color (paleta y derivados) ---------- */
Â  Â  :root{
Â  Â  Â  /* Base del sistema (legibilidad ante todo) */
Â  Â  Â  --ink:#0b1220;Â  Â  Â  Â  Â  Â  /* texto principal */
Â  Â  Â  --muted:#596076;Â  Â  Â  Â  Â  /* texto secundario */
Â  Â  Â  --surface:#ffffff;Â  Â  Â  Â  /* fondo */
Â  Â  Â  --surface-2:#f6f8fb;Â  Â  Â  /* placas claras */
Â  Â  Â  --border:#e7ecf3;Â  Â  Â  Â  Â /* bordes suaves */

Â  Â  Â  /* Paleta principal (tu paleta) */
Â  Â  Â  --ivory:#F8FFE5;
Â  Â  Â  --mint:#06D6A0;
Â  Â  Â  --teal:#1B9AAA;
Â  Â  Â  --coral:#EF476F;
Â  Â  Â  --gold:#FFC43D;

Â  Â  Â  /* Derivados â€“ claros para placas y auroras */
Â  Â  Â  --mint-plate: color-mix(in oklab, var(--mint) 10%, #fff);
Â  Â  Â  --teal-plate: color-mix(in oklab, var(--teal) 12%, #fff);
Â  Â  Â  --coral-plate: color-mix(in oklab, var(--coral) 10%, #fff);
Â  Â  Â  --gold-plate: color-mix(in oklab, var(--gold) 10%, #fff);

Â  Â  Â  /* Gradientes aurora para headers */
Â  Â  Â  --g-mint: linear-gradient(135deg, color-mix(in oklab,#fff 60%,var(--mint)), color-mix(in oklab,#fff 30%,var(--teal)));
Â  Â  Â  --g-teal: linear-gradient(135deg, color-mix(in oklab,#fff 60%,var(--teal)), color-mix(in oklab,#fff 25%,var(--mint)));
Â  Â  Â  --g-coral:linear-gradient(135deg, color-mix(in oklab,#fff 62%,var(--coral)), color-mix(in oklab,#fff 35%,var(--gold)));
Â  Â  Â  --g-gold: linear-gradient(135deg, color-mix(in oklab,#fff 60%,var(--gold)), color-mix(in oklab,#fff 25%,var(--coral)));

Â  Â  Â  /* Dimensiones y sombras */
Â  Â  Â  --radius:14px; --radius-xl:20px; --app-h:64px; --touch:44px;
Â  Â  Â  --shadow-1:0 1px 2px rgba(5,18,35,.06),0 10px 26px rgba(5,18,35,.06);
Â  Â  Â  --shadow-2:0 2px 8px rgba(5,18,35,.10),0 18px 36px rgba(5,18,35,.12);
Â  Â  Â  --rim: inset 0 1px 0 #fff;
Â  Â  }

Â  Â  /* ---------- Base ---------- */
Â  Â  *,*::before,*::after{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0;background:var(--surface);color:var(--ink);
Â  Â  Â  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
Â  Â  Â  font-size:clamp(15px,1vw + .3vh,18px);line-height:1.65;min-height:100dvh;
Â  Â  Â  -webkit-tap-highlight-color:transparent
Â  Â  }
Â  Â  :focus-visible{outline:3px solid color-mix(in oklab, var(--gold), var(--mint) 30%);outline-offset:2px;border-radius:10px}
Â  Â  .hide{display:none !important}
Â  Â  .container{max-width:min(1160px,98vw);margin:0 auto;padding:8px clamp(12px,4vw,20px);container-type:inline-size}
Â  Â  .grow{flex:1;min-width:0}

Â  Â  /* ---------- AppBar + chips ---------- */
Â  Â  header.appbar{
Â  Â  Â  position:sticky;top:0;z-index:50;min-height:var(--app-h);
Â  Â  Â  background:linear-gradient(180deg,#ffffff 55%,#f4f8ff 100%);
Â  Â  Â  border-bottom:1px solid var(--border);
Â  Â  Â  backdrop-filter:saturate(1.05) blur(6px)
Â  Â  }
Â  Â  .appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
Â  Â  .brand-chip{
Â  Â  Â  display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;
Â  Â  Â  color:#0E121A;background:var(--ivory);border:1px solid #eef4df;box-shadow:var(--shadow-1),var(--rim);
Â  Â  Â  font-weight:900;letter-spacing:.3px
Â  Â  }
Â  Â  .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--gold);box-shadow:0 0 0 2px rgba(0,0,0,.06)}
Â  Â  h1{margin:0;font-size:clamp(21px,2.8vw,30px);font-weight:900;letter-spacing:.2px}

Â  Â  .chip{
Â  Â  Â  display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);
Â  Â  Â  border-radius:999px;font-size:.84rem;background:var(--surface-2);box-shadow:var(--rim)
Â  Â  }
Â  Â  .chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
Â  Â  .chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}

Â  Â  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
Â  Â  Â  padding:10px 12px;border-radius:12px;box-shadow:var(--shadow-1),var(--rim);
Â  Â  Â  min-height:var(--touch);min-width:44px;display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-weight:700}
Â  Â  .btn.primary{background:var(--gold-plate);border-color:color-mix(in oklab,var(--gold),transparent 70%)}
Â  Â  .btn.ghost{background:transparent;border-color:transparent;box-shadow:none;color:color-mix(in oklab,var(--teal),#000 5%)}
Â  Â  .btn.icon{min-width:var(--touch);aspect-ratio:1/1;padding:0 10px}

Â  Â  /* ---------- Tarjetas + headers Aurora ---------- */
Â  Â  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-1);overflow:hidden;contain:content}
Â  Â  .card-h{position:relative;padding:14px 16px;border-radius:var(--radius-xl) var(--radius-xl) 0 0;color:#0c1825;
Â  Â  Â  display:flex;align-items:center;justify-content:space-between;gap:10px;text-shadow:0 1px 0 rgba(255,255,255,.8);isolation:isolate}
Â  Â  .card-h h2{margin:0;font-size:clamp(18px,2.2vw,22px);font-weight:900;letter-spacing:.2px}
Â  Â  .card-b{padding:12px}
Â  Â  .subtitle{color:var(--muted);font-weight:600}

Â  Â  .hdr-planta{background:var(--g-mint)}
Â  Â  .hdr-inter {background:var(--g-teal)}
Â  Â  .hdr-tareas{background:var(--g-coral)}
Â  Â  .hdr-dirÂ  Â {background:var(--g-gold)}
Â  Â  .hdr-addÂ  Â {background:linear-gradient(135deg,#ffffff,color-mix(in oklab,#fff 70%,var(--teal)))}

Â  Â  /* ---------- Tabs (superior & bottom) con SVG ---------- */
Â  Â  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
Â  Â  .tab{
Â  Â  Â  padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--surface-2);
Â  Â  Â  cursor:pointer;font-weight:900;letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:10px
Â  Â  }
Â  Â  .tab[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--teal),transparent 65%);box-shadow:0 10px 24px rgba(20,70,120,.08),var(--rim)}

Â  Â  nav.bottom{position:sticky;bottom:0;z-index:30;background:#fff;border-top:1px solid var(--border)}
Â  Â  .tabs-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:center;padding:8px 12px}
Â  Â  .tab-bottom{
Â  Â  Â  padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);cursor:pointer;font-weight:800;
Â  Â  Â  display:flex;align-items:center;justify-content:center;gap:8px
Â  Â  }
Â  Â  .tab-bottom[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--gold),transparent 60%);box-shadow:0 8px 22px rgba(0,0,0,.08),var(--rim)}

Â  Â  /* ---------- Listas, inputs ---------- */
Â  Â  ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px;content-visibility:auto;contain-intrinsic-size:600px}
Â  Â  li.item{display:grid;grid-template-columns:auto minmax(120px,1fr) auto;gap:12px;align-items:center;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
Â  Â  .muted{color:var(--muted)} .text{min-width:0} .line{overflow-wrap:anywhere} .strike{text-decoration:line-through;opacity:.88}
Â  Â  label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
Â  Â  input,textarea,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;color:var(--ink);font:inherit;min-height:var(--touch);box-shadow:var(--rim)}
Â  Â  textarea{min-height:90px;resize:vertical}
Â  Â  input::placeholder,textarea::placeholder{color:color-mix(in oklab,var(--muted),transparent 20%)}

Â  Â  /* ---------- PÃ­ldoras ---------- */
Â  Â  .pill{
Â  Â  Â  display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;padding:6px 10px;border-radius:12px;line-height:1;border:1px solid transparent;color:#0d1726;background:var(--surface-2);
Â  Â  Â  box-shadow:var(--rim)
Â  Â  }
Â  Â  .pill.room{
Â  Â  Â  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
Â  Â  Â  font-size:clamp(18px,2.4vw,22px); padding:10px 14px; border-radius:14px; letter-spacing:.3px;
Â  Â  }
Â  Â  .room-planta{ background: var(--mint-plate); border-color: color-mix(in oklab,var(--mint),transparent 60%) }
Â  Â  .room-inter { background: var(--teal-plate); border-color: color-mix(in oklab,var(--teal),transparent 60%) }

Â  Â  /* ---------- Cromatismo tareas ---------- */
Â  Â  .t-hue{ /* se setea inline el --h */ --h:120; border-left:6px solid hsl(var(--h) 72% 46%) }
Â  Â  .t-hue .pill.date{ background: hsl(var(--h) 95% 92%); border-color:hsl(var(--h) 70% 72%) }
Â  Â  .done-bg{ background: linear-gradient(180deg,#f0fdf4,transparent) }

Â  Â  /* ---------- Secciones ---------- */
Â  Â  .section-banner{margin:10px 0 8px;border-radius:16px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);box-shadow:var(--rim);
Â  Â  Â  display:flex;align-items:center;justify-content:space-between;gap:12px}
Â  Â  .sb-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--surface-2);border:1px solid var(--border);font-weight:700;box-shadow:var(--rim)}

Â  Â  /* ---------- Toast + Modales ---------- */
Â  Â  #toast{position:fixed;left:50%;bottom:calc(14px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow-2);z-index:80}
Â  Â  #toast[hidden]{display:none}
Â  Â  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:90}
Â  Â  .modal[open]{display:grid}
Â  Â  .dialog{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-2);padding:16px;width:min(560px,92vw)}

Â  Â  /* ---------- FAB Emergencias ---------- */
Â  Â  .fab{
Â  Â  Â  position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));z-index:70;border-radius:999px;padding:14px 16px;
Â  Â  Â  background:linear-gradient(135deg, var(--coral-plate), color-mix(in oklab,var(--coral),#fff 25%));
Â  Â  Â  border:1px solid color-mix(in oklab,var(--coral),transparent 60%);
Â  Â  Â  color:#0b1220;box-shadow:0 16px 38px rgba(239,71,111,.3), var(--rim);display:flex;align-items:center;gap:10px;font-weight:900
Â  Â  }
Â  Â  .fab-panel{
Â  Â  Â  position:fixed;right:16px;bottom:calc(80px + env(safe-area-inset-bottom));z-index:69;width:min(420px,92vw);
Â  Â  Â  background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-2);padding:12px;display:none
Â  Â  }
Â  Â  .fab-panel[open]{display:block}

Â  Â  .contact-chip{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);box-shadow:var(--rim);margin:6px 0}
Â  Â  .gear{margin-left:auto;border:1px solid var(--border);background:#fff;border-radius:999px;width:36px;height:36px;display:inline-grid;place-items:center;box-shadow:var(--rim)}

Â  Â  /* ---------- SVG base (cÃ­rculo blanco + halo) ---------- */
Â  Â  .ico-wrap{position:relative;display:inline-grid;place-items:center}
Â  Â  .ico-bg{fill:#fff;filter:drop-shadow(0 4px 12px rgba(0,0,0,.12))}
Â  Â  .ico{width:20px;height:20px}
Â  Â  .ico-xl{width:22px;height:22px}

Â  Â  /* ---------- Responsivo ---------- */
Â  Â  @media (max-width:520px){
Â  Â  Â  .statusRow{order:3;width:100%}
Â  Â  Â  #userGroup{order:2;margin-left:auto}
Â  Â  Â  .toolbar{order:4;width:100%;justify-content:flex-start}
Â  Â  Â  #title{font-size:clamp(18px,5vw,22px)}
Â  Â  }
Â  Â  @container (max-width:700px){ .g3,.g2{grid-template-columns:1fr} }

Â  Â  /* =======================
Â  Â  Â   Aurora vFinal â€” UI Base
Â  Â  Â   (Override no-destructivo)
Â  Â  Â   ======================= */
Â  Â  :root{
Â  Â  Â  --aurora-ivory:#F8FFE5;
Â  Â  Â  --aurora-mint:#06D6A0;
Â  Â  Â  --aurora-teal:#1B9AAA;
Â  Â  Â  --aurora-coral:#EF476F;
Â  Â  Â  --aurora-gold:#FFC43D;

Â  Â  Â  /* Derivados suaves para placas/cabeceras */
Â  Â  Â  --mint-soft: color-mix(in oklab, var(--aurora-mint) 14%, white);
Â  Â  Â  --teal-soft: color-mix(in oklab, var(--aurora-teal) 14%, white);
Â  Â  Â  --coral-soft: color-mix(in oklab, var(--aurora-coral) 14%, white);
Â  Â  Â  --gold-soft: color-mix(in oklab, var(--aurora-gold) 16%, white);
Â  Â  }
Â  Â  /* AppBar / TÃ­tulo */
Â  Â  header.appbar{
Â  Â  Â  background:
Â  Â  Â  Â  linear-gradient(180deg, #ffffff 0%, color-mix(in oklab, var(--aurora-ivory) 24%, white) 100%);
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,.06);
Â  Â  Â  box-shadow: 0 6px 18px rgba(0,0,0,.06);
Â  Â  }
Â  Â  header.appbar h1{
Â  Â  Â  font-weight: 900;
Â  Â  Â  letter-spacing: .2px;
Â  Â  Â  line-height: 1.2;
Â  Â  Â  /* Fluid type para mÃ³vil/desktop */
Â  Â  Â  font-size: clamp(20px, 2.1rem + .5vw, 34px);
Â  Â  Â  /* Sutil rim-light (sobre fondo claro no â€œensuciaâ€) */
Â  Â  Â  text-shadow: 0 1px 0 rgba(255,255,255,.8);
Â  Â  }
Â  Â  /* Chips de estado (online/auth) si existen */
Â  Â  .brand-chip, .state-chip{
Â  Â  Â  background: #fff;
Â  Â  Â  border: 1px solid rgba(0,0,0,.08);
Â  Â  Â  box-shadow:
Â  Â  Â  Â  inset 0 1px 0 rgba(255,255,255,.9),
Â  Â  Â  Â  0 4px 10px rgba(0,0,0,.05);
Â  Â  Â  border-radius: 999px;
Â  Â  }
Â  Â  /* Tabs superiores o inferiores (atributos ARIA robustos) */
Â  Â  [role="tablist"]{
Â  Â  Â  display:flex; gap:.25rem;
Â  Â  Â  background:#fff;
Â  Â  Â  border-top: 1px solid rgba(0,0,0,.06);
Â  Â  Â  box-shadow: 0 -6px 18px rgba(0,0,0,.04);
Â  Â  Â  padding: .25rem env(safe-area-inset-right) calc(.25rem + env(safe-area-inset-bottom)) env(safe-area-inset-left);
Â  Â  }
Â  Â  [role="tablist"] [role="tab"],.tab{
Â  Â  Â  flex:1 1 0;
Â  Â  Â  display:flex; flex-direction:column; align-items:center; justify-content:center;
Â  Â  Â  gap:.25rem; padding:.5rem .25rem;
Â  Â  Â  font-size: clamp(11px, .75rem + .15vw, 13px);
Â  Â  Â  color:#374151;
Â  Â  Â  background:#fff;
Â  Â  Â  border:1px solid transparent;
Â  Â  L Â  Â  border-radius: 12px;
Â  Â  Â  outline-offset: 3px;
Â  Â  }
Â  Â  [role="tab"][aria-selected="true"],.tab[aria-selected="true"]{
Â  Â  Â  border-color: color-mix(in oklab, var(--aurora-teal) 38%, #ffffff);
Â  Â  Â  box-shadow:
Â  Â  Â  Â  0 1px 0 rgba(255,255,255,.9) inset,
Â  Â  Â  Â  0 8px 18px rgba(27,154,170,.14);
Â  Â  }
Â  Â  /* Icon badge: cÃ­rculo blanco con halo */
Â  Â  .icon-badge{
Â  Â  Â  width: clamp(24px, 26px + .25vw, 32px);
Â  Â  Â  height: clamp(24px, 26px + .25vw, 32px);
Â  Â  Â  border-radius: 9999px;
Â  Â  Â  display:grid; place-items:center;
Â  Â  Â  background:#fff;
Â  Â  Â  box-shadow:
Â  Â  Â  Â  0 0 0 1px rgba(255,255,255,.85) inset, /* rim-light */
Â  Â  Â  Â  0 1px 0 rgba(0,0,0,.03) inset,
Â  Â  Â  Â  0 8px 18px rgba(0,0,0,.10); Â  Â  Â  Â  Â  Â /* halo */
Â  Â  }
Â  Â  /* Accesibilidad: foco visible alto contraste */
Â  Â  :where([role="tab"], .tab, button, a):focus-visible{
Â  Â  Â  outline: 3px solid color-mix(in oklab, var(--aurora-coral) 50%, white);
Â  Â  Â  outline-offset: 3px;
Â  Â  Â  border-radius: 14px;
Â  Â  }
Â  Â  /* Evitar scroll lateral accidental */
Â  Â  html,body{ overflow-x:hidden; }
Â  </style>
</head>
<body>
Â  Â  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
Â  Â  <defs>
Â  Â  Â  Â  Â  Â  <linearGradient id="g-mint" x1="0" y1="0" x2="1" y2="1">
Â  Â  Â  Â  <stop offset="0%" Â stop-color="#2EE6B7"/>
Â  Â  Â  Â  <stop offset="100%" stop-color="#06D6A0"/>
Â  Â  Â  </linearGradient>
Â  Â  Â  <linearGradient id="g-teal" x1="0" y1="0" x2="1" y2="1">
Â  Â  Â  Â  <stop offset="0%" Â stop-color="#3BC5D6"/>
Â  Â  Â  Â  <stop offset="100%" stop-color="#1B9AAA"/>
Â  Â  Â  </linearGradient>
Â  Â  Â  <linearGradient id="g-coral" x1="0" y1="0" x2="1" y2="1">
Â  Â  Â  Â  <stop offset="0%" Â stop-color="#FF6A8B"/>
Â  Â  Â  Â  <stop offset="100%" stop-color="#EF476F"/>
Â  Â  Â  </linearGradient>
Â  Â  Â  <linearGradient id="g-gold" x1="0" y1="0" x2="1" y2="1">
Â  Â  Â  Â  <stop offset="0%" Â stop-color="#FFD766"/>
Â  Â  Â  Â  <stop offset="100%" stop-color="#FFC43D"/>
Â  Â  Â  </linearGradient>

Â  Â  Â  Â  Â  Â  <filter id="halo" x="-50%" y="-50%" width="200%" height="200%">
Â  Â  Â  Â  <feGaussianBlur in="SourceAlpha" stdDeviation="1.2" result="blur"/>
Â  Â  Â  Â  <feColorMatrix in="blur" type="matrix"
Â  Â  Â  Â  Â  values="0 0 0 0 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  0 0 0 0 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  0 0 0 0 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  0 0 0 .18 0" result="shadow"/>
Â  Â  Â  Â  <feMerge>
Â  Â  Â  Â  Â  <feMergeNode in="shadow"/>
Â  Â  Â  Â  Â  <feMergeNode in="SourceGraphic"/>
Â  Â  Â  Â  </feMerge>
Â  Â  Â  </filter>

Â  Â  Â  Â  Â  Â  Â  Â  Â  <symbol id="i-planta" viewBox="0 0 24 24" role="img" aria-label="Planta">
Â  Â  Â  Â  <circle cx="12" cy="12" r="12" fill="#fff"/>
Â  Â  Â  Â  <g filter="url(#halo)" fill="none" stroke="url(#g-mint)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  <circle cx="7" cy="6" r="1.6" fill="url(#g-mint)" stroke="none"/>
Â  Â  Â  Â  Â  <circle cx="13" cy="6" r="1.6" fill="url(#g-mint)" stroke="none"/>
Â  Â  Â  Â  Â  <path d="M7 7.6v2.6a3 3 0 0 0 6 0V7.6"/>
Â  Â  Â  Â  Â  <path d="M13 12a4.2 4.2 0 1 0 8.4 0"/>
Â  Â  Â  Â  Â  <circle cx="21.4" cy="12" r="1.6" fill="url(#g-mint)" stroke="none"/>
Â  Â  Â  Â  </g>
Â  Â  Â  </symbol>

Â  Â  Â  Â  Â  Â  <symbol id="i-tareas" viewBox="0 0 24 24" role="img" aria-label="Tareas">
Â  Â  Â  Â  <circle cx="12" cy="12" r="12" fill="#fff"/>
Â  Â  Â  Â  <g filter="url(#halo)">
Â  Â  Â  Â  Â  <path d="M6 6h9l3 3v9H6z" fill="url(#g-coral)"/>
Â  Â  Â  Â  Â  <path d="M15 6v3h3" fill="#fff" opacity=".35"/>
Â  Â  Â  Â  Â  <rect x="8" y="11" width="8" height="1.6" rx=".8" fill="#fff" opacity=".9"/>
Â  Â  Â  Â  Â  <rect x="8" y="14" width="6" height="1.6" rx=".8" fill="#fff" opacity=".9"/>
Â  Â  Â  Â  </g>
Â  Â  Â  </symbol>

Â  Â  Â  Â  Â  Â  <symbol id="i-directorio" viewBox="0 0 24 24" role="img" aria-label="Directorio">
Â  Â  Â  Â  <circle cx="12" cy="12" r="12" fill="#fff"/>
Â  Â  Â  Â  <g filter="url(#halo)">
Â  Â  Â  Â  Â  <rect x="6.2" y="6" width="11.6" height="12" rx="1.8" fill="url(#g-gold)"/>
Â  Â  Â  Â  Â  <rect x="8" y="9" width="8" height="1.4" rx=".7" fill="#fff" opacity=".92"/>
Â  Â  Â  Â  Â  <rect x="8" y="12" width="6.5" height="1.4" rx=".7" fill="#fff" opacity=".92"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M9 16c1.2 1.6 2.8 2.5 4.9 2.8c.7.1 1.3-.4 1.6-1l.4-.7a1 1 0 0 0-.3-1.3l-1-.7a1 1 0 0 0-1.2.1l-.5.4c-.9-.3-1.7-.8-2.3-1.5l.4-.5a1 1 0 0 0 .1-1.2l-.7-1a1 1 0 0 0-1.3-.3l-.7.4c-.6.3-1.1.9-1 1.6c.3 2 1.2 3.6 2.6 4.9z" fill="#fff" opacity=".95"/>
Â  Â  Â  Â  </g>
Â  Â  Â  </symbol>

Â  Â  Â  Â  Â  Â  <symbol id="i-biblioteca" viewBox="0 0 24 24" role="img" aria-label="Biblioteca">
Â  Â  Â  Â  <circle cx="12" cy="12" r="12" fill="#fff"/>
Â  Â  Â  Â  <g filter="url(#halo)">
Â  Â  Â  Â  Â  <rect x="5.8" y="7" width="3.6" height="10" rx="1" fill="url(#g-mint)"/>
Â  Â  Â  Â  Â  <rect x="10.2" y="6" width="3.6" height="12" rx="1" fill="url(#g-gold)"/>
Â  Â  Â  Â  Â  <rect x="14.6" y="8" width="3.6" height="9" rx="1" fill="url(#g-teal)"/>
Â  Â  Â  Â  Â  <rect x="6.6" y="9" width="2" height="1.4" rx=".7" fill="#fff" opacity=".85"/>
Â  Â  Â  Â  Â  <rect x="11" y="9" width="2" height="1.4" rx=".7" fill="#fff" opacity=".85"/>
Â  Â  Â  Â  Â  <rect x="15.4" y="10" width="2" height="1.4" rx=".7" fill="#fff" opacity=".85"/>
Â  Â  Â  Â  </g>
Â  Â  Â  </symbol>

Â  Â  Â  Â  Â  Â  <symbol id="i-emergencias" viewBox="0 0 24 24" role="img" aria-label="Emergencias">
Â  Â  Â  Â  <circle cx="12" cy="12" r="12" fill="#fff"/>
Â  Â  Â  Â  <g filter="url(#halo)" fill="url(#g-coral)">
Â  Â  Â  Â  Â  <path d="M12 5a3 3 0 0 0-3 3v1.2c0 .6-.3 1.1-.7 1.5A6 6 0 0 0 6 14h12a6 6 0 0 0-2.3-3.3c-.4-.4-.7-.9-.7-1.5V8a3 3 0 0 0-3-3z"/>
ciÂ  Â  Â  Â  <rect x="10" y="15" width="4" height="2" rx="1"/>
Â  Â  Â  Â  </g>
Â  Â  Â  </symbol>
Â  Â  </defs>
Â  </svg>

Â  <header class="appbar" role="banner">
Â  Â  <div class="container">
Â  Â  Â  <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>INFECCIOSAS</span>
Â  Â  Â  <h1 id="title">Planta Â· Tareas Â· Directorio</h1>
Â  Â  Â  <div class="grow"></div>

Â  Â  Â  <div class="statusRow" aria-live="polite">
Â  Â  Â  Â  <span id="badge-online" class="chip bad">Offline</span>
Â  Â  Â  Â  <span id="badge-auth" class="chip bad">Google: desconectado</span>
Â  Â  Â  </div>

Â  Â  Â  <div id="userGroup" class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
Â  Â  Â  Â  <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
Â  Â  Â  Â  Â  <img id="avatar" class="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-1)">
Â  Â  Â  Â  Â  <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
Â  Â  Â  Â  Â  <span id="notifBadge" class="chip" title="Tareas activas">0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="installBtn" class="btn ghost" aria-label="Instalar">â• Instalar</button>
Â  Â  Â  Â  <button id="signin"Â  class="btn primary">Acceder</button>
Â  Â  Â  Â  <button id="signout" class="btn hide">Salir</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <main class="container">
Â  Â  <div id="updateBanner" class="chip" style="display:none">Nueva versiÃ³n disponible. <button id="reloadNow" class="btn primary">Actualizar</button></div>
Â  Â  <div id="installBanner" class="chip" style="display:none">Instala la app para acceso mÃ¡s rÃ¡pido. <button id="installAction" class="btn primary">Instalar</button></div>

Â  Â  Â  Â  <section id="gate" class="card" role="region" aria-live="polite">
Â  Â  Â  <div class="card-h hdr-add"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
Â  Â  Â  Â  <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
Â  Â  Â  Â  <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="app" class="hide" aria-labelledby="tabsLabel">
Â  Â  Â  <div class="card" style="margin-bottom:12px">
Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
Â  Â  Â  Â  Â  <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
Â  Â  Â  Â  Â  Â  <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">
Â  Â  Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24"><use href="#i-planta"></use></svg>
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Planta
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">
Â  Â  Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24"><use href="#i-tareas"></use></svg>
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Tareas
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">
Â  Â  Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24"><use href="#i-directorio"></use></svg>
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Directorio
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-h hdr-planta"><h2>Ingresos & Interconsultas</h2><span class="subtitle">AÃ±adir y organizar</span></div>
Â  Â  Â  Â  Â  <div class="card-b grid g3" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
Â  Â  Â  Â  Â  Â  <div><label for="p-room">HabitaciÃ³n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
Â  Â  Â  Â  Â  Â  <div><label for="p-desc">DescripciÃ³n</label><input id="p-desc" placeholder="Resumen clÃ­nico, motivoâ€¦"></div>
Â  Â  Â  Â  Â  Â  <div style="align-self:end"><button id="p-add" class="btn primary">AÃ±adir</button></div>

Â  Â  Â  Â  Â  Â  <div class="g2" style="grid-column:1/-1;align-items:end;display:grid;gap:12px;grid-template-columns:1fr 1fr">
Â  Â  Â  Â  Â  Â  Â  <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, analÃ­ticaâ€¦ (opcional)"></div>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label>Grupo</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="segmented" role="group" aria-label="Grupo" style="display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:var(--shadow-1),var(--rim)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="p-group-planta" type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--mint-plate);border-color:color-mix(in oklab,var(--mint),transparent 60%)">Planta</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="p-group-inter"Â  type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--teal-plate);border-color:color-mix(in oklab,var(--teal),transparent 60%)">Interconsulta</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="addTarget" class="chip" aria-live="polite" style="margin-left:8px">AÃ±adiendo a: Planta</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-planta"><h2>Planta</h2><span id="p-count-planta" class="chip" aria-live="polite">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  Â  <ul id="p-list-planta" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-inter"><h2>Interconsultas</h2><span id="p-count-inter" class="chip" aria-live="polite">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  Â  <ul id="p-list-inter" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-planta"><h2>Completadas</h2><span id="p-done-count" class="chip" aria-live="polite">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b done-bg">
Â  Â  Â  Â  Â  Â  <ul id="p-done" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="p-done-empty" class="muted">Nada completado.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-h hdr-tareas"><h2>AÃ±adir tarea</h2><span class="subtitle" id="t-status">Fecha â†’ DescripciÃ³n</span></div>
Â  Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  Â  <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
Â  Â  Â  Â  Â  Â  Â  <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
Â  Â  Â  Â  Â  Â  Â  <div><label for="t-text">DescripciÃ³n</label><input id="t-text" type="text" placeholder="Describe la tareaâ€¦" maxlength="400"></div>
section Â  Â  Â  Â  Â  <div style="align-self:end"><button id="t-add" class="btn primary">AÃ±adir</button></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-coral"><h2 class="subtitle" style="color:#0c1825">Tareas activas</h2><span id="t-count" class="chip">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  Â  <ul id="t-list" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="t-empty" class="muted">No hay tareas activas.</p>
section Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-planta"><h2>Completadas</h2><span id="t-done-count" class="chip">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b done-bg">
Â  Â  Â  Â  Â  Â  <ul id="t-done" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-h hdr-inter"><h2>Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b">
Â  Â  Â  Â  Â  Â  <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
Â  Â  Â  Â  Â  Â  <ul id="t-trash" class="list"></ul>
Â  Â  Â  Â  Â  Â  <p id="t-trash-empty" class="muted">Papelera vacÃ­a.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-h hdr-dir"><h2>Directorio telefÃ³nico</h2><span id="d-count" class="chip">0</span></div>
Â  Â  Â  Â  Â  <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr auto">
Â  Â  Â  Â  Â  Â  <div><label for="d-q">BÃºsqueda inteligente</label><input id="d-q" type="search" placeholder="SecciÃ³n, nombre o extensiÃ³nâ€¦ (ej. cardio, uci, parada)"></div>
section Â  Â  Â  Â  Â  <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  Â  <button id="d-add" class="btn primary">AÃ±adir</button>
Â  Â  Â  Â  Â  Â  Â  <button id="d-import" class="btn">Importar JSON</button>
Â  Â  Â  Â  Â  Â  Â  <button id="d-export" class="btn">Exportar JSON</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="card-b"><ul id="d-list" class="list"></ul><p id="d-empty" class="muted">Sin registros.</p></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <nav class="bottom" aria-label="Secciones">
Â  Â  Â  Â  <div class="tabs-bottom">
Â  Â  Â  Â  Â  <button class="tab-bottom" id="b-planta" aria-selected="true">
Â  Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true"><svg width="24" height="24"><use href="#i-planta"></use></svg></span>
Â  Â  Â  Â  Â  Â  Planta
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button class="tab-bottom" id="b-tareas" aria-selected="false">
section Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true"><svg width="24" height="24"><use href="#i-tareas"></use></svg></span>
Â  Â  Â  Â  Â  Â  Tareas
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button class="tab-bottom" id="b-directorio" aria-selected="false">
Â  Â  Â  Â  Â  Â  <span class="icon-badge" aria-hidden="true"><svg width="24" height="24"><use href="#i-directorio"></use></svg></span>
Â  Â  Â  Â  Â  Â  Directorio
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </nav>
Â  Â  </section>
Â  </main>

Â  Â  <button id="fab" class="fab" aria-expanded="false" aria-controls="fabPanel">
Â  Â  <span class="icon-badge" aria-hidden="true">
Â  Â  Â  <svg width="24" height="24"><use href="#i-emergencias"></use></svg>
Â  Â  </span>
Â  Â  Emergencias
Â  </button>
Â  <div id="fabPanel" class="fab-panel" role="dialog" aria-label="NÃºmeros de emergencia">
Â  Â  <div class="toolbar" style="display:flex;align-items:center;gap:8px">
Â  Â  Â  <strong>Accesos rÃ¡pidos</strong>
Â  Â  Â  <button id="fabEdit" class="gear" title="Configurar"><svg class="ico"><use href="#ico-gear"/></svg></button>
Â  Â  </div>
Â  Â  <div id="fabList" style="margin-top:8px"></div>
Â  </div>

Â  Â  <dialog id="modal" class="modal" aria-modal="true">
Â  Â  <form id="modalForm" class="dialog" method="dialog">
Â  Â  Â  <h3 id="modalTitle" style="margin:0 0 8px 0">Editar</h3>
Â  Â  Â  <div id="modalBody" class="grid" style="grid-template-columns:1fr"></div>
section Â  Â  Â  <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
Â  Â  Â  Â  <button id="modalCancel" class="btn" value="cancel">Cancelar</button>
Â  Â  Â  Â  <button id="modalOk" class="btn primary" value="ok">Guardar</button>
Â  Â  Â  </div>
Â  Â  </form>
Â  </dialog>

Â  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

Â  <script type="module">
Â  Â  /* ==================== Utiles bÃ¡sicos ==================== */
Â  Â  const BASE = new URL('./', location).pathname;

Â  Â  const appModÂ  Â = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
Â  Â  const authModÂ  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
Â  Â  const fsModÂ  Â  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');

Â  Â  const { firebaseConfig } = await import(BASE + 'firebase-config.js');

Â  Â  const fbApp = appMod.initializeApp(firebaseConfig);
Â  Â  const authÂ  = authMod.getAuth(fbApp);
Â  Â  const dbÂ  Â  = fsMod.initializeFirestore(fbApp, {
Â  Â  Â  localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() })
section Â  });
Â  Â  const serverTS = fsMod.serverTimestamp;

Â  Â  const $ = (s, r=document)=>r.querySelector(s);
Â  Â  const todayISO = ()=> new Date().toISOString().slice(0,10);
Â  Â  const idle = (fn)=>('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0);
Â  Â  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.hidden=false; setTimeout(()=>t.hidden=true,2200); };
Â  Â  const esc = (s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
Â  Â  const pillForDate=(iso)=>{ try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,''); }catch{return iso} };

Â  Â  // Viewport fix (guard para no redeclarar)
Â  Â  if(!window.__APP_setVHVar){
Â  Â  Â  window.__APP_setVHVar=()=>{ document.documentElement.style.setProperty('--vh', `${Math.max(innerHeight,document.documentElement.clientHeight)*0.01}px`); };
Â  Â  Â  addEventListener('resize', __APP_setVHVar, {passive:true}); __APP_setVHVar();
Â  Â  }

Â  Â  function roomSortKey(s){
Â  Â  Â  if(!s) return Number.POSITIVE_INFINITY;
Â  Â  Â  const m = String(s).match(/\d+/g);
Â  Â  Â  if(!m) return Number.POSITIVE_INFINITY;
Â  Â  Â  const first = parseInt(m[0],10);
Â  Â  Â  const second = m[1] ? parseInt(m[1],10)/100 : 0;
Â  Â  Â  return first + second;
Â  Â  }

Â  Â  const setOnline=(on)=>{ const b=$('#badge-online'); b.textContent=on?'Online':'Offline'; b.className='chip '+(on?'ok':'bad'); };
Â  Â  setOnline(navigator.onLine);
Â  Â  addEventListener('online', ()=>setOnline(true), {passive:true});
Â  Â  addEventListener('offline',()=>setOnline(false), {passive:true});

Â  Â  const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
Â  Â  const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();

Â  Â  const doSignIn=async()=>{ try{
Â  Â  Â  if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider);
Â  Â  Â  else await authMod.signInWithPopup(auth,provider);
Â  Â  }catch(e){ $('#authErr').textContent=e.message||String(e); } };

Â  Â  $('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

Â  Â  authMod.onAuthStateChanged(auth, user=>{
Â  Â  Â  if(user){
Â  Â  Â  Â  badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
Â  Â  Â  Â  avatar.src=user.photoURL||''; displayname.textContent=user.displayName||user.email||''; userchip.classList.remove('hide');
Â  Â  Â  Â  $('#signout').classList.remove('hide'); $('#signin').classList.add('hide'); gate.classList.add('hide'); appUI.classList.remove('hide');
Â  Â  Â  Â  mountApp(user.uid);
Â  Â  Â  }else{
Â  Â  Â  Â  badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
section Â  Â  Â  Â  userchip.classList.add('hide'); $('#signout').classList.add('hide'); $('#signin').classList.remove('hide'); appUI.classList.add('hide'); gate.classList.remove('hide');
Â  Â  Â  Â  unmountApp();
Â  Â  Â  }
Â  Â  });

Â  Â  /* ==================== Datos ==================== */
Â  Â  const col = {
Â  Â  Â  plantaÂ  : (uid)=> fsMod.collection(db,'users',uid,'planta'),
Â  Â  Â  tareasÂ  : (uid)=> fsMod.collection(db,'users',uid,'tareas'),
Â  Â  Â  dirÂ  Â  Â : (uid)=> fsMod.collection(db,'users',uid,'directorio'),
Â  Â  };
Â  Â  let unsubs=[]; const currentUid=()=>auth.currentUser?.uid;
Â  Â  function unmountApp(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

Â  Â  /* ==================== Tabs ==================== */
Â  Â  const tabOrder=['planta','tareas','directorio'];
Â  Â  function setTabA11y(id){
Â  Â  Â  for(const k of tabOrder){
Â  Â  Â  Â  const sel = (k===id);
Â  Â  Â  Â  const el = document.getElementById('tab-'+k);
Â  Â  Â  Â  el.setAttribute('aria-selected', sel);
Â  Â  Â  Â  el.setAttribute('tabindex', sel ? '0' : '-1');
Â  Â  Â  }
Â  Â  }
Â  Â  function selectTab(id, focusPanel=false){
Â  Â  Â  const map={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio']};
Â  Â  Â  for(const k in map){ const [p,t,b,l]=map[k]; const sel=(k===id);
Â  Â  Â  Â  document.getElementById(p).classList.toggle('hide',!sel);
Â  Â  Â  Â  document.getElementById(t).setAttribute('aria-selected',sel);
Â  Â  Â  Â  document.getElementById(b).setAttribute('aria-selected',sel);
Â  Â  Â  Â  if(sel){ document.getElementById('title').textContent=l; localStorage.setItem('tab', k); if(focusPanel) document.getElementById(p).focus?.(); }
Â  Â  Â  }
Â  Â  Â  setTabA11y(id);
Â  Â  Â  location.hash = id;
Â  Â  }
Â  Â  document.getElementById('tab-planta').onclick =()=>selectTab('planta',true);
Â  Â  document.getElementById('tab-tareas').onclick =()=>selectTab('tareas',true);
Â  Â  document.getElementById('tab-directorio').onclick=()=>selectTab('directorio',true);
Â  Â  document.getElementById('b-planta').onclick =()=>selectTab('planta');
Â  Â  document.getElementById('b-tareas').onclick =()=>selectTab('tareas');
Â  Â  document.getElementById('b-directorio').onclick=()=>selectTab('directorio');

Â  Â  document.getElementById('tablist').addEventListener('keydown', (e)=>{
Â  Â  Â  const cur = tabOrder.findIndex(k => document.getElementById('tab-'+k).getAttribute('aria-selected')==='true');
Â  Â  Â  if(e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); const n=(cur+1)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
Â  Â  Â  if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); const n=(cur-1+tabOrder.length)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
Â  Â  Â  if(e.key==='Home'){ e.preventDefault(); document.getElementById('tab-'+tabOrder[0]).focus(); document.getElementById('tab-'+tabOrder[0]).click(); }
Â  Â  Â  if(e.key==='End'){ e.preventDefault(); document.getElementById('tab-'+tabOrder.at(-1)).focus(); document.getElementById('tab-'+tabOrder.at(-1)).click(); }
section Â  });

Â  Â  const setNotif = (n)=>{ const el=document.getElementById('notifBadge'); el.textContent=String(n); el.title=n?`${n} tareas activas`:'Sin avisos'; };

Â  Â  /* ==================== PLANTA ==================== */
Â  Â  let currentGroup='planta';
Â  Â  function updateAddTarget(){
Â  Â  Â  const t=document.getElementById('addTarget');
Â  Â  Â  if(currentGroup==='planta'){ t.textContent='AÃ±adiendo a: Planta'; }
Â  Â  Â  else { t.textContent='AÃ±adiendo a: Interconsulta'; }
Â  Â  }
Â  Â  document.getElementById('p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget();};
Â  Â  document.getElementById('p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget();};
Â  Â  updateAddTarget();

Â  Â  const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(),
Â  Â  Â  grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });

Â  Â  const btn = (t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.onclick=(e)=>{e.preventDefault(); fn?.(e)}; b.type='button'; return b;};

Â  Â  const docItemBase=(x,done=false)=>{
Â  Â  Â  const li=document.createElement('li'); li.className='item ' + (x.grupo==='interconsulta'?'ic':'pl');
Â  Â  Â  const roomClass = 'pill room ' + (x.grupo==='interconsulta'?'room-inter':'room-planta');
Â  Â  Â  li.innerHTML=`<span class="${roomClass}">${esc(x.room||'â€”')}</span>
Â  Â  Â  Â  <div class="text">${done?`<div class="line strike">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
Â  Â  Â  Â  ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
Â  Â  Â  Â  <div class="toolbar actions"></div>`;
Â  Â  Â  return li;
Â  Â  };

Â  Â  // Render item activo con botones: âœ“, âœ, â‡„ (toggle grupo), ğŸ—‘ï¸
Â  Â  const renderPlantaItem=(x)=>{
Â  Â  Â  const li=docItemBase(x);
Â  Â  Â  const a=li.querySelector('.actions');
Â  Â  Â  a.append(
Â  Â  Â  Â  btn('âœ“',()=>upd('planta',x.__id,{status:'done'}),'btn icon'),
Â  Â  Â  Â  btn('âœ',()=>editPlanta(x),'btn icon')
Â  Â  Â  );
Â  Â  Â  // Toggle Planta <-> Interconsulta
Â  Â  Â  const swap=btn('',async()=>{ const next = (x.grupo==='interconsulta')?'planta':'interconsulta'; await upd('planta',x.__id,{grupo:next}); },'btn icon');
Â  Â  Â  swap.innerHTML = `<svg class="ico"><use href="#ico-swap"/></svg>`;
Â  Â  Â  a.append(swap, btn('ğŸ—‘ï¸',()=>upd('planta',x.__id,{status:'trash'}),'btn icon'));
Â  Â  Â  return li;
Â  Â  };
Â  Â  const renderPlantaDone=(x)=>{const li=docItemBase(x,true); const a=li.querySelector('.actions');
Â  Â  Â  a.append(btn('â†©',()=>upd('planta',x.__id,{status:'active'}),'btn icon'),btn('âœ–',()=>del('planta',x.__id),'btn icon')); return li;};

Â  Â  const val=(id)=>document.getElementById(id)?.value||'';
Â  Â  const openEdit=(fields,onOk)=>{
Â  Â  Â  const body=document.getElementById('modalBody'); body.innerHTML='';
Â  Â  Â  for(const f of fields){ const w=document.createElement('div'); w.innerHTML=`<label for="${f.id}">${f.l}</label><input id="${f.id}" value="${esc(f.v||'')}">`; body.append(w);}
Â  Â  Â  const dlg=document.getElementById('modal'); document.getElementById('modalTitle').textContent='Editar'; document.getElementById('modalOk').textContent='Guardar'; document.getElementById('modalCancel').textContent='Cancelar';
Â  Â  Â  dlg.showModal(); dlg.setAttribute('aria-hidden','false');
Â  Â  Â  document.getElementById('modalOk').onclick=async e=>{e.preventDefault(); await onOk(); dlg.close();};
Â  Â  Â  document.getElementById('modalCancel').onclick=e=>{e.preventDefault(); dlg.close();};
Â  Â  Â  dlg.addEventListener('close',()=>dlg.setAttribute('aria-hidden','true'),{once:true});
Â  Â  };
Â  Â  const editPlanta=(x)=>openEdit(
Â  Â  Â  [{l:'HabitaciÃ³n',id:'p_room',v:x.room||''},{l:'DescripciÃ³n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}],
Â  Â  Â  async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')})
Â  Â  );

Â  Â  function setupPlanta(uid){
Â  Â  Â  document.getElementById('p-add').onclick=async()=>{
Â  Â  Â  Â  const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup});
Â  Â  Â  Â  if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(id=>document.getElementById(id).value='');
Â  Â  Â  };
Â  Â  Â  const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
Â  Â  Â  const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));

Â  Â  Â  const u1=fsMod.onSnapshot(qA,(s)=>{
Â  Â  Â  Â  const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x);});
Â  Â  Â  Â  const arrP = all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
Â  Â  Â  Â  const arrI = all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
Â  Â  Â  Â  const lp=document.getElementById('p-list-planta'), li=document.getElementById('p-list-inter'); lp.innerHTML=''; li.innerHTML='';
Â  Â  Â  Â  arrP.forEach(x=>lp.appendChild(renderPlantaItem(x)));
Â  Â  Â  Â  arrI.forEach(x=>li.appendChild(renderPlantaItem(x)));
section Â  Â  Â  Â  document.getElementById('p-empty-planta').style.display=arrP.length?'none':'block'; document.getElementById('p-empty-inter').style.display=arrI.length?'none':'block';
Â  Â  Â  Â  document.getElementById('p-count-planta').textContent=arrP.length; document.getElementById('p-count-inter').textContent=arrI.length;
Â  Â  Â  });

Â  Â  Â  const u2=fsMod.onSnapshot(qD,(s)=>{
Â  Â  Â  Â  const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
Â  Â  Â  Â  arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
Â  Â  Â  Â  const l=document.getElementById('p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(renderPlantaDone(x)));
Â  Â  Â  Â  document.getElementById('p-done-empty').style.display=arr.length?'none':'block'; document.getElementById('p-done-count').textContent=arr.length;
Â  Â  Â  });
Â  Â  Â  unsubs.push(u1,u2);
Â  Â  }

Â  Â  /* ==================== TAREAS ==================== */
Â  Â  const tareaDoc = (d)=>({ date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
Â  Â  function daysFromToday(iso){ try{ const d = new Date(iso+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch{return 0} }
Â  Â  function hueForDays(diff){ if(isNaN(diff)) return 205; if(diff <= -7) return 0; if(diff < 0) return 10; const max=30; return Math.round(10 + (Math.min(diff,max)/max)*120); }

Â  Â  function renderTareaItem(x){
Â  Â  Â  const diff = daysFromToday(x.date);
Â  Â  Â  const h = hueForDays(diff);
Â  Â  Â  const li=document.createElement('li'); li.className='item t-hue'; li.style.setProperty('--h', h);
Â  Â  Â  li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span>
Â  Â  Â  Â  <div class="text"><div class="line">${esc(x.text||'')}</div></div>
Â  Â  Â  Â  <div class="toolbar actions"></div>`;
Â  Â  Â  const a=li.querySelector('.actions');
Â  Â  Â  a.append(btn('âœ“',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'),btn('âœ',()=>editTarea(x),'btn icon'),btn('ğŸ—‘ï¸',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon'));
Â  Â  Â  return li;
Â  Â  }
Â  Â  function renderTareaDone(x){
Â  Â  Â  const li=document.createElement('li'); li.className='item'; li.style.borderLeft = `6px solid hsl(150 50% 38%)`;
Â  Â  Â  li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span>
Â  Â  Â  Â  <div class="text"><div class="line strike">${esc(x.text||'')}</div></div>
Â  Â  Â  Â  <div class="toolbar actions"></div>`;
Â  Â  Â  li.querySelector('.actions').append(btn('â†©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('âœ–',()=>del('tareas',x.__id),'btn icon'));
Â  Â  Â  return li;
Â  Â  }
Â  Â  function renderTareaTrash(x){
Â  Â  Â  const li=document.createElement('li'); li.className='item';
Â  Â  Â  li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span>
Â  Â  Â  Â  <div class="text muted"><div class="line">${esc(x.text||'')}</div></div>
Â  Â  Â  Â  <div class="toolbar actions"></div>`;
Â  Â  Â  li.querySelector('.actions').append(btn('â¤´',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('âœ–',()=>del('tareas',x.__id),'btn icon'));
Â  Â  Â  return li;
Â  Â  }
Â  Â  const editTarea=(x)=>openEdit(
Â  Â  Â  [{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'DescripciÃ³n',id:'t_text',v:x.text||''}],
Â  Â  Â  async()=>upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')})
Â  Â  );
Â  Â  function setupTareas(uid){
Â  Â  Â  document.getElementById('t-date').value=todayISO();
Â  Â  Â  document.getElementById('t-add').onclick=async ()=>{
Â  Â  Â  Â  const date=document.getElementById('t-date').value, text=document.getElementById('t-text').value.trim(); if(!text) return;
Â  Â  Â  Â  await fsMod.addDoc(col.tareas(uid), tareaDoc({date,text})); document.getElementById('t-text').value='';
Â  Â  Â  };
Â  Â  Â  const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
Â  Â  Â  const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
Â  Â  Â  const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

Â  Â  Â  const u1=fsMod.onSnapshot(qA,(snap)=>{
Â  Â  Â  Â  const arr=[]; snap.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
Â  Â  Â  Â  arr.sort((a,b)=> daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0) );
Â  Â  Â  Â  const list=document.getElementById('t-list'); list.innerHTML=''; let n=0;
Â  Â  Â  Â  idle(()=>{arr.forEach(x=>{list.appendChild(renderTareaItem(x)); n++;}); document.getElementById('t-count').textContent=n; document.getElementById('t-empty').style.display=n?'none':'block'; setNotif(n);});
section Â  Â  });
Â  Â  Â  const u2=fsMod.onSnapshot(qD,(s)=>{
Â  Â  Â  Â  const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
Â  Â  Â  Â  arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
Â  Â  Â  Â  const l=document.getElementById('t-done'); l.innerHTML=''; let n=0;
Â  G Â  Â  Â  idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaDone(x)); n++;}); document.getElementById('t-done-empty').style.display=n?'none':'block'; document.getElementById('t-done-count').textContent=n;});
Â  Â  Â  });
Â  Â  Â  const u3=fsMod.onSnapshot(qT,(s)=>{
Â  Â  Â  Â  const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
Â  Â  Â  Â  arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
Â  Â  Â  Â  const l=document.getElementById('t-trash'); l.innerHTML=''; let n=0;
Â  Â  Â  Â  idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaTrash(x)); n++;}); document.getElementById('t-trash-empty').style.display=n?'none':'block'; document.getElementById('t-trash-count').textContent=n;});
Â  Â  Â  });
Â  Â  Â  document.getElementById('t-emptyTrash').onclick=()=>emptyTrash(uid,'tareas');
Â  Â  Â  unsubs.push(u1,u2,u3);
Â  Â  }

Â  Â  /* ==================== DIRECTORIO ==================== */
Â  Â  const dirDoc=(d)=>({ seccion:String(d.seccion||'').trim()||'Sin secciÃ³n', nombre:String(d.nombre||'').trim()||'Sin nombre', telefono:String(d.telefono||'').trim(), notas:String(d.notas||'').trim(), createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
Â  Â  let dirCache=[];
Â  Â  function telHref(raw){ const s=String(raw||'').replace(/[^\d+]/g,''); return s?`tel:${s}`:null; }
Â  Â  function setupDirectorio(uid){
Â  Â  Â  document.getElementById('d-add').onclick=async()=>{
Â  Â  Â  Â  const d=dirDoc({seccion:prompt('SecciÃ³n')||'',nombre:prompt('Nombre')||'',telefono:prompt('TelÃ©fonos (formato libre)')||'',notas:''});
Â  Â  Â  Â  await fsMod.addDoc(col.dir(uid),d);
Â  Â  Â  };
Â  Â  Â  document.getElementById('d-import').onclick=importDir(uid); document.getElementById('d-export').onclick=exportDir(uid);
Â  Â  Â  const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{ dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderDirList(); });
Â  Â  Â  document.getElementById('d-q').addEventListener('input', renderDirList, {passive:true});
Â  Â  Â  unsubs.push(u);
Â  Â  }
Â  Â  function phonesToChips(raw){
Â  Â  Â  const parts = String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
Â  Â  Â  return parts.map(p=>{ const href = telHref(p); return href?`<a class="pill" href="${href}" dir="ltr">${esc(p)}</a>`:`<span class="pill" dir="ltr">${esc(p)}</span>`; }).join(' ');
Â  Â  }
Â  Â  function renderDirList(){
Â  Â  Â  const v=($('#d-q')?.value||'').toLowerCase(); const l=$('#d-list'); if(!l) return; l.innerHTML='';
Â  Â  Â  let arr=[...dirCache]; arr.sort((a,b)=> (a.seccion||'').localeCompare(b.seccion||'') || (a.nombre||'').localeCompare(b.nombre||''));
Â  Â  Â  let n=0; idle(()=>{Â 
Â  Â  Â  Â  let currentSec='';
Â  Â  Â  Â  arr.forEach(x=>{
Â  Â  Â  Â  Â  const match = !v || [x.seccion,x.nombre,String(x.telefono||''),x.notas].some(y=>String(y||'').toLowerCase().includes(v));
section Â  Â  Â  Â  Â  if(!match) return;
Â  Â  Â  Â  Â  if(x.seccion!==currentSec){
Â  Â  Â  Â  Â  Â  currentSec=x.seccion||'Sin secciÃ³n';
Â  Â  Â  Â  Â  Â  const hdr=document.createElement('div'); hdr.className='section-banner';Â 
Â  Â  Â  Â  Â  Â  const letter=(currentSec[0]||'Â¿').toUpperCase();
Â  Â  Â  Â  Â  Â  hdr.innerHTML=`<div style="display:flex;align-items:center;gap:10px">
Â  Â  Â  Â  Â  Â  Â  <span class="pill" style="font-size:18px;background:var(--gold-plate);border-color:color-mix(in oklab,var(--gold),transparent 60%)">${letter}</span>
Â  Â  Â  Â  Â  Â  Â  <strong>${esc(currentSec)}</strong>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  l.appendChild(hdr);
section Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const li=document.createElement('li'); li.className='item';
Â  Â  Â  Â  Â  li.innerHTML=`<div class="text"><div class="line"><strong>${esc(x.nombre||'')}</strong></div>
Â  Â  Â  Â  Â  Â  <div class="line">${phonesToChips(x.telefono)}</div>
Â  Â  Â  Â  Â  Â  ${x.notas?`<div class="muted">${esc(x.notas)}</div>`:''}</div>
Â  Â  Â  Â  Â  Â  <div class="toolbar actions"></div>`;
Â  Â  Â  Â  Â  li.querySelector('.actions').append(btn('âœ',()=>editDir(x),'btn icon'),btn('ğŸ—‘ï¸',()=>del('directorio',x.__id),'btn icon'));
Â  Â  Â  Â  Â  l.appendChild(li); n++;
Â  Â  Â  Â  });
Â  Â  Â  Â  $('#d-count').textContent=n+' registros'; $('#d-empty').style.display=n?'none':'block';
Â  Â  Â  });
Â  Â  }
Â  Â  const editDir=(x)=>openEdit(
Â  Â  Â  [{l:'SecciÃ³n',id:'d_sec',v:x.seccion||''},{l:'Nombre',id:'d_nom',v:x.nombre||''},{l:'TelÃ©fonos',id:'d_tel',v:x.telefono||''},{l:'Notas',id:'d_not',v:x.notas||''}],
Â  Â  Â  async()=>upd('directorio',x.__id,{seccion:val('d_sec'),nombre:val('d_nom'),telefono:val('d_tel'),notas:val('d_not')})
Â  Â  );
Â  Â  function importDir(uid){return async()=>{try{
Â  Â  Â  const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON invÃ¡lido');
Â  Â  Â  const snap=await fsMod.getDocs(col.dir(uid)); const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
Â  Â  Â  const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[]; for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); }
section Â  Â  Â  await Promise.all(ops); toast('Importado ('+ops.length+')');
Â  Â  }catch(e){ toast(e.message||String(e)); }}};
Â  Â  function exportDir(uid){return async()=>{const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado'); }};

Â  Â  /* ==================== Emergencias (localStorage) ==================== */
Â  Â  const defaultEmerg=[{n:'Parada',t:'2222'},{n:'UCI',t:'1234'},{n:'Seguridad',t:'091'},{n:'Jef. EnfermerÃ­a',t:'2345'}];
Â  Â  function loadEmerg(){ try{ const j=localStorage.getItem('emerg_nums'); if(!j) return defaultEmerg; const a=JSON.parse(j); return Array.isArray(a)&&a.length?a:defaultEmerg; }catch{return defaultEmerg} }
Â  Â  function saveEmerg(a){ localStorage.setItem('emerg_nums', JSON.stringify(a)); }
Â  Â  function renderFab(){
Â  Â  Â  const list=$('#fabList'); list.innerHTML=''; const arr=loadEmerg();
Â  Â  Â  arr.forEach((o,i)=>{
Â  Â  Â  Â  const row=document.createElement('div'); row.className='contact-chip';
Â  Â  Â  Â  const href = o.t.replace(/[^\d+]/g,''); row.innerHTML=`<strong>${esc(o.n)}</strong>
Â  Â  Â  Â  Â  <a class="btn" href="${href?('tel:'+href):'#'}" style="min-height:36px">${esc(o.t)}</a>`;
section Â  Â  Â  Â  list.appendChild(row);
Â  Â  Â  });
Â  Â  }
Â  Â  $('#fab').onclick=()=>{ const p=$('#fabPanel'); const open=p.hasAttribute('open'); if(open){p.removeAttribute('open'); $('#fab').setAttribute('aria-expanded','false');} else { renderFab(); p.setAttribute('open',''); $('#fab').setAttribute('aria-expanded','true'); } };
Â  Â  $('#fabEdit').onclick=()=>{ const arr=loadEmerg(); const body=$('#modalBody'); body.innerHTML='';
Â  Â  Â  arr.forEach((o,i)=>{ const w=document.createElement('div'); w.innerHTML=`<label>Nombre</label><input id="en_${i}_n" value="${esc(o.n)}"><label>TelÃ©fono</label><input id="en_${i}_t" value="${esc(o.t)}">`; body.append(w); });
Â  Â  Â  const add=document.createElement('button'); add.className='btn'; add.textContent='AÃ±adir fila'; add.onclick=(e)=>{e.preventDefault(); const i=body.querySelectorAll('input').length/2; const w=document.createElement('div'); w.innerHTML=`<label>Nombre</label><input id="en_${i}_n"><label>TelÃ©fono</label><input id="en_${i}_t">`; body.append(w); };
Â  Â  Â  body.append(add);
Â  Â  Â  const dlg=$('#modal'); $('#modalTitle').textContent='Editar emergencias'; $('#modalOk').textContent='Guardar'; $('#modalCancel').textContent='Cancelar';
Â  Â  Â  dlg.showModal(); dlg.setAttribute('aria-hidden','false');
Â  Â  Â  $('#modalOk').onclick=(e)=>{ e.preventDefault(); const out=[]; const inputs=[...body.querySelectorAll('input')];
Â  G Â  Â  Â  for(let i=0;i<inputs.length;i+=2){ const n=inputs[i].value.trim(); const t=inputs[i+1].value.trim(); if(n||t) out.push({n,t}); }
Â  Â  Â  Â  saveEmerg(out.length?out:defaultEmerg); dlg.close(); renderFab();
Â  Â  Â  };
Â  Â  Â  $('#modalCancel').onclick=(e)=>{e.preventDefault(); dlg.close();};
Â  Â  Â  dlg.addEventListener('close',()=>dlg.setAttribute('aria-hidden','true'),{once:true});
Â  Â  };

Â  Â  /* ==================== Mount ==================== */
Â  Â  function mountApp(uid){
Â  Â  Â  setupPlanta(uid); setupTareas(uid); setupDirectorio(uid);
Â  Â  Â  const last = location.hash?.slice(1) || localStorage.getItem('tab') || 'planta';
Â  Â  Â  selectTab(last);
Â  Â  }
Â  Â  async function upd(kind,id,patch){ const ref=fsMod.doc(db,'users',auth.currentUser?.uid,kind,id); await fsMod.updateDoc(ref,{...patch,updatedAt:serverTS()}); }
Â  Â  async function del(kind,id){ await fsMod.deleteDoc(fsMod.doc(db,'users',auth.currentUser?.uid,kind,id)); }
Â  Â  async function emptyTrash(uid,kind){ const q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada'); }

Â  Â  async function pickReadText(){ if('showOpenFilePicker' in window){ const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const f=await h.getFile(); return await f.text(); } return await new Promise((res,rej)=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); }; i.click(); }); }
Â  Â  async function pickWriteBlob(blob,name){ if('showSaveFilePicker' in window){ const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const w=await h.createWritable(); await w.write(blob); await w.close(); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

Â  Â  /* ==================== PWA banners & SW ==================== */
Â  Â  let deferredPrompt=null;
Â  Â  addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').style.display='inline-flex';});
Â  Â  $('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').style.display='none'; } };
Â  Â  $('#installBtn').onclick=()=>$('#installAction').click();

Â  Â  if('serviceWorker' in navigator){
Â  Â  Â  const reg=await navigator.serviceWorker.register(BASE+'sw.js');
sÂ  Â  Â  navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
Â  Â  Â  const showUpdate=()=>{$('#updateBanner').style.display='inline-flex'; $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'});};
Â  Â  Â  if(reg.waiting) showUpdate();
Â  Â  Â  reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
Â  Â  }

Â  Â  selectTab((location.hash?.slice(1)) || 'planta');
Â  </script>
</body>
</html>
