<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />
  <title>Infecciosas ‚Äî Planta ¬∑ Tareas ¬∑ Directorio</title>

  <!-- Rutas relativas: v√°lidas en ra√≠z o /Planta/ -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    /* ---------- Sistema crom√°tico (paleta + derivados) ---------- */
    :root{
      /* Paleta base (tu propuesta) */
      --c-cream:#F8FFE5;
      --c-mint:#06D6A0;
      --c-teal:#1B9AAA;
      --c-rose:#EF476F;
      --c-gold:#FFC43D;

      /* Neutros y tinta */
      --ink:#0b1220;             /* Texto principal (AAA sobre blanco) */
      --ink-2:#111827;           /* Titulares */
      --muted:#4b5563;           /* Texto secundario */
      --border:#e5e7eb;          /* Borde claro */
      --surface:#ffffff;         /* Tarjetas */
      --surface-2:#f8fafc;       /* Superficie suave */

      /* Gradientes de marca (degradados suaves con rim light) */
      --grad-brand:linear-gradient(120deg, color-mix(in oklab, var(--c-mint) 78%, white), color-mix(in oklab, var(--c-teal) 74%, white));
      --grad-planta:linear-gradient(120deg, color-mix(in oklab, var(--c-mint) 88%, white), color-mix(in oklab, var(--c-teal) 60%, white));
      --grad-tareas:linear-gradient(120deg, color-mix(in oklab, var(--c-rose) 82%, white), color-mix(in oklab, var(--c-gold) 62%, white));
      --grad-dir:linear-gradient(120deg, color-mix(in oklab, var(--c-teal) 72%, white), color-mix(in oklab, var(--c-mint) 62%, white));
      --grad-done:linear-gradient(120deg, color-mix(in oklab, var(--c-mint) 64%, white), color-mix(in oklab, #22c55e 42%, white));

      /* Brillos y rim-light */
      --rim:1px solid rgba(255,255,255,.65);
      --glow:0 12px 40px rgba(27,154,170,.18);
      --glow-soft:0 8px 28px rgba(2,6,23,.10);

      /* Tipograf√≠a y radios */
      --radius:16px; --radius-xl:22px; --touch:44px; --app-h:64px;

      /* Tabs inferiores */
      --tab-active: var(--grad-brand);
      --tab-inactive:#f1f5f9;

      /* Badges */
      --badge-bg:#0f172a; --badge-fg:#fff;
    }

    /* ---------- Reset & base ---------- */
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      color:var(--ink);
      background:#fff;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-size: clamp(15px, 0.88rem + 0.3vw, 18px);
      line-height: 1.62;
      min-height: 100dvh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
    }
    :focus-visible{ outline:3px solid color-mix(in oklab, var(--c-gold), var(--c-teal) 20%); outline-offset:2px; border-radius:10px }

    .container{ max-width:min(1160px,98vw); margin:0 auto; padding:8px clamp(12px,4vw,20px); container-type:inline-size }
    .hide{ display:none !important }
    .muted{ color:var(--muted) }

    /* ---------- Appbar ---------- */
    header.appbar{
      position:sticky; top:0; z-index:50; min-height:var(--app-h);
      background:
        radial-gradient(1200px 120px at 20% -40%, color-mix(in oklab, var(--c-cream) 60%, white), transparent 60%),
        linear-gradient(180deg,#ffffff 60%,#f5fbff 100%);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(1.05) blur(6px);
    }
    .appbar .container{ display:flex; align-items:center; gap:14px; flex-wrap:wrap }
    .brand-chip{
      display:inline-flex; align-items:center; gap:12px; padding:12px 18px; border-radius:999px;
      color:#072018; background-image:var(--grad-brand);
      border:var(--rim); box-shadow:var(--glow);
      font-weight:950; letter-spacing:.35px; text-transform:uppercase
    }
    .brand-dot{ width:10px;height:10px;border-radius:50%; background:var(--c-gold); box-shadow:0 0 0 2px rgba(0,0,0,.05) }
    h1{ margin:0; font-weight:900; letter-spacing:.2px; color:var(--ink-2); font-size: clamp(22px, 1.2rem + 0.9vw, 34px) }
    h2{ margin:0; font-size: clamp(18px, 1rem + 0.5vw, 22px); font-weight: 850 }

    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--surface-2); font-size:.84rem }
    .chip.ok{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0 }
    .chip.bad{ background:#fef2f2; color:#991b1b; border-color:#fecaca }

    .btn{ appearance:none; border:1px solid var(--border); background:#fff; color:var(--ink); padding:10px 12px; border-radius:12px; box-shadow:var(--glow-soft); min-height:var(--touch); min-width:44px; display:inline-flex; align-items:center; justify-content:center; gap:8px; cursor:pointer }
    .btn.primary{ background-image:var(--grad-brand); color:#082018; border-color:transparent }
    .btn.ghost{ background:transparent; border-color:transparent; box-shadow:none; color:color-mix(in oklab, var(--c-teal), black 18%) }
    .btn.icon{ min-width:var(--touch); aspect-ratio:1/1; padding:0 10px }

    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:1.6em; height:1.6em; padding:0 .5em; border-radius:999px; font-weight:800; background:var(--badge-bg); color:var(--badge-fg); box-shadow:0 0 0 1px rgba(0,0,0,.12), 0 6px 14px rgba(0,0,0,.15) }

    /* ---------- Tarjetas ---------- */
    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--glow-soft); overflow:hidden }
    .card-h{ position:relative; padding:14px 16px; border-radius:var(--radius-xl) var(--radius-xl) 0 0; color:#082018; display:flex; align-items:center; justify-content:space-between; gap:10px; text-shadow:0 1px 0 rgba(255,255,255,.6) }
    .card-b{ padding:12px }
    .hdr-brand{ background-image:var(--grad-brand); border-bottom:var(--rim) }
    .hdr-add{   background-image:var(--grad-brand) }
    .hdr-planta{background-image:var(--grad-planta)}
    .hdr-tareas{background-image:var(--grad-tareas)}
    .hdr-dir{   background-image:var(--grad-dir)}
    .hdr-done{  background-image:var(--grad-done)}

    /* ---------- Tabs superiores ---------- */
    .tabs{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
    .tab{ padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:var(--surface-2); cursor:pointer; font-weight:900; letter-spacing:.2px }
    #tab-planta[aria-selected="true"]{ background:color-mix(in oklab,#fff,var(--c-mint) 18%); border-color:color-mix(in oklab,var(--c-mint), transparent 70%) }
    #tab-tareas[aria-selected="true"]{ background:color-mix(in oklab,#fff,var(--c-rose) 18%); border-color:color-mix(in oklab,var(--c-rose), transparent 70%) }
    #tab-directorio[aria-selected="true"]{ background:color-mix(in oklab,#fff,var(--c-teal) 18%); border-color:color-mix(in oklab,var(--c-teal), transparent 70%) }

    /* ---------- P√≠ldoras y chips ---------- */
    .pill{ display:inline-flex; align-items:center; justify-content:center; font-weight:800; font-size:13px; padding:6px 10px; border-radius:10px; line-height:1; border:1px solid transparent; color:#082018; background:var(--surface-2) }
    .pill.room{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-weight:900; letter-spacing:.3px; font-size:clamp(18px,2.4vw,22px); padding:10px 14px; border-radius:12px; color:#07111f; box-shadow:inset 0 -1px 0 rgba(0,0,0,.06) }
    .pill.date{ background:color-mix(in oklab,#fff,var(--c-gold) 14%); border-color:color-mix(in oklab,var(--c-gold),#fff 60%) }
    .phone-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2f7; border:1px solid #d8e0ea; color:#0f172a; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-variant-numeric: tabular-nums; line-height:1.2; margin:2px 6px 2px 0; text-decoration:none }

    /* ---------- Listas ---------- */
    ul.list{ list-style:none; padding:0; margin:0; display:grid; gap:10px; content-visibility:auto; contain-intrinsic-size:600px }
    li.item{ display:grid; grid-template-columns:auto minmax(140px,1fr) auto; gap:12px; align-items:center; border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff }

    /* ---------- Directorio premium ---------- */
    .sec-group{ border:1px solid var(--border); border-radius:18px; overflow:hidden; background:#fff; box-shadow:var(--glow-soft) }
    .sec-head{
      display:flex; align-items:center; gap:12px; padding:14px 16px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--c-cream) 80%, #fff), #fff);
      border-bottom:1px solid var(--border);
    }
    .dropcap{
      width:40px; height:40px; border-radius:12px;
      background-image:var(--grad-dir); border:var(--rim); box-shadow:var(--glow);
      color:#072018; font-weight:950; display:grid; place-items:center; font-size:20px; letter-spacing:.5px;
      flex:0 0 auto;
    }
    .sec-title{ font-weight:900; color:var(--ink-2); letter-spacing:.2px; font-size: clamp(17px, 0.95rem + 0.5vw, 22px) }

    .c-row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:12px 16px; border-top:1px dashed color-mix(in oklab, var(--border), var(--c-teal) 16%) }
    .c-name{ font-weight:750 }
    .c-notes{ color:var(--muted) }

    /* ---------- B√∫squeda inteligente ---------- */
    .smart-search{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px;
      background:rgba(255,255,255,.45); border:var(--rim); box-shadow:var(--glow);
      backdrop-filter: blur(14px) saturate(1.1);
    }
    .smart-search input{
      width:100%; border:0; outline:0; background:transparent; color:var(--ink);
      font:inherit; min-height:var(--touch);
    }

    /* ---------- Navegaci√≥n inferior (icono + texto) ---------- */
    nav.bottom{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--border) }
    .tabs-bottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; align-items:center; padding:8px 12px; padding-bottom: calc(8px + env(safe-area-inset-bottom)) }
    .tab-bottom{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      padding:10px 8px; border-radius:16px; border:1px solid var(--border); background:var(--tab-inactive);
      cursor:pointer; font-weight:800; color:#0b1220;
    }
    .tab-bottom[aria-selected="true"]{
      background-image:var(--tab-active); color:#082018; border-color:transparent; box-shadow:var(--glow);
    }
    .tab-bottom svg{ width:22px; height:22px; fill:currentColor }

    /* ---------- FAB emergencias ---------- */
    .fab{
      position:fixed; right:16px; bottom: calc(16px + env(safe-area-inset-bottom));
      width:60px; height:60px; border-radius:20px; display:grid; place-items:center; cursor:pointer;
      background:linear-gradient(135deg, color-mix(in oklab, var(--c-rose) 90%, white), color-mix(in oklab, var(--c-gold) 40%, white));
      border:var(--rim); color:#fff; box-shadow:0 18px 50px rgba(239,71,111,.35); z-index:55;
    }
    .fab svg{ width:28px; height:28px; stroke:white; stroke-width:1.4; fill:none }

    /* ---------- Banners y utilidades ---------- */
    .banner{ display:none; margin:10px 0; padding:10px 12px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:12px }
    .banner[aria-hidden="false"]{ display:flex; gap:10px; align-items:center }
    #toast{ position:fixed; left:50%; bottom:calc(14px + env(safe-area-inset-bottom)); transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--glow); z-index:60 }
    #toast[hidden]{ display:none }

    /* ---------- Grids ---------- */
    .grid{ display:grid; gap:12px }
    .g3{ grid-template-columns:1fr 2fr auto }
    .g2{ grid-template-columns:1fr 1fr }
    @container (max-width:700px){ .g3,.g2{ grid-template-columns:1fr } }
    @media (max-width:680px){ .g3,.g2{ grid-template-columns:1fr } }

    @media (prefers-reduced-motion:reduce){ *{ scroll-behavior:auto!important; animation:none!important; transition:none!important } }
  </style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="container">
      <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>INFECCIOSAS</span>
      <h1 id="title">Planta ¬∑ Tareas ¬∑ Directorio</h1>
      <div class="grow" style="flex:1"></div>
      <div class="statusRow" aria-live="polite" style="display:flex;gap:8px;flex-wrap:wrap">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>
      <div id="userGroup" class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
          <img id="avatar" class="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--glow-soft)">
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
          <span id="notifBadge" class="badge" title="Notificaciones">0</span>
        </div>
        <button id="installBtn" class="btn ghost" aria-label="Instalar">‚ûï Instalar</button>
        <button id="signin"  class="btn primary">Acceder</button>
        <button id="signout" class="btn hide">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="updateBanner" class="banner" aria-hidden="true">
      Nueva versi√≥n disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
    </div>
    <div id="installBanner" class="banner" aria-hidden="true">
      Instala la app para acceso m√°s r√°pido. <button id="installAction" class="btn primary">Instalar</button>
    </div>

    <!-- Gate -->
    <section id="gate" class="card" role="region" aria-live="polite" style="margin-bottom:12px">
      <div class="card-h hdr-brand"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
      <div class="card-b">
        <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
        <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
        <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
      </div>
    </section>

    <!-- App UI -->
    <section id="app" class="hide" aria-labelledby="tabsLabel">
      <div class="card" style="margin-bottom:12px">
        <div class="card-b">
          <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
          <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
            <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">Planta</button>
            <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">Tareas</button>
            <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">Directorio</button>
          </div>
        </div>
      </div>

      <!-- PLANTA -->
      <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-add">
            <h2>A√±adir (Planta/Interconsulta)</h2>
            <span class="subtitle">Habitaci√≥n ¬∑ Descripci√≥n ¬∑ Pendientes</span>
          </div>
          <div class="card-b grid g3">
            <div><label for="p-room">Habitaci√≥n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
            <div><label for="p-desc">Descripci√≥n</label><input id="p-desc" placeholder="Resumen cl√≠nico, motivo‚Ä¶"></div>
            <div style="align-self:end"><button id="p-add" class="btn primary">A√±adir</button></div>

            <div class="g2" style="grid-column:1/-1;align-items:end">
              <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, anal√≠tica‚Ä¶ (opcional)"></div>
              <div>
                <label>Grupo</label>
                <div class="segmented" role="group" aria-label="Grupo" style="display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:var(--glow-soft)">
                  <button id="p-group-planta" type="button" class="active" aria-pressed="true" class="btn">Planta</button>
                  <button id="p-group-inter"  type="button" aria-pressed="false" class="btn ghost">Interconsulta</button>
                </div>
                <span id="addTarget" class="pill" aria-live="polite" style="margin-left:8px;font-weight:800">A√±adiendo a: Planta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-planta"><h2>Planta</h2><span id="p-count-planta" class="badge" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-planta" class="list"></ul>
            <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-planta"><h2>Interconsultas</h2><span id="p-count-inter" class="badge" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-inter" class="list"></ul>
            <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-done"><h2>Completadas</h2><span id="p-done-count" class="badge" aria-live="polite">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="p-done" class="list"></ul>
            <p id="p-done-empty" class="muted">Nada completado.</p>
          </div>
        </div>
      </div>

      <!-- TAREAS -->
      <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-add"><h2>A√±adir tarea</h2><span class="subtitle" id="t-status">Fecha ‚Üí Descripci√≥n</span></div>
          <div class="card-b">
            <div class="grid g3">
              <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
              <div><label for="t-text">Descripci√≥n</label><input id="t-text" type="text" placeholder="Describe la tarea‚Ä¶" maxlength="400"></div>
              <div style="align-self:end"><button id="t-add" class="btn primary">A√±adir</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-tareas"><h2>Tareas activas</h2><span id="t-count" class="badge">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#fff7ed,transparent)">
            <ul id="t-list" class="list"></ul>
            <p id="t-empty" class="muted">No hay tareas activas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-done"><h2>Completadas</h2><span id="t-done-count" class="badge">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="t-done" class="list"></ul>
            <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h" style="background-image:linear-gradient(120deg, color-mix(in oklab, var(--c-rose) 60%, white), color-mix(in oklab, var(--c-rose) 30%, white))">
            <h2>Papelera</h2><span id="t-trash-count" class="badge">0</span></div>
          <div class="card-b">
            <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
            <ul id="t-trash" class="list"></ul>
            <p id="t-trash-empty" class="muted">Papelera vac√≠a.</p>
          </div>
        </div>
      </div>

      <!-- DIRECTORIO -->
      <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1">
        <div class="card" style="margin-bottom:12px">
          <div class="card-h hdr-dir"><h2>Directorio telef√≥nico</h2><span id="d-count" class="badge">0</span></div>
          <div class="card-b grid g2">
            <div class="smart-search">
              <!-- Icono b√∫squeda -->
              <svg aria-hidden="true" viewBox="0 0 24 24" width="20" height="20"><path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm9.5 17.5L16 17" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
              <input id="d-q" type="search" placeholder="Secci√≥n, nombre o extensi√≥n‚Ä¶ (e.g., cardio, uci, parada)" autocomplete="off">
            </div>
            <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap">
              <button id="d-add" class="btn primary">A√±adir</button>
              <button id="d-import" class="btn">Importar JSON</button>
              <button id="d-export" class="btn">Exportar JSON</button>
            </div>
          </div>
        </div>

        <!-- Render din√°mico por grupos -->
        <div id="d-groups" class="grid" style="gap:14px"></div>
        <p id="d-empty" class="muted">Sin registros.</p>
      </div>

      <!-- Bottom tabs (icono + texto) -->
      <nav class="bottom" aria-label="Secciones">
        <div class="tabs-bottom">
          <button class="tab-bottom" id="b-planta" aria-selected="true" aria-label="Planta">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.5 4.5a4 4 0 1 1 7 2.5l2 3a3 3 0 0 1-5 3.5l-2-3A4 4 0 0 1 8.5 4.5Z"/></svg>
            <span>Planta</span>
          </button>
          <button class="tab-bottom" id="b-tareas" aria-selected="false" aria-label="Tareas">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 4h10M7 9h10M7 14h10M7 19h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            <span>Tareas</span>
          </button>
          <button class="tab-bottom" id="b-directorio" aria-selected="false" aria-label="Directorio">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h8a3 3 0 0 1 3 3v10H7a3 3 0 0 1-3-3V6Zm11 0h3a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2h-3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
            <span>Directorio</span>
          </button>
        </div>
      </nav>
    </section>
  </main>

  <!-- Modal edici√≥n (reutilizado) -->
  <dialog id="modal" class="hide" aria-modal="true"></dialog>

  <!-- Toast -->
  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- FAB Emergencias -->
  <button id="fab-emerg" class="fab" title="Emergencias" aria-label="Emergencias">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 6a6 6 0 0 1 6 6v3l1.5 2M6 15v-3a6 6 0 0 1 6-6" />
      <circle cx="12" cy="19" r="1.6" fill="white" stroke="none"/>
    </svg>
  </button>

  <script type="module">
    /* ========== Utilidades generales ========== */
    const BASE = new URL('./', location).pathname;

    // Evitar doble declaraci√≥n (soluci√≥n al error setVHVar)
    if(!window.__setVHVar){
      window.__setVHVar = function(){
        const vh = (window.visualViewport ? visualViewport.height : window.innerHeight) * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      };
      window.__setVHVar();
      addEventListener('resize', window.__setVHVar, {passive:true});
      addEventListener('orientationchange', window.__setVHVar, {passive:true});
    }

    const $ = (s, r=document)=>r.querySelector(s);
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.hidden=false; setTimeout(()=>t.hidden=true,2200); };
    const idle = (fn)=>('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0);
    const esc = (s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const norm = (s)=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

    const setOnline=(on)=>{ const b=$('#badge-online'); b.textContent=on?'Online':'Offline'; b.className='chip '+(on?'ok':'bad'); };
    setOnline(navigator.onLine);
    addEventListener('online', ()=>setOnline(true), {passive:true});
    addEventListener('offline',()=>setOnline(false), {passive:true});

    /* ========== Firebase (App/Auth/Firestore) ========== */
    const appMod   = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    const authMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
    const fsMod    = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
    const { firebaseConfig } = await import(BASE + 'firebase-config.js');

    const fbApp = appMod.initializeApp(firebaseConfig);
    const auth  = authMod.getAuth(fbApp);
    const db    = fsMod.initializeFirestore(fbApp, {
      localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() })
    });
    const serverTS = fsMod.serverTimestamp;

    const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
    const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();
    const doSignIn=async()=>{ try{
      if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider);
      else await authMod.signInWithPopup(auth,provider);
    }catch(e){ $('#authErr').textContent=e.message||String(e); } };

    $('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

    authMod.onAuthStateChanged(auth, user=>{
      if(user){
        badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
        avatar.src=user.photoURL||''; displayname.textContent=user.displayName||user.email||''; userchip.classList.remove('hide');
        $('#signout').classList.remove('hide'); $('#signin').classList.add('hide'); gate.classList.add('hide'); appUI.classList.remove('hide');
        mountApp(user.uid);
      }else{
        badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
        userchip.classList.add('hide'); $('#signout').classList.add('hide'); $('#signin').classList.remove('hide'); appUI.classList.add('hide'); gate.classList.remove('hide');
        unmountApp();
      }
    });

    /* ========== Colecciones y helpers ========== */
    const col = {
      planta  : (uid)=> fsMod.collection(db,'users',uid,'planta'),
      tareas  : (uid)=> fsMod.collection(db,'users',uid,'tareas'),
      dir     : (uid)=> fsMod.collection(db,'users',uid,'directorio'),
    };
    let unsubs=[]; const currentUid=()=>auth.currentUser?.uid;
    function unmountApp(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

    /* ========== Navegaci√≥n tabs (superior e inferior) ========== */
    const tabOrder=['planta','tareas','directorio'];
    function setTab(id, focus=false){
      const map={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio']};
      for(const k in map){ const [p,t,b,l]=map[k]; const sel=(k===id);
        document.getElementById(p).classList.toggle('hide',!sel);
        document.getElementById(t).setAttribute('aria-selected',sel);
        const bb=document.getElementById(b); bb.setAttribute('aria-selected',sel);
        if(sel){ $('#title').textContent=l; localStorage.setItem('tab', k); if(focus) document.getElementById(p).focus?.(); }
      }
      location.hash = id;
    }
    $('#tab-planta').onclick =()=>setTab('planta',true);
    $('#tab-tareas').onclick =()=>setTab('tareas',true);
    $('#tab-directorio').onclick=()=>setTab('directorio',true);
    $('#b-planta').onclick =()=>setTab('planta');
    $('#b-tareas').onclick =()=>setTab('tareas');
    $('#b-directorio').onclick=()=>setTab('directorio');

    $('#tablist').addEventListener('keydown', (e)=>{
      const cur = tabOrder.findIndex(k => document.getElementById('tab-'+k).getAttribute('aria-selected')==='true');
      if(e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); const n=(cur+1)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).click(); }
      if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); const n=(cur-1+tabOrder.length)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).click(); }
      if(e.key==='Home'){ e.preventDefault(); document.getElementById('tab-'+tabOrder[0]).click(); }
      if(e.key==='End'){ e.preventDefault(); document.getElementById('tab-'+tabOrder.at(-1)).click(); }
    });

    const setNotif = (n)=>{ const el=$('#notifBadge'); el.textContent=String(n); el.title=n?`${n} tareas activas`:'Sin avisos'; };

    /* ========== PLANTA ========== */
    let currentGroup='planta';
    const setTarget=()=>{ const t=$('#addTarget'); t.textContent = currentGroup==='planta' ? 'A√±adiendo a: Planta' : 'A√±adiendo a: Interconsulta'; };
    $('#p-group-planta').onclick=()=>{currentGroup='planta'; setTarget();};
    $('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; setTarget();};
    setTarget();

    const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(),
      grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });

    const btn = (t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.onclick=(e)=>{e.preventDefault(); fn?.(e)}; b.type='button'; return b;};

    const docItemBase=(x,done=false)=>{
      const li=document.createElement('li'); li.className='item ' + (x.grupo==='interconsulta'?'ic':'pl');
      const roomClass = 'pill room ' + (x.grupo==='interconsulta'?'inter':'planta');
      li.innerHTML=`<span class="${roomClass}">${esc(x.room||'‚Äî')}</span>
        <div class="text">${done?`<div class="line" style="text-decoration:line-through;opacity:.9">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
        ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
        <div class="toolbar actions"></div>`;
      return li;
    };
    const renderPlantaItem=(x)=>{const li=docItemBase(x); const a=li.querySelector('.actions');
      a.append(btn('‚úì',()=>upd('planta',x.__id,{status:'done'}),'btn icon'),btn('‚úé',()=>editPlanta(x),'btn icon'),btn('üóëÔ∏è',()=>upd('planta',x.__id,{status:'trash'}),'btn icon')); return li;};
    const renderPlantaDone=(x)=>{const li=docItemBase(x,true); const a=li.querySelector('.actions');
      a.append(btn('‚Ü©',()=>upd('planta',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('planta',x.__id),'btn icon')); return li;};

    const openEdit=(fields,onOk)=>{
      const dlg=$('#modal'); dlg.classList.remove('hide');
      dlg.innerHTML=`<form method="dialog" class="dialog" style="background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--glow);padding:16px;width:min(560px,92vw)">
        <h3 style="margin:0 0 8px 0">Editar</h3>
        <div class="grid" style="grid-template-columns:1fr">${fields.map(f=>`<div><label for="${esc(f.id)}">${esc(f.l)}</label><input id="${esc(f.id)}" value="${esc(f.v||'')}"></div>`).join('')}</div>
        <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="modalCancel" class="btn" value="cancel">Cancelar</button>
          <button id="modalOk" class="btn primary" value="ok">Guardar</button>
        </div>
      </form>`;
      dlg.showModal();
      $('#modalOk').onclick=e=>{e.preventDefault(); onOk().then(()=>dlg.close());};
      $('#modalCancel').onclick=e=>{e.preventDefault(); dlg.close();};
      dlg.addEventListener('close',()=>dlg.classList.add('hide'),{once:true});
    };
    const val=(id)=>document.getElementById(id)?.value||'';
    const editPlanta=(x)=>openEdit(
      [{l:'Habitaci√≥n',id:'p_room',v:x.room||''},{l:'Descripci√≥n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}],
      async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')})
    );

    function setupPlanta(uid){
      $('#p-add').onclick=async()=>{
        const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup});
        if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(id=>document.getElementById(id).value='');
      };
      const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
      const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));

      const u1=fsMod.onSnapshot(qA,(s)=>{
        const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x);});
        const arrP = all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=> (String(a.room||'')).localeCompare(String(b.room||''), 'es', {numeric:true}));
        const arrI = all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=> (String(a.room||'')).localeCompare(String(b.room||''), 'es', {numeric:true}));
        const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
        arrP.forEach(x=>lp.appendChild(renderPlantaItem(x)));
        arrI.forEach(x=>li.appendChild(renderPlantaItem(x)));
        $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
        $('#p-count-planta').textContent=arrP.length; $('#p-count-inter').textContent=arrI.length;
      });

      const u2=fsMod.onSnapshot(qD,(s)=>{
        const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
        const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(renderPlantaDone(x)));
        $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=arr.length;
      });
      unsubs.push(u1,u2);
    }

    /* ========== TAREAS (gradiente de urgencia) ========== */
    const tareaDoc = (d)=>({ date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
    const daysFromToday=(iso)=>{ try{ const d = new Date(iso+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch{return 0} };
    const hueForDays=(diff)=>{ if(isNaN(diff)) return 205; if(diff <= -7) return 0; if(diff < 0) return 10; const max=30; return Math.round(10 + (Math.min(diff,max)/max)*120); };
    const renderTareaItem=(x)=>{
      const diff = daysFromToday(x.date), h = hueForDays(diff);
      const li=document.createElement('li'); li.className='item';
      li.style.borderLeft = `6px solid hsl(${h} 72% 46%)`;
      li.innerHTML=`<span class="pill date" style="background:hsl(${h} 90% 92%);border-color:hsl(${h} 70% 72%)">${new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(new Date(x.date+'T00:00:00')).toUpperCase().replace(/\./g,'')}</span>
        <div class="text"><div class="line">${esc(x.text||'')}</div></div>
        <div class="toolbar actions"></div>`;
      const a=li.querySelector('.actions');
      a.append(btn('‚úì',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'),btn('‚úé',()=>editTarea(x),'btn icon'),btn('üóëÔ∏è',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon'));
      return li;
    };
    const renderTareaDone=(x)=>{
      const li=document.createElement('li'); li.className='item';
      li.style.borderLeft = `6px solid hsl(150 50% 38%)`;
      li.innerHTML=`<span class="pill date">${new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(new Date(x.date+'T00:00:00')).toUpperCase().replace(/\./g,'')}</span>
        <div class="text"><div class="line" style="text-decoration:line-through;opacity:.9">${esc(x.text||'')}</div></div>
        <div class="toolbar actions"></div>`;
      li.querySelector('.actions').append(btn('‚Ü©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
      return li;
    };
    const renderTareaTrash=(x)=>{
      const li=document.createElement('li'); li.className='item';
      li.innerHTML=`<span class="pill date">${new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(new Date(x.date+'T00:00:00')).toUpperCase().replace(/\./g,'')}</span>
        <div class="text muted"><div class="line">${esc(x.text||'')}</div></div>
        <div class="toolbar actions"></div>`;
      li.querySelector('.actions').append(btn('‚§¥',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
      return li;
    };
    const editTarea=(x)=>openEdit(
      [{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'Descripci√≥n',id:'t_text',v:x.text||''}],
      async()=>upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')})
    );
    function setupTareas(uid){
      $('#t-date').value=todayISO();
      $('#t-add').onclick=async ()=>{
        const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return;
        await fsMod.addDoc(col.tareas(uid), tareaDoc({date,text})); $('#t-text').value='';
      };
      const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
      const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
      const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

      const u1=fsMod.onSnapshot(qA,(snap)=>{
        const arr=[]; snap.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0) );
        const list=$('#t-list'); list.innerHTML=''; let n=0;
        idle(()=>{arr.forEach(x=>{list.appendChild(renderTareaItem(x)); n++;}); $('#t-count').textContent=n; $('#t-empty').style.display=n?'none':'block'; setNotif(n);});
      });
      const u2=fsMod.onSnapshot(qD,(s)=>{
        const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
        const l=$('#t-done'); l.innerHTML=''; let n=0;
        idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaDone(x)); n++;}); $('#t-done-empty').style.display=n?'none':'block'; $('#t-done-count').textContent=n;});
      });
      const u3=fsMod.onSnapshot(qT,(s)=>{
        const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
        const l=$('#t-trash'); l.innerHTML=''; let n=0;
        idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaTrash(x)); n++;}); $('#t-trash-empty').style.display=n?'none':'block'; $('#t-trash-count').textContent=n;});
      });
      $('#t-emptyTrash').onclick=()=>emptyTrash(uid,'tareas');
      unsubs.push(u1,u2,u3);
    }

    /* ========== DIRECTORIO (agrupado premium + b√∫squeda inteligente) ========== */
    const dirDoc=(d)=>({ seccion:String(d.seccion||'').trim()||'Sin secci√≥n', nombre:String(d.nombre||'').trim()||'Sin nombre', telefono:String(d.telefono||'').trim(), notas:String(d.notas||'').trim(), createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
    let dirCache=[];
    const ALIAS = {
      cardio:['cardiologia','cardiolog√≠a','cardio'],
      uci:['cuidados intensivos','reanimacion','reanimaci√≥n','uci'],
      parada:['rcp','codigo','c√≥digo','emergencias','parada','paro'],
      urg:['urg','urgencias'],
      micro:['microbiologia','microbiolog√≠a','lab']
    };
    const phonesToChips=(raw)=>{
      const parts = String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
      return parts.map(p=>`<span class="phone-chip" dir="ltr">${esc(p)}</span>`).join(' ');
    };
    const renderGroups=(q='')=>{
      const v=norm(q); const root=$('#d-groups'); root.innerHTML='';
      if(!dirCache.length){ $('#d-empty').style.display='block'; return; }
      $('#d-empty').style.display='none';

      // Construir alias ampliados para b√∫squeda
      const expand = (t)=>{ const w=norm(t).split(/\s+/).filter(Boolean); let bag=[...w]; for(const k in ALIAS){ if(w.some(x=>ALIAS[k].includes(x))) bag.push(k); } return bag.join(' '); };

      // Filtrar y agrupar
      const filtered = dirCache.filter(x=>{
        if(!v) return true;
        const hay = [x.seccion,x.nombre,String(x.telefono||''),x.notas].map(y=>norm(String(y||''))).join(' ');
        return hay.includes(v) || norm(expand(hay)).includes(v);
      });

      const groups = new Map();
      filtered.forEach(x=>{
        const s = String(x.seccion||'Sin secci√≥n').trim();
        if(!groups.has(s)) groups.set(s,[]);
        groups.get(s).push(x);
      });

      // Ordenar por secci√≥n A‚ÜíZ y contactos por nombre
      const ordered = [...groups.entries()].sort((a,b)=> a[0].localeCompare(b[0],'es'));
      let total=0;

      for(const [sec, list] of ordered){
        list.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'','es'));
        total += list.length;

        const g=document.createElement('div'); g.className='sec-group';
        const firstLetter = (sec||'')[0]?.toUpperCase() || '¬∑';
        g.innerHTML=`
          <div class="sec-head">
            <div class="dropcap" aria-hidden="true">${esc(firstLetter)}</div>
            <div class="sec-title">${esc(sec)} <span class="muted">(${list.length})</span></div>
          </div>
          <div class="sec-body"></div>`;
        const body = g.querySelector('.sec-body');

        list.forEach(x=>{
          const row=document.createElement('div'); row.className='c-row';
          row.innerHTML=`
            <div>
              <div class="c-name">${esc(x.nombre||'')}</div>
              ${x.notas?`<div class="c-notes">${esc(x.notas)}</div>`:''}
            </div>
            <div class="phones">${phonesToChips(x.telefono)}</div>`;
          body.appendChild(row);
        });

        root.appendChild(g);
      }
      $('#d-count').textContent=total;
    };

    function importDir(uid){return async()=>{try{
      const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido');
      const snap=await fsMod.getDocs(col.dir(uid)); const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
      const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[]; for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); }
      await Promise.all(ops); toast('Importado ('+ops.length+')');
    }catch(e){ toast(e.message||String(e)); }}};
    function exportDir(uid){return async()=>{const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado'); }};

    function setupDirectorio(uid){
      $('#d-add').onclick=async()=>{
        const d=dirDoc({seccion:prompt('Secci√≥n')||'',nombre:prompt('Nombre')||'',telefono:prompt('Tel√©fonos (formato libre)')||'',notas:''});
        await fsMod.addDoc(col.dir(uid),d);
      };
      $('#d-import').onclick=importDir(uid); $('#d-export').onclick=exportDir(uid);
      const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{ dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderGroups($('#d-q').value||''); });
      $('#d-q').addEventListener('input', (e)=>renderGroups(e.target.value), {passive:true});
      unsubs.push(u);
    }

    /* ========== Emergencias (FAB) ========== */
    function emergCandidates(){
      const keys=['parada','codigo','c√≥digo','emergencias','seguridad','jefe','uci','urgencias'];
      const arr = dirCache.filter(x=>{
        const h = norm([x.seccion,x.nombre,x.notas].join(' '));
        return keys.some(k=>h.includes(k));
      });
      // Prioriza "parada" y "seguridad"
      arr.sort((a,b)=> (norm(a.seccion).includes('parada')?-1:0) - (norm(b.seccion).includes('parada')?-1:0));
      return arr.slice(0,6);
    }
    $('#fab-emerg').onclick=()=>{
      const list = emergCandidates();
      const dlg=$('#modal'); dlg.classList.remove('hide');
      dlg.innerHTML=`<form method="dialog" class="dialog" style="background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--glow);padding:16px;width:min(560px,92vw)">
        <h3 style="margin:0 0 12px 0">Emergencias</h3>
        <div class="grid" style="gap:10px">
          ${
            list.length ? list.map(x=>
              `<div class="c-row" style="border:1px solid var(--border);border-radius:12px">
                <div><div class="c-name">${esc(x.seccion)} ‚Äî ${esc(x.nombre||'')}</div>${x.notas?`<div class="c-notes">${esc(x.notas)}</div>`:''}</div>
                <div>${phonesToChips(x.telefono)}</div>
              </div>`
            ).join('') : `<p class="muted">Configura tus emergencias a√±adiendo entradas con secciones como ‚ÄúParada‚Äù, ‚ÄúSeguridad‚Äù, ‚ÄúUCI‚Äù‚Ä¶</p>`
          }
        </div>
        <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn primary" value="ok">Cerrar</button>
        </div>
      </form>`;
      dlg.showModal();
      dlg.addEventListener('close',()=>dlg.classList.add('hide'),{once:true});
    };

    /* ========== Montaje general ========== */
    function mountApp(uid){
      setupPlanta(uid); setupTareas(uid); setupDirectorio(uid);
      const last = location.hash?.slice(1) || localStorage.getItem('tab') || 'planta';
      setTab(last);
    }
    async function upd(kind,id,patch){ const ref=fsMod.doc(db,'users',auth.currentUser?.uid,kind,id); await fsMod.updateDoc(ref,{...patch,updatedAt:serverTS()}); }
    async function del(kind,id){ await fsMod.deleteDoc(fsMod.doc(db,'users',auth.currentUser?.uid,kind,id)); }
    async function emptyTrash(uid,kind){ const q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada'); }

    async function pickReadText(){ if('showOpenFilePicker' in window){ const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const f=await h.getFile(); return await f.text(); } return await new Promise((res,rej)=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); }; i.click(); }); }
    async function pickWriteBlob(blob,name){ if('showSaveFilePicker' in window){ const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const w=await h.createWritable(); await w.write(blob); await w.close(); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

    /* ========== PWA (install + SW actualizable) ========== */
    let deferredPrompt=null;
    addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').setAttribute('aria-hidden','false');});
    $('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').setAttribute('aria-hidden','true'); } };
    $('#installBtn').onclick=()=>$('#installAction').click();

    if('serviceWorker' in navigator){
      const reg=await navigator.serviceWorker.register(BASE+'sw.js');
      navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
      const showUpdate=()=>{$('#updateBanner').setAttribute('aria-hidden','false'); $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'});};
      if(reg.waiting) showUpdate();
      reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
    }

    setTab((location.hash?.slice(1)) || 'planta');
  </script>
</body>
</html>
