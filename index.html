const SCOPE = self.registration.scope; // e.g. https://usuario.github.io/Planta/
const CACHE = 'planta-v5';
const PRECACHE_URLS = [
  '', 'index.html','manifest.webmanifest',
  'icons/icon-192.png','icons/icon-512.png','icons/maskable192.png','icons/maskable512.png'
].map(p => new URL(p, SCOPE).toString());

self.addEventListener('install', event => {
  event.waitUntil((async ()=>{
    const cache = await caches.open(CACHE);
    for (const url of PRECACHE_URLS) { try{ await cache.add(url); }catch(e){ /* ignora 404 */ } }
    await self.skipWaiting();
  })());
});

self.addEventListener('activate', event => {
  event.waitUntil((async ()=>{
    const keys = await caches.keys();
    await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
    await self.clients.claim();
  })());
});

self.addEventListener('fetch', event => {
  const {request} = event;
  if(request.method!=='GET') return;
  event.respondWith((async ()=>{
    const cache = await caches.open(CACHE);
    const cached = await cache.match(request);
    if (cached) return cached;
    try{
      const resp = await fetch(request);
      if (resp.ok && new URL(request.url).origin === new URL(SCOPE).origin) cache.put(request, resp.clone());
      return resp;
    }catch{
      return cached || Response.error();
    }
  })());
});

self.addEventListener('message', e=>{ if(e.data?.type==='SKIP_WAITING') self.skipWaiting(); });
