<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#FFFFFF" />
  <meta name="color-scheme" content="light" />
  <!-- CSP b√°sica: permite inline JS mediante nonce, estilos inline para CSS cr√≠tico -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https://lh3.googleusercontent.com https://*.googleusercontent.com;
                 font-src 'self' data:;
                 script-src 'self' https://www.gstatic.com https://www.googleapis.com 'nonce-pwa-idx';
                 connect-src 'self' https://firestore.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com https://www.googleapis.com;
                 object-src 'none'; base-uri 'self'; form-action 'self'">
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <title>Planta ‚Äî Hub PWA</title>
  <style>
    /* ============ Tokens One UI 8 ============ */
    :root{
      --bg:#ffffff; --surface:#ffffff; --surface-subtle:#f5f7fa;
      --ink:#0a0a0a; --muted:#475569;
      --accent:#0EA5E9; --accent-2:#22C55E; --accent-3:#F59E0B;
      --danger:#B91C1C; --ok:#065F46; --warn:#9A3412;
      --r-lg:20px; --r-md:16px; --r-sm:12px;
      --shadow:0 8px 24px rgba(2,6,23,.08);
      --shadow-sm:0 4px 12px rgba(2,6,23,.06);
      --tap:48px;
      --pad:clamp(14px,2vw,20px);
      --gap:clamp(10px,1.6vw,16px);
    }
    html,body{height:100%}
    body{
      margin:0;
      font: clamp(14px, 1.6vw, 16px)/1.55 ui-sans-serif, system-ui, "Segoe UI", Roboto, Helvetica, Arial;
      color:var(--ink); background:var(--bg);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; touch-action:manipulation;
    }
    .container{max-width:1100px;margin:0 auto;padding:var(--pad);container-type:inline-size}
    .grid{display:grid;gap:var(--gap)}
    a{color:inherit;text-decoration:none}
    /* Skip link */
    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{position:fixed;left:16px;top:16px;width:auto;height:auto;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;z-index:1000}
    /* Focus */
    :focus-visible{outline:3px solid color-mix(in oklab, var(--accent) 65%, white); outline-offset:2px; border-radius:12px}
    /* Header */
    header.appbar{
      position:sticky;top:0;z-index:50;
      background:color-mix(in oklab,#fff 90%, transparent);
      backdrop-filter:saturate(1.05) blur(8px);
      border-bottom:1px solid rgba(2,6,23,.06);
      padding-top:env(safe-area-inset-top);
    }
    .row{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
    .logo{width:44px;height:44px;border-radius:14px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.9), var(--shadow-sm);
      background:conic-gradient(from 210deg at 50% 50%, #9BD6F5, #6ECFF3, #0EA5E9, #0891B2, #9BD6F5)}
    .brand h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(18px,2.2cqi,22px)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;
      border:1px solid rgba(2,6,23,.08);padding:6px 10px;font-size:.82rem;background:#f3f4f6;color:#0a0a0a}
    .online{background:#DCFCE7;color:var(--ok);border-color:rgba(16,185,129,.25)}
    .offline{background:#FEE2E2;color:#991B1B;border-color:rgba(239,68,68,.25)}
    .userchip{display:flex;align-items:center;gap:8px}
    .userchip img{width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-sm)}
    /* Buttons */
    button{appearance:none;border:0;cursor:pointer;min-height:var(--tap);
      border-radius:14px;padding:12px clamp(12px,2cqi,16px);font:inherit;letter-spacing:.2px;
      background:#eef2ff;color:#1e3a8a;box-shadow:var(--shadow-sm);display:inline-flex;gap:10px;align-items:center;transition:transform .06s, box-shadow .18s}
    button.primary{background:linear-gradient(135deg,var(--accent), #0284C7); color:#fff; box-shadow:0 14px 28px rgba(2,132,199,.28)}
    button.ghost{background:transparent;box-shadow:none;color:#0a0a0a}
    button:active{transform:translateY(1px) scale(.995)}
    button[disabled]{opacity:.55;filter:grayscale(.2);cursor:not-allowed;box-shadow:none}
    /* Cards */
    .card{background:var(--surface);border-radius:var(--r-lg);box-shadow:var(--shadow);padding:var(--pad);container-type:inline-size}
    .card h2{margin:0 0 6px 0;font-size:1.1rem}
    .stat{display:flex;align-items:baseline;gap:8px}
    .stat .num{font-weight:900;font-size:clamp(22px,4cqi,28px)}
    .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;border:1px solid rgba(2,6,23,.08);background:#F8FAFC;font-size:.9rem}
    .chip.info{background:#E0F2FE;color:#0C4A6E;border-color:rgba(14,165,233,.25)}
    .chip.warn{background:#FEF3C7;color:#92400E;border-color:rgba(245,158,11,.25)}
    .chip.ok{background:#DCFCE7;color:#065F46;border-color:rgba(16,185,129,.25)}
    /* Banners */
    .banner{display:none;padding:12px;border-radius:16px;border:1px dashed rgba(2,6,23,.12);background:#F0F6FF}
    .banner[aria-hidden="false"]{display:block}
    /* List mini */
    ul.list{list-style:none;margin:8px 0 0 0;padding:0;display:grid;gap:8px}
    .item{display:flex;gap:10px;align-items:center}
    .date{min-width:max(64px,12cqi);font-weight:700;background:#eef2ff;color:#1e3a8a;border-radius:10px;padding:6px 8px;text-align:center}
    .text{flex:1;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;line-clamp:2}
    /* Search compact */
    .search{display:flex;gap:8px;align-items:center}
    .search input{flex:1;border:1px solid rgba(2,6,23,.08);border-radius:12px;padding:10px 12px;background:#F8FAFC;outline:0}
    .search input::placeholder{color:#94a3b8}
    .search input:focus{outline:3px solid color-mix(in oklab, var(--accent) 35%, white);outline-offset:2px}
    /* Layout responsive con container queries */
    .cards{display:grid;gap:var(--gap)}
    @container (min-width: 640px){ .cards{grid-template-columns: 1fr 1fr} }
    @container (min-width: 960px){ .cards{grid-template-columns: 1fr 1fr 1fr} }
    /* Toast + Modal */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:14px;box-shadow:var(--shadow);max-width:92vw}
    .toast[hidden]{display:none}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.35)}
    .modal[aria-hidden="false"]{display:grid}
    .dialog{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:560px;width:calc(100% - 32px)}
    .dialog h3{margin:0 0 8px 0}
    .dialog .row{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    textarea.conf{width:100%;min-height:180px;border:1px solid rgba(2,6,23,.1);border-radius:12px;padding:10px 12px;background:#F8FAFC;outline:0;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas}
    textarea.conf:focus{outline:3px solid color-mix(in oklab, var(--accent) 35%, white);outline-offset:2px}
    /* Footer */
    footer{color:#64748b;font-size:.9rem}
    footer a{color:#0369a1;text-decoration:underline}
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){ *{transition:none!important; animation-duration:.001s!important} }
  </style>
</head>
<body>
  <a href="#main" class="skip">Saltar al contenido principal</a>

  <!-- ===== APP BAR ===== -->
  <header class="appbar">
    <div class="container row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Planta ‚Äî Hub</h1>
          <div class="badges">
            <div id="badge-online" class="badge offline" aria-live="polite">Sin conexi√≥n</div>
            <div id="badge-auth" class="badge offline" aria-live="polite">Google: desconectado</div>
            <div id="badge-sync" class="badge" title="Estado de sincronizaci√≥n">√öltima sincronizaci√≥n: ‚Äî</div>
          </div>
          <div id="authHint" style="font-size:.82rem;color:#6B7280;margin-top:6px"></div>
        </div>
      </div>
      <div class="userchip" id="userchip" hidden>
        <img id="avatar" alt="" referrerpolicy="no-referrer" />
        <span id="displayname" style="font-weight:600;max-width:32ch;white-space:nowrap;text-overflow:ellipsis;overflow:hidden"></span>
      </div>
      <div class="actions" style="display:flex;gap:10px">
        <button id="installBtn" class="ghost" aria-hidden="true" hidden>‚ûï Instalar app</button>
        <button id="settingsBtn" class="ghost" title="Ajustes">‚öôÔ∏è Ajustes</button>
        <button id="signin" class="primary">Acceder con Google</button>
        <button id="signout" class="ghost" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- ===== MAIN ===== -->
  <main id="main" class="container grid" style="margin-top:var(--gap)">
    <div id="installBanner" class="banner" aria-hidden="true">
      <b>Instala la app</b> para acceso m√°s r√°pido. <button id="installAction" class="primary" style="margin-left:8px">Instalar</button>
    </div>
    <div id="updateBanner" class="banner" aria-hidden="true" aria-live="polite">
      <b>Nueva versi√≥n disponible.</b> <button id="reloadNow" class="primary" style="margin-left:8px">Actualizar</button>
    </div>
    <div id="offlineBanner" class="banner" aria-hidden="true" aria-live="polite">
      <b>Modo sin conexi√≥n.</b> Algunas cifras pueden ser locales (pendiente de sincronizaci√≥n).
    </div>

    <!-- Gate de autenticaci√≥n -->
    <section id="authGate" class="card" role="region" aria-live="polite" style="text-align:center">
      <h2>Bienvenido</h2>
      <p style="margin-top:4px;color:#667085">Accede con Google para sincronizar entre Android y PC.</p>
      <button id="signin2" class="primary">Acceder con Google</button>
      <div id="authErr" style="color:var(--danger);margin-top:12px;min-height:1.2em"></div>
    </section>

    <!-- UI principal -->
    <section id="ui" class="grid" hidden>
      <div class="cards">
        <!-- Planta -->
        <article class="card" role="region" aria-labelledby="planta-title">
          <h2 id="planta-title">Planta</h2>
          <div class="stat"><span class="num" id="count-planta">‚Äî</span><span>habitaciones activas</span></div>
          <p style="margin:.5rem 0 0;color:#64748b">Gestor de habitaciones y pendientes en curso.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
            <a href="./Planta.html"><button class="primary">Abrir Planta</button></a>
            <button id="syncPlanta" title="Forzar sincronizaci√≥n">üîÑ Forzar sincronizaci√≥n</button>
          </div>
        </article>

        <!-- Tareas -->
        <article class="card" role="region" aria-labelledby="tareas-title">
          <h2 id="tareas-title">Tareas</h2>
          <div class="stat"><span class="num" id="count-hoy">‚Äî</span><span>tareas para hoy</span></div>
          <div class="chip info" id="hoyChip" aria-hidden="true" hidden>Hoy: <span id="hoyLabel">‚Äî</span></div>
          <ul class="list" id="next-list" aria-label="Pr√≥ximas tareas (3)">
            <!-- Items din√°micos -->
          </ul>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
            <a href="./Tareas.html"><button class="primary">Abrir Tareas</button></a>
            <button id="syncTareas" title="Forzar sincronizaci√≥n">üîÑ Forzar sincronizaci√≥n</button>
          </div>
        </article>

        <!-- Directorio -->
        <article class="card" role="region" aria-labelledby="dir-title">
          <h2 id="dir-title">Directorio</h2>
          <p style="margin:.25rem 0;color:#64748b">B√∫squeda r√°pida (nombre, extensi√≥n, unidad).</p>
          <form id="dirSearch" class="search" role="search" aria-label="Buscar en Directorio">
            <input id="q" type="search" placeholder="Buscar‚Ä¶ (p. ej., microbiolog√≠a)" autocomplete="off" />
            <button type="submit">üîç Buscar</button>
          </form>
          <div style="margin-top:10px">
            <a href="./Directorio.html"><button class="primary">Abrir Directorio</button></a>
          </div>
        </article>
      </div>

      <!-- Estado/Sincronizaci√≥n -->
      <section class="card" role="region" aria-labelledby="sync-title">
        <h2 id="sync-title">Estado de sincronizaci√≥n</h2>
        <div class="badges" style="margin-top:6px">
          <div class="badge" id="syncStamp">√öltima sincronizaci√≥n: ‚Äî</div>
          <div class="badge" id="dataMode">Origen datos: ‚Äî</div>
        </div>
      </section>

      <footer class="grid" style="margin-top:4px">
        <div class="card" style="padding:12px">
          <small>¬© 2025 ¬∑ Unidad de Enfermedades Infecciosas ‚Äî Hub PWA. <a href="#" id="privacyLink">Privacidad</a> ¬∑ <a href="#" id="aboutLink">Acerca de</a></small>
        </div>
      </footer>
    </section>
  </main>

  <!-- ===== MODAL AJUSTES ===== -->
  <div id="settingsModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="dialog">
      <h3>Ajustes</h3>
      <p style="margin:.25rem 0;color:#64748b">Configura Firebase y utilidades. La hora usa <b>Europe/Madrid</b> (24h).</p>
      <label for="cfg" style="font-weight:600;display:block;margin:.5rem 0 .25rem">Configuraci√≥n Firebase (JSON)</label>
      <textarea id="cfg" class="conf" spellcheck="false" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "appId": "..."
}'></textarea>
      <div class="row">
        <button id="testCfg">Probar conexi√≥n</button>
        <button id="saveCfg" class="primary">Guardar y reiniciar</button>
      </div>
      <hr style="margin:16px 0;border:0;border-top:1px solid rgba(2,6,23,.08)">
      <div class="row" style="justify-content:space-between">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="clearCache" title="Limpiar cach√© SW y almacenamiento local">üßπ Limpiar cach√©</button>
          <button id="closeSettings">Cerrar</button>
        </div>
        <button id="logout" class="ghost" style="color:#B91C1C">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden></div>

  <!-- ===== APP LOGIC ===== -->
  <script type="module" nonce="pwa-idx">
    /* =================== Utils =================== */
    const TZ = 'Europe/Madrid';
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const fmtDate = (d, opts={}) => new Intl.DateTimeFormat('es-ES', { timeZone:TZ, ...opts }).format(d);
    const todayISO = () => {
      const d = new Date();
      const tz = new Intl.DateTimeFormat('en-CA', { timeZone:TZ, year:'numeric', month:'2-digit', day:'2-digit' }).format(d); // YYYY-MM-DD
      return tz;
    };
    const nowHHMM = () => new Intl.DateTimeFormat('es-ES',{timeZone:TZ,hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date());
    const show = (el, v=true)=> el?.setAttribute('aria-hidden', v ? 'false':'true');
    const hide = (el)=> el?.setAttribute('aria-hidden','true');
    const toast = $('#toast');
    const showToast = (msg)=>{ toast.textContent=msg; toast.hidden=false; setTimeout(()=>toast.hidden=true, 3600); };

    // Online badge
    const badgeOnline = $('#badge-online'), offlineBanner = $('#offlineBanner');
    function setOnline(){
      const on = navigator.onLine;
      badgeOnline.textContent = on ? 'En l√≠nea' : 'Sin conexi√≥n';
      badgeOnline.classList.toggle('online', on);
      badgeOnline.classList.toggle('offline', !on);
      (on ? hide : show)(offlineBanner, true);
    }
    addEventListener('online', setOnline); addEventListener('offline', setOnline); setOnline();

    // Install handling
    let deferredPrompt = null;
    const installBtn = $('#installBtn'); const installBanner = $('#installBanner');
    addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.hidden=false; show(installBanner,true); });
    const doInstall = async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
      installBtn.hidden=true; hide(installBanner);
    };
    installBtn.addEventListener('click', doInstall);
    $('#installAction').addEventListener('click', doInstall);
    // Hide CTA in standalone
    const isStandalone = matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isStandalone) { installBtn.hidden = true; hide(installBanner); }

    // Service Worker updates
    const updateBanner = $('#updateBanner');
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope:'./' }).then(async reg=>{
        try{ await reg.update(); }catch{}
        const notify = (sw)=>{ if (sw && sw.state==='installed' && navigator.serviceWorker.controller) show(updateBanner,true); };
        if(reg.waiting) notify(reg.waiting);
        reg.addEventListener('updatefound', ()=>{ const sw=reg.installing; sw?.addEventListener('statechange', ()=>notify(sw)); });
      }).catch(console.error);
      navigator.serviceWorker.addEventListener('controllerchange', ()=>location.reload());
    }
    $('#reloadNow').addEventListener('click', async ()=>{
      const reg = await navigator.serviceWorker.getRegistration();
      reg?.waiting?.postMessage({ type:'SKIP_WAITING' });
    });

    // Settings modal
    const settingsModal = $('#settingsModal');
    const openSettings = ()=>settingsModal.setAttribute('aria-hidden','false');
    const closeSettings = ()=>settingsModal.setAttribute('aria-hidden','true');
    $('#settingsBtn').addEventListener('click', openSettings);
    $('#closeSettings').addEventListener('click', closeSettings);

    // Local storage helpers
    const LS = {
      cfg: 'pwa.firebaseConfig',
      cacheCounts: 'pwa.cache.counts',
      mode: 'pwa.data.mode' // 'cloud' | 'local'
    };
    const readCfg = ()=> {
      try{ return JSON.parse(localStorage.getItem(LS.cfg) || '{}'); }catch{ return {}; }
    };
    const writeCfg = (obj)=> localStorage.setItem(LS.cfg, JSON.stringify(obj));

    // Fill settings textarea with current cfg
    const cfgTA = $('#cfg'); cfgTA.value = JSON.stringify(readCfg(), null, 2);

    // Connectivity/sync badges
    const badgeAuth = $('#badge-auth'), badgeSync = $('#badge-sync');
    const syncStamp = $('#syncStamp'), dataMode = $('#dataMode');
    const setSyncStamp = (hhmm = nowHHMM())=>{
      badgeSync.textContent = `√öltima sincronizaci√≥n: ${hhmm}`;
      syncStamp.textContent = `√öltima sincronizaci√≥n: ${hhmm}`;
    };
    const setDataMode = (mode)=>{ dataMode.textContent = `Origen datos: ${mode === 'cloud' ? 'Firestore' : 'Local'}`; localStorage.setItem(LS.mode, mode); };

    // Directorio quick search
    $('#dirSearch').addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = $('#q').value.trim();
      const url = new URL('./Directorio.html', location.href);
      if (q) url.searchParams.set('q', q);
      location.href = url.toString();
    });

    /* =================== Firebase Init =================== */
    let appMod, authMod, fsMod, app, auth, db;
    let GoogleAuthProvider, getAuth, setPersistence, browserLocalPersistence,
        signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut, useDeviceLanguage;
    let getFirestore, enableIndexedDbPersistence, serverTimestamp,
        collection, addDoc, doc, getDoc, getDocs, onSnapshot, query, where, orderBy, limit, writeBatch;

    const authGate = $('#authGate'), ui = $('#ui');
    const signInBtn = $('#signin'), signOutBtn = $('#signout'), signIn2 = $('#signin2');
    const userchip = $('#userchip'), avatar = $('#avatar'), displayname = $('#displayname');
    const authErr = $('#authErr'), authHint = $('#authHint');

    async function initFirebase(){
      // Load config from Settings (localStorage)
      const cfg = readCfg();
      if (!cfg || !cfg.apiKey) {
        openSettings();
        authHint.textContent = 'Introduce la configuraci√≥n de Firebase (Authentication: Google habilitado y dominio autorizado).';
        return;
      }
      [appMod, authMod, fsMod] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'),
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js')
      ]);
      app = appMod.initializeApp(cfg);

      ({ getAuth, GoogleAuthProvider, setPersistence, browserLocalPersistence,
         signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut, useDeviceLanguage } = authMod);
      auth = getAuth(app); try{ useDeviceLanguage(auth); }catch{}
      await setPersistence(auth, browserLocalPersistence).catch(()=>{});

      ({ getFirestore, enableIndexedDbPersistence, serverTimestamp,
         collection, addDoc, doc, getDoc, getDocs, onSnapshot, query, where, orderBy, limit, writeBatch } = fsMod);
      db = getFirestore(app);
      try{ await enableIndexedDbPersistence(db, { synchronizeTabs:true }); }catch(e){ console.warn('IndexedDB no disponible', e?.code||e); }

      try{ const res = await getRedirectResult(auth); if(res?.user) console.info('Redirect OK', res.user.email); }catch(e){ authErr.textContent = e?.message || e?.code || 'Error post-redirect'; }

      wireAuth();
    }

    function setAuthBadge(connected){
      badgeAuth.textContent = connected ? 'Google: conectado' : 'Google: desconectado';
      badgeAuth.classList.toggle('online', connected);
      badgeAuth.classList.toggle('offline', !connected);
      if (!connected) { setDataMode('local'); }
    }

    function wireAuth(){
      const doSignin = async ()=>{
        authErr.textContent = '';
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt:'select_account' });
        try{
          try{ await signInWithPopup(auth, provider); }
          catch(e){ console.warn('Popup fall√≥, uso redirect', e?.code||e?.message); await signInWithRedirect(auth, provider); }
        }catch(err){
          const msg = (err?.message||err?.code)||'Error de acceso';
          authErr.textContent = msg;
          if (String(msg).includes('unauthorized-domain')) {
            authHint.textContent = 'Firebase ‚Üí Authentication ‚Üí Authorized domains: a√±ade tu dominio (p.ej., crasasito.github.io).';
          }
        }
      };
      signInBtn.addEventListener('click', doSignin);
      signIn2.addEventListener('click', doSignin);

      $('#logout').addEventListener('click', async ()=>{ try{ await signOut(auth); closeSettings(); }catch{} });
      signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });

      onAuthStateChanged(auth, (user)=>{
        const connected = !!user;
        setAuthBadge(connected);
        if (!connected){
          ui.hidden = true; authGate.hidden = false;
          signInBtn.style.display=''; signOutBtn.style.display='none';
          userchip.hidden = true; avatar.src=''; displayname.textContent='';
          return;
        }
        // Connected
        authGate.hidden = true; ui.hidden = false;
        signInBtn.style.display='none'; signOutBtn.style.display='';
        userchip.hidden = false; avatar.src = user.photoURL||''; displayname.textContent = user.displayName||user.email||'';
        setDataMode('cloud');
        subscribeCounters(user.uid).catch(e=>{ console.error(e); fallbackLocal(); });
      });
    }

    /* =================== Counters & Mini-list =================== */
    const elPlanta = $('#count-planta');
    const elHoy = $('#count-hoy');
    const nextList = $('#next-list');
    const hoyChip = $('#hoyChip'), hoyLabel = $('#hoyLabel');

    let unsubPlanta = null, unsubHoy = null, unsubNext = null;

    const colUser = (uid, coll)=> collection(db, 'users', uid, coll);

    function renderNext(items){
      const frag = document.createDocumentFragment();
      items.forEach(it=>{
        const li = document.createElement('li'); li.className='item';
        const d = document.createElement('div'); d.className='date'; d.textContent = it.fecha?.slice(5) || '‚Äî'; // MM-DD
        const t = document.createElement('div'); t.className='text'; t.textContent = it.descripcion || it.titulo || '(tarea)';
        li.append(d,t); frag.appendChild(li);
      });
      requestAnimationFrame(()=> nextList.replaceChildren(frag));
    }

    async function subscribeCounters(uid){
      unsubPlanta?.(); unsubHoy?.(); unsubNext?.();

      // Planta: contar documentos en 'planta' (habitaciones activas)
      unsubPlanta = onSnapshot(colUser(uid, 'planta'), snap=>{
        elPlanta.textContent = String(snap.size ?? '0');
        setSyncStamp();
        cacheCounts({ planta: snap.size });
      }, err=>{
        console.warn('Snapshot planta fall√≥:', err?.code||err?.message);
        const cached = readCounts(); elPlanta.textContent = cached.planta ?? '‚Äî';
      });

      // Tareas (colecci√≥n 'tareas' esperada con campo 'fecha' = 'YYYY-MM-DD')
      const isoToday = todayISO(); hoyLabel.textContent = isoToday; hoyChip.hidden=false; hoyChip.setAttribute('aria-hidden','false');

      // Conteo hoy
      try{
        const qHoy = query(colUser(uid, 'tareas'), where('fecha','==', isoToday));
        unsubHoy = onSnapshot(qHoy, snap=>{
          elHoy.textContent = String(snap.size ?? '0'); setSyncStamp(); cacheCounts({ hoy: snap.size });
        }, err=>{ console.warn('Snapshot hoy:', err?.code||err?.message); const c=readCounts(); elHoy.textContent = c.hoy ?? '‚Äî'; });
      }catch(e){
        console.warn('Query por fecha requiere √≠ndice; fallback getDocs', e?.code||e);
        const docs = await getDocs(colUser(uid,'tareas')).catch(()=>null);
        const count = docs ? docs.docs.filter(d=> (d.data().fecha===isoToday)).length : 0;
        elHoy.textContent = String(count); setSyncStamp(); cacheCounts({ hoy: count });
      }

      // Pr√≥ximas 3 tareas a partir de hoy (si existe 'fecha')
      try{
        const qNext = query(colUser(uid,'tareas'), orderBy('fecha','asc'), limit(6));
        unsubNext = onSnapshot(qNext, snap=>{
          const items = snap.docs.map(d=>d.data()).filter(x=>!!x.fecha).filter(x=>x.fecha >= isoToday).slice(0,3);
          renderNext(items); setSyncStamp(); cacheCounts({ next: items });
        }, err=>{ console.warn('Snapshot next:', err?.code||err?.message); const c=readCounts(); renderNext(c.next || []); });
      }catch(e){
        console.warn('Query pr√≥ximas requiere √≠ndice; fallback local');
        const docs = await getDocs(colUser(uid,'tareas')).catch(()=>null);
        const items = docs ? docs.docs.map(d=>d.data()).filter(x=>!!x.fecha).sort((a,b)=>String(a.fecha).localeCompare(String(b.fecha))).filter(x=>x.fecha>=isoToday).slice(0,3) : [];
        renderNext(items); setSyncStamp(); cacheCounts({ next: items });
      }
    }

    // Cache local para fallback (cifras del hub)
    function readCounts(){
      try{ return JSON.parse(localStorage.getItem(LS.cacheCounts) || '{}'); }catch{ return {}; }
    }
    function cacheCounts(partial){
      const current = readCounts();
      const merged = { ...current, ...partial, stamp: nowHHMM() };
      localStorage.setItem(LS.cacheCounts, JSON.stringify(merged));
      setDataMode('cloud'); setSyncStamp(merged.stamp);
    }
    function fallbackLocal(){
      const c = readCounts();
      if (c.planta!=null) elPlanta.textContent = String(c.planta);
      if (c.hoy!=null) elHoy.textContent = String(c.hoy);
      if (Array.isArray(c.next)) renderNext(c.next);
      setDataMode('local'); setSyncStamp(c.stamp || '‚Äî');
    }

    // Forzar sincronizaci√≥n (golpe de red m√≠nimo)
    async function forceSync(which){
      try{
        // Trae una muestra de la colecci√≥n para refrescar cach√© de red
        const uid = auth?.currentUser?.uid; if(!uid) throw new Error('Sin usuario');
        const coll = which === 'planta' ? 'planta' : 'tareas';
        await getDocs(query(colUser(uid, coll), limit(1)));
        setSyncStamp();
        showToast('Sincronizaci√≥n solicitada');
      }catch(e){
        console.warn('forceSync', e); showToast('No se pudo forzar la sincronizaci√≥n');
      }
    }
    $('#syncPlanta').addEventListener('click', ()=>forceSync('planta'));
    $('#syncTareas').addEventListener('click', ()=>forceSync('tareas'));

    /* =================== Settings actions =================== */
    $('#saveCfg').addEventListener('click', ()=>{
      try{
        const obj = JSON.parse(cfgTA.value || '{}');
        if (!obj.apiKey || !obj.projectId) throw new Error('Faltan campos (apiKey, projectId, ‚Ä¶)');
        writeCfg(obj); showToast('Configuraci√≥n guardada. Recargando‚Ä¶'); setTimeout(()=>location.reload(), 500);
      }catch(e){ showToast('JSON inv√°lido: ' + (e?.message||e)); }
    });
    $('#testCfg').addEventListener('click', async ()=>{
      try{
        const obj = JSON.parse(cfgTA.value || '{}'); if(!obj.apiKey) throw new Error('Completa el JSON');
        // Prueba m√≠nima: inicializar app temporal y obtener fecha de servidor como ping
        const { initializeApp, deleteApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
        const { getFirestore, doc, getDoc, serverTimestamp, setDoc } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
        const temp = initializeApp(obj, 'test-' + Math.random().toString(36).slice(2));
        const dbt = getFirestore(temp);
        const pingRef = doc(dbt, '_meta', 'ping');
        await setDoc(pingRef, { ping: serverTimestamp() }, { merge:true });
        const snap = await getDoc(pingRef);
        await deleteApp(temp);
        showToast(snap.exists() ? 'Conexi√≥n OK ‚úÖ' : 'Conexi√≥n dudosa');
      }catch(e){ console.error(e); showToast('Fallo de conexi√≥n: ' + (e?.code||e?.message||e)); }
    });

    // Limpiar cach√© SW + storage local
    $('#clearCache').addEventListener('click', async ()=>{
      try{
        if ('serviceWorker' in navigator){
          const reg = await navigator.serviceWorker.getRegistration();
          reg?.active?.postMessage({ type:'clearCache' });
        }
        const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k)));
        localStorage.removeItem(LS.cacheCounts);
        showToast('Cach√© limpiada');
      }catch(e){ showToast('No se pudo limpiar la cach√©'); }
    });

    // Enlaces est√°ticos
    $('#privacyLink').addEventListener('click',(e)=>{ e.preventDefault(); alert('Privacidad: datos locales + Firestore asociados a tu cuenta.'); });
    $('#aboutLink').addEventListener('click',(e)=>{ e.preventDefault(); alert('Hub PWA de Planta ¬∑ One UI 8 ¬∑ 2025'); });

    // Arranque
    initFirebase().catch(e=>{ console.error(e); openSettings(); });

  </script>
</body>
</html>
