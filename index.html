<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="description" content="Planta ‚Äî Gestor de planta e interconsultas. Sincroniza en tiempo real con Firestore, funciona offline y se instala como PWA." />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <title>Planta ‚Äî PWA (Firestore)</title>
  <style>
    :root{
      --bg:#ffffff;--ink:#0b1220;--muted:#667085;
      --primary:#2563eb;--primary-600:#1d4ed8;
      --accent:#10b981;--warn:#f59e0b;--danger:#ef4444;
      --radius:16px;--pad:16px;--gap:14px;--tap:48px;
      --shadow:0 6px 24px rgba(2,6,23,.08),0 2px 8px rgba(2,6,23,.06);
      --soft:0 2px 10px rgba(2,6,23,.06)
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    .container{max-width:1000px;margin:0 auto;padding:clamp(12px,2vw,24px)}
    header.appbar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.1) blur(6px);
      background:color-mix(in oklab,#fff 88%, transparent);border-bottom:1px solid rgba(2,6,23,.06)}
    .row{display:flex;align-items:center;gap:12px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;flex:1}
    .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 200deg at 50% 50%,#3b82f6,#2563eb,#1d4ed8,#3b82f6);box-shadow:inset 0 0 0 2px rgba(255,255,255,.9),0 6px 18px rgba(37,99,235,.25)}
    .brand h1{font-size:18px;margin:0 0 -2px 0;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;min-height:var(--tap);
      font:inherit;cursor:pointer;background:#f3f4f6;color:#0b1220;box-shadow:var(--soft);
      display:inline-flex;gap:10px;align-items:center;transition:transform .06s,box-shadow .2s,background .2s}
    button.primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;box-shadow:0 6px 22px rgba(37,99,235,.28)}
    button.ghost{background:transparent;box-shadow:none;color:#1d4ed8}
    button:active{transform:translateY(1px) scale(.995)}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad)}
    .grid{display:grid;gap:var(--gap)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid rgba(37,99,235,.18);cursor:pointer;user-select:none}
    .tab[aria-selected="true"]{background:linear-gradient(135deg,#e0e7ff,#dbeafe);border-color:color-mix(in oklab,var(--primary) 30%, transparent);box-shadow:inset 0 0 0 2px rgba(37,99,235,.12)}
    .composer{display:grid;gap:10px;grid-template-columns:120px 1fr 180px auto;align-items:center}
    .field{display:flex;align-items:center;gap:10px;background:#f8fafc;padding:10px 12px;border-radius:14px;border:1px solid rgba(2,6,23,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}
    .field input{flex:1;border:0;outline:0;background:transparent;min-height:36px;font-size:16px}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap; grid-column:1/-1}
    .chip{padding:8px 12px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid rgba(37,99,235,.18);cursor:pointer;user-select:none;font-size:13px}
    .chip[data-selected="true"]{background:#dcfce7;color:#065f46;border-color:rgba(16,185,129,.25)}
    ul.tasks{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .task{display:grid;grid-template-columns:120px 1fr 180px auto;align-items:center;gap:12px;background:#fff;border-radius:14px;padding:10px 12px;border:1px solid rgba(2,6,23,.06);box-shadow:var(--soft)}
    .room{font-weight:700;letter-spacing:.5px;border-radius:10px;padding:8px 10px;background:#eef2ff;color:#1e3a8a;justify-self:start;min-width:100px;text-align:center}
    .pendiente{border-radius:999px;padding:8px 12px;background:#fff7ed;color:#9a3412;justify-self:end;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .task__text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .task__actions{display:flex;gap:6px;justify-self:end}
    .btn-icon{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:#f3f4f6}
    .btn-icon.success{background:#dcfce7;color:#065f46}
    .btn-icon.warn{background:#fff7ed;color:#9a3412}
    .btn-icon.danger{background:#fee2e2;color:#991b1b}
    .completed .task{opacity:.95;background:#f9fafb}
    .completed .task__text{text-decoration:line-through;color:#4b5563}
    .install{display:none;margin-top:12px;padding:12px;border-radius:14px;border:1px dashed rgba(37,99,235,.35);background:#f0f6ff}
    .install[aria-hidden="false"]{display:block}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);max-width:92vw}
    .toast[hidden]{display:none}
    @media (max-width:880px){
      .composer{grid-template-columns:100px 1fr; grid-auto-rows:auto}
      .composer .field:nth-child(1){grid-column:1/2}
      .composer .field:nth-child(2){grid-column:2/3}
      .composer .field:nth-child(3){grid-column:1/3}
      .composer button{grid-column:1/3}
      .task{grid-template-columns:100px 1fr; grid-auto-rows:auto}
      .task .pendiente{grid-column:1/2; justify-self:start; margin-top:6px}
      .task .task__actions{grid-column:2/3}
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="container row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Planta</h1>
          <p>Sincronizada, offline, instalable</p>
        </div>
      </div>
      <div class="actions">
        <button id="installBtn" class="ghost" aria-label="Instalar app">‚ûï Instalar</button>
        <button id="signin" class="primary">Acceder</button>
        <button id="signout" class="ghost" style="display:none">Salir</button>
      </div>
    </div>
  </header>

  <main class="container grid" style="margin-top:16px">
    <section id="authGate" class="card" role="region" aria-live="polite" style="text-align:center;padding:26px">
      <h2 style="margin:0 0 6px 0">Bienvenido</h2>
      <p style="margin:0 0 16px 0;color:var(--muted)">Accede con Google para sincronizar tus listas entre dispositivos.</p>
      <button id="signin2" class="primary">Acceder con Google</button>
      <div id="authErr" style="color:#b91c1c;margin-top:10px;min-height:1.2em"></div>
    </section>

    <section id="ui" class="grid" hidden>
      <div class="card grid" role="region" aria-labelledby="tabs-label">
        <div id="tabs-label" class="section-title">Listas</div>
        <div class="tabs" role="tablist" aria-label="Listas">
          <button class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" id="tab-planta">Planta</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-inter" id="tab-inter">Interconsultas</button>
        </div>

        <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta">
          <div class="composer" style="margin-top:12px">
            <div class="field" aria-label="Habitaci√≥n">
              <input id="room-planta" type="text" inputmode="numeric" placeholder="421-2" pattern="\d{3}-\d" title="Formato ###-#" maxlength="5" />
            </div>
            <div class="field" aria-label="Descripci√≥n (min 20)">
              <input id="desc-planta" type="text" placeholder="Descripci√≥n (‚â•20 caracteres)" minlength="20" />
            </div>
            <div class="field" aria-label="Pendiente (min 15)">
              <input id="pend-planta" type="text" placeholder="Pendiente (‚â•15 caracteres)" minlength="15" />
            </div>
            <button class="primary" id="add-planta" title="A√±adir tarea de planta">A√±adir</button>
            <div class="chips">
              <span>Prioridad:</span>
              <button class="chip" data-prio="baja" data-list="planta">Baja</button>
              <button class="chip" data-prio="media" data-selected="true" data-list="planta">Media</button>
              <button class="chip" data-prio="alta" data-list="planta">Alta</button>
            </div>
          </div>
          <h3 class="section-title">En curso</h3>
          <ul id="list-planta" class="tasks" aria-live="polite"></ul>
        </div>

        <div id="panel-inter" role="tabpanel" aria-labelledby="tab-inter" hidden>
          <div class="composer" style="margin-top:12px">
            <div class="field" aria-label="Habitaci√≥n">
              <input id="room-inter" type="text" inputmode="numeric" placeholder="421-2" pattern="\d{3}-\d" title="Formato ###-#" maxlength="5" />
            </div>
            <div class="field" aria-label="Descripci√≥n (min 20)">
              <input id="desc-inter" type="text" placeholder="Descripci√≥n (‚â•20 caracteres)" minlength="20" />
            </div>
            <div class="field" aria-label="Pendiente (min 15)">
              <input id="pend-inter" type="text" placeholder="Pendiente (‚â•15 caracteres)" minlength="15" />
            </div>
            <button class="primary" id="add-inter" title="A√±adir interconsulta">A√±adir</button>
            <div class="chips">
              <span>Prioridad:</span>
              <button class="chip" data-prio="baja" data-list="inter">Baja</button>
              <button class="chip" data-prio="media" data-selected="true" data-list="inter">Media</button>
              <button class="chip" data-prio="alta" data-list="inter">Alta</button>
            </div>
          </div>
          <h3 class="section-title">En curso</h3>
          <ul id="list-inter" class="tasks" aria-live="polite"></ul>
        </div>
      </div>

      <div class="card grid completed" role="region" aria-labelledby="comp-title">
        <div id="comp-title" class="section-title">Completadas</div>
        <ul id="list-completed" class="tasks" aria-live="polite"></ul>
        <div class="actions" style="justify-content:flex-end">
          <button id="emptyTrash" class="btn danger">Vaciar papelera</button>
        </div>
      </div>

      <div id="installContainer" class="install" aria-hidden="true">
        <b>Instala Planta</b> para un acceso m√°s r√°pido. <button id="installAction" class="primary">Instalar</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" hidden></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      getRedirectResult, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, enableIndexedDbPersistence, serverTimestamp,
      collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, runTransaction, getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebase.config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    (async () => {
      try { await setPersistence(auth, browserLocalPersistence); } catch {}
      try { await enableIndexedDbPersistence(db); } catch(e) {}
      try { await getRedirectResult(auth); } catch {}
    })();

    if ('serviceWorker' in navigator) {
      const swUrl = new URL('./sw.js', window.location.href);
      navigator.serviceWorker.register(swUrl, { scope: './' }).catch(console.error);
    }
    let deferredInstallEvent = null;
    const installBanner = document.getElementById('installContainer');
    const installBtn = document.getElementById('installBtn');
    const installAction = document.getElementById('installAction');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredInstallEvent = e;
      installBanner.setAttribute('aria-hidden','false');
    });
    const triggerInstall = async () => {
      if(!deferredInstallEvent) return;
      deferredInstallEvent.prompt();
      await deferredInstallEvent.userChoice;
      deferredInstallEvent = null;
      installBanner.setAttribute('aria-hidden','true');
    };
    installBtn.addEventListener('click', triggerInstall);
    installAction?.addEventListener('click', triggerInstall);

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const toast = document.getElementById('toast');
    const showToast = (msg)=>{ toast.textContent = msg; toast.hidden = false; setTimeout(()=>toast.hidden=true, 4000); };

    const state = { user:null, prio:{ planta:'media', inter:'media' } };

    const tabPlanta = document.getElementById('tab-planta'), tabInter = document.getElementById('tab-inter');
    const panelPlanta = document.getElementById('panel-planta'), panelInter = document.getElementById('panel-inter');
    function setTab(which){
      const isPlanta = which==='planta';
      tabPlanta.setAttribute('aria-selected', isPlanta?'true':'false');
      tabInter.setAttribute('aria-selected', isPlanta?'false':'true');
      panelPlanta.hidden = !isPlanta; panelInter.hidden = isPlanta;
      (isPlanta?document.getElementById('room-planta'):document.getElementById('room-inter'))?.focus();
    }
    tabPlanta.addEventListener('click',()=>setTab('planta'));
    tabInter.addEventListener('click',()=>setTab('inter'));
    $$('.chip').forEach(ch=>{
      ch.addEventListener('click',()=>{
        const list = ch.dataset.list;
        $$('.chip[data-list="'+list+'"]').forEach(c=>c.removeAttribute('data-selected'));
        ch.setAttribute('data-selected','true');
        state.prio[list==='inter'?'inter':'planta'] = ch.dataset.prio;
      });
    });

    const authErr = document.getElementById('authErr');
    async function doSignin(){
      authErr.textContent = '';
      const provider = new GoogleAuthProvider();
      try{
        await signInWithPopup(auth, provider);
      }catch(e){
        try{
          await signInWithRedirect(auth, provider);
        }catch(err){
          const msg = (err && (err.message || err.code)) || 'Error de acceso con Google';
          authErr.textContent = msg;
          showToast(msg);
          console.error('Auth error:', err);
        }
      }
    }
    document.getElementById('signin').addEventListener('click', doSignin);
    document.getElementById('signin2').addEventListener('click', doSignin);
    document.getElementById('signout').addEventListener('click', ()=>signOut(auth));

    const authGate = document.getElementById('authGate'), ui = document.getElementById('ui');
    const signInBtn = document.getElementById('signin'), signOutBtn = document.getElementById('signout');

    onAuthStateChanged(auth, (user)=>{
      state.user = user || null;
      if(!user){
        ui.hidden = true;
        authGate.hidden = false;
        signInBtn.style.display = '';
        signOutBtn.style.display = 'none';
        return;
      }
      signInBtn.style.display = 'none';
      signOutBtn.style.display = '';
      authGate.hidden = true;
      ui.hidden = false;
      subscribeAll();
    });

    const colRef = (name)=>collection(db,'users',state.user.uid,name);
    const parseRoom = (s)=>{
      if(!s) return null;
      const m = s.trim().match(/^(\d{3})-(\d)$/);
      if(!m) return null;
      const planta = parseInt(m[1],10);
      const cama = parseInt(m[2],10);
      return { room: m[0], sortKey: planta*10 + cama };
    };

    function renderList(ul, snap, {completed=false}={}){
      ul.innerHTML = '';
      for(const d of snap.docs){
        const item = d.data();
        const li = document.createElement('li');
        li.className='task'; li.dataset.id=d.id; li.dataset.col=d.ref.parent.id;

        const room = document.createElement('div');
        room.className = 'room'; room.textContent = item.habitacion || '---';

        const text = document.createElement('div');
        text.className='task__text'; text.textContent=item.descripcion || '(sin descripci√≥n)';
        text.title = item.descripcion || '';

        const pend = document.createElement('div');
        pend.className='pendiente'; pend.textContent=item.pendiente || '';
        pend.title = item.pendiente || '';

        const actions = document.createElement('div'); actions.className='task__actions';
        if(!completed){
          const done = document.createElement('button'); done.className='btn-icon success'; done.title='Marcar como completada'; done.textContent='‚úî';
          done.addEventListener('click', ()=>completeTask(d.id, d.ref.parent.id));
          const del = document.createElement('button'); del.className='btn-icon danger'; del.title='Eliminar'; del.textContent='üóë';
          del.addEventListener('click', ()=>deleteTask(d.id, d.ref.parent.id));
          actions.append(done, del);
        }else{
          const undo = document.createElement('button'); undo.className='btn-icon warn'; undo.title='Deshacer'; undo.textContent='‚Ü©';
          undo.addEventListener('click', ()=>undoTask(d.id, item.previousList || 'planta'));
          actions.append(undo);
        }
        li.append(room, text, pend, actions);
        ul.appendChild(li);
      }
    }

    let unsubPlanta=null, unsubInter=null, unsubComp=null;
    function subscribeAll(){
      unsubPlanta?.(); unsubInter?.(); unsubComp?.();
      unsubPlanta = onSnapshot(query(colRef('planta'), orderBy('sortKey','asc')),(snap)=>renderList(document.getElementById('list-planta'),snap));
      unsubInter  = onSnapshot(query(colRef('interconsultas'), orderBy('sortKey','asc')),(snap)=>renderList(document.getElementById('list-inter'),snap));
      unsubComp   = onSnapshot(query(colRef('completadas'), orderBy('completedAt','desc')),(snap)=>renderList(document.getElementById('list-completed'),snap,{completed:true}));
    }

    async function addTask(listName, roomVal, descVal, pendVal, prioridad){
      const parsed = parseRoom(roomVal);
      if(!parsed){ showToast('Habitaci√≥n inv√°lida, usa ###-#'); return; }
      if(!descVal || descVal.trim().length < 20){ showToast('Descripci√≥n ‚â• 20 caracteres'); return; }
      if(!pendVal || pendVal.trim().length < 15){ showToast('Pendiente ‚â• 15 caracteres'); return; }
      const payload = {
        habitacion: parsed.room,
        sortKey: parsed.sortKey,
        descripcion: descVal.trim(),
        pendiente: pendVal.trim(),
        prioridad,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      await addDoc(colRef(listName), payload);
    }

    document.getElementById('add-planta').addEventListener('click', async ()=>{
      const r=document.getElementById('room-planta'), d=document.getElementById('desc-planta'), p=document.getElementById('pend-planta');
      await addTask('planta', r.value, d.value, p.value, state.prio.planta);
      r.value=''; d.value=''; p.value=''; r.focus();
    });
    document.getElementById('add-inter').addEventListener('click', async ()=>{
      const r=document.getElementById('room-inter'), d=document.getElementById('desc-inter'), p=document.getElementById('pend-inter');
      await addTask('interconsultas', r.value, d.value, p.value, state.prio.inter);
      r.value=''; d.value=''; p.value=''; r.focus();
    });

    document.getElementById('pend-planta').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('add-planta').click(); });
    document.getElementById('pend-inter').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('add-inter').click(); });

    async function completeTask(id, fromCol){
      const src = doc(db,'users',state.user.uid,fromCol,id);
      const dst = doc(colRef('completadas'));
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(src); if(!snap.exists()) return;
        const data = snap.data();
        tx.set(dst, {
          habitacion: data.habitacion,
          sortKey: data.sortKey,
          descripcion: data.descripcion,
          pendiente: data.pendiente,
          prioridad: data.prioridad,
          previousList: fromCol,
          createdAt: data.createdAt || serverTimestamp(),
          completedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tx.delete(src);
      });
    }
    async function undoTask(id, previous='planta'){
      const src = doc(db,'users',state.user.uid,'completadas',id);
      const dst = doc(colRef(previous));
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(src); if(!snap.exists()) return;
        const data = snap.data();
        tx.set(dst, {
          habitacion: data.habitacion,
          sortKey: data.sortKey,
          descripcion: data.descripcion,
          pendiente: data.pendiente,
          prioridad: data.prioridad,
          createdAt: data.createdAt || serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tx.delete(src);
      });
    }
    async function deleteTask(id, fromCol){
      await deleteDoc(doc(db,'users',state.user.uid,fromCol,id));
    }
    document.getElementById('emptyTrash').addEventListener('click', async ()=>{
      const qSnap = await getDocs(colRef('completadas'));
      await Promise.allSettled(qSnap.docs.map(d=>deleteDoc(d.ref)));
    });

    setTab('planta');
  </script>
</body>
</html>
