<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content"
  />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />
  <title>Infecciosas — Planta · Tareas · Directorio</title>

  <!-- Se reescribe en runtime según BASE (raíz o /Planta/) -->
  <link rel="manifest" href="/Planta/manifest.webmanifest" />
  <link rel="icon" href="/Planta/icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="/Planta/icons/icon-192.png" />

  <style>
    .hide{display:none!important}
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:#fff;color:#0b1220;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:clamp(15px,1vw + .3vh,18px);line-height:1.62;min-height:100dvh;-webkit-tap-highlight-color:transparent
    }
    :focus-visible{outline:3px solid color-mix(in oklab, hsl(43 84% 56%), #22c55e 18%);outline-offset:2px;border-radius:10px}

    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0b1220; --muted:#64748b; --border:#e5e7eb;
      --radius:14px; --radius-xl:20px; --app-h:64px; --touch:44px;
      --shadow-1:0 1px 2px rgba(2,6,23,.05),0 8px 24px rgba(2,6,23,.06);
      --shadow-2:0 2px 6px rgba(2,6,23,.08),0 16px 36px rgba(2,6,23,.08);

      --hdr-fg-1:hsl(220 20% 98%); --hdr-fg-2:hsl(220 16% 92%); --hdr-fg-3:hsl(220 12% 86%);

      --brand-hi:hsl(205 85% 44%); --brand-lo:hsl(205 82% 40%);
      --planta-hi:hsl(156 58% 44%); --planta-lo:hsl(156 52% 38%);
      --tareas-hi:hsl(10 72% 50%);  --tareas-lo:hsl(10 66% 44%);
      --dir-hi:hsl(205 85% 44%);    --dir-lo:hsl(205 82% 40%);
      --add-hi:hsl(222 70% 46%);    --add-lo:hsl(222 64% 40%);
      --done-hi:hsl(150 52% 40%);   --done-lo:hsl(150 46% 36%);
      --trash-hi:hsl(220 20% 38%);  --trash-lo:hsl(220 18% 34%);
      --sheen:linear-gradient(92deg,rgba(255,255,255,.10),rgba(255,255,255,0) 50%);
      --accent-gold:hsl(43 84% 56%);

      --pill-ink:#0b1220;
      --pill-date-bg:hsl(205 80% 96%);  --pill-date-bd:hsl(205 68% 86%);
      --pill-section-bg:hsl(205 45% 96%);--pill-section-bd:hsl(205 35% 86%);

      --room-ink:#06111e;
      --room-planta-bg:hsl(156 78% 96%);  --room-planta-bd:hsl(156 58% 40%);
      --room-inter-bg:hsl(28  95% 96%);   --room-inter-bd:hsl(28  70% 46%);

      --phone-bg:#eef2f7; --phone-bd:#d8e0ea; --phone-ink:#0f172a;

      --badge-bg:hsl(210 16% 18%); --badge-fg:#fff;
    }
    .container{max-width:min(1160px,98vw);margin:0 auto;padding:8px clamp(12px,4vw,20px);container-type:inline-size}

    header.appbar{
      position:sticky;top:0;z-index:50;min-height:var(--app-h);
      background:linear-gradient(180deg,#ffffff 50%,#f2f7ff 100%);border-bottom:1px solid var(--border);
      backdrop-filter:saturate(1.05) blur(6px)
    }
    .appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brandRow{display:flex;align-items:center;gap:14px;min-width:0}
    .grow{flex:1;min-width:0}
    .statusRow{display:flex;gap:8px;flex-wrap:wrap}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar .btn{white-space:nowrap}
    @media (max-width:520px){
      .statusRow{order:3;width:100%}
      #userGroup{order:2;margin-left:auto}
      .toolbar{order:4;width:100%;justify-content:flex-start}
      #title{font-size:clamp(18px,5vw,22px)}
    }

    .brand-chip{
      display:inline-flex;align-items:center;gap:12px;
      padding:14px 24px;border-radius:999px;
      color:var(--hdr-fg-1);border:1px solid rgba(255,255,255,.28);
      background-image:linear-gradient(179deg,var(--brand-hi),var(--brand-lo)), var(--sheen);
      text-shadow:0 1px 2px rgba(0,0,0,.35);
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      font-size:clamp(22px,3.6vw,28px);
      font-weight:960;letter-spacing:.44px;text-transform:uppercase
    }
    .brand-dot{width:12px;height:12px;border-radius:50%;background:var(--accent-gold);box-shadow:0 0 0 2px rgba(0,0,0,.06)}
    h1{margin:0;font-size:clamp(20px,2.6vw,28px);font-weight:900;letter-spacing:.2px}
    h2{margin:0;font-size:clamp(18px,2.2vw,22px)}

    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:.82rem;background:var(--surface-2)}
    .chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
    .chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}

    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#0b1220;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow-1);min-height:var(--touch);min-width:44px;display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer}
    .btn.primary{background:var(--accent-gold);color:#0E121A;border-color:transparent}
    .btn.ghost{background:transparent;border-color:transparent;box-shadow:none;color:hsl(205 80% 34%)}
    .btn.icon{min-width:var(--touch);aspect-ratio:1/1;padding:0 10px}

    .badge{
      display:inline-flex;align-items:center;justify-content:center;min-width:1.6em;height:1.6em;
      padding:0 .5em;border-radius:999px;font-weight:800;background:var(--badge-bg); color:var(--badge-fg);
      box-shadow:0 0 0 1px rgba(0,0,0,.12), 0 6px 14px rgba(0,0,0,.15);
    }

    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-1);overflow:hidden;contain:content}
    .card-h{
      position:relative;padding:14px 16px;border-radius:var(--radius-xl) var(--radius-xl) 0 0;
      color:var(--hdr-fg-1);display:flex;align-items:center;justify-content:space-between;gap:10px;
      text-shadow:0 1px 2px rgba(0,0,0,.35);overflow:hidden;isolation:isolate
    }
    .card-h::after{content:"";position:absolute;inset:0;background-image:var(--sheen);pointer-events:none;z-index:-1}
    .card-b{padding:12px}
    .subtitle{color:var(--hdr-fg-2);font-weight:600}
    .counter{color:var(--hdr-fg-3);border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-weight:700}

    .hdr-brand{background-image:linear-gradient(179deg,var(--brand-hi),var(--brand-lo))}
    .hdr-add  {background-image:linear-gradient(179deg,var(--add-hi),var(--add-lo))}
    .hdr-planta{background-image:linear-gradient(179deg,var(--planta-hi),var(--planta-lo))}
    .hdr-tareas{background-image:linear-gradient(179deg,var(--tareas-hi),var(--tareas-lo))}
    .hdr-dir{background-image:linear-gradient(179deg,var(--dir-hi),var(--dir-lo))}
    .hdr-done {background-image:linear-gradient(179deg,var(--done-hi),var(--done-lo))}
    .hdr-trash{background-image:linear-gradient(179deg,var(--trash-hi),var(--trash-lo))}

    .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .tab{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--surface-2);cursor:pointer;font-weight:900;letter-spacing:.2px}
    #tab-planta[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(156 58% 44%) 20%);border-color:color-mix(in oklab,hsl(156 58% 44%),transparent 60%)}
    #tab-tareas[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(10 72% 50%) 20%); border-color:color-mix(in oklab,hsl(10 72% 50%),transparent 60%)}
    #tab-directorio[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(205 85% 44%) 20%);border-color:color-mix(in oklab,hsl(205 85% 44%),transparent 60%)}

    .section-banner{
      margin:10px 0 8px;border-radius:16px;padding:10px 14px;color:var(--hdr-fg-1);
      font-weight:950;letter-spacing:.4px;text-shadow:0 1px 2px rgba(0,0,0,.3);
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .sb-planta{background-image:linear-gradient(179deg,var(--planta-hi),var(--planta-lo))}
    .sb-tareas{background-image:linear-gradient(179deg,var(--tareas-hi),var(--tareas-lo))}
    .sb-dir   {background-image:linear-gradient(179deg,var(--dir-hi),var(--dir-lo))}
    .sb-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.25);font-weight:700}

    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:800;font-size:13px;padding:6px 10px;border-radius:10px;line-height:1;border:1px solid transparent;
      color:var(--pill-ink);background:var(--surface-2);
      font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;
    }
    .pill.room{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-weight:900; letter-spacing:.35px;
      font-size:clamp(26px,4.6vw,34px);
      padding:12px 18px;border-radius:14px;color:var(--room-ink);
      border:2px solid transparent;
      box-shadow:inset 0 -1px 0 rgba(0,0,0,.06), 0 1px 0 rgba(255,255,255,.7);
    }
    .pill.room.planta{ background:var(--room-planta-bg); border-color:var(--room-planta-bd) }
    .pill.room.inter { background:var(--room-inter-bg);  border-color:var(--room-inter-bd)  }

    .pill.date{background:var(--pill-date-bg);border-color:var(--pill-date-bd)}
    .pill.section{background:var(--pill-section-bg);border-color:var(--pill-section-bd)}

    .phone-chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      background:var(--phone-bg);border:1px solid var(--phone-bd);color:var(--phone-ink);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-variant-numeric: tabular-nums; line-height:1.2; margin:2px 6px 2px 0;
    }

    ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px;content-visibility:auto;contain-intrinsic-size:600px}
    li.item{
      display:grid;grid-template-columns:max-content minmax(160px,1fr) auto;
      gap:12px;align-items:center;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff
    }
    li.item.pl{ border-left:6px solid hsl(156 58% 44%) }
    li.item.ic{ border-left:6px solid hsl(28 86% 50%) }

    .group-li{border:0;background:transparent;padding:0}
    .group-hdr{
      margin:18px 0 6px;padding:8px 12px;border-radius:12px;color:var(--hdr-fg-1);
      font-weight:900;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.28);
      display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(0,0,0,.06);
    }
    .group-count{
      color:var(--hdr-fg-3);border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);padding:4px 8px;border-radius:999px;font-weight:800
    }
    .group-sep{height:4px;border-radius:999px;margin:10px 0 12px;background:linear-gradient(90deg,#0003,#0000);opacity:.95}

    .muted{color:var(--muted)} .text{min-width:0} .line{overflow-wrap:anywhere} .strike{text-decoration:line-through;opacity:.88}

    label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
    input,textarea,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;color:#0b1220;font:inherit;min-height:var(--touch)}
    textarea{min-height:90px;resize:vertical}
    input::placeholder,textarea::placeholder{color:color-mix(in oklab,var(--muted),transparent 20%)}
    .grid{display:grid;gap:12px}
    .g3{grid-template-columns:1fr 2fr auto}
    .g2{grid-template-columns:1fr 1fr}
    @container (max-width:700px){.g3,.g2{grid-template-columns:1fr}}
    @media (max-width:680px){.g3,.g2{grid-template-columns:1fr}}

    nav.bottom{position:sticky;bottom:0;z-index:30;background:#fff;border-top:1px solid var(--border)}
    .tabs-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:center;padding:8px 12px}
    .tab-bottom{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);cursor:pointer;font-weight:900}
    #b-planta[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(156 58% 44%) 18%);border-color:color-mix(in oklab,hsl(156 58% 44%),transparent 70%)}
    #b-tareas[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(10 72% 50%) 18%); border-color:color-mix(in oklab,hsl(10 72% 50%),transparent 70%)}
    #b-directorio[aria-selected="true"]{background:color-mix(in oklab,#fff,hsl(205 85% 44%) 18%);border-color:color-mix(in oklab,hsl(205 85% 44%),transparent 70%)}

    .banner{display:none;margin:10px 0;padding:10px 12px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px}
    .banner[aria-hidden="false"]{display:flex;gap:10px;align-items:center}
    #toast{position:fixed;left:50%;bottom:calc(14px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow-2);z-index:60}
    #toast[hidden]{display:none}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:70}
    .modal[open]{display:grid}
    .dialog{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-2);padding:16px;width:min(560px,92vw)}
    .dialog .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .segmented{
      display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:var(--shadow-1)
    }
    .segmented button{border:0;background:transparent;border-radius:999px;padding:8px 12px;cursor:pointer;color:#334155;min-height:36px}
    .segmented button.active{
      background:color-mix(in oklab,#fff,var(--accent-gold) 20%);color:#111827;
      box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--accent-gold),transparent 60%)
    }
    .target-badge{
      display:inline-flex;align-items:center;gap:8px;margin-left:8px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid transparent
    }
    .target-badge.is-planta{background:linear-gradient(180deg,hsl(156 52% 95%),#fff);border-color:hsl(156 42% 78%);color:hsl(156 44% 28%)}
    .target-badge.is-inter {background:linear-gradient(180deg,hsl(28 86% 95%),#fff); border-color:hsl(28 62% 78%); color:hsl(28 64% 28%)}

    @media (prefers-reduced-motion:reduce){*{scroll-behavior:auto!important;animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="container">
      <div class="brandRow" aria-label="Marca">
        <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>Infecciosas</span>
        <h1 id="title">Planta · Tareas · Directorio</h1>
      </div>

      <div class="grow"></div>

      <div class="statusRow" aria-live="polite">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>

      <div id="userGroup" class="toolbar">
        <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
          <img id="avatar" class="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-1)">
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
          <span id="notifBadge" class="badge" title="Notificaciones">0</span>
        </div>
        <button id="installBtn" class="btn ghost" aria-label="Instalar">Instalar</button>
        <button id="signin"  class="btn primary">Acceder</button>
        <button id="signout" class="btn hide">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="updateBanner" class="banner" aria-hidden="true">
      Nueva versión disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
    </div>
    <div id="installBanner" class="banner" aria-hidden="true">
      Instala la app para acceso más rápido. <button id="installAction" class="btn primary">Instalar</button>
    </div>

    <section id="gate" class="card" role="region" aria-live="polite">
      <div class="card-h hdr-brand"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
      <div class="card-b">
        <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
        <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
        <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
      </div>
    </section>

    <section id="app" class="hide" aria-labelledby="tabsLabel">
      <div class="card" style="margin-bottom:12px">
        <div class="card-b">
          <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
          <div role="tablist" class="tabs" aria-label="Secciones" id="tablist">
            <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta">Planta</button>
            <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas">Tareas</button>
            <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio">Directorio</button>
          </div>
        </div>
      </div>

      <!-- ===== PLANTA ===== -->
      <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta">
        <div class="section-banner sb-planta"><span>PLANTA</span><span class="sb-pill">Ingresos &amp; Interconsultas</span></div>

        <div class="card">
          <div class="card-h hdr-add">
            <h2>Añadir (Planta/Interconsulta)</h2>
            <span class="subtitle">Habitación · Descripción · Pendientes</span>
          </div>
          <div class="card-b grid g3">
            <div><label for="p-room">Habitación</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
            <div><label for="p-desc">Descripción</label><input id="p-desc" placeholder="Resumen clínico, motivo…"></div>
            <div style="align-self:end"><button id="p-add" class="btn primary">Añadir</button></div>

            <div class="g2" style="grid-column:1/-1;align-items:end">
              <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, analítica… (opcional)"></div>
              <div>
                <label>Grupo</label>
                <div class="segmented" role="group" aria-label="Grupo">
                  <button id="p-group-planta" type="button" class="active" aria-pressed="true">Planta</button>
                  <button id="p-group-inter"  type="button" aria-pressed="false">Interconsulta</button>
                </div>
                <span id="addTarget" class="target-badge is-planta" aria-live="polite">Añadiendo a: Planta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-planta"><h2>Planta</h2><span id="p-count-planta" class="counter" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-planta" class="list"></ul>
            <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-planta"><h2>Interconsultas</h2><span id="p-count-inter" class="counter" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-inter" class="list"></ul>
            <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-done"><h2>Completadas</h2><span id="p-done-count" class="counter" aria-live="polite">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="p-done" class="list"></ul>
            <p id="p-done-empty" class="muted">Nada completado.</p>
          </div>
        </div>
      </div>

      <!-- ===== TAREAS ===== -->
      <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas">
        <div class="section-banner sb-tareas"><span>TAREAS</span><span class="sb-pill">Rojo → Verde según proximidad</span></div>

        <div class="card">
          <div class="card-h hdr-add"><h2>Añadir tarea</h2><span class="subtitle" id="t-status">Fecha → Descripción</span></div>
          <div class="card-b">
            <div class="grid g3">
              <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
              <div><label for="t-text">Descripción</label><input id="t-text" type="text" placeholder="Describe la tarea…" maxlength="400"></div>
              <div style="align-self:end"><button id="t-add" class="btn primary">Añadir</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-tareas"><h2>Tareas activas</h2><span id="t-count" class="counter">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#fff7ed,transparent)">
            <ul id="t-list" class="list"></ul>
            <p id="t-empty" class="muted">No hay tareas activas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-done"><h2>Completadas</h2><span id="t-done-count" class="counter">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="t-done" class="list"></ul>
            <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-trash"><h2>Papelera</h2><span id="t-trash-count" class="counter">0</span></div>
          <div class="card-b">
            <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
            <ul id="t-trash" class="list"></ul>
            <p id="t-trash-empty" class="muted">Papelera vacía.</p>
          </div>
        </div>
      </div>

      <!-- ===== DIRECTORIO ===== -->
      <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio">
        <div class="section-banner sb-dir"><span>DIRECTORIO</span><span class="sb-pill">Búsqueda por secciones + JSON</span></div>

        <div class="card">
          <div class="card-h hdr-dir"><h2>Directorio telefónico</h2><span id="d-count" class="counter">0</span></div>
          <div class="card-b grid g2">
            <div><label for="d-q">Buscar</label><input id="d-q" type="search" placeholder="Buscar por sección, nombre o teléfono…"></div>
            <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap">
              <button id="d-add" class="btn primary">Añadir</button>
              <button id="d-import" class="btn">Importar JSON</button>
              <button id="d-export" class="btn">Exportar JSON</button>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="card-b"><ul id="d-list" class="list"></ul><p id="d-empty" class="muted">Sin registros.</p></div>
        </div>
      </div>

      <nav class="bottom" aria-label="Secciones">
        <div class="tabs-bottom">
          <button class="tab-bottom" id="b-planta" aria-selected="true">Planta</button>
          <button class="tab-bottom" id="b-tareas" aria-selected="false">Tareas</button>
          <button class="tab-bottom" id="b-directorio" aria-selected="false">Directorio</button>
        </div>
      </nav>
    </section>
  </main>

  <dialog id="modal" class="modal" aria-modal="true">
    <form id="modalForm" class="dialog" method="dialog">
      <h3 id="modalTitle" style="margin:0 0 8px 0">Editar</h3>
      <div id="modalBody" class="grid" style="grid-template-columns:1fr"></div>
      <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="btn" value="cancel">Cancelar</button>
        <button id="modalOk" class="btn primary" value="ok">Guardar</button>
      </div>
    </form>
  </dialog>

  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    /* ===== BasePath ===== */
    const BASE = (function() {
      const p = location.pathname;
      const i = p.indexOf('/Planta/');
      return i >= 0 ? '/Planta/' : '/';
    })();

    /* Reescribir rutas si el repo no está en raíz */
    (function(){
      const links = document.querySelectorAll('link[rel="manifest"],link[rel="icon"],link[rel="apple-touch-icon"]');
      for (let i=0;i<links.length;i++){
        const link = links[i];
        const href = link.getAttribute('href') || '';
        if (href.indexOf('/Planta/') === 0) link.setAttribute('href', href.replace('/Planta/', BASE));
      }
    })();

    /* ===== Firebase SDK ===== */
    const appMod   = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    const authMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
    const fsMod    = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');

    /* Config incrustada para evitar imports adicionales */
    const firebaseConfig = {
      apiKey: "AIzaSyA2HaGFibNh-nHeIX2i2mIQ5h2iGaeWsco",
      authDomain: "planta-59ff8.firebaseapp.com",
      projectId: "planta-59ff8",
      storageBucket: "planta-59ff8.firebasestorage.app",
      messagingSenderId: "185987714097",
      appId: "1:185987714097:web:024cc87eb8372c52345910"
    };

    const fbApp = appMod.initializeApp(firebaseConfig);
    const auth  = authMod.getAuth(fbApp);
    const db    = fsMod.initializeFirestore(fbApp, {
      localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() })
    });
    const serverTS = fsMod.serverTimestamp;

    /* ===== Utils ===== */
    function $(s, r){ return (r||document).querySelector(s); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function idle(fn){ return ('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0); }
    function toast(m){ var t=$('#toast'); t.textContent=String(m||''); t.hidden=false; setTimeout(function(){t.hidden=true;},2200); }
    function esc(s){ return String(s==null?'':s).replace(/[&<>"]/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m];}); }
    function pillForDate(iso){
      try{
        var d=new Date(String(iso)+'T00:00:00');
        return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,'');
      }catch(e){ return String(iso); }
    }
    function roomSortKey(s){
      if(!s) return Number.POSITIVE_INFINITY;
      var m = String(s).match(/\d+/g);
      if(!m) return Number.POSITIVE_INFINITY;
      var first = parseInt(m[0],10);
      var second = m[1] ? parseInt(m[1],10)/100 : 0;
      return first + second;
    }

    function setOnline(on){
      var b=$('#badge-online');
      b.textContent=on?'Online':'Offline';
      b.className='chip '+(on?'ok':'bad');
    }
    setOnline(navigator.onLine);
    addEventListener('online', function(){setOnline(true);}, {passive:true});
    addEventListener('offline',function(){setOnline(false);}, {passive:true});

    var badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
    var gate=$('#gate'), appUI=$('#app'); var provider=new authMod.GoogleAuthProvider();

    async function doSignIn(){
      try{
        if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider);
        else await authMod.signInWithPopup(auth,provider);
      }catch(e){
        $('#authErr').textContent = e && e.message ? String(e.message) : String(e);
      }
    }
    $('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async function(){ await authMod.signOut(auth); };

    authMod.onAuthStateChanged(auth, function(user){
      if(user){
        badgeAuth.textContent='Google: '+(user.displayName||user.email);
        badgeAuth.className='chip ok';
        avatar.src=user.photoURL||'';
        displayname.textContent=user.displayName||user.email||'';
        userchip.classList.remove('hide');
        $('#signout').classList.remove('hide'); $('#signin').classList.add('hide'); gate.classList.add('hide'); appUI.classList.remove('hide');
        mountApp(user.uid);
      }else{
        badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
        userchip.classList.add('hide'); $('#signout').classList.add('hide'); $('#signin').classList.remove('hide'); appUI.classList.add('hide'); gate.classList.remove('hide');
        unmountApp();
      }
    });

    var col = {
      planta  : function(uid){ return fsMod.collection(db,'users',uid,'planta'); },
      tareas  : function(uid){ return fsMod.collection(db,'users',uid,'tareas'); },
      dir     : function(uid){ return fsMod.collection(db,'users',uid,'directorio'); }
    };
    var unsubs=[]; function currentUid(){ return auth.currentUser && auth.currentUser.uid; }
    function unmountApp(){ for(var i=0;i<unsubs.length;i++){ try{unsubs[i]&&unsubs[i]();}catch(_){}} unsubs=[]; }

    var tabOrder=['planta','tareas','directorio'];
    function selectTab(id, focusPanel){
      var map={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio']};
      for(var k in map){
        var arr = map[k];
        var p=arr[0], t=arr[1], b=arr[2], l=arr[3];
        var sel=(k===id);
        $('#'+p).classList.toggle('hide',!sel);
        $('#'+t).setAttribute('aria-selected', String(sel));
        $('#'+b).setAttribute('aria-selected', String(sel));
        if(sel){ $('#title').textContent=l; localStorage.setItem('tab', k); if(focusPanel){ var el=$('#'+p); if(el && el.focus) el.focus(); } }
      }
    }
    $('#tab-planta').onclick =function(){selectTab('planta',true);};
    $('#tab-tareas').onclick =function(){selectTab('tareas',true);};
    $('#tab-directorio').onclick=function(){selectTab('directorio',true);};
    $('#b-planta').onclick =function(){selectTab('planta');};
    $('#b-tareas').onclick =function(){selectTab('tareas');};
    $('#b-directorio').onclick=function(){selectTab('directorio');};

    $('#tablist').addEventListener('keydown', function(e){
      var cur = -1;
      for(var i=0;i<tabOrder.length;i++){ if($('#tab-'+tabOrder[i]).getAttribute('aria-selected')==='true'){ cur=i; break; } }
      if(e.key==='ArrowRight' || e.key==='ArrowDown'){
        e.preventDefault(); var n=(cur+1)%tabOrder.length; var id=tabOrder[n]; $('#tab-'+id).focus(); $('#tab-'+id).click();
      } else if(e.key==='ArrowLeft' || e.key==='ArrowUp'){
        e.preventDefault(); var n2=(cur-1+tabOrder.length)%tabOrder.length; var id2=tabOrder[n2]; $('#tab-'+id2).focus(); $('#tab-'+id2).click();
      } else if(e.key==='Home'){
        e.preventDefault(); var id3=tabOrder[0]; $('#tab-'+id3).focus(); $('#tab-'+id3).click();
      } else if(e.key==='End'){
        e.preventDefault(); var id4=tabOrder[tabOrder.length-1]; $('#tab-'+id4).focus(); $('#tab-'+id4).click();
      }
    });

    function setNotif(n){ var el=$('#notifBadge'); el.textContent=String(n); el.title=n?(String(n)+' tareas activas'):'Sin avisos'; }

    /* ===== PLANTA ===== */
    var currentGroup='planta';
    function updateAddTarget(){
      var t=$('#addTarget');
      if(currentGroup==='planta'){ t.textContent='Añadiendo a: Planta'; t.className='target-badge is-planta'; }
      else { t.textContent='Añadiendo a: Interconsulta'; t.className='target-badge is-inter'; }
    }
    $('#p-group-planta').onclick=function(){currentGroup='planta'; updateAddTarget(); mkeActive('#p-group-planta','#p-group-inter');};
    $('#p-group-inter').onclick =function(){currentGroup='interconsulta'; updateAddTarget(); mkeActive('#p-group-inter','#p-group-planta');};
    function mkeActive(on,off){ $(on).classList.add('active'); $(on).setAttribute('aria-pressed','true'); $(off).classList.remove('active'); $(off).setAttribute('aria-pressed','false'); }
    updateAddTarget();

    function plantaDoc(d){
      return {
        room:(d.room||'').trim(),
        desc:(d.desc||'').trim(),
        pendiente:(d.pendiente||'').trim(),
        grupo:d.grupo||'planta',
        status:d.status||'active',
        createdAt:d.createdAt||serverTS(),
        updatedAt:serverTS(),
        deviceId:navigator.userAgent.slice(0,64)
      };
    }

    function makeBtn(label,fn,cls){
      var b=document.createElement('button');
      b.className=cls||'btn'; b.type='button'; b.textContent=label;
      b.onclick=function(e){ e.preventDefault(); try{fn&&fn(e);}catch(err){ toast(err && err.message ? String(err.message) : String(err)); } };
      return b;
    }

    function docItemBase(x,done){
      var li=document.createElement('li');
      li.className='item ' + (x.grupo==='interconsulta'?'ic':'pl');
      var roomSpan=document.createElement('span');
      roomSpan.className='pill room ' + (x.grupo==='interconsulta'?'inter':'planta');
      roomSpan.textContent=String(x.room||'—');
      var textDiv=document.createElement('div'); textDiv.className='text';
      var mainLine=document.createElement('div'); mainLine.className='line' + (done?' strike':'');
      mainLine.textContent=String(x.desc||'');
      textDiv.appendChild(mainLine);
      if(x.pendiente){
        var pend=document.createElement('div'); pend.className='muted'; pend.textContent=String(x.pendiente);
        textDiv.appendChild(pend);
      }
      var actions=document.createElement('div'); actions.className='toolbar actions';
      li.appendChild(roomSpan); li.appendChild(textDiv); li.appendChild(actions);
      return li;
    }

    function renderPlantaItem(x){
      var li=docItemBase(x,false);
      var a=li.querySelector('.actions');
      a.appendChild(makeBtn('Hecha',function(){upd('planta',x.__id,{status:'done'});},'btn icon'));
      a.appendChild(makeBtn('Editar',function(){editPlanta(x);},'btn icon'));
      a.appendChild(makeBtn('Borrar',function(){upd('planta',x.__id,{status:'trash'});},'btn icon'));
      return li;
    }
    function renderPlantaDone(x){
      var li=docItemBase(x,true);
      var a=li.querySelector('.actions');
      a.appendChild(makeBtn('Restaurar',function(){upd('planta',x.__id,{status:'active'});},'btn icon'));
      a.appendChild(makeBtn('Eliminar',function(){del('planta',x.__id);},'btn icon'));
      return li;
    }

    function openEdit(fields,onOk){
      var body=$('#modalBody'); body.innerHTML='';
      for(var i=0;i<fields.length;i++){
        var f=fields[i];
        var w=document.createElement('div');
        var lab=document.createElement('label'); lab.setAttribute('for',f.id); lab.textContent=f.l;
        var inp=document.createElement('input'); inp.id=f.id; inp.value=String(f.v||'');
        w.appendChild(lab); w.appendChild(inp); body.appendChild(w);
      }
      var dlg=$('#modal'); $('#modalTitle').textContent='Editar'; $('#modalOk').textContent='Guardar'; $('#modalCancel').textContent='Cancelar';
      dlg.showModal(); dlg.setAttribute('aria-hidden','false');
      $('#modalOk').onclick=async function(e){e.preventDefault(); try{ await onOk(); } finally { dlg.close(); }};
      $('#modalCancel').onclick=function(e){e.preventDefault(); dlg.close();};
      dlg.addEventListener('close',function(){dlg.setAttribute('aria-hidden','true');},{once:true});
    }
    function val(id){ var el=$('#'+id); return el? String(el.value||'') : ''; }
    function editPlanta(x){
      openEdit(
        [{l:'Habitación',id:'p_room',v:x.room||''},{l:'Descripción',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}],
        async function(){ await upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')}); }
      );
    }

    function setupPlanta(uid){
      $('#p-add').onclick=async function(){
        var d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup});
        if(!d.room && !d.desc) return;
        await fsMod.addDoc(col.planta(uid),d);
        var ids=['p-room','p-desc','p-pend']; for(var i=0;i<ids.length;i++){ var el=$('#'+ids[i]); if(el) el.value=''; }
      };
      var qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
      var qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));

      var u1=fsMod.onSnapshot(qA,function(s){
        var all=[]; s.forEach(function(d){var x=d.data(); x.__id=d.id; all.push(x);});
        var arrP = all.filter(function(x){return (x.grupo||'planta')==='planta';})
                       .sort(function(a,b){return roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||''));});
        var arrI = all.filter(function(x){return (x.grupo||'planta')==='interconsulta';})
                       .sort(function(a,b){return roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||''));});
        var lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
        arrP.forEach(function(x){ lp.appendChild(renderPlantaItem(x)); });
        arrI.forEach(function(x){ li.appendChild(renderPlantaItem(x)); });
        $('#p-empty-planta').style.display=arrP.length?'none':'block';
        $('#p-empty-inter').style.display=arrI.length?'none':'block';
        $('#p-count-planta').textContent=String(arrP.length);
        $('#p-count-inter').textContent=String(arrI.length);
      });

      var u2=fsMod.onSnapshot(qD,function(s){
        var arr=[]; s.forEach(function(d){var x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort(function(a,b){ return (b.updatedAt&&b.updatedAt.seconds||0)-(a.updatedAt&&a.updatedAt.seconds||0); });
        var l=$('#p-done'); l.innerHTML='';
        arr.forEach(function(x){ l.appendChild(renderPlantaDone(x)); });
        $('#p-done-empty').style.display=arr.length?'none':'block';
        $('#p-done-count').textContent=String(arr.length);
      });
      unsubs.push(u1,u2);
    }

    /* ===== TAREAS ===== */
    function tareaDoc(d){
      return { date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) };
    }
    function daysFromToday(iso){
      try{ var d=new Date(String(iso)+'T00:00:00'); var t=new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch(e){return 0;}
    }
    function hueForDays(diff){
      if(isNaN(diff)) return 205;
      if(diff <= -7) return 0;
      if(diff < 0)   return 10;
      var max=30; return Math.round(10 + (Math.min(diff,max)/max)*120);
    }
    function bgForHue(h){ return 'hsl('+h+' 90% 92%)'; }

    function renderTareaItem(x){
      var diff = daysFromToday(x.date);
      var h = hueForDays(diff);
      var bg = bgForHue(h);
      var li=document.createElement('li'); li.className='item';
      li.style.borderLeft = '6px solid hsl('+h+' 72% 46%)';
      li.innerHTML='<span class="pill date" style="background:'+bg+';border-color:hsl('+h+' 70% 72%)">'+esc(pillForDate(x.date))+'</span>'
        + '<div class="text"><div class="line">'+esc(x.text||'')+'</div></div>'
        + '<div class="toolbar actions"></div>';
      var a=li.querySelector('.actions');
      a.appendChild(makeBtn('Hecha',function(){upd('tareas',x.__id,{status:'done'});},'btn icon'));
      a.appendChild(makeBtn('Editar',function(){editTarea(x);},'btn icon'));
      a.appendChild(makeBtn('Borrar',function(){upd('tareas',x.__id,{status:'trash'});},'btn icon'));
      return li;
    }
    function renderTareaDone(x){
      var li=document.createElement('li'); li.className='item';
      li.style.borderLeft = '6px solid hsl(150 50% 38%)';
      li.innerHTML='<span class="pill date">'+esc(pillForDate(x.date))+'</span>'
        + '<div class="text"><div class="line strike">'+esc(x.text||'')+'</div></div>'
        + '<div class="toolbar actions"></div>';
      var a=li.querySelector('.actions');
      a.appendChild(makeBtn('Restaurar',function(){upd('tareas',x.__id,{status:'active'});},'btn icon'));
      a.appendChild(makeBtn('Eliminar',function(){del('tareas',x.__id);},'btn icon'));
      return li;
    }
    function renderTareaTrash(x){
      var li=document.createElement('li'); li.className='item';
      li.innerHTML='<span class="pill date">'+esc(pillForDate(x.date))+'</span>'
        + '<div class="text muted"><div class="line">'+esc(x.text||'')+'</div></div>'
        + '<div class="toolbar actions"></div>';
      var a=li.querySelector('.actions');
      a.appendChild(makeBtn('Recuperar',function(){upd('tareas',x.__id,{status:'active'});},'btn icon'));
      a.appendChild(makeBtn('Eliminar',function(){del('tareas',x.__id);},'btn icon'));
      return li;
    }
    function editTarea(x){
      openEdit(
        [{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'Descripción',id:'t_text',v:x.text||''}],
        async function(){ await upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')}); }
      );
    }

    function setupTareas(uid){
      var dateEl=$('#t-date'); if(dateEl) dateEl.value=todayISO();
      $('#t-add').onclick=async function(){
        var date=$('#t-date').value; var text=$('#t-text').value.trim(); if(!text) return;
        await fsMod.addDoc(col.tareas(uid), tareaDoc({date:date,text:text})); $('#t-text').value='';
      };
      var qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
      var qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
      var qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

      var u1=fsMod.onSnapshot(qA,function(snap){
        var arr=[]; snap.forEach(function(d){var x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort(function(a,b){ return daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt&&b.createdAt.seconds||0)-(a.createdAt&&a.createdAt.seconds||0); });
        var list=$('#t-list'); list.innerHTML=''; var n=0;
        idle(function(){ for(var i=0;i<arr.length;i++){ list.appendChild(renderTareaItem(arr[i])); n++; } $('#t-count').textContent=String(n); $('#t-empty').style.display=n?'none':'block'; setNotif(n); });
      });
      var u2=fsMod.onSnapshot(qD,function(s){
        var arr=[]; s.forEach(function(d){var x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort(function(a,b){ return (b.updatedAt&&b.updatedAt.seconds||0)-(a.updatedAt&&a.updatedAt.seconds||0); });
        var l=$('#t-done'); l.innerHTML=''; var n=0;
        idle(function(){ for(var i=0;i<arr.length;i++){ l.appendChild(renderTareaDone(arr[i])); n++; } $('#t-done-empty').style.display=n?'none':'block'; $('#t-done-count').textContent=String(n); });
      });
      var u3=fsMod.onSnapshot(qT,function(s){
        var arr=[]; s.forEach(function(d){var x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort(function(a,b){ return (b.updatedAt&&b.updatedAt.seconds||0)-(a.updatedAt&&a.updatedAt.seconds||0); });
        var l=$('#t-trash'); l.innerHTML=''; var n=0;
        idle(function(){ for(var i=0;i<arr.length;i++){ l.appendChild(renderTareaTrash(arr[i])); n++; } $('#t-trash-empty').style.display=n?'none':'block'; $('#t-trash-count').textContent=String(n); });
      });
      $('#t-emptyTrash').onclick=function(){ emptyTrash(uid,'tareas'); };
      unsubs.push(u1,u2,u3);
    }

    /* ===== DIRECTORIO ===== */
    function dirDoc(d){
      return {
        seccion:String(d.seccion||'').trim()||'Sin sección',
        nombre:String(d.nombre||'').trim()||'Sin nombre',
        telefono:String(d.telefono||'').trim(),
        notas:String(d.notas||'').trim(),
        createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64)
      };
    }
    var dirCache=[];

    function setupDirectorio(uid){
      $('#d-add').onclick=async function(){
        var d=dirDoc({
          seccion:prompt('Sección')||'',
          nombre:prompt('Nombre')||'',
          telefono:prompt('Teléfonos (formato libre)')||'',
          notas:''
        });
        await fsMod.addDoc(col.dir(uid),d);
      };
      $('#d-import').onclick=importDir(uid);
      $('#d-export').onclick=exportDir(uid);
      var u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),function(s){
        dirCache=[]; s.forEach(function(d){var x=d.data(); x.__id=d.id; dirCache.push(x);});
        renderDirList();
      });
      $('#d-q').addEventListener('input', renderDirList, {passive:true});
      unsubs.push(u);
    }

    function phonesToChips(raw){
      var parts = String(raw||'').split(/[,;\n]| {2,}/).map(function(s){return s.trim();}).filter(function(Boolean){return Boolean;});
      var out=[]; for(var i=0;i<parts.length;i++){ out.push('<span class="phone-chip" dir="ltr">'+esc(parts[i])+'</span>'); }
      return out.join(' ');
    }

    var SEC_HUES = [205, 156, 28, 222, 10, 280, 190, 330];
    function hueFromString(s){
      var h=0; for(var i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) & 0xffffffff;
      return SEC_HUES[Math.abs(h) % SEC_HUES.length];
    }
    function sectionHeaderStyle(sec, count){
      var h = hueFromString(sec||'');
      return {
        hdr:'background-image:linear-gradient(179deg, hsl('+h+' 62% 46%), hsl('+h+' 58% 40%));',
        sep:'background-image:linear-gradient(90deg, hsl('+h+' 70% 52%), hsl('+h+' 60% 46%));',
        label:String(sec || 'Sin sección'),
        count:String(count)
      };
    }

    function renderDirList(){
      var qEl = $('#d-q'); var v = qEl ? String(qEl.value||'').toLowerCase() : '';
      var l=$('#d-list'); if(!l) return; l.innerHTML='';
      var arr=dirCache.filter(function(x){
        if(!v) return true;
        var s1=String(x.seccion||'').toLowerCase();
        var s2=String(x.nombre||'').toLowerCase();
        var s3=String(x.telefono||'').toLowerCase();
        var s4=String(x.notas||'').toLowerCase();
        return s1.indexOf(v)>-1 || s2.indexOf(v)>-1 || s3.indexOf(v)>-1 || s4.indexOf(v)>-1;
      });
      arr.sort(function(a,b){ return (a.seccion||'').localeCompare(b.seccion||'') || (a.nombre||'').localeCompare(b.nombre||''); });

      var groups = new Map();
      for(var i=0;i<arr.length;i++){ var x=arr[i]; var k = x.seccion || 'Sin sección'; if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(x); }

      var total=0; var first=true;
      groups.forEach(function(items, sec){
        var meta = sectionHeaderStyle(sec, items.length);

        if(!first){
          var sep=document.createElement('div');
          sep.className='group-sep';
          sep.setAttribute('aria-hidden','true');
          sep.style.cssText = meta.sep;
          l.appendChild(sep);
        }
        first=false;

        var gLi=document.createElement('li'); gLi.className='group-li'; gLi.setAttribute('role','presentation');
        var hdr=document.createElement('div'); hdr.className='group-hdr'; hdr.setAttribute('role','heading'); hdr.setAttribute('aria-level','3'); hdr.style.cssText = meta.hdr;
        var sLeft=document.createElement('span'); sLeft.textContent=meta.label;
        var sRight=document.createElement('span'); sRight.className='group-count'; sRight.textContent=meta.count;
        hdr.appendChild(sLeft); hdr.appendChild(sRight); gLi.appendChild(hdr);
        l.appendChild(gLi);

        for(var j=0;j<items.length;j++){ l.appendChild(renderDir(items[j])); }
        total += items.length;
      });
      $('#d-count').textContent = String(total)+' registros';
      $('#d-empty').style.display = total ? 'none' : 'block';
    }

    function renderDir(x){
      var li=document.createElement('li'); li.className='item';
      var left=document.createElement('span'); left.className='pill section'; left.textContent=String(x.seccion||'—');
      var center=document.createElement('div'); center.className='text';
      var name=document.createElement('div'); name.className='line'; name.innerHTML='<strong>'+esc(x.nombre||'')+'</strong>';
      var phones=document.createElement('div'); phones.className='line'; phones.innerHTML=phonesToChips(x.telefono);
      center.appendChild(name); center.appendChild(phones);
      if(x.notas){ var notas=document.createElement('div'); notas.className='muted'; notas.textContent=String(x.notas); center.appendChild(notas); }
      var actions=document.createElement('div'); actions.className='toolbar actions';
      actions.appendChild(makeBtn('Editar',function(){editDir(x);},'btn icon'));
      actions.appendChild(makeBtn('Borrar',function(){del('directorio',x.__id);},'btn icon'));
      li.appendChild(left); li.appendChild(center); li.appendChild(actions);
      return li;
    }
    function editDir(x){
      openEdit(
        [{l:'Sección',id:'d_sec',v:x.seccion||''},{l:'Nombre',id:'d_nom',v:x.nombre||''},{l:'Teléfonos',id:'d_tel',v:x.telefono||''},{l:'Notas',id:'d_not',v:x.notas||''}],
        async function(){ await upd('directorio',x.__id,{seccion:val('d_sec'),nombre:val('d_nom'),telefono:val('d_tel'),notas:val('d_not')}); }
      );
    }
    function importDir(uid){
      return async function(){
        try{
          var txt=await pickReadText(); var arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inválido');
          var snap=await fsMod.getDocs(col.dir(uid));
          function key(o){ return (String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase(); }
          var set=new Set(snap.docs.map(function(d){ return key(d.data()); }));
          var ops=[]; for(var i=0;i<arr.length;i++){ var o=arr[i]; if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); }
          await Promise.all(ops); toast('Importado ('+ops.length+')');
        }catch(e){ toast(e && e.message ? String(e.message) : String(e)); }
      };
    }
    function exportDir(uid){
      return async function(){
        var snap=await fsMod.getDocs(fsMod.query(col.dir(uid)));
        var out=snap.docs.map(function(d){ var obj=d.data(); obj.id=d.id; return obj; });
        var blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
        await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado');
      };
    }

    function mountApp(uid){
      setupPlanta(uid); setupTareas(uid); setupDirectorio(uid);
      var last = localStorage.getItem('tab') || 'planta';
      selectTab(last);
    }
    async function upd(kind,id,patch){ var ref=fsMod.doc(db,'users',currentUid(),kind,id); await fsMod.updateDoc(ref,Object.assign({},patch,{updatedAt:serverTS()})); }
    async function del(kind,id){ await fsMod.deleteDoc(fsMod.doc(db,'users',currentUid(),kind,id)); }
    async function emptyTrash(uid,kind){
      var q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash'));
      var s=await fsMod.getDocs(q);
      await Promise.all(s.docs.map(function(x){ return fsMod.deleteDoc(x.ref); }));
      toast('Papelera vaciada');
    }

    async function pickReadText(){
      if('showOpenFilePicker' in window){
        var handles=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]});
        var f=await handles[0].getFile(); return await f.text();
      }
      return await new Promise(function(res,rej){
        var i=document.createElement('input'); i.type='file'; i.accept='.json,application/json';
        i.onchange=function(){
          var f=i.files && i.files[0]; if(!f) return rej(new Error('Cancelado'));
          var r=new FileReader(); r.onload=function(){ res(String(r.result||'')); }; r.onerror=function(){ rej(new Error('Error leyendo')); }; r.readAsText(f);
        };
        i.click();
      });
    }
    async function pickWriteBlob(blob,name){
      if('showSaveFilePicker' in window){
        var h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]});
        var w=await h.createWritable(); await w.write(blob); await w.close(); return;
      }
      var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }

    var deferredPrompt=null;
    addEventListener('beforeinstallprompt',function(e){ e.preventDefault(); deferredPrompt=e; $('#installBanner').setAttribute('aria-hidden','false'); });
    $('#installAction').onclick=async function(){ if(deferredPrompt){ await deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').setAttribute('aria-hidden','true'); } };
    $('#installBtn').onclick=function(){ $('#installAction').click(); };

    if('serviceWorker' in navigator){
      const reg=await navigator.serviceWorker.register(BASE+'sw.js');
      navigator.serviceWorker.addEventListener('controllerchange',function(){ location.reload(); });
      function showUpdate(){ $('#updateBanner').setAttribute('aria-hidden','false'); $('#reloadNow').onclick=function(){ if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); }; }
      if(reg.waiting) showUpdate();
      reg.addEventListener('updatefound',function(){ var sw=reg.installing; if(!sw) return; sw.addEventListener('statechange',function(){ if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate(); }); });
    }

    selectTab('planta');
  </script>
</body>
</html>
