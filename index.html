<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#E5E9F0"/>
  <meta name="description" content="Planta ‚Äî PWA de planta e interconsultas. Local-first, instalable, sincroniza con Firestore y funciona offline."/>
  <!-- üëá Manifiesto CONSISTENTE con /Planta/ -->
  <link rel="manifest" href="./manifest.webmanifest"/>
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png"/>
  <link rel="apple-touch-icon" href="./icons/icon-192.png"/>
  <title>Planta ‚Äî PWA</title>
  <style>
    :root{
      --bg:#fff; --ink:#0b1220; --muted:#667085; --primary:#2563eb; --primary-600:#1d4ed8;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --card:#fff; --soft:0 2px 10px rgba(2,6,23,.06);
      --hard:0 6px 24px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06); --radius:18px; --pad:16px; --gap:14px; --tap:48px;
    }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1000px;margin:0 auto;padding:clamp(12px,2vw,24px)}
    header.appbar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.05) blur(6px);
      background:color-mix(in oklab,#fff 90%,transparent);border-bottom:1px solid rgba(2,6,23,.06)}
    .row{display:flex;align-items:center;gap:12px;min-height:64px}
    .brand{display:flex;align-items:center;gap:12px;flex:1}
    .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 200deg at 50% 50%,#93c5fd,#3b82f6,#2563eb,#1d4ed8,#93c5fd);
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.9),0 6px 18px rgba(37,99,235,.25)}
    .brand h1{margin:0;font-size:18px}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{border-radius:999px;padding:6px 10px;font-size:12px;background:#f3f4f6;color:#0b1220;border:1px solid rgba(2,6,23,.06)}
    .online{background:#dcfce7;color:#065f46;border-color:rgba(16,185,129,.25)}
    .offline{background:#fee2e2;color:#991b1b;border-color:rgba(239,68,68,.25)}
    .userchip{display:flex;align-items:center;gap:8px}
    .userchip img{width:28px;height:28px;border-radius:50%;box-shadow:var(--soft)}
    button{appearance:none;border:0;border-radius:12px;min-height:var(--tap);padding:10px 14px;cursor:pointer;font:inherit;color:#0b1220;background:#f3f4f6;box-shadow:var(--soft);
      display:inline-flex;gap:10px;align-items:center;transition:transform .06s,box-shadow .2s,background .2s}
    button.primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;box-shadow:0 6px 22px rgba(37,99,235,.28)}
    button.ghost{background:transparent;box-shadow:none;color:var(--primary)}
    button:active{transform:translateY(1px) scale(.995)} button[disabled]{opacity:.45;filter:grayscale(.3);cursor:not-allowed;box-shadow:none}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--hard);padding:var(--pad)}
    .grid{display:grid;gap:var(--gap)} .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid rgba(37,99,235,.18);cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(135deg,#e0e7ff,#dbeafe);border-color:color-mix(in oklab,var(--primary) 30%, transparent);box-shadow:inset 0 0 0 2px rgba(37,99,235,.12)}
    .composer{display:grid;gap:10px;grid-template-columns:120px 1fr 180px auto;align-items:center}
    .field{display:flex;align-items:center;gap:10px;background:#f8fafc;padding:10px 12px;border-radius:14px;border:1px solid rgba(2,6,23,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}
    .field input{flex:1;border:0;outline:0;background:transparent;min-height:36px;font-size:16px}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;grid-column:1/-1}
    .chip{padding:8px 12px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid rgba(37,99,235,.18);cursor:pointer;font-size:13px}
    .chip[data-selected="true"]{background:#dcfce7;color:#065f46;border-color:rgba(16,185,129,.25)}
    ul.tasks{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .task{display:grid;grid-template-columns:120px 1fr 180px auto;align-items:center;gap:12px;background:#fff;border-radius:14px;padding:10px 12px;border:1px solid rgba(2,6,23,.06);box-shadow:var(--soft)}
    .room{font-weight:700;letter-spacing:.5px;border-radius:10px;padding:8px 10px;background:#eef2ff;color:#1e3a8a;justify-self:start;min-width:100px;text-align:center}
    .task__text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .pendiente{border-radius:999px;padding:8px 12px;background:#fff7ed;color:#9a3412;justify-self:end;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .task__actions{display:flex;gap:6px;justify-self:end}
    .btn-icon{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:#f3f4f6}
    .btn-icon.success{background:#dcfce7;color:#065f46}.btn-icon.warn{background:#fff7ed;color:#9a3412}.btn-icon.danger{background:#fee2e2;color:#991b1b}
    .completed .task{opacity:.95;background:#f9fafb}.completed .task__text{text-decoration:line-through;color:#4b5563}
    .banner{display:none;margin-top:12px;padding:12px;border-radius:14px;border:1px dashed rgba(37,99,235,.35);background:#f0f6ff}
    .banner[aria-hidden="false"]{display:block}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--hard);max-width:92vw}
    .toast[hidden]{display:none}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.35)}
    .modal[aria-hidden="false"]{display:grid}
    .modal .dialog{background:#fff;border-radius:16px;box-shadow:var(--hard);padding:18px;max-width:480px;width:calc(100% - 32px)}
    .dialog .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    @media (max-width:880px){
      .composer{grid-template-columns:100px 1fr; grid-auto-rows:auto}
      .composer .field:nth-child(1){grid-column:1/2}
      .composer .field:nth-child(2){grid-column:2/3}
      .composer .field:nth-child(3){grid-column:1/3}
      .composer button{grid-column:1/3}
      .task{grid-template-columns:100px 1fr; grid-auto-rows:auto}
      .task .pendiente{grid-column:1/2; justify-self:start; margin-top:6px}
      .task .task__actions{grid-column:2/3}
    }
    .help{font-size:12px;color:var(--muted);margin-top:6px}.err{color:#b91c1c}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="container row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Planta</h1>
          <div class="badges">
            <div id="badge-online" class="badge offline" aria-live="polite">Offline</div>
            <div id="badge-auth" class="badge offline" aria-live="polite">Google: desconectado</div>
          </div>
          <div id="authHint" class="help"></div>
        </div>
      </div>
      <div class="userchip" id="userchip" hidden>
        <img id="avatar" alt="" referrerpolicy="no-referrer"/>
        <span id="displayname"></span>
      </div>
      <div class="actions">
        <button id="installBtn" class="ghost">‚ûï Instalar</button>
        <button id="signin" class="primary">Acceder</button>
        <button id="signout" class="ghost" style="display:none">Salir</button>
      </div>
    </div>
  </header>

  <main class="container grid" style="margin-top:16px">
    <section id="authGate" class="card" role="region" aria-live="polite" style="text-align:center;padding:26px">
      <h2 style="margin:0 0 6px 0">Bienvenido</h2>
      <p style="margin:0 0 16px 0;color:var(--muted)">Accede con Google para sincronizar entre dispositivos.</p>
      <button id="signin2" class="primary">Acceder con Google</button>
      <div id="authErr" class="err" style="margin-top:10px;min-height:1.2em"></div>
    </section>

    <section id="ui" class="grid" hidden>
      <div id="updateBanner" class="banner" aria-hidden="true">
        <b>Nueva versi√≥n disponible.</b> <button id="reloadNow" class="primary" style="margin-left:8px">Actualizar</button>
      </div>
      <div id="installBanner" class="banner" aria-hidden="true">
        <b>Instala Planta</b> para acceso m√°s r√°pido. <button id="installAction" class="primary" style="margin-left:8px">Instalar</button>
      </div>

      <div class="card grid" role="region" aria-labelledby="tabs-label">
        <div id="tabs-label" class="section-title">Listas</div>
        <div class="tabs" role="tablist" aria-label="Listas">
          <button class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" id="tab-planta">Planta</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-inter" id="tab-inter">Interconsultas</button>
        </div>

        <!-- PLANTA -->
        <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta">
          <div class="composer" style="margin-top:12px">
            <div class="field" aria-label="Habitaci√≥n">
              <input id="room-planta" type="text" inputmode="numeric" placeholder="421-2" pattern="\\d{3}-\\d" title="Formato ###-#" maxlength="5" required />
            </div>
            <div class="field" aria-label="Descripci√≥n (m√≠n 20)">
              <input id="desc-planta" type="text" placeholder="Descripci√≥n (‚â•20 caracteres)" minlength="20" required />
            </div>
            <div class="field" aria-label="Pendiente (m√°x 15)">
              <input id="pend-planta" type="text" placeholder="Pendiente (‚â§15 caracteres)" maxlength="15" />
            </div>
            <button class="primary" id="add-planta" title="A√±adir tarea de planta" disabled>A√±adir</button>
            <div class="chips">
              <span>Prioridad:</span>
              <button class="chip" data-prio="baja" data-list="planta">Baja</button>
              <button class="chip" data-prio="media" data-selected="true" data-list="planta">Media</button>
              <button class="chip" data-prio="alta" data-list="planta">Alta</button>
            </div>
            <div id="val-planta" class="help"></div>
          </div>
          <h3 class="section-title">En curso</h3>
          <ul id="list-planta" class="tasks" aria-live="polite"></ul>
        </div>

        <!-- INTERCONSULTAS -->
        <div id="panel-inter" role="tabpanel" aria-labelledby="tab-inter" hidden>
          <div class="composer" style="margin-top:12px">
            <div class="field" aria-label="Habitaci√≥n">
              <input id="room-inter" type="text" inputmode="numeric" placeholder="421-2" pattern="\\d{3}-\\d" title="Formato ###-#" maxlength="5" required />
            </div>
            <div class="field" aria-label="Descripci√≥n (m√≠n 20)">
              <input id="desc-inter" type="text" placeholder="Descripci√≥n (‚â•20 caracteres)" minlength="20" required />
            </div>
            <div class="field" aria-label="Pendiente (m√°x 15)">
              <input id="pend-inter" type="text" placeholder="Pendiente (‚â§15 caracteres)" maxlength="15" />
            </div>
            <button class="primary" id="add-inter" title="A√±adir interconsulta" disabled>A√±adir</button>
            <div class="chips">
              <span>Prioridad:</span>
              <button class="chip" data-prio="baja" data-list="inter">Baja</button>
              <button class="chip" data-prio="media" data-selected="true" data-list="inter">Media</button>
              <button class="chip" data-prio="alta" data-list="inter">Alta</button>
            </div>
            <div id="val-inter" class="help"></div>
          </div>
          <h3 class="section-title">En curso</h3>
          <ul id="list-inter" class="tasks" aria-live="polite"></ul>
        </div>
      </div>

      <div class="card grid completed" role="region" aria-labelledby="comp-title">
        <div id="comp-title" class="section-title">Completadas</div>
        <ul id="list-completed" class="tasks" aria-live="polite"></ul>
        <div class="actions" style="justify-content:flex-end">
          <button id="emptyTrash" class="btn danger">Vaciar papelera</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal logout -->
  <div id="modal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="dialog">
      <div class="title" style="font-weight:700;margin-bottom:6px">¬øCerrar sesi√≥n?</div>
      <div class="body" style="color:var(--muted)">Se cerrar√° la sesi√≥n en este dispositivo.</div>
      <div class="actions">
        <button id="cancelLogout">Cancelar</button>
        <button id="confirmLogout" class="primary">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" hidden></div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    // ---------- Utilidades UI ----------
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const toast = $('#toast');
    const badgeOnline = $('#badge-online');
    const badgeAuth = $('#badge-auth');
    const authHint = $('#authHint');
    const showToast = (msg)=>{ toast.textContent = msg; toast.hidden = false; setTimeout(()=>toast.hidden=true, 4200); };

    const setOnline = ()=>{ const on = navigator.onLine;
      badgeOnline.textContent = on ? 'Online' : 'Offline';
      badgeOnline.classList.toggle('online', on);
      badgeOnline.classList.toggle('offline', !on);
    };
    window.addEventListener('online', setOnline); window.addEventListener('offline', setOnline); setOnline();

    // ---------- PWA (SW/Install/Update) ----------
    let deferredPrompt = null;
    const installBanner = $('#installBanner');
    const updateBanner = $('#updateBanner');
    const installBtn = $('#installBtn');
    const installAction = $('#installAction');
    const reloadNow = $('#reloadNow');

    if ('serviceWorker' in navigator) {
      const url = new URL('./sw.js', location.href);
      navigator.serviceWorker.register(url, { scope: './' }).then(async reg=>{
        try{ await reg.update(); }catch{}
        const onWaiting = (sw)=>{ if (sw && sw.state === 'installed' && navigator.serviceWorker.controller) updateBanner.setAttribute('aria-hidden','false'); };
        if (reg.waiting) onWaiting(reg.waiting);
        reg.addEventListener('updatefound', ()=>{ const sw = reg.installing; sw?.addEventListener('statechange', ()=> onWaiting(sw)); });
      }).catch(console.error);

      window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBanner.setAttribute('aria-hidden','false'); });
    }
    const doInstall = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBanner.setAttribute('aria-hidden','true'); };
    installBtn.addEventListener('click', doInstall);
    installAction?.addEventListener('click', doInstall);
    reloadNow?.addEventListener('click', async ()=>{ const reg = await navigator.serviceWorker.getRegistration(); if (reg?.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); });
    navigator.serviceWorker?.addEventListener('controllerchange', ()=> location.reload());

    // ---------- Estado app ----------
    const state = { user:null, prio:{ planta:'media', inter:'media' } };

    // Tabs
    const tabPlanta = $('#tab-planta'), tabInter = $('#tab-inter');
    const panelPlanta = $('#panel-planta'), panelInter = $('#panel-inter');
    function setTab(which){
      const isPlanta = which==='planta';
      tabPlanta.setAttribute('aria-selected', isPlanta?'true':'false');
      tabInter.setAttribute('aria-selected', isPlanta?'false':'true');
      panelPlanta.hidden = !isPlanta; panelInter.hidden = isPlanta;
      (isPlanta?$('#room-planta'):$('#room-inter'))?.focus();
      updateAddButtons();
    }
    tabPlanta.addEventListener('click',()=>setTab('planta'));
    tabInter.addEventListener('click',()=>setTab('inter'));

    // Chips prioridad
    $$('.chip').forEach(ch=>{
      ch.addEventListener('click',()=>{
        const list = ch.dataset.list;
        $$('.chip[data-list="'+list+'"]').forEach(c=>c.removeAttribute('data-selected'));
        ch.setAttribute('data-selected','true');
        state.prio[list==='inter'?'inter':'planta'] = ch.dataset.prio;
      });
    });

    // Sanitizador & parse habitaci√≥n
    const sanitize = (s)=> (s ?? '').toString().replace(/[<>]/g,'').trim();
    const parseRoom = (s)=>{
      if(!s) return null;
      const m = s.trim().match(/^(\\d{3})-(\\d)$/);
      if(!m) return null;
      const planta = parseInt(m[1],10), cama = parseInt(m[2],10);
      return { room: `${m[1]}-${m[2]}`, sortKey: planta*10 + cama };
    };

    // Validaci√≥n de inputs + habilitaci√≥n de botones A√±adir
    function inputsOk(prefix){
      const room = $(`#room-${prefix}`).value;
      const desc = $(`#desc-${prefix}`).value;
      const pend = $(`#pend-${prefix}`).value;
      const validRoom = !!parseRoom(room);
      const validDesc = !!desc && desc.trim().length >= 20;
      const validPend = !pend || pend.trim().length <= 15;
      return { ok: validRoom && validDesc && validPend, validRoom, validDesc, validPend };
    }
    function updateAddButtons(){
      const connected = !!state.user;
      const p1 = inputsOk('planta'); const p2 = inputsOk('inter');
      $('#add-planta').disabled = !(connected && p1.ok);
      $('#add-inter').disabled  = !(connected && p2.ok);
      $('#val-planta').textContent = connected ? (!p1.validRoom ? 'Habitaci√≥n ###-#' : (!p1.validDesc ? 'Descripci√≥n ‚â• 20' : (!p1.validPend ? 'Pendiente ‚â§ 15' : ''))) : 'Accede con Google';
      $('#val-inter').textContent  = connected ? (!p2.validRoom ? 'Habitaci√≥n ###-#' : (!p2.validDesc ? 'Descripci√≥n ‚â• 20' : (!p2.validPend ? 'Pendiente ‚â§ 15' : ''))) : 'Accede con Google';
    }
    ['room-planta','desc-planta','pend-planta','room-inter','desc-inter','pend-inter'].forEach(id=>{
      $(`#${id}`).addEventListener('input', updateAddButtons);
      $(`#${id}`).addEventListener('change', updateAddButtons);
      $(`#${id}`).addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          if(id.includes('planta')) $('#add-planta').click();
          else $('#add-inter').click();
        }
      });
    });

    // ---------- Firebase (lazy import) ----------
    let appMod, authMod, fsMod, app, auth, db;
    // Declarar funciones ANTES del destructuring (evita "getFirestore is not defined")
    let getFirestore, enableIndexedDbPersistence, serverTimestamp,
        onSnapshot, collection, addDoc, doc, deleteDoc, updateDoc,
        getDoc, getDocs, query, orderBy, writeBatch;
    let GoogleAuthProvider, getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut, useDeviceLanguage;

    async function initFirebase(){
      [appMod, authMod, fsMod] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'),
        import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js')
      ]);
      app = appMod.initializeApp(firebaseConfig);

      ({ getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut, useDeviceLanguage } = authMod);
      auth = getAuth(app);
      try{ useDeviceLanguage(auth); }catch{}

      ({
        getFirestore, enableIndexedDbPersistence, serverTimestamp,
        collection, addDoc, doc, deleteDoc, updateDoc, getDoc, getDocs,
        onSnapshot, query, orderBy, writeBatch
      } = fsMod);
      db = getFirestore(app);

      try { await setPersistence(auth, browserLocalPersistence); } catch {}
      try { await enableIndexedDbPersistence(db); } catch(e) { console.warn('IndexedDB persistence no habilitada:', e?.code || e?.message || e); }

      // Resultado de redirect (si lo hubo)
      try { const res = await getRedirectResult(auth); if (res?.user) { showToast('Sesi√≥n iniciada (redirect)'); } }
      catch(err) { console.error('Redirect error:', err); document.getElementById('authErr').textContent = (err?.message || err?.code) || 'Error tras redirigir el acceso.'; }
    }
    await initFirebase();

    // ---------- Auth UI ----------
    const userchip = $('#userchip'), avatar = $('#avatar'), displayname = $('#displayname');
    const authErr = $('#authErr');
    const addPlantaBtn = $('#add-planta'), addInterBtn = $('#add-inter');

    function setAuthBadge(connected){
      badgeAuth.textContent = connected ? 'Google: conectado' : 'Google: desconectado';
      badgeAuth.classList.toggle('online', connected);
      badgeAuth.classList.toggle('offline', !connected);
      authHint.textContent = connected ? '' :
        'Si el acceso falla: Firebase ‚Üí Authentication ‚Üí Google (Enable) y Authorized domains: a√±ade crasasito.github.io';
    }

    const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    async function doSignin(e){
      authErr.textContent = '';
      const provider = new GoogleAuthProvider();
      const forcePopup = e?.shiftKey && !isMobile; // Shift+Click ‚Üí popup
      try{
        if (isMobile || !forcePopup) await signInWithRedirect(auth, provider);
        else await signInWithPopup(auth, provider);
      }catch(err){
        const code = err?.code || '';
        if (!isMobile && (code.includes('popup') || code.includes('operation-not-supported'))) {
          try { await signInWithRedirect(auth, provider); return; } catch(err2) {
            const msg2 = (err2?.message || err2?.code) || 'Error de acceso con Google (redirect)';
            authErr.textContent = msg2; showToast(msg2); console.error('Auth redirect error:', err2);
          }
        } else {
          const msg = (err?.message || err?.code) || 'Error de acceso con Google';
          authErr.textContent = msg; showToast(msg); console.error('Auth error:', err);
          if (String(msg).includes('unauthorized-domain')) {
            authHint.textContent = 'A√±ade crasasito.github.io en Firebase ‚Üí Authentication ‚Üí Authorized domains.';
          }
        }
      }
    }
    $('#signin').addEventListener('click', doSignin);
    $('#signin2').addEventListener('click', doSignin);

    // Logout con modal
    const modal = $('#modal'); const openModal=()=>modal.setAttribute('aria-hidden','false'); const closeModal=()=>modal.setAttribute('aria-hidden','true');
    $('#signout').addEventListener('click', openModal);
    $('#cancelLogout').addEventListener('click', closeModal);
    $('#confirmLogout').addEventListener('click', async ()=>{ closeModal(); try{ await signOut(auth); } catch(e){ console.error(e); } });

    const authGate = $('#authGate'), ui = $('#ui');
    const signInBtn = $('#signin'], signOutBtn = $('#signout');

    onAuthStateChanged(auth, (user)=>{
      state.user = user || null;
      const connected = !!user;
      setAuthBadge(connected);
      addPlantaBtn.disabled = !connected;
      addInterBtn.disabled = !connected;
      updateAddButtons();

      if(!user){
        ui.hidden = true; authGate.hidden = false;
        signInBtn.style.display = ''; signOutBtn.style.display = 'none';
        userchip.hidden = true; avatar.src=''; displayname.textContent='';
        return;
      }
      signInBtn.style.display = 'none'; signOutBtn.style.display = '';
      authGate.hidden = true; ui.hidden = false;
      userchip.hidden = false; avatar.src = user.photoURL || ''; displayname.textContent = user.displayName || user.email || '';
      subscribeAll().then(backfillSortKeys).catch(console.error);
    });

    // ---------- Firestore ----------
    const colRef = (name)=>collection(db,'users',state.user.uid,name);

    function renderList(ul, snap, {completed=false}={}){
      const frag = document.createDocumentFragment();
      for(const d of snap.docs){
        const item = d.data();
        const li = document.createElement('li');
        li.className='task'; li.dataset.id=d.id; li.dataset.col=d.ref.parent.id;

        const room = document.createElement('div'); room.className = 'room'; room.textContent = item.habitacion || '---';
        const text = document.createElement('div'); text.className='task__text'; text.textContent=sanitize(item.descripcion || '(sin descripci√≥n)'); text.title = item.descripcion || '';
        const pend = document.createElement('div'); pend.className='pendiente'; pend.textContent=sanitize(item.pendiente || ''); pend.title = item.pendiente || '';

        const actions = document.createElement('div'); actions.className='task__actions';
        if(!completed){
          const done = document.createElement('button'); done.className='btn-icon success'; done.title='Marcar como completada'; done.textContent='‚úî';
          const edit = document.createElement('button'); edit.className='btn-icon warn'; edit.title='Editar pendiente'; edit.textContent='‚úé';
          const del = document.createElement('button'); del.className='btn-icon danger'; del.title='Eliminar'; del.textContent='üóë';
          done.addEventListener('click', ()=>completeTask(d.id, d.ref.parent.id));
          edit.addEventListener('click', ()=>editPendiente(d.id, d.ref.parent.id, item.pendiente||''));
          del.addEventListener('click', ()=>deleteTask(d.id, d.ref.parent.id));
          actions.append(done, edit, del);
        }else{
          const undo = document.createElement('button'); undo.className='btn-icon warn'; undo.title='Deshacer'; undo.textContent='‚Ü©';
          undo.addEventListener('click', ()=>undoTask(d.id, item.previousList || 'planta'));
          actions.append(undo);
        }
        li.append(room, text, pend, actions);
        frag.appendChild(li);
      }
      requestAnimationFrame(()=>{ ul.replaceChildren(frag); });
    }

    let unsubPlanta=null, unsubInter=null, unsubComp=null;
    async function subscribeAll(){
      unsubPlanta?.(); unsubInter?.(); unsubComp?.();
      unsubPlanta = onSnapshot(query(colRef('planta'), orderBy('sortKey','asc')), (snap)=>renderList($('#list-planta'),snap));
      unsubInter  = onSnapshot(query(colRef('interconsultas'), orderBy('sortKey','asc')), (snap)=>renderList($('#list-inter'),snap));
      unsubComp   = onSnapshot(query(colRef('completadas'), orderBy('completedAt','desc')), (snap)=>renderList($('#list-completed'),snap,{completed:true}));
    }

    async function backfillSortKeys(){
      const lists = ['planta','interconsultas'];
      for (const L of lists){
        try{
          const snap = await getDocs(colRef(L));
          for (const d of snap.docs){
            const it = d.data();
            if (typeof it.sortKey !== 'number' && typeof it.habitacion === 'string'){
              const parsed = parseRoom(it.habitacion);
              if (parsed){
                await updateDoc(doc(db,'users',state.user.uid,L,d.id), { sortKey: parsed.sortKey });
              }
            }
          }
        }catch(e){ console.warn('backfill error', L, e); }
      }
    }

    // ADD
    async function addTask(listName, roomVal, descVal, pendVal, prioridad){
      if(!state.user){ showToast('Debes iniciar sesi√≥n con Google.'); return; }
      const parsed = parseRoom(roomVal);
      if(!parsed){ showToast('Habitaci√≥n inv√°lida, usa ###-#'); return; }
      const desc = sanitize(descVal);
      const pend = sanitize(pendVal);
      if(!desc || desc.length < 20){ showToast('Descripci√≥n ‚â• 20 caracteres'); return; }
      if(pend && pend.length > 15){ showToast('Pendiente ‚â§ 15 caracteres'); return; }

      const payload = {
        habitacion: parsed.room, sortKey: parsed.sortKey,
        descripcion: desc, pendiente: pend || '',
        prioridad, createdAt: serverTimestamp(), updatedAt:serverTimestamp()
      };
      try{
        await addDoc(colRef(listName), payload);
      }catch(err){
        console.error('addDoc error:', err);
        const msg = (err?.message || err?.code) || 'Error al guardar';
        showToast(msg);
        if (String(msg).includes('permission-denied') || String(msg).includes('unauthorized-domain')){
          authHint.textContent = 'En Firebase ‚Üí Authentication ‚Üí Authorized domains debe figurar: crasasito.github.io';
        }
      }
    }
    $('#add-planta').addEventListener('click', async ()=>{
      const r=$('#room-planta'), d=$('#desc-planta'), p=$('#pend-planta');
      await addTask('planta', r.value, d.value, p.value, state.prio.planta);
      r.value=''; d.value=''; p.value=''; r.focus(); updateAddButtons();
    });
    $('#add-inter').addEventListener('click', async ()=>{
      const r=$('#room-inter'), d=$('#desc-inter'), p=$('#pend-inter');
      await addTask('interconsultas', r.value, d.value, p.value, state.prio.inter);
      r.value=''; d.value=''; p.value=''; r.focus(); updateAddButtons();
    });

    // EDIT pendiente
    async function editPendiente(id, fromCol, current=''){
      const nuevo = prompt('Editar ‚ÄúPendiente‚Äù (‚â§15 caracteres):', current || '');
      if(nuevo===null) return;
      const v = sanitize(nuevo).slice(0,15);
      await updateDoc(doc(db,'users',state.user.uid,fromCol,id), { pendiente:v, updatedAt:serverTimestamp() });
    }

    // COMPLETE / UNDO / DELETE
    async function completeTask(id, fromCol){
      const srcRef = doc(db,'users',state.user.uid,fromCol,id);
      const snap = await getDoc(srcRef);
      if(!snap.exists()) return;
      const data = snap.data();
      const batch = writeBatch(db);
      const dstRef = doc(colRef('completadas'));
      batch.set(dstRef, {
        habitacion:data.habitacion, sortKey:data.sortKey,
        descripcion:data.descripcion, pendiente:data.pendiente,
        prioridad:data.prioridad, previousList:fromCol,
        createdAt:data.createdAt || serverTimestamp(),
        completedAt:serverTimestamp(), updatedAt:serverTimestamp()
      });
      batch.delete(srcRef);
      await batch.commit();
    }
    async function undoTask(id, previous='planta'){
      const srcRef = doc(db,'users',state.user.uid,'completadas',id);
      const snap = await getDoc(srcRef);
      if(!snap.exists()) return;
      const data = snap.data();
      const batch = writeBatch(db);
      const dstRef = doc(colRef(previous));
      batch.set(dstRef, {
        habitacion:data.habitacion, sortKey:data.sortKey,
        descripcion:data.descripcion, pendiente:data.pendiente,
        prioridad:data.prioridad, createdAt:data.createdAt || serverTimestamp(),
        updatedAt:serverTimestamp()
      });
      batch.delete(srcRef);
      await batch.commit();
    }
    async function deleteTask(id, fromCol){
      await deleteDoc(doc(db,'users',state.user.uid,fromCol,id));
    }

    // UX inicial
    setTab('planta'); updateAddButtons();
  </script>
</body>
</html>
