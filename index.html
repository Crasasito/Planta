<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<meta name="color-scheme" content="light" />
<title>Infecciosas â€” Planta Â· Tareas Â· Directorio</title>

<link rel="manifest" href="manifest.webmanifest" />
<link rel="icon" href="icons/icon-192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<style>
  :root{
    --canvas:#fff; --canvas-2:#f7f9fc; --ink:#0b1220; --muted:#536076; --bd:#e7eaf0;
    --lav:#C9B7FF; --sky:#AEE5FF; --sea:#A5FFE9; --coral:#FF7F50; --turq:#21D4D4;
    --accent:#F1C40F; --ok:#1C9B6D;
    --r:14px; --r-xl:20px; --touch:44px; --app-h:64px;
    --sh-1: 0 2px 8px rgba(2,6,23,.06), 0 16px 42px rgba(2,6,23,.06);
    --sh-2: 0 4px 12px rgba(2,6,23,.08), 0 28px 62px rgba(2,6,23,.10);
    --glass: rgba(255,255,255,.42); --rim: rgba(255,255,255,.62);

    --pill-ink:#0b1220;
    --pill-date-bg:hsl(205 80% 96%);  --pill-date-bd:hsl(205 68% 86%);
    --pill-section-bg:hsl(205 45% 96%);--pill-section-bd:hsl(205 35% 86%);
    --room-ink:#07111f;
    --room-planta-bg:hsl(156 75% 92%);  --room-planta-bd:hsl(156 52% 60%);
    --room-inter-bg:hsl(28 92% 92%);    --room-inter-bd:hsl(28 70% 62%);
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--canvas); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial;
    font-size:clamp(15px,1vw + .28vh,18px); line-height:1.62; min-height:100dvh;
    -webkit-tap-highlight-color:transparent; overflow-x:hidden; position:relative;
    padding-bottom:env(safe-area-inset-bottom, 0px);
  }
  body::before{
    content:""; position:fixed; inset:-12vmax; z-index:-1;
    background:
      radial-gradient(40% 35% at 12% 12%, rgba(174,229,255,.6), transparent 60%),
      radial-gradient(35% 30% at 88% 18%, rgba(201,183,255,.55), transparent 60%),
      radial-gradient(60% 50% at 84% 84%, rgba(165,255,233,.45), transparent 70%),
      radial-gradient(40% 35% at 18% 86%, rgba(255,127,80,.18), transparent 70%);
    filter: blur(42px) saturate(1.05); opacity:.65; pointer-events:none;
  }

  :focus-visible{outline:3px solid #f1c40f; outline-offset:2px; border-radius:10px}
  .hide{display:none !important}
  .container{max-width:min(1160px,98vw);margin:0 auto;padding:8px clamp(12px,4vw,20px);container-type:inline-size}

  header.appbar{
    position:sticky; top:0; z-index:50; min-height:var(--app-h);
    background:var(--glass); border-bottom:1px solid var(--rim);
    -webkit-backdrop-filter: blur(16px) saturate(1.05); backdrop-filter: blur(16px) saturate(1.05);
  }
  .appbar .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .grow{flex:1;min-width:0}
  .brand-chip{
    display:inline-flex;align-items:center;gap:12px;padding:10px 16px;border-radius:999px;
    background:linear-gradient(180deg,#FCECA6,#F6C945); color:#0E121A;
    border:1px solid rgba(255,255,255,.55); box-shadow:var(--sh-1); font-weight:900; letter-spacing:.35px; text-transform:uppercase
  }
  .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--turq)}
  h1{margin:0;font-size:clamp(21px,2.6vw,30px);font-weight:900;letter-spacing:.2px}
  h2{margin:0;font-size:clamp(18px,2.1vw,22px)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;font-size:.82rem;background:var(--canvas-2)}
  .chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
  .chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}

  .btn{appearance:none;border:1px solid var(--bd);background:#fff;color:#0b1220;padding:10px 12px;border-radius:12px;box-shadow:var(--sh-1);min-height:var(--touch);min-width:44px;display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#0E121A;border-color:transparent}
  .btn.ghost{background:transparent;border-color:transparent;box-shadow:none}
  .btn.icon{min-width:var(--touch);aspect-ratio:1/1;padding:0 10px}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:1.6em;height:1.6em;padding:0 .5em;border-radius:999px;font-weight:800;background:#0F172A;color:#fff;box-shadow:0 0 0 1px rgba(0,0,0,.12), 0 6px 14px rgba(0,0,0,.15)}

  .card{background:var(--glass);border:1px solid var(--rim);border-radius:var(--r-xl);box-shadow:var(--sh-1);overflow:hidden;
    -webkit-backdrop-filter: blur(18px) saturate(1.1); backdrop-filter: blur(18px) saturate(1.1);}
  .card-h{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid var(--rim);background:linear-gradient(180deg,rgba(255,255,255,.72),rgba(255,255,255,.42))}
  .card-b{padding:12px}
  .subtitle{color:#334155;font-weight:600}
  .counter{color:#0E121A;border:1px solid var(--rim);background:rgba(255,255,255,.6);padding:6px 10px;border-radius:999px;font-weight:700}

  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tab{padding:12px 14px;border-radius:999px;border:1px solid var(--rim);background:rgba(255,255,255,.6);cursor:pointer;font-weight:900;letter-spacing:.2px;box-shadow:var(--sh-1)}
  #tab-planta[aria-selected="true"]{background:linear-gradient(180deg,#E6FFF5,#FFFFFF)}
  #tab-tareas[aria-selected="true"]{background:linear-gradient(180deg,#FFF0EA,#FFFFFF)}
  #tab-directorio[aria-selected="true"]{background:linear-gradient(180deg,#EAF4FF,#FFFFFF)}

  .section-banner{margin:10px 0 8px;border-radius:16px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;color:#0E121A;font-weight:950;letter-spacing:.4px;background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.5));border:1px solid var(--rim)}
  .sb-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.7);border:1px solid var(--rim);font-weight:700}

  .pill{display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;padding:6px 10px;border-radius:10px;line-height:1;border:1px solid transparent;color:var(--pill-ink);background:var(--canvas-2);font-variant-numeric:tabular-nums}
  .pill.room{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-weight:900;letter-spacing:.3px;font-size:clamp(22px,3vw,28px);padding:10px 14px;border-radius:12px;color:var(--room-ink);box-shadow:inset 0 -1px 0 rgba(0,0,0,.06)}
  .pill.room.planta{background:var(--room-planta-bg);border-color:var(--room-planta-bd)}
  .pill.room.inter{background:var(--room-inter-bg);border-color:var(--room-inter-bd)}
  .pill.date{background:var(--pill-date-bg);border-color:var(--pill-date-bd)}
  .pill.section{background:var(--pill-section-bg);border-color:var(--pill-section-bd)}

  .phone-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;border:1px solid #d8e0ea;color:#0f172a;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-variant-numeric:tabular-nums;line-height:1.2;margin:2px 6px 2px 0;text-decoration:none}

  ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px;content-visibility:auto;contain-intrinsic-size:600px}
  li.item{display:grid;grid-template-columns:auto minmax(120px,1fr) auto;gap:12px;align-items:center;border:1px solid var(--rim);border-radius:14px;padding:12px;background:rgba(255,255,255,.75);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}
  li.item.pl{ border-left:6px solid #17B26A }
  li.item.ic{ border-left:6px solid #F59E0B }

  .muted{color:var(--muted)} .text{min-width:0} .line{overflow-wrap:anywhere} .strike{text-decoration:line-through;opacity:.88}
  label{font-size:12px;color:rgba(11,18,32,.52)}
  input,textarea,select{width:100%;border:1px solid var(--rim);border-radius:12px;padding:12px;background:rgba(255,255,255,.78);color:#0b1220;font:inherit;min-height:var(--touch);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}
  textarea{min-height:90px;resize:vertical}
  input::placeholder,textarea::placeholder{color:rgba(83,96,118,.66)}

  .grid{display:grid;gap:12px}
  .g3{grid-template-columns:1fr 2fr auto}
  .g2{grid-template-columns:1fr 1fr}
  @container (max-width:700px){.g3,.g2{grid-template-columns:1fr}}
  @media (max-width:680px){.g3,.g2{grid-template-columns:1fr}}

  nav.bottom{position:sticky;bottom:0;z-index:30;background:var(--glass);border-top:1px solid var(--rim);-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px)}
  .tabs-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:center;padding:8px 12px}
  .tab-bottom{padding:10px 14px;border-radius:999px;border:1px solid var(--rim);background:rgba(255,255,255,.7);cursor:pointer;font-weight:900;box-shadow:var(--sh-1)}
  #b-planta[aria-selected="true"],#b-tareas[aria-selected="true"],#b-directorio[aria-selected="true"]{background:#fff}

  .banner{display:none;margin:10px 0;padding:10px 12px;background:#EAF2FF;border:1px solid #C7D2FE;border-radius:12px}
  .banner[aria-hidden="false"]{display:flex;gap:10px;align-items:center}

  #toast{position:fixed;left:50%;bottom:calc(14px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--sh-2);z-index:60}
  #toast[hidden]{display:none}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:70}
  .modal[open]{display:grid}
  .dialog{background:rgba(255,255,255,.92);border:1px solid var(--rim);border-radius:16px;box-shadow:var(--sh-2);padding:16px;width:min(560px,92vw);-webkit-backdrop-filter:blur(18px);backdrop-filter:blur(18px)}
  .dialog .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  .segmented{display:inline-flex;gap:4px;background:rgba(255,255,255,.74);border:1px solid var(--rim);border-radius:999px;padding:2px;box-shadow:var(--sh-1)}
  .segmented button{border:0;background:transparent;border-radius:999px;padding:8px 12px;cursor:pointer;color:#334155;min-height:36px}
  .segmented button.active{background:#fff1b3;color:#111827;box-shadow:inset 0 0 0 1px #f3d44f}

  .target-badge{display:inline-flex;align-items:center;gap:8px;margin-left:8px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid var(--rim);background:rgba(255,255,255,.6)}
  .target-badge.is-planta{color:hsl(156 44% 28%)}
  .target-badge.is-inter{color:hsl(28 64% 28%)}

  .search-wrap{position:relative}
  .search-input{padding-left:42px}
  .search-ico{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:18px}
  .dir-tabs{display:flex;gap:8px;margin-top:8px}
  .dir-tabs button{border:1px solid var(--rim);background:rgba(255,255,255,.7);border-radius:10px;padding:8px 12px;cursor:pointer}
  .dir-tabs button[aria-selected="true"]{background:#fff;font-weight:800}

  .alpha-group{margin:12px 0}
  .alpha-head{font-weight:900;font-size:14px;letter-spacing:.24em;color:#334155;margin:16px 0 6px 6px}
  .alpha-divider{height:1px;background:var(--rim);border:0;margin:6px 0 4px}

  .fab{
    position:fixed; right:18px; bottom:calc(18px + env(safe-area-inset-bottom));
    width:56px; height:56px; border-radius:999px; border:0; cursor:pointer;
    background:var(--coral); color:#0E121A; font-weight:900; box-shadow: 0 6px 14px rgba(217,72,15,.35), var(--sh-1);
  }
  @media (prefers-reduced-motion:reduce){*{scroll-behavior:auto!important;animation:none!important;transition:none!important}}
</style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="container row">
      <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>Infecciosas</span>
      <h1 id="title">Planta Â· Tareas Â· Directorio</h1>
      <div class="grow"></div>
      <div class="row" aria-live="polite" style="gap:8px;flex-wrap:wrap">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>
      <div class="row">
        <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
          <img id="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--sh-1)">
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
          <span id="notifBadge" class="badge" title="Notificaciones">0</span>
        </div>
        <button id="installBtn" class="btn ghost" aria-label="Instalar">âž• Instalar</button>
        <button id="signin"  class="btn primary">Acceder</button>
        <button id="signout" class="btn hide">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="updateBanner" class="banner" aria-hidden="true">
      Nueva versiÃ³n disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
    </div>
    <div id="installBanner" class="banner" aria-hidden="true">
      Instala la app para acceso mÃ¡s rÃ¡pido. <button id="installAction" class="btn primary">Instalar</button>
    </div>

    <section id="gate" class="card" role="region" aria-live="polite">
      <div class="card-h"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
      <div class="card-b">
        <p class="muted">Funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
        <div class="row"><button id="signin2" class="btn primary">Acceder con Google</button></div>
        <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
      </div>
    </section>

    <section id="app" class="hide" aria-labelledby="tabsLabel">
      <div class="card" style="margin-bottom:12px">
        <div class="card-b">
          <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
          <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
            <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">Planta</button>
            <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">Tareas</button>
            <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">Directorio</button>
          </div>
        </div>
      </div>

      <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
        <div class="section-banner"><span>PLANTA</span><span class="sb-pill">Ingresos &amp; Interconsultas</span></div>

        <div class="card">
          <div class="card-h"><h2>AÃ±adir (Planta/Interconsulta)</h2><span class="subtitle">HabitaciÃ³n Â· DescripciÃ³n Â· Pendientes</span></div>
          <div class="card-b grid g3">
            <div><label for="p-room">HabitaciÃ³n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
            <div><label for="p-desc">DescripciÃ³n</label><input id="p-desc" placeholder="Resumen clÃ­nico, motivoâ€¦"></div>
            <div style="align-self:end"><button id="p-add" class="btn primary">AÃ±adir</button></div>

            <div class="g2" style="grid-column:1/-1;align-items:end">
              <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, analÃ­ticaâ€¦ (opcional)"></div>
              <div>
                <label>Grupo</label>
                <div class="segmented" role="group" aria-label="Grupo">
                  <button id="p-group-planta" type="button" class="active" aria-pressed="true">Planta</button>
                  <button id="p-group-inter"  type="button" aria-pressed="false">Interconsulta</button>
                </div>
                <span id="addTarget" class="target-badge is-planta" aria-live="polite">AÃ±adiendo a: Planta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Planta</h2><span id="p-count-planta" class="counter" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-planta" class="list"></ul>
            <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Interconsultas</h2><span id="p-count-inter" class="counter" aria-live="polite">0</span></div>
          <div class="card-b">
            <ul id="p-list-inter" class="list"></ul>
            <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Completadas</h2><span id="p-done-count" class="counter" aria-live="polite">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="p-done" class="list"></ul>
            <p id="p-done-empty" class="muted">Nada completado.</p>
          </div>
        </div>
      </div>

      <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1">
        <div class="section-banner"><span>TAREAS</span><span class="sb-pill">Rojo â†’ Verde segÃºn proximidad</span></div>

        <div class="card">
          <div class="card-h"><h2>AÃ±adir tarea</h2><span class="subtitle">Fecha â†’ DescripciÃ³n</span></div>
          <div class="card-b">
            <div class="grid g3">
              <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
              <div><label for="t-text">DescripciÃ³n</label><input id="t-text" type="text" placeholder="Describe la tareaâ€¦" maxlength="400"></div>
              <div style="align-self:end"><button id="t-add" class="btn primary">AÃ±adir</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Tareas activas</h2><span id="t-count" class="counter">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#fff7ed,transparent)">
            <ul id="t-list" class="list"></ul>
            <p id="t-empty" class="muted">No hay tareas activas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Completadas</h2><span id="t-done-count" class="counter">0</span></div>
          <div class="card-b" style="background:linear-gradient(180deg,#f0fdf4,transparent)">
            <ul id="t-done" class="list"></ul>
            <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><h2>Papelera</h2><span id="t-trash-count" class="counter">0</span></div>
          <div class="card-b">
            <div class="row" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
            <ul id="t-trash" class="list"></ul>
            <p id="t-trash-empty" class="muted">Papelera vacÃ­a.</p>
          </div>
        </div>
      </div>

      <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1">
        <div class="section-banner"><span>DIRECTORIO</span><span class="sb-pill">BÃºsqueda inteligente Â· Emergencias</span></div>

        <div class="card">
          <div class="card-h"><h2>Directorio telefÃ³nico</h2><span id="d-count" class="counter">0</span></div>
          <div class="card-b">
            <div class="grid g2">
              <div class="search-wrap">
                <span class="search-ico" aria-hidden="true">ðŸ”Ž</span>
                <label class="hide" for="d-q">Buscar</label>
                <input id="d-q" class="search-input" type="search" placeholder="SecciÃ³n, rol (p.ej., cardiÃ³logo), nombre o extensiÃ³nâ€¦">
              </div>
              <div class="row" style="align-self:end;justify-content:flex-end;flex-wrap:wrap">
                <button id="d-add" class="btn primary">AÃ±adir</button>
                <button id="d-import" class="btn">Importar JSON</button>
                <button id="d-export" class="btn">Exportar JSON</button>
              </div>
            </div>
            <div class="dir-tabs" role="tablist" aria-label="Vistas">
              <button id="d-tab-search" role="tab" aria-selected="true"  aria-controls="d-view-search">BÃºsqueda</button>
              <button id="d-tab-sections" role="tab" aria-selected="false" aria-controls="d-view-sections">Secciones</button>
            </div>
          </div>
        </div>

        <div class="card" id="d-view-search" role="region" aria-live="polite" style="margin-top:12px">
          <div class="card-b"><ul id="d-list" class="list"></ul><p id="d-empty" class="muted">Sin registros.</p></div>
        </div>

        <div class="card hide" id="d-view-sections" role="region" aria-live="polite" style="margin-top:12px">
          <div class="card-b" id="d-sections"></div>
        </div>
      </div>

      <nav class="bottom" aria-label="Secciones">
        <div class="tabs-bottom">
          <button class="tab-bottom" id="b-planta" aria-selected="true">Planta</button>
          <button class="tab-bottom" id="b-tareas" aria-selected="false">Tareas</button>
          <button class="tab-bottom" id="b-directorio" aria-selected="false">Directorio</button>
        </div>
      </nav>
    </section>
  </main>

  <button id="fabEmergency" class="fab" title="Emergencias" aria-label="Abrir emergencias">SOS</button>

  <dialog id="modal" class="modal" aria-modal="true">
    <form id="modalForm" class="dialog" method="dialog">
      <h3 id="modalTitle" style="margin:0 0 8px 0">Editar</h3>
      <div id="modalBody" class="grid" style="grid-template-columns:1fr"></div>
      <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="btn" value="cancel">Cancelar</button>
        <button id="modalOk" class="btn primary" value="ok">Guardar</button>
      </div>
    </form>
  </dialog>

  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

<script type="module">
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const todayISO = ()=> new Date().toISOString().slice(0,10);
const idle = (fn)=>('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0);
const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.hidden=false; setTimeout(()=>t.hidden=true,2200); };
const enc = (s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
const pillForDate=(iso)=>{ try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,''); }catch{return iso} };
const norm = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
const onlyDigits = (s)=> String(s||'').replace(/\D+/g,'');

const setOnline=(on)=>{ const b=$('#badge-online'); b.textContent=on?'Online':'Offline'; b.className='chip '+(on?'ok':'bad'); };
setOnline(navigator.onLine);
addEventListener('online', ()=>setOnline(true), {passive:true});
addEventListener('offline',()=>setOnline(false), {passive:true});

const tabOrder=['planta','tareas','directorio'];
function setTabA11y(id){
  for(const k of tabOrder){
    const sel=(k===id);
    const el=document.getElementById('tab-'+k);
    el.setAttribute('aria-selected', sel? 'true':'false');
    el.setAttribute('tabindex', sel? '0':'-1');
  }
}
function selectTab(id, focusPanel=false){
  const map={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio']};
  for(const k in map){
    const [p,t,b,l]=map[k]; const sel=(k===id);
    document.getElementById(p).classList.toggle('hide',!sel);
    document.getElementById(t).setAttribute('aria-selected',sel?'true':'false');
    document.getElementById(b).setAttribute('aria-selected',sel?'true':'false');
    if(sel){ $('#title').textContent=l; localStorage.setItem('tab', k); if(focusPanel) document.getElementById(p).focus?.(); }
  }
  setTabA11y(id);
  location.hash = id;
}
$('#tab-planta').onclick =()=>selectTab('planta',true);
$('#tab-tareas').onclick =()=>selectTab('tareas',true);
$('#tab-directorio').onclick=()=>selectTab('directorio',true);
$('#b-planta').onclick =()=>selectTab('planta');
$('#b-tareas').onclick =()=>selectTab('tareas');
$('#b-directorio').onclick=()=>selectTab('directorio');

$('#tablist').addEventListener('keydown', (e)=>{
  const cur = tabOrder.findIndex(k => document.getElementById('tab-'+k).getAttribute('aria-selected')==='true');
  if(e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); const n=(cur+1)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
  if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); const n=(cur-1+tabOrder.length)%tabOrder.length; document.getElementById('tab-'+tabOrder[n]).focus(); document.getElementById('tab-'+tabOrder[n]).click(); }
  if(e.key==='Home'){ e.preventDefault(); document.getElementById('tab-'+tabOrder[0]).focus(); document.getElementById('tab-'+tabOrder[0]).click(); }
  if(e.key==='End'){ e.preventDefault(); document.getElementById('tab-'+tabOrder.at(-1)).focus(); document.getElementById('tab-'+tabOrder.at(-1)).click(); }
});

const BASE = new URL('./', location).pathname;
const appMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
const authMod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
const fsMod   = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
const { firebaseConfig } = await import(BASE + 'firebase-config.js');

const fbApp = appMod.initializeApp(firebaseConfig);
const auth  = authMod.getAuth(fbApp);
const db    = fsMod.initializeFirestore(fbApp, { localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() }) });
const serverTS = fsMod.serverTimestamp;

const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();

const doSignIn=async()=>{ try{
  if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider);
  else await authMod.signInWithPopup(auth,provider);
}catch(e){ $('#authErr').textContent=e?.message || String(e); } };
$('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

authMod.onAuthStateChanged(auth, user=>{
  if(user){
    badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
    avatar.src=user.photoURL||''; displayname.textContent=user.displayName||user.email||''; userchip.classList.remove('hide');
    $('#signout').classList.remove('hide'); $('#signin').classList.add('hide'); gate.classList.add('hide'); appUI.classList.remove('hide');
    mountApp(user.uid);
  }else{
    badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
    userchip.classList.add('hide'); $('#signout').classList.add('hide'); $('#signin').classList.remove('hide'); appUI.classList.add('hide'); gate.classList.remove('hide');
    unmountApp();
  }
});

const col = {
  planta  : (uid)=> fsMod.collection(db,'users',uid,'planta'),
  tareas  : (uid)=> fsMod.collection(db,'users',uid,'tareas'),
  dir     : (uid)=> fsMod.collection(db,'users',uid,'directorio'),
};
let unsubs=[]; const currentUid=()=>auth.currentUser?.uid;
function unmountApp(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

let currentGroup='planta';
function updateAddTarget(){
  const t=$('#addTarget');
  if(currentGroup==='planta'){ t.textContent='AÃ±adiendo a: Planta'; t.className='target-badge is-planta'; }
  else { t.textContent='AÃ±adiendo a: Interconsulta'; t.className='target-badge is-inter'; }
}
$('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget(); mkActive('#p-group-planta','#p-group-inter');};
$('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget(); mkActive('#p-group-inter','#p-group-planta');};
function mkActive(on,off){ $(on).classList.add('active'); $(on).setAttribute('aria-pressed','true'); $(off).classList.remove('active'); $(off).setAttribute('aria-pressed','false'); }
updateAddTarget();

const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(),
  grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });

const btn = (t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.type='button'; b.onclick=(e)=>{e.preventDefault(); fn?.(e)}; return b;};

function roomSortKey(s){
  if(!s) return Number.POSITIVE_INFINITY;
  const m = String(s).match(/\d+/g);
  if(!m) return Number.POSITIVE_INFINITY;
  const first = parseInt(m[0],10);
  const second = m[1] ? parseInt(m[1],10)/100 : 0;
  return first + second;
}

const renderPlantaItem=(x,done=false)=>{
  const li=document.createElement('li'); li.className='item ' + (x.grupo==='interconsulta'?'ic':'pl');
  const pill=document.createElement('span'); pill.className='pill room ' + (x.grupo==='interconsulta'?'inter':'planta'); pill.innerHTML=enc(x.room||'â€”');
  const text=document.createElement('div'); text.className='text';
  const d1=document.createElement('div'); d1.className='line'+(done?' strike':''); d1.innerHTML=enc(x.desc||''); text.appendChild(d1);
  if(x.pendiente){ const d2=document.createElement('div'); d2.className='muted'; d2.innerHTML=enc(x.pendiente); text.appendChild(d2); }
  const act=document.createElement('div'); act.className='row'; act.style.gap='8px';
  if(!done){
    act.append(btn('âœ“',()=>upd('planta',x.__id,{status:'done'}),'btn icon'));
    act.append(btn('âœŽ',()=>editPlanta(x),'btn icon'));
    act.append(btn('ðŸ—‘ï¸',()=>upd('planta',x.__id,{status:'trash'}),'btn icon'));
  }else{
    act.append(btn('â†©',()=>upd('planta',x.__id,{status:'active'}),'btn icon'));
    act.append(btn('âœ–',()=>del('planta',x.__id),'btn icon'));
  }
  li.append(pill,text,act); return li;
};

const openEdit=(fields,onOk)=>{
  const body=$('#modalBody'); body.innerHTML='';
  for(const f of fields){
    const w=document.createElement('div');
    const lab=document.createElement('label'); lab.setAttribute('for',f.id); lab.textContent=f.l;
    const inp=document.createElement('input'); inp.id=f.id; inp.value=String(f.v||'');
    w.append(lab,inp); body.appendChild(w);
  }
  const dlg=$('#modal'); $('#modalTitle').textContent='Editar'; $('#modalOk').textContent='Guardar'; $('#modalCancel').textContent='Cancelar';
  dlg.showModal(); dlg.setAttribute('aria-hidden','false');
  $('#modalOk').onclick=async e=>{e.preventDefault(); await onOk(); dlg.close();};
  $('#modalCancel').onclick=e=>{e.preventDefault(); dlg.close();};
  dlg.addEventListener('close',()=>dlg.setAttribute('aria-hidden','true'),{once:true});
};
const val=(id)=>document.getElementById(id)?.value||'';
const editPlanta=(x)=>openEdit(
  [{l:'HabitaciÃ³n',id:'p_room',v:x.room||''},{l:'DescripciÃ³n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}],
  async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')})
);

function setupPlanta(uid){
  $('#p-add').onclick=async()=>{
    const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup});
    if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(id=>document.getElementById(id).value='');
  };
  const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));

  const u1=fsMod.onSnapshot(qA,(s)=>{
    const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x);});
    const arrP = all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
    const arrI = all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=> roomSortKey(a.room)-roomSortKey(b.room) || String(a.room||'').localeCompare(String(b.room||'')));
    const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
    arrP.forEach(x=>lp.appendChild(renderPlantaItem(x,false)));
    arrI.forEach(x=>li.appendChild(renderPlantaItem(x,false)));
    $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
    $('#p-count-planta').textContent=String(arrP.length); $('#p-count-inter').textContent=String(arrI.length);
  });

  const u2=fsMod.onSnapshot(qD,(s)=>{
    const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
    const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(renderPlantaItem(x,true)));
    $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=String(arr.length);
  });
  unsubs.push(u1,u2);
}

const tareaDoc = (d)=>({ date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
function daysFromToday(iso){ try{ const d = new Date(iso+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch{return 0} }
function hueForDays(diff){ if(isNaN(diff)) return 205; if(diff <= -7) return 0; if(diff < 0) return 10; const max=30; return Math.round(10 + (Math.min(diff,max)/max)*120); }
function renderTareaItem(x,mode){
  const li=document.createElement('li'); li.className='item';
  const diff = daysFromToday(x.date);
  const h = mode==='active' ? hueForDays(diff) : 150;
  if(mode==='active') li.style.borderLeft = `6px solid hsl(${h} 72% 46%)`; else li.style.borderLeft = `6px solid hsl(150 50% 38%)`;
  const pill=document.createElement('span'); pill.className='pill date'; if(mode==='active'){ pill.style.background=`hsl(${h} 90% 92%)`; pill.style.borderColor=`hsl(${h} 70% 72%)`; } pill.textContent=pillForDate(x.date);
  const text=document.createElement('div'); text.className='text';
  const d1=document.createElement('div'); d1.className='line'+(mode==='done'?' strike':''); d1.innerHTML=enc(x.text||''); text.appendChild(d1);
  const act=document.createElement('div'); act.className='row'; act.style.gap='8px';
  if(mode==='active'){
    act.append(btn('âœ“',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'));
    act.append(btn('âœŽ',()=>editTarea(x),'btn icon'));
    act.append(btn('ðŸ—‘ï¸',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon'));
  }else if(mode==='done'){
    act.append(btn('â†©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'));
    act.append(btn('âœ–',()=>del('tareas',x.__id),'btn icon'));
  }else{
    act.append(btn('â¤´',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'));
    act.append(btn('âœ–',()=>del('tareas',x.__id),'btn icon'));
  }
  li.append(pill,text,act); return li;
}
const editTarea=(x)=>openEdit(
  [{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'DescripciÃ³n',id:'t_text',v:x.text||''}],
  async()=>upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')})
);

function setupTareas(uid){
  $('#t-date').value=todayISO();
  $('#t-add').onclick=async ()=>{
    const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return;
    await fsMod.addDoc(col.tareas(uid), tareaDoc({date,text})); $('#t-text').value='';
  };
  const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
  const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

  const u1=fsMod.onSnapshot(qA,(snap)=>{
    const arr=[]; snap.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=> daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0) );
    const list=$('#t-list'); list.innerHTML=''; let n=0;
    idle(()=>{arr.forEach(x=>{list.appendChild(renderTareaItem(x,'active')); n++;}); $('#t-count').textContent=String(n); $('#t-empty').style.display=n?'none':'block'; setNotif(n);});
  });
  const u2=fsMod.onSnapshot(qD,(s)=>{
    const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
    const l=$('#t-done'); l.innerHTML=''; let n=0;
    idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaItem(x,'done')); n++;}); $('#t-done-empty').style.display=n?'none':'block'; $('#t-done-count').textContent=String(n);});
  });
  const u3=fsMod.onSnapshot(qT,(s)=>{
    const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
    const l=$('#t-trash'); l.innerHTML=''; let n=0;
    idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaItem(x,'trash')); n++;}); $('#t-trash-empty').style.display=n?'none':'block'; $('#t-trash-count').textContent=String(n);});
  });
  $('#t-emptyTrash').onclick=()=>emptyTrash(uid,'tareas');
  unsubs.push(u1,u2,u3);
}

const ROLE_LEX = {
  "cardiologia":["cardio","cardiologo","cardiologa","ucic","hemodinamica"],
  "urgencias":["er","emergencias","suap","puerta"],
  "urologia":["uro","urologo","urologa"],
  "neumologia":["neumo","respiratorio","epoc"],
  "microbiologia":["micro","lab","laboratorio"],
  "infectiosas":["infecciosas","id","proa"]
};
let dirCache=[];

function telHref(raw){ const s=String(raw||'').replace(/[^\d+]/g,''); return s?`tel:${s}`:null; }
function createPhoneChips(raw){
  const frag=document.createDocumentFragment();
  const parts = String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
  for(const p of parts){
    const href=telHref(p);
    const el=document.createElement(href?'a':'span');
    el.className='phone-chip'; if(href){ el.href=href; el.setAttribute('dir','ltr'); } el.textContent=p; frag.appendChild(el);
  }
  return frag;
}
function scoreDirItem(x, q){
  if(!q) return 1;
  const Q = norm(q);
  const parts = [norm(x.seccion), norm(x.nombre), norm(x.notas), norm(String(x.telefono||''))];
  const digits = onlyDigits(x.telefono);
  let score = 0;
  if(parts[1].includes(Q)) score += 4;
  if(parts[0].includes(Q)) score += 3;
  if(parts[3].includes(Q)) score += 3;
  if(onlyDigits(q) && digits.includes(onlyDigits(q))) score += 3;
  for(const k in ROLE_LEX){
    if(ROLE_LEX[k].some(alias => Q.includes(alias)) || Q.includes(k)){
      if(parts[0].includes(k) || parts[1].includes(k)) score += 2;
    }
  }
  if(parts[2].includes(Q)) score += 1;
  return score;
}
function renderDir(x){
  const li=document.createElement('li'); li.className='item';
  const pill=document.createElement('span'); pill.className='pill section'; pill.textContent = x.seccion || 'â€”';
  const text=document.createElement('div'); text.className='text';
  const l1=document.createElement('div'); l1.className='line'; const strong=document.createElement('strong'); strong.textContent = x.nombre || ''; l1.appendChild(strong);
  const l2=document.createElement('div'); l2.className='line'; l2.appendChild(createPhoneChips(x.telefono));
  text.append(l1,l2);
  if(x.notas){ const l3=document.createElement('div'); l3.className='muted'; l3.textContent=x.notas; text.appendChild(l3); }
  const act=document.createElement('div'); act.className='row'; act.style.gap='8px';
  act.append(btn('âœŽ',()=>editDir(x),'btn icon'), btn('ðŸ—‘ï¸',()=>del('directorio',x.__id),'btn icon')); 
  li.append(pill,text,act); return li;
}
const editDir=(x)=>openEdit(
  [{l:'SecciÃ³n',id:'d_sec',v:x.seccion||''},{l:'Nombre',id:'d_nom',v:x.nombre||''},{l:'TelÃ©fonos',id:'d_tel',v:x.telefono||''},{l:'Notas',id:'d_not',v:x.notas||''}],
  async()=>upd('directorio',x.__id,{seccion:val('d_sec'),nombre:val('d_nom'),telefono:val('d_tel'),notas:val('d_not')})
);

const importDir = (uid)=> async ()=>{
  try{
    const txt=await pickReadText(); const arr=JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('JSON invÃ¡lido');
    const snap=await fsMod.getDocs(col.dir(uid));
    const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
    const set=new Set(snap.docs.map(d=>key(d.data())));
    const ops=[];
    for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),{ seccion:String(o.seccion||'').trim()||'Sin secciÃ³n', nombre:String(o.nombre||'').trim()||'Sin nombre', telefono:String(o.telefono||'').trim(), notas:String(o.notas||'').trim(), createdAt:serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) })); }
    await Promise.all(ops); toast('Importado ('+ops.length+')');
  }catch(e){ toast(e?.message||String(e)); }
};
const exportDir = (uid)=> async ()=>{
  const snap=await fsMod.getDocs(fsMod.query(col.dir(uid)));
  const out=snap.docs.map(d=>({id:d.id,...d.data()}));
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado');
};

function renderDirList(){
  const v=$('#d-q')?.value?.trim() || '';
  const list=$('#d-list'); if(!list) return; list.innerHTML='';
  const arr=[...dirCache].sort((a,b)=>{
    const da=scoreDirItem(a,v), db=scoreDirItem(b,v);
    if(db!==da) return db-da;
    return (a.seccion||'').localeCompare(b.seccion||'') || (a.nombre||'').localeCompare(b.nombre||'');
  });
  let n=0; idle(()=>{ arr.forEach(x=>{ if(!v || scoreDirItem(x,v)>0){ list.appendChild(renderDir(x)); n++; } });
    $('#d-count').textContent=n+' registros'; $('#d-empty').style.display=n?'none':'block';
  });
}
function renderSections(){
  const host = $('#d-sections'); if(!host) return; host.innerHTML='';
  const groups = new Map();
  for(const x of dirCache){
    const s = String(x.seccion||'Sin secciÃ³n');
    const key = s.trim()[0]?.toUpperCase() || '#';
    if(!groups.has(key)) groups.set(key, []);
    groups.get(key).push(x);
  }
  const letters = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b));
  for(const L of letters){
    const list = groups.get(L).sort((a,b)=> (a.seccion||'').localeCompare(b.seccion||'') || (a.nombre||'').localeCompare(b.nombre||''));
    const wrap = document.createElement('div'); wrap.className='alpha-group';
    const head = document.createElement('div'); head.className='alpha-head'; head.textContent=L; wrap.appendChild(head);
    const hr = document.createElement('hr'); hr.className='alpha-divider'; wrap.appendChild(hr);
    const ul = document.createElement('ul'); ul.className='list';
    list.forEach(x=> ul.appendChild(renderDir(x)));
    wrap.appendChild(ul);
    host.appendChild(wrap);
  }
}
function setupDirectorio(uid){
  $('#d-add').onclick=async()=>{
    const d={ seccion:prompt('SecciÃ³n')||'', nombre:prompt('Nombre')||'', telefono:prompt('TelÃ©fonos (formato libre)')||'', notas:'' };
    await fsMod.addDoc(col.dir(uid),{ ...d, seccion:String(d.seccion||'').trim()||'Sin secciÃ³n', nombre:String(d.nombre||'').trim()||'Sin nombre', telefono:String(d.telefono||'').trim(), notas:String(d.notas||'').trim(), createdAt:serverTS(), updatedAt:serverTS(), deviceId:navigator.userAgent.slice(0,64) });
  };
  $('#d-import').onclick = importDir(uid);
  $('#d-export').onclick = exportDir(uid);
  const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{ dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderDirList(); renderSections(); });
  $('#d-q').addEventListener('input', renderDirList, {passive:true});

  const tabS = $('#d-tab-search');
  const tabC = $('#d-tab-sections');
  tabS.onclick = ()=>{ tabS.setAttribute('aria-selected','true'); tabC.setAttribute('aria-selected','false'); $('#d-view-search').classList.remove('hide'); $('#d-view-sections').classList.add('hide'); };
  tabC.onclick = ()=>{ tabC.setAttribute('aria-selected','true'); tabS.setAttribute('aria-selected','false'); $('#d-view-search').classList.add('hide'); $('#d-view-sections').classList.remove('hide'); };

  $('#fabEmergency').onclick = showEmergency;
  unsubs.push(u);
}

const DEFAULT_EMERG=[{nombre:"Equipo de Parada",telefono:"7777"},{nombre:"Seguridad",telefono:"5555"},{nombre:"Jefe de EnfermerÃ­a",telefono:"3333"}];
function getEmerg(){ try{ return JSON.parse(localStorage.getItem('emergencias')||'[]'); }catch{return []} }
function setEmerg(arr){ localStorage.setItem('emergencias', JSON.stringify(arr)); }
function showEmergency(){
  const arr = getEmerg(); const list = (arr && arr.length? arr: DEFAULT_EMERG);
  const body=$('#modalBody'); body.innerHTML=''; $('#modalTitle').textContent='Emergencias';
  for(const e of list){
    const w=document.createElement('div'); w.className='item'; w.style.gridTemplateColumns='1fr auto'; w.style.borderLeft='6px solid var(--coral)';
    const tx=document.createElement('div'); tx.className='text';
    const l1=document.createElement('div'); l1.className='line'; const st=document.createElement('strong'); st.textContent=e.nombre; l1.appendChild(st);
    const l2=document.createElement('div'); l2.className='line'; l2.appendChild(createPhoneChips(e.telefono));
    tx.append(l1,l2);
    const act=document.createElement('div'); act.className='row'; act.style.gap='8px';
    const tel=telHref(e.telefono); const a=document.createElement('a'); a.className='btn'; a.textContent='Llamar'; a.href=tel||'#';
    act.append(a); w.append(tx,act); body.appendChild(w);
  }
  const row=document.createElement('div'); row.style.marginTop='8px'; const cfg=document.createElement('button'); cfg.className='btn'; cfg.id='emEdit'; cfg.textContent='Configurarâ€¦'; row.appendChild(cfg); body.appendChild(row);
  const dlg=$('#modal'); $('#modalOk').classList.add('hide'); $('#modalCancel').textContent='Cerrar'; dlg.showModal(); dlg.setAttribute('aria-hidden','false');

  $('#emEdit').onclick = ()=>{
    body.innerHTML=''; $('#modalTitle').textContent='Configurar emergencias';
    const cur = getEmerg().length? getEmerg(): DEFAULT_EMERG;
    cur.forEach((e,idx)=>{
      const w=document.createElement('div');
      const l1=document.createElement('label'); l1.textContent='Nombre'; const i1=document.createElement('input'); i1.id='em_n'+idx; i1.value=e.nombre;
      const l2=document.createElement('label'); l2.textContent='TelÃ©fono(s)'; const i2=document.createElement('input'); i2.id='em_t'+idx; i2.value=e.telefono;
      w.append(l1,i1,l2,i2); body.appendChild(w);
    });
    $('#modalOk').classList.remove('hide');
    $('#modalOk').onclick = (ev)=>{
      ev.preventDefault();
      const out = cur.map((_,idx)=>({nombre:val('em_n'+idx), telefono:val('em_t'+idx)}));
      setEmerg(out); toast('Emergencias guardadas'); dlg.close();
    };
  };
  $('#modalCancel').onclick=(e)=>{e.preventDefault(); dlg.close();};
  dlg.addEventListener('close',()=>{ $('#modalOk').classList.remove('hide'); $('#modalCancel').textContent='Cancelar'; dlg.setAttribute('aria-hidden','true'); },{once:true});
}

async function upd(kind,id,patch){ const ref=fsMod.doc(db,'users',auth.currentUser?.uid,kind,id); await fsMod.updateDoc(ref,{...patch,updatedAt:serverTS()}); }
async function del(kind,id){ await fsMod.deleteDoc(fsMod.doc(db,'users',auth.currentUser?.uid,kind,id)); }
async function emptyTrash(uid,kind){ const q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada'); }

async function pickReadText(){
  if('showOpenFilePicker' in window){
    const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]});
    const f=await h.getFile(); return await f.text();
  }
  return await new Promise((res,rej)=>{
    const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json';
    i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); };
    i.click();
  });
}
async function pickWriteBlob(blob,name){
  if('showSaveFilePicker' in window){
    const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]});
    const w=await h.createWritable(); await w.write(blob); await w.close(); return;
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}

let deferredPrompt=null;
addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').setAttribute('aria-hidden','false');});
$('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').setAttribute('aria-hidden','true'); } };
$('#installBtn').onclick=()=>$('#installAction').click();

if('serviceWorker' in navigator){
  try{
    const reg=await navigator.serviceWorker.register(BASE+'sw.js');
    navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
    const showUpdate=()=>{ $('#updateBanner').setAttribute('aria-hidden','false'); $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'}); };
    if(reg.waiting) showUpdate();
    reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
  }catch(e){ /* noop */ }
}

function setNotif(n){ const el=$('#notifBadge'); el.textContent=String(n); el.title=n?`${n} tareas activas`:'Sin avisos'; }
function mountApp(uid){
  setupPlanta(uid); setupTareas(uid); setupDirectorio(uid);
  const last = (location.hash && location.hash.slice(1)) || localStorage.getItem('tab') || 'planta';
  selectTab(last);
}
selectTab((location.hash && location.hash.slice(1)) || 'planta');
</script>
</body>
</html>
