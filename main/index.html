<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#ffffff"/>
<title>Aurora UI â€” Infecciosas 2.0 (v3.4 Premium)</title>
<link rel="manifest" href="manifest.webmanifest"/>
<link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<style>
/* ===== AJUSTES PREMIUM v3.4 ==========================================
   MEJORAS IMPLEMENTADAS:
   - Icono Fonendoscopio: RediseÃ±ado con gradientes premium y estÃ©tica moderna
   - Directorio TelefÃ³nico:
     * Sin truncamiento: nombres y descripciones completas visibles
     * Sin solapamiento: encabezados de letra (A, B...) no tapan contenido
     * Encabezado de letra con efecto "glow" y "rim light" sutil y difuminado
     * Barra A-Z refinada y mÃ¡s integrada
   - Iconos: centrados y proporcionales
   - Estructura HTML: sin cambios (mantiene funcionalidad JavaScript)
========================================================================= */

/* ---------- TOKENS & BASE ---------- */
:root{
  --ink:#0b1220; --muted:#5a667a;
  --surface:#ffffff; --surface-2:#f7f9fc; --border:#e8eef5;

  --lav:#EAE2FF; --lav-700:#8B5CF6;
  --ora:#FFE5D1; --ora-700:#FB923C;
  --coral-700:#F43F5E; --green-700:#10B981;
  --indigo-600:#6366F1; --gold-500:#FACC15;
  --mint-600:#06D6A0; --teal-600:#1B9AAA;

  --gx-planta: linear-gradient(135deg,#F5F0FF 0%, #EAE2FF 55%, #C7B8FF 100%);
  --gx-inter:  linear-gradient(135deg,#FFF3E4 0%, #FFE5D1 55%, #FFD0A3 100%);
  --gx-tareas: linear-gradient(135deg,#FFE4E9 0%, #FFC9D4 55%, #FFA9B9 100%);
  --gx-green:  linear-gradient(135deg,#E9FFF1 0%, #CFFAE2 55%, #B2F5D4 100%);
  --gx-dir:    linear-gradient(135deg,#FFFBE5 0%, #FFF1B5 55%, #FFE783 100%);
  --gx-bib:    linear-gradient(135deg,#EDF2FF 0%, #DDE4FF 55%, #C7D3FF 100%);
  --gx-extra:  linear-gradient(135deg,#FDE7FA 0%, #F9CEF5 55%, #F3B1EF 100%);

  --gx-celeste: linear-gradient(135deg,#E9F4FF 0%, #D6ECFF 55%, #BCE2FF 100%);
  --gx-turq:    linear-gradient(135deg,#E8FFFB 0%, #CFFAF2 55%, #B3F4E9 100%);
  --gx-coral:   linear-gradient(135deg,#FFE8EC 0%, #FFC9D3 55%, #FFA9B9 100%);

  --glass-bg: linear-gradient(180deg,rgba(255,255,255,.92) 0%, rgba(247,249,252,.82) 100%);
  --rim-ambient: radial-gradient(60% 40% at 50% 0%, rgba(255,255,255,.38), rgba(255,255,255,0));
  --shadow-1: 0 1px 2px rgba(7,16,31,.05), 0 8px 24px rgba(7,16,31,.06);
  --shadow-2: 0 2px 10px rgba(7,16,31,.10), 0 20px 40px rgba(7,16,31,.14);

  --radius:14px; --radius-xl:22px; --appbar:64px; --touch:44px;
  --fs: clamp(15px, 0.85vw + 0.35vh, 18px);
  --h2: clamp(20px, 2.6vw, 26px);
  --vh: 1vh;

  --bottom-h: 68px; --nav-btn: 56px; --ico-bottom: 28px;
}
@media (max-width:480px){ :root{ --bottom-h:64px; --nav-btn:52px; --ico-bottom:26px } }
@media (min-width:1025px){ :root{ --bottom-h:72px; --nav-btn:60px; --ico-bottom:28px } }

*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--surface);
  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  font-size:var(--fs); line-height:1.65; min-height:calc(var(--vh)*100);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent; overflow-x:hidden;
  text-rendering:optimizeLegibility; overscroll-behavior-y:none;
}
:focus-visible{outline:3px solid color-mix(in oklab,var(--lav-700),white 70%); outline-offset:2px; border-radius:12px}
.container{max-width:min(1180px,98vw); margin:0 auto; padding:8px clamp(12px,4vw,20px); container-type:inline-size}
.grow{flex:1;min-width:0}
.hide{display:none !important}
.muted{color:var(--muted)}
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
svg.ico{display:block}

/* ---------- APPBAR y HEADERS ---------- */
header.appbar{position:sticky; top:0; z-index:50; min-height:var(--appbar); backdrop-filter: blur(8px) saturate(1.06); background: var(--glass-bg); border-bottom:1px solid var(--border)}
.appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);box-shadow:inset 0 1px 0 #fff, var(--shadow-1);display:inline-flex;align-items:center;gap:10px;font-weight:1000;letter-spacing:.2px}
.brand-dot{width:10px;height:10px;border-radius:50%;background:var(--gold-500)}
h1#title{margin:0;font-size:clamp(18px,2.2vw,22px);font-weight:1000;letter-spacing:.2px;color:#0e1624;filter:drop-shadow(0 1px 0 rgba(0,0,0,.05))}

.card{background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(255,255,255,.82) 100%);backdrop-filter: blur(8px) saturate(1.06);border: 1px solid var(--border);border-radius: var(--radius-xl);box-shadow: 0 18px 36px rgba(60,100,180,.12);overflow:hidden; contain:content}
.card-h{position:relative; padding:16px 18px 18px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid color-mix(in oklab,#000,transparent 90%); background:#fff; isolation:isolate; overflow:hidden; box-shadow: inset 0 0 0 1px color-mix(in oklab,var(--ink),transparent 92%), inset 0 0 0 8px rgba(255,255,255,.65); outline: 1px solid rgba(140,160,220,.18); outline-offset: -6px}
.card-h::before{content:""; position:absolute; inset:0 0 auto 0; height:46px; z-index:0; opacity:.95; background: var(--gx-neutral, linear-gradient(135deg,#F3F6FB 0%, #EDF2F9 100%))}
.card-h::after{content:""; position:absolute; inset:-20% -10% auto -10%; height:160%; background: var(--rim-ambient); mix-blend-mode:screen; opacity:.6; z-index:0}
.card-h > *{position:relative; z-index:2}
.card-h h2{margin:0;font-size:var(--h2);font-weight:1000;letter-spacing:.2px;color:#0b1220;line-height:1.15;transform:translateY(-1px)}
.card-h h2::after{content:""; position:absolute; left:-2px; right:-2px; bottom:-8px; height:6px; border-radius:999px; background: color-mix(in oklab, var(--accent, #6b7280), white 45%); box-shadow: 0 0 14px color-mix(in oklab, var(--accent, #6b7280), white 10%); z-index:-1; pointer-events:none}
.card-b{position:relative;z-index:1;padding:12px}

.h-planta{ --gx-neutral: var(--gx-planta); --accent: var(--lav-700) }
.h-inter { --gx-neutral: var(--gx-inter);  --accent: var(--ora-700) }
.h-tareas{ --gx-neutral: var(--gx-tareas); --accent: var(--coral-700) }
.h-green { --gx-neutral: var(--gx-green);  --accent: var(--green-700) }
.h-dir   { --gx-neutral: var(--gx-dir);    --accent: var(--gold-500) }
.h-bib   { --gx-neutral: var(--gx-bib);    --accent: var(--indigo-600) }
.h-celeste{ --gx-neutral: var(--gx-celeste); --accent:#3B82F6 }
.h-turq   { --gx-neutral: var(--gx-turq);    --accent: var(--mint-600) }
.h-coral  { --gx-neutral: var(--gx-coral);   --accent: var(--coral-700) }

/* ---------- CONTENIDO Y BOTONES ---------- */
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:.84rem;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
.chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
.chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow-1);min-height:var(--touch);display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:800}
.btn.primary{background:linear-gradient(180deg,#fffdf3 0%, #fff7d1 100%); border-color:color-mix(in oklab,var(--gold-500),transparent 65%); box-shadow:var(--shadow-2)}
.btn.icon{min-width:36px;height:36px;padding:0;display:grid;place-items:center}
.btn.icon .ico{width:20px;height:20px}
.btn.icon.swap .ico{width:23px;height:23px}

/* ---------- LISTAS / INPUTS ---------- */
ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
li.item{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px; align-items:center; border:1px solid var(--border); border-radius:16px; padding:12px; background:#fff
}
.pill{display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;padding:7px 12px;border-radius:14px;line-height:1;border:1px solid transparent;color:#0d1726;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
.pill.room{
  font-family: ui-monospace,Consolas,Menlo,monospace; font-size:clamp(22px,3.2vw,26px);
  padding:12px 16px; letter-spacing:.3px; color:#07101f; background:#fff; white-space:nowrap;
  border:1px solid color-mix(in oklab,var(--lav-700),transparent 78%);
  box-shadow:0 0 0 1px color-mix(in oklab,#000,transparent 90%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08);
}
.pill.room[data-group="planta"]{background: linear-gradient(180deg,#ffffff 0%, #faf7ff 100%); border-color: color-mix(in oklab,var(--lav-700),transparent 65%); box-shadow: 0 0 0 6px color-mix(in oklab,var(--lav),transparent 60%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08)}
.pill.room[data-group="interconsulta"]{background: linear-gradient(180deg,#ffffff 0%, #fff7f0 100%); border-color: color-mix(in oklab,var(--ora-700),transparent 60%); box-shadow: 0 0 0 6px color-mix(in oklab,var(--ora),transparent 58%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08)}

.pill.date{font-weight:1000}
.pill.tel{font-weight:800}

.item .text{display:flex; align-items:center; gap:10px; min-width:0}
.item .text > *{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%}
.item .text .muted{opacity:.8}

.item .actions{display:flex; align-items:center; justify-content:flex-end; gap:6px; min-width:114px}

label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
input,textarea,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;color:var(--ink);font:inherit;min-height:var(--touch);box-shadow:inset 0 1px 0 #fff}
textarea{min-height:90px;resize:vertical}

/* ---------- VISOR ---------- */
.viewer{width:100%; block-size: min(72vh, calc(100dvh - var(--appbar) - var(--bottom-h) - env(safe-area-inset-bottom) - 48px)); border:1px solid var(--border); border-radius:16px; background:#fff; box-shadow:var(--shadow-1)}

/* ========== DIRECTORIO (PREMIUM v3.4) ========== */
.dir-wrap{display:grid;grid-template-columns:1fr min(32px,6.5vw);gap:14px;align-items:start}
.dir-wrap > div:first-child{min-width:0}

/* Barra alfabÃ©tica A-Z refinada */
.az{
  position:sticky; top:calc(var(--appbar) + 12px);
  display:grid; gap:5px; align-content:start; z-index:15; /* Por encima de todo */
  padding:6px 4px; border-radius:16px;
  background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(248,250,254,.88));
  border:1px solid color-mix(in oklab,var(--border),transparent 20%);
  backdrop-filter: blur(10px) saturate(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,.06), inset 0 1px 0 rgba(255,255,255,.8);
}
.az a{
  display:grid;place-items:center; width:100%; aspect-ratio:1/1;
  border:1px solid var(--border); border-radius:10px; text-decoration:none;
  color:#1d2838; font-weight:1000; font-size:10.5px; background:#fff;
  box-shadow:inset 0 1px 0 #fff, 0 1px 3px rgba(0,0,0,.04);
  transition: all 0.15s ease;
}
.az a:hover{
  background:linear-gradient(180deg,#fffef8 0%, #fffaed 100%);
  border-color:color-mix(in oklab,var(--gold-500),transparent 70%);
  transform: scale(1.08);
}

/* PREMIUM: Encabezado de letra con GLOW y RIM LIGHT */
.section-tag{
  position:sticky; top:calc(var(--appbar) + 10px); z-index:10; /* Por debajo de A-Z, por encima de lista */
  margin:-12px; margin-bottom:12px; padding:14px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  font-weight:1000; font-size:clamp(16px,1.8vw,19px); letter-spacing:.6px;
  color:#0b1220; background:linear-gradient(180deg,#ffffff 0%, #fafbfd 100%);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);
  backdrop-filter: blur(12px) saturate(1.08);
  isolation: isolate;
  transition: all 0.2s ease;
}
/* Efecto GLOW y RIM LIGHT sutil y difuminado */
.section-tag::before {
  content: '';
  position: absolute;
  inset: -3px;
  z-index: -1;
  border-radius: inherit;
  background: radial-gradient(
    ellipse 120% 80% at 50% -10%,
    color-mix(in oklab, var(--gold-500), transparent 65%) 0%,
    color-mix(in oklab, var(--gold-500), transparent 85%) 30%,
    transparent 60%
  );
  box-shadow:
    0 0 32px color-mix(in oklab, var(--gold-500), transparent 75%),
    0 0 16px color-mix(in oklab, var(--gold-500), transparent 85%);
  opacity: 0.85;
  filter: blur(4px);
}
.section-tag .count{font-weight:900; opacity:.7; font-size:.92em}
section[id^="sec-"]{ scroll-margin-top: calc(var(--appbar) + 72px) }

/* PREMIUM: Permitir que el texto del directorio se vea completo (sin truncamiento) */
#panel-directorio .item {
  grid-template-columns: 1fr auto;
  align-items: flex-start;
  padding: 14px 16px;
}
#panel-directorio .item .text {
  flex-direction: column;
  align-items: flex-start;
  gap: 6px;
  min-width: 0;
}
#panel-directorio .item .text > * {
  white-space: normal; /* Permite el salto de lÃ­nea */
  overflow: visible;
  text-overflow: clip;
  max-width: 100%;
}
#panel-directorio .item .text .line {
  width: 100%;
  word-wrap: break-word;
}
#panel-directorio .item .text .line:first-child {
  font-weight: 800;
  font-size: 1.02em;
  color: var(--ink);
  line-height: 1.4;
}
#panel-directorio .item .text .line:nth-child(2) {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  line-height: 1.5;
}
#panel-directorio .item .actions {
  min-width: auto;
  flex-shrink: 0;
}

#panel-directorio .list{grid-template-columns:1fr}
@media (min-width:900px){
  #panel-directorio .list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
}

/* ---------- BOTTOM NAV ---------- */
nav.bottom{position:fixed;left:0;right:0;bottom:0;z-index:60;background:#fff;border-top:1px solid var(--border);backdrop-filter: blur(6px) saturate(1.02)}
.bottom-inner{display:flex;align-items:center;gap:12px;height:calc(var(--bottom-h) + env(safe-area-inset-bottom));padding:10px clamp(10px,5vw,18px);padding-bottom:calc(10px + env(safe-area-inset-bottom))}
.icons-left{display:flex;align-items:center;gap:12px;}
.nav-btn{appearance:none;border:1px solid var(--border);background:var(--surface-2);border-radius:999px;box-shadow:var(--shadow-1);width:var(--nav-btn);height:var(--nav-btn);display:grid;place-items:center;cursor:pointer;transition:all .15s ease}
.nav-btn:hover{transform:scale(1.05)}
.nav-btn[aria-current="page"]{background:#fff;border-color:color-mix(in oklab,var(--gold-500),transparent 58%);box-shadow:0 8px 22px rgba(0,0,0,.08), inset 0 1px 0 #fff}
.nav-btn .ico{width:var(--ico-bottom);height:var(--ico-bottom)}
.divider{flex:1;height:1px;background:linear-gradient(90deg,transparent, var(--border), transparent)}
.active-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--surface-2);font-weight:900;font-size:.88em}
main.container{ padding-bottom: calc(var(--bottom-h) + env(safe-area-inset-bottom) + 24px) }

/* ---------- MODAL ---------- */
dialog{border:none;border-radius:var(--radius-xl);padding:0;max-width:min(540px,92vw);box-shadow:var(--shadow-2);background:#fff}
dialog::backdrop{background:rgba(11,18,32,.65);backdrop-filter:blur(4px)}
.modal-h{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface-2)}
.modal-h h3{margin:0;font-size:1.1rem;font-weight:1000}
.modal-b{padding:20px;display:grid;gap:14px}
.modal-f{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface-2)}

@media (prefers-reduced-motion: reduce){
  *{animation:none !important; transition:none !important}
  header.appbar, .card{backdrop-filter:none}
}
</style>
</head>

<body>
<!-- ===== SVGs (ICONOS PREMIUM) ===== -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;pointer-events:none">
  <defs>
    <linearGradient id="gLav" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#d9cbff"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
    <linearGradient id="gOra" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffd7b0"/><stop offset="1" stop-color="#FB923C"/></linearGradient>
    <linearGradient id="gInd" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#d6dbff"/><stop offset="1" stop-color="#6F7BF7"/></linearGradient>
    <linearGradient id="gGold" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffeaa8"/><stop offset="1" stop-color="#FACC15"/></linearGradient>
    <linearGradient id="gMint" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#a8ffe8"/><stop offset="1" stop-color="#06D6A0"/></linearGradient>

    <!-- PREMIUM: Icono Fonendoscopio RediseÃ±ado -->
    <symbol id="i-stetho" viewBox="0 0 24 24">
      <g opacity="0.95">
        <path fill="url(#gLav)" d="M8 3a2 2 0 0 0-2 2v9c0 2.21 1.79 4 4 4h4c2.21 0 4-1.79 4-4V5a2 2 0 0 0-2-2H8z" opacity="0.7"/>
        <circle cx="12" cy="19" r="2.5" fill="url(#gOra)" opacity="0.85"/>
        <path fill="url(#gMint)" d="M6 5a1 1 0 0 1 1-1h2v2H7a1 1 0 0 1-1-1zm10 0a1 1 0 0 0-1-1h-2v2h2a1 1 0 0 0 1-1z" opacity="0.9"/>
        <path stroke="url(#gInd)" stroke-width="1.5" stroke-linecap="round" d="M12 16.5v2M8 6v8c0 2.21 1.79 4 4 4s4-1.79 4-4V6" fill="none" opacity="0.6"/>
      </g>
    </symbol>

    <!-- swap -->
    <symbol id="i-swap" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M7.1 7.5a6 6 0 0 1 10.6-2.8l1.4 1.4L21 4.2v5.3h-5.3l1.9-1.9-1.4-1.4a4 4 0 0 0-7 2.3H7.1z"/>
      <path fill="url(#gOra)" d="M16.9 16.5a6 6 0 0 1-10.6 2.8l-1.4-1.4L3 19.8v-5.3h5.3l-1.9 1.9 1.4 1.4a4 4 0 0 0 7-2.3h2.1z"/>
    </symbol>
    <!-- edit -->
    <symbol id="i-edit" viewBox="0 0 24 24">
      <path fill="url(#gLav)" d="M17.7 3.3a1 1 0 0 1 1.4 0l1.6 1.6a1 1 0 0 1 0 1.4l-1.4 1.4-3-3 1.4-1.4z"/>
      <path fill="url(#gInd)" d="M15.6 6.4l3 3L9 19H6v-3l9.6-9.6z"/>
    </symbol>
    <!-- check -->
    <symbol id="i-check" viewBox="0 0 24 24">
      <path fill="none" stroke="url(#gMint)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
    </symbol>
    <!-- book -->
    <symbol id="i-book" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6z" opacity=".7"/>
      <path fill="url(#gLav)" d="M8 6h8v2H8V6zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"/>
    </symbol>
    <!-- calendar -->
    <symbol id="i-cal" viewBox="0 0 24 24">
      <rect x="3" y="4" width="18" height="18" rx="2" fill="url(#gInd)" opacity=".7"/>
      <path fill="url(#gOra)" d="M3 8h18v2H3z"/>
      <circle cx="8" cy="14" r="1.5" fill="url(#gLav)"/>
      <circle cx="12" cy="14" r="1.5" fill="url(#gLav)"/>
      <circle cx="16" cy="14" r="1.5" fill="url(#gLav)"/>
    </symbol>
    <!-- home -->
    <symbol id="i-home" viewBox="0 0 24 24">
      <path fill="url(#gLav)" d="M12 3l10 9h-3v9H5v-9H2l10-9z" opacity=".8"/>
      <rect x="9" y="14" width="6" height="7" fill="url(#gInd)" opacity=".6"/>
    </symbol>
    <!-- phone -->
    <symbol id="i-phone" viewBox="0 0 24 24">
      <path fill="url(#gMint)" d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.02-.24 11.36 11.36 0 0 0 3.57.57 1 1 0 0 1 1 1v3.49a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1 11.36 11.36 0 0 0 .57 3.57 1 1 0 0 1-.24 1.02l-2.2 2.2z"/>
    </symbol>
  </defs>
</svg>

<!-- ===== GATE (Login) ===== -->
<div id="gate" style="display:grid;place-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#f0f4ff 0%, #e8f0fe 100%)">
  <div style="text-align:center;max-width:420px">
    <div style="margin-bottom:24px">
      <div class="brand" style="display:inline-flex;margin-bottom:16px"><span class="brand-dot"></span><span>Aurora</span></div>
      <h2 style="margin:0 0 8px 0;font-size:clamp(24px,3vw,32px);font-weight:1000;color:#0b1220">Infecciosas 2.0</h2>
      <p class="muted" style="margin:0">Inicia sesiÃ³n con tu cuenta de Google para continuar</p>
    </div>
    <button id="signin" class="btn primary" style="font-size:1.05rem;padding:14px 24px">
      <svg class="ico" style="width:20px;height:20px" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Iniciar sesiÃ³n con Google
    </button>
    <p id="authErr" style="margin-top:16px;color:var(--coral-700);font-size:.9rem"></p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app" class="hide">

<header class="appbar">
  <div class="container">
    <div class="brand"><span class="brand-dot"></span><span>Aurora</span></div>
    <h1 id="title">Planta</h1>
    <div class="grow"></div>
    <div id="userchip" class="chip hide" style="gap:10px">
      <img id="avatar" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover"/>
      <span id="displayname"></span>
    </div>
    <button id="signout" class="btn hide">Cerrar sesiÃ³n</button>
  </div>
</header>

<main class="container">

<!-- ===== PLANTA ===== -->
<div id="panel-planta">
  <div class="card">
    <div class="card-h h-planta">
      <h2>Planta</h2>
      <span id="badge-auth" class="chip">Google: â€”</span>
    </div>
    <div class="card-b">
      <div style="display:grid;gap:12px;margin-bottom:18px">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="p-group-planta" class="btn primary">Planta</button>
          <button id="p-group-inter" class="btn">Interconsulta</button>
          <span id="addTarget" style="align-self:center;font-weight:800;font-size:.9rem" class="muted">AÃ±adiendo a: Planta</span>
        </div>
        <input id="p-room" placeholder="HabitaciÃ³n (ej. 301-1)" aria-label="HabitaciÃ³n"/>
        <input id="p-desc" placeholder="DescripciÃ³n del paciente" aria-label="DescripciÃ³n"/>
        <input id="p-pend" placeholder="Cosas pendientes (opcional)" aria-label="Pendientes"/>
        <button id="p-add" class="btn primary">+ AÃ±adir</button>
      </div>

      <details open style="margin-bottom:20px">
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">
          Planta (<span id="p-count-planta">0</span>)
        </summary>
        <ul id="p-list-planta" class="list"></ul>
        <p id="p-empty-planta" class="muted" style="text-align:center;padding:20px">No hay pacientes en planta</p>
      </details>

      <details open style="margin-bottom:20px">
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">
          Interconsulta (<span id="p-count-inter">0</span>)
        </summary>
        <ul id="p-list-inter" class="list"></ul>
        <p id="p-empty-inter" class="muted" style="text-align:center;padding:20px">No hay interconsultas</p>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">
          Completados (<span id="p-done-count">0</span>)
        </summary>
        <ul id="p-done" class="list"></ul>
        <p id="p-done-empty" class="muted" style="text-align:center;padding:20px">No hay completados</p>
      </details>
    </div>
  </div>
</div>

<!-- ===== TAREAS ===== -->
<div id="panel-tareas" class="hide">
  <div class="card">
    <div class="card-h h-tareas">
      <h2>Tareas</h2>
      <span class="chip"><span id="t-count">0</span> pendientes</span>
    </div>
    <div class="card-b">
      <div style="display:grid;gap:12px;margin-bottom:18px">
        <label>Fecha</label>
        <input id="t-date" type="date" aria-label="Fecha de la tarea"/>
        <label>DescripciÃ³n</label>
        <textarea id="t-text" placeholder="Describe la tarea..." aria-label="DescripciÃ³n de la tarea"></textarea>
        <button id="t-add" class="btn primary">+ AÃ±adir tarea</button>
      </div>

      <details open style="margin-bottom:20px">
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">Activas</summary>
        <ul id="t-list" class="list"></ul>
        <p id="t-empty" class="muted" style="text-align:center;padding:20px">No hay tareas activas</p>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">
          Completadas (<span id="t-done-count">0</span>)
        </summary>
        <ul id="t-done" class="list"></ul>
        <p id="t-done-empty" class="muted" style="text-align:center;padding:20px">No hay tareas completadas</p>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:1000;margin-bottom:12px;user-select:none">
          Papelera (<span id="t-trash-count">0</span>)
        </summary>
        <ul id="t-trash" class="list"></ul>
        <p id="t-trash-empty" class="muted" style="text-align:center;padding:20px">La papelera estÃ¡ vacÃ­a</p>
      </details>
    </div>
  </div>
</div>

<!-- ===== DIRECTORIO ===== -->
<div id="panel-directorio" class="hide">
  <div class="card">
    <div class="card-h h-dir">
      <h2>Directorio</h2>
      <span class="chip"><span id="dir-count">0</span> contactos</span>
    </div>
    <div class="card-b">
      <div style="display:grid;gap:12px;margin-bottom:18px">
        <label>Nombre / Servicio</label>
        <input id="dir-name" placeholder="Ej. AnatomÃ­a PatolÃ³gica" aria-label="Nombre o servicio"/>
        <label>TelÃ©fono</label>
        <input id="dir-tel" type="tel" placeholder="Ej. 91 123 45 67" aria-label="TelÃ©fono"/>
        <label>DescripciÃ³n (opcional)</label>
        <input id="dir-desc" placeholder="Ej. ExtensiÃ³n 2345, horario 8-15h" aria-label="DescripciÃ³n"/>
        <button id="dir-add" class="btn primary">+ AÃ±adir contacto</button>
      </div>

      <div id="dir-list-wrap" class="dir-wrap">
        <div id="dir-list-container"></div>
        <div class="az" id="dir-az"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== BIBLIOTECA ===== -->
<div id="panel-biblioteca" class="hide">
  <div class="card" style="margin-bottom:20px">
    <div class="card-h h-bib">
      <h2>Notas</h2>
    </div>
    <div class="card-b">
      <textarea id="notes-editor" placeholder="Escribe tus notas aquÃ­..." style="min-height:200px" aria-label="Editor de notas"></textarea>
      <button id="notes-save" class="btn primary" style="margin-top:12px">ðŸ’¾ Guardar notas</button>
      <p id="notes-status" class="muted" style="margin-top:8px;font-size:.88rem"></p>
    </div>
  </div>

  <div class="card">
    <div class="card-h h-bib">
      <h2>Documentos</h2>
      <span class="chip"><span id="bib-count">0</span> archivos</span>
    </div>
    <div class="card-b">
      <div style="display:grid;gap:12px;margin-bottom:18px">
        <label>TÃ­tulo del documento</label>
        <input id="bib-title" placeholder="Ej. Protocolo de sepsis" aria-label="TÃ­tulo del documento"/>
        <label>URL del archivo (PDF, imagen, etc.)</label>
        <input id="bib-url" type="url" placeholder="https://..." aria-label="URL del archivo"/>
        <button id="bib-add" class="btn primary">+ AÃ±adir documento</button>
      </div>

      <ul id="bib-list" class="list"></ul>
      <p id="bib-empty" class="muted" style="text-align:center;padding:20px">No hay documentos</p>
    </div>
  </div>
</div>

</main>

<!-- ===== BOTTOM NAV ===== -->
<nav class="bottom">
  <div class="bottom-inner" id="bottomNav">
    <div class="icons-left">
      <button id="b-planta" class="nav-btn" aria-current="page" aria-label="Planta">
        <svg class="ico" aria-hidden="true"><use href="#i-home"/></svg>
      </button>
      <button id="b-tareas" class="nav-btn" aria-current="false" aria-label="Tareas">
        <svg class="ico" aria-hidden="true"><use href="#i-cal"/></svg>
      </button>
      <button id="b-directorio" class="nav-btn" aria-current="false" aria-label="Directorio">
        <svg class="ico" aria-hidden="true"><use href="#i-phone"/></svg>
      </button>
      <button id="b-biblioteca" class="nav-btn" aria-current="false" aria-label="Biblioteca">
        <svg class="ico" aria-hidden="true"><use href="#i-book"/></svg>
      </button>
    </div>
    <div class="divider"></div>
    <div class="active-chip">
      <svg class="ico" style="width:18px;height:18px" aria-hidden="true"><use href="#i-stetho"/></svg>
      <span id="activeLabel">Planta</span>
    </div>
  </div>
</nav>

</div>

<!-- ===== MODAL EDICIÃ“N ===== -->
<dialog id="editModal">
  <div class="modal-h">
    <h3>Editar</h3>
    <button id="modal-close" class="btn icon" aria-label="Cerrar">âœ•</button>
  </div>
  <div class="modal-b" id="modal-fields"></div>
  <div class="modal-f">
    <button id="modal-cancel" class="btn">Cancelar</button>
    <button id="modal-save" class="btn primary">Guardar</button>
  </div>
</dialog>

<!-- ===== MODAL VISOR ===== -->
<dialog id="viewerModal">
  <div class="modal-h">
    <h3 id="viewer-title">Documento</h3>
    <button id="viewer-close" class="btn icon" aria-label="Cerrar">âœ•</button>
  </div>
  <div class="modal-b">
    <iframe id="viewer-frame" class="viewer" title="Visor de documentos"></iframe>
  </div>
</dialog>

<script type="module">
/* ===== Helpers ===== */
const $=(s)=>document.querySelector(s); const $$=(s)=>document.querySelectorAll(s);
const esc=(s)=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
const todayISO=()=>new Date().toISOString().slice(0,10);
const toast=(m)=>{console.log('[Toast]',m)};
const setNotif=(n)=>{if('setAppBadge' in navigator) navigator.setAppBadge?.(n||0).catch(()=>{})};

/* ===== Firebase ===== */
const BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:8000/':'./';
const appMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
const authMod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
const { firebaseConfig } = await import(BASE + 'firebase-config.js');
const fbApp=appMod.initializeApp(firebaseConfig);
const auth =authMod.getAuth(fbApp);
const db   =fsMod.initializeFirestore(fbApp,{localCache:fsMod.persistentLocalCache({tabManager:fsMod.persistentMultipleTabManager()})});
const serverTS=fsMod.serverTimestamp;

/* ===== Auth ===== */
const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();
const doSignIn=async()=>{try{ if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider); else await authMod.signInWithPopup(auth,provider);}catch(e){$('#authErr').textContent=e.message||String(e)}};
$('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

authMod.onAuthStateChanged(auth, user=>{
  if(user){
    badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
    if($('#avatar')) avatar.src=user.photoURL||''; if($('#displayname')) displayname.textContent=user.displayName||user.email||'';
    userchip?.classList.remove('hide'); $('#signout')?.classList.remove('hide'); $('#signin')?.classList.add('hide');
    gate.classList.add('hide'); appUI.classList.remove('hide'); mount(user.uid);
  }else{
    badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
    userchip?.classList.add('hide'); $('#signout')?.classList.add('hide'); $('#signin')?.classList.remove('hide');
    appUI.classList.add('hide'); gate.classList.remove('hide'); unmount();
  }
});

/* ===== Colecciones ===== */
const col={
  planta:(uid)=>fsMod.collection(db,'users',uid,'planta'),
  tareas:(uid)=>fsMod.collection(db,'users',uid,'tareas'),
  dir:(uid)=>fsMod.collection(db,'users',uid,'directorio'),
  biblio:(uid)=>fsMod.collection(db,'users',uid,'biblioteca'),
  notes:(uid)=>fsMod.doc(db,'users',uid,'biblioteca','__notes__'),
};
let unsubs=[]; const currentUid=()=>auth.currentUser?.uid; function unmount(){unsubs.forEach(u=>u&&u()); unsubs=[];}
const pushRetry=(job)=>{try{const q=JSON.parse(localStorage.getItem('aurora.retry')||'[]'); q.push(job); localStorage.setItem('aurora.retry',JSON.stringify(q));}catch{}};
async function upd(kind,id,patch){const ref=fsMod.doc(db,'users',currentUid(),kind,id);const data={...patch,updatedAt:serverTS()};try{await fsMod.updateDoc(ref,data);}catch{pushRetry({path:ref.path,data});toast('Se guardarÃ¡ al recuperar conexiÃ³n')}}
async function del(kind,id){const ref=fsMod.doc(db,'users',currentUid(),kind,id);try{await fsMod.deleteDoc(ref);}catch{pushRetry({path:ref.path,data:{__delete__:true}});toast('Se eliminarÃ¡ al reconectar')}}

/* ===== NAV ===== */
const activeLabel=$('#activeLabel');
const mapTabs={planta:['panel-planta','b-planta','Planta'],tareas:['panel-tareas','b-tareas','Tareas'],directorio:['panel-directorio','b-directorio','Directorio'],biblioteca:['panel-biblioteca','b-biblioteca','Biblioteca']};
function selectTab(id){for(const k in mapTabs){const [p,b,l]=mapTabs[k]; const sel=(k===id); $('#'+p)?.classList.toggle('hide',!sel); const btn=$('#'+b); if(btn){btn.setAttribute('aria-current', sel?'page':'false'); btn.tabIndex=sel?0:-1;} if(sel){$('#title').textContent=l; activeLabel.textContent=l;}} localStorage.setItem('tab', id); location.hash=id;}
$('#b-planta').onclick =()=>selectTab('planta'); $('#b-tareas').onclick =()=>selectTab('tareas'); $('#b-directorio').onclick=()=>selectTab('directorio'); $('#b-biblioteca').onclick=()=>selectTab('biblioteca');
const orderBottom=['b-planta','b-tareas','b-directorio','b-biblioteca'];
$('#bottomNav').addEventListener('keydown',(e)=>{const active=document.activeElement; const i=orderBottom.indexOf(active?.id); if(i<0) return; let j=i; if(e.key==='ArrowRight') j=(i+1)%orderBottom.length; else if(e.key==='ArrowLeft') j=(i-1+orderBottom.length)%orderBottom.length; else if(e.key==='Home') j=0; else if(e.key==='End') j=orderBottom.length-1; else if(e.key==='Enter'||e.key===' '){active.click(); return;} e.preventDefault(); const btn=$('#'+orderBottom[j]); btn?.focus(); btn?.click();},{passive:false});
addEventListener('hashchange',()=>{const h=location.hash.slice(1); if(mapTabs[h]) selectTab(h);},{passive:true});

/* ===== Planta ===== */
let currentGroup='planta';
const updateAddTarget=()=>$('#addTarget').textContent=currentGroup==='planta'?'AÃ±adiendo a: Planta':'AÃ±adiendo a: Interconsulta';
$('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget();};
$('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget();};

const plantaDoc=(d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(), grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
const roomSortKey=(s)=>{ if(!s) return 1e9; const m=String(s).match(/\d+/g); if(!m) return 1e9; const a=parseInt(m[0],10); const b=m[1]?parseInt(m[1],10)/100:0; return a+b; };

function plantaItem(x,done=false){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<span class="pill room" data-group="${x.grupo||'planta'}">${esc(x.room||'â€”')}</span>
  <div class="text">${done?`<div class="line" style="text-decoration:line-through">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
  ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
  <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');

  const swap=document.createElement('button'); swap.className='btn icon swap'; swap.title='Cambiar entre Planta e Interconsulta';
  swap.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-swap"/></svg>`;
  swap.onclick=()=>upd('planta',x.__id,{grupo:(x.grupo==='interconsulta')?'planta':'interconsulta'});

  const editB=btn('',()=>editPlanta(x),'btn icon'); editB.title='Editar';
  editB.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`;

  const actB=btn('',()=> done?del('planta',x.__id):upd('planta',x.__id,{status:'done'}),'btn icon'); actB.title=done?'Eliminar':'Marcar completado';
  actB.innerHTML = done ? `<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`
                       : `<svg class="ico" aria-hidden="true"><use href="#i-check"/></svg>`;

  a.append(swap, editB, actB);
  return li;
}
const btn=(t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; if(t) b.textContent=t; b.onclick=(e)=>{e.preventDefault();fn?.(e)}; b.type='button'; return b;};
const val=(id)=>document.getElementById(id)?.value||'';
const editPlanta=(x)=>openEdit([{l:'HabitaciÃ³n',id:'p_room',v:x.room||''},{l:'DescripciÃ³n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}], async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')}));

function setupPlanta(uid){
  $('#p-add').onclick=async()=>{ const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup}); if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(i=>$('#'+i).value=''); };
  const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));
  const u1=fsMod.onSnapshot(qA,(s)=>{ const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x)});
    const arrP=all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const arrI=all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
    arrP.forEach(x=>lp.appendChild(plantaItem(x))); arrI.forEach(x=>li.appendChild(plantaItem(x)));
    $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
    $('#p-count-planta').textContent=arrP.length; $('#p-count-inter').textContent=arrI.length; });
  const u2=fsMod.onSnapshot(qD,(s)=>{ const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x)}); arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(plantaItem(x,true))); $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=arr.length; });
  unsubs.push(u1,u2);
}

/* ===== Tareas ===== */
const tareaDoc=(d)=>({date:d.date||todayISO(),text:(d.text||'').trim(),status:d.status||'active',createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});
const daysFromToday=(iso)=>{try{const d=new Date(iso+'T00:00:00'); const t=new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24));}catch{return 0}};
const fmtDate=(iso)=>{try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,'');}catch{return iso}};
function tareaItem(x){
  const li=document.createElement('li'); li.className='item';
  const diff=daysFromToday(x.date);
  const h=isNaN(diff)?205:(diff<=-7?0:(diff<0?10:Math.round(10+(Math.min(diff,30)/30)*120)));
  li.style.borderLeft=`6px solid hsl(${h} 72% 46%)`;
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(
    btn('',()=>upd('tareas',x.__id,{status:'done'}),'btn icon')
      .appendChild(Object.assign(document.createElementNS('http://www.w3.org/2000/svg','svg'),{classList:['ico'],innerHTML:'<use href="#i-check"/>'}))||li.querySelector('.actions').lastChild,
    btn('âœŽ',()=>editTarea(x),'btn icon'),
    btn('ðŸ—‘ï¸',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon')
  ); return li;
}
function tareaDone(x){
  const li=document.createElement('li'); li.className='item'; li.style.borderLeft=`6px solid hsl(150 50% 38%)`;
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text"><div class="line" style="text-decoration:line-through">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(btn('â†©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('âœ–',()=>del('tareas',x.__id),'btn icon')); return li;
}
function tareaTrash(x){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text muted"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(btn('â¤´',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('âœ–',()=>del('tareas',x.__id),'btn icon')); return li;
}
const editTarea=(x)=>openEdit([{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'DescripciÃ³n',id:'t_text',v:x.text||''}], async()=>upd('tareas',x.__id,{date:$('#t_date').value,text:$('#t_text').value}));

function setupTareas(uid){
  $('#t-date').value=todayISO();
  $('#t-add').onclick=async()=>{const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return; await fsMod.addDoc(col.tareas(uid),tareaDoc({date,text})); $('#t-text').value='';};
  const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
  const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));
  const u1=fsMod.onSnapshot(qA,(snap)=>{const arr=[];snap.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)});
    arr.sort((a,b)=>daysFromToday(a.date)-daysFromToday(b.date)||(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    const list=$('#t-list'); list.innerHTML=''; arr.forEach(x=>list.appendChild(tareaItem(x))); $('#t-count').textContent=arr.length; $('#t-empty').style.display=arr.length?'none':'block'; setNotif(arr.length)});
  const u2=fsMod.onSnapshot(qD,(s)=>{const arr=[];s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)}); arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#t-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(tareaDone(x))); $('#t-done-empty').style.display=arr.length?'none':'block'; $('#t-done-count').textContent=arr.length});
  const u3=fsMod.onSnapshot(qT,(s)=>{const arr=[];s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)}); arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#t-trash'); l.innerHTML=''; arr.forEach(x=>l.appendChild(tareaTrash(x))); $('#t-trash-empty').style.display=arr.length?'none':'block'; $('#t-trash-count').textContent=arr.length});
  unsubs.push(u1,u2,u3);
}

/* ===== Directorio ===== */
const dirDoc=(d)=>({name:(d.name||'').trim(),tel:(d.tel||'').trim(),desc:(d.desc||'').trim(),createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});
function dirItem(x){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<div class="text">
    <div class="line">${esc(x.name||'â€”')}</div>
    <div class="line"><span class="pill tel">${esc(x.tel||'â€”')}</span>${x.desc?`<span class="muted">${esc(x.desc)}</span>`:''}</div>
  </div>
  <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');
  const editB=btn('âœŽ',()=>editDir(x),'btn icon'); editB.title='Editar';
  const delB=btn('âœ–',()=>del('directorio',x.__id),'btn icon'); delB.title='Eliminar';
  a.append(editB,delB);
  return li;
}
const editDir=(x)=>openEdit([{l:'Nombre',id:'dir_name',v:x.name||''},{l:'TelÃ©fono',id:'dir_tel',v:x.tel||''},{l:'DescripciÃ³n',id:'dir_desc',v:x.desc||''}], async()=>upd('directorio',x.__id,{name:val('dir_name'),tel:val('dir_tel'),desc:val('dir_desc')}));

function setupDirectorio(uid){
  $('#dir-add').onclick=async()=>{const d=dirDoc({name:val('dir-name'),tel:val('dir-tel'),desc:val('dir-desc')}); if(!d.name && !d.tel) return; await fsMod.addDoc(col.dir(uid),d); ['dir-name','dir-tel','dir-desc'].forEach(i=>$('#'+i).value='');};
  const q=fsMod.query(col.dir(uid));
  const u=fsMod.onSnapshot(q,(s)=>{
    const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x)});
    arr.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    $('#dir-count').textContent=arr.length;

    const grouped={};
    arr.forEach(x=>{
      const first=(x.name||'â€”').charAt(0).toUpperCase();
      const letter=/[A-Z]/.test(first)?first:'#';
      if(!grouped[letter]) grouped[letter]=[];
      grouped[letter].push(x);
    });

    const letters=Object.keys(grouped).sort();
    const container=$('#dir-list-container');
    container.innerHTML='';
    letters.forEach(letter=>{
      const section=document.createElement('section');
      section.id=`sec-${letter}`;
      const tag=document.createElement('div');
      tag.className='section-tag';
      tag.innerHTML=`<span style="font-size:1.3em;opacity:.9">${letter}</span><span class="count">${grouped[letter].length}</span>`;
      section.appendChild(tag);
      const ul=document.createElement('ul');
      ul.className='list';
      grouped[letter].forEach(x=>ul.appendChild(dirItem(x)));
      section.appendChild(ul);
      container.appendChild(section);
    });

    const azDiv=$('#dir-az');
    azDiv.innerHTML='';
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l=>{
      const a=document.createElement('a');
      a.href=`#sec-${l}`;
      a.textContent=l;
      if(!grouped[l]) a.style.opacity='0.3';
      azDiv.appendChild(a);
    });
  });
  unsubs.push(u);
}

/* ===== Biblioteca ===== */
const biblioDoc=(d)=>({title:(d.title||'').trim(),url:(d.url||'').trim(),createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});
function biblioItem(x){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<div class="text"><div class="line">${esc(x.title||'â€”')}</div><div class="muted">${esc(x.url||'')}</div></div><div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');
  const viewB=btn('ðŸ‘',()=>openViewer(x.title,x.url),'btn icon'); viewB.title='Ver';
  const editB=btn('âœŽ',()=>editBiblio(x),'btn icon'); editB.title='Editar';
  const delB=btn('âœ–',()=>del('biblioteca',x.__id),'btn icon'); delB.title='Eliminar';
  a.append(viewB,editB,delB);
  return li;
}
const editBiblio=(x)=>openEdit([{l:'TÃ­tulo',id:'bib_title',v:x.title||''},{l:'URL',id:'bib_url',v:x.url||''}], async()=>upd('biblioteca',x.__id,{title:val('bib_title'),url:val('bib_url')}));

function setupBiblioteca(uid){
  $('#bib-add').onclick=async()=>{const d=biblioDoc({title:val('bib-title'),url:val('bib-url')}); if(!d.title && !d.url) return; await fsMod.addDoc(col.biblio(uid),d); ['bib-title','bib-url'].forEach(i=>$('#'+i).value='');};
  const q=fsMod.query(col.biblio(uid));
  const u=fsMod.onSnapshot(q,(s)=>{const arr=[];s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)}); arr.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); const l=$('#bib-list'); l.innerHTML=''; arr.forEach(x=>l.appendChild(biblioItem(x))); $('#bib-empty').style.display=arr.length?'none':'block'; $('#bib-count').textContent=arr.length});
  unsubs.push(u);

  const notesRef=col.notes(uid);
  const editor=$('#notes-editor'), status=$('#notes-status');
  fsMod.getDoc(notesRef).then(d=>{if(d.exists()) editor.value=d.data().text||'';}).catch(()=>{});
  $('#notes-save').onclick=async()=>{try{await fsMod.setDoc(notesRef,{text:editor.value,updatedAt:serverTS()},{merge:true}); status.textContent='âœ“ Guardado '+new Date().toLocaleTimeString();}catch(e){status.textContent='Error: '+e.message}};
}

/* ===== Modal EdiciÃ³n ===== */
const editModal=$('#editModal');
let editSaveFn=null;
function openEdit(fields,saveFn){
  const container=$('#modal-fields');
  container.innerHTML='';
  fields.forEach(f=>{
    const label=document.createElement('label'); label.textContent=f.l;
    const input=document.createElement('input'); input.id=f.id; input.value=f.v||'';
    container.append(label,input);
  });
  editSaveFn=saveFn;
  editModal.showModal();
}
$('#modal-close').onclick=()=>editModal.close();
$('#modal-cancel').onclick=()=>editModal.close();
$('#modal-save').onclick=async()=>{if(editSaveFn) await editSaveFn(); editModal.close();};

/* ===== Modal Visor ===== */
const viewerModal=$('#viewerModal');
function openViewer(title,url){
  $('#viewer-title').textContent=title||'Documento';
  $('#viewer-frame').src=url;
  viewerModal.showModal();
}
$('#viewer-close').onclick=()=>{viewerModal.close(); $('#viewer-frame').src='';};

/* ===== Mount ===== */
function mount(uid){
  setupPlanta(uid);
  setupTareas(uid);
  setupDirectorio(uid);
  setupBiblioteca(uid);
  const saved=localStorage.getItem('tab');
  if(saved && mapTabs[saved]) selectTab(saved);
  else if(location.hash.slice(1) && mapTabs[location.hash.slice(1)]) selectTab(location.hash.slice(1));
  else selectTab('planta');
}
</script>

</body>
</html>
