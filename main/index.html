<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#ffffff"/>
<title>Infecciosas</title>
<link rel="manifest" href="manifest.webmanifest"/>
<link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<style>
/* ===== AJUSTES SOLICITADOS ==========================
   - Mantener estructura y colores de secciones
   - Descripciones completas (sin truncado)
   - Directorio sin solapes, encabezado por letra con glow
   - Barra A–Z premium a la derecha
   - Icono de fonendoscopio más “premium”
===================================================== */

/* ---------- TOKENS & BASE ---------- */
:root{
  --ink:#0b1220; --muted:#5a667a;
  --surface:#ffffff; --surface-2:#f7f9fc; --border:#e8eef5;

  --lav:#EAE2FF; --lav-700:#8B5CF6;
  --ora:#FFE5D1; --ora-700:#FB923C;
  --coral-700:#F43F5E; --green-700:#10B981;
  --indigo-600:#6366F1; --gold-500:#FACC15;
  --mint-600:#06D6A0; --teal-600:#1B9AAA;

  --gx-planta: linear-gradient(135deg,#F5F0FF 0%, #EAE2FF 55%, #C7B8FF 100%);
  --gx-inter:  linear-gradient(135deg,#FFF3E4 0%, #FFE5D1 55%, #FFD0A3 100%);
  --gx-tareas: linear-gradient(135deg,#FFE4E9 0%, #FFC9D4 55%, #FFA9B9 100%);
  --gx-green:  linear-gradient(135deg,#E9FFF1 0%, #CFFAE2 55%, #B2F5D4 100%);
  --gx-dir:    linear-gradient(135deg,#FFFBE5 0%, #FFF1B5 55%, #FFE783 100%);
  --gx-bib:    linear-gradient(135deg,#EDF2FF 0%, #DDE4FF 55%, #C7D3FF 100%);
  --gx-extra:  linear-gradient(135deg,#FDE7FA 0%, #F9CEF5 55%, #F3B1EF 100%);

  --gx-celeste: linear-gradient(135deg,#E9F4FF 0%, #D6ECFF 55%, #BCE2FF 100%);
  --gx-turq:    linear-gradient(135deg,#E8FFFB 0%, #CFFAF2 55%, #B3F4E9 100%);
  --gx-coral:   linear-gradient(135deg,#FFE8EC 0%, #FFC9D3 55%, #FFA9B9 100%);

  --glass-bg: linear-gradient(180deg,rgba(255,255,255,.92) 0%, rgba(247,249,252,.82) 100%);
  --rim-ambient: radial-gradient(60% 40% at 50% 0%, rgba(255,255,255,.38), rgba(255,255,255,0));
  --shadow-1: 0 1px 2px rgba(7,16,31,.05), 0 8px 24px rgba(7,16,31,.06);
  --shadow-2: 0 2px 10px rgba(7,16,31,.10), 0 20px 40px rgba(7,16,31,.14);

  --radius:14px; --radius-xl:22px; --appbar:64px; --touch:44px;
  --fs: clamp(15px, 0.85vw + 0.35vh, 18px);
  --h2: clamp(20px, 2.6vw, 26px);
  --vh: 1vh;

  --bottom-h: 68px; --nav-btn: 56px; --ico-bottom: 28px;
}
@media (max-width:480px){ :root{ --bottom-h:64px; --nav-btn:52px; --ico-bottom:26px } }
@media (min-width:1025px){ :root{ --bottom-h:72px; --nav-btn:60px; --ico-bottom:28px } }

*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--surface);
  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  font-size:var(--fs); line-height:1.65; min-height:calc(var(--vh)*100);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent; overflow-x:hidden;
  text-rendering:optimizeLegibility; overscroll-behavior-y:none;
}
:focus-visible{
  outline:3px solid color-mix(in oklab,var(--lav-700),white 70%);
  outline-offset:2px; border-radius:12px;
}
.container{
  max-width:min(1180px,98vw);
  margin:0 auto;
  padding:8px clamp(12px,4vw,20px);
  container-type:inline-size;
}
.grow{flex:1;min-width:0}
.hide{display:none !important}
.muted{color:var(--muted)}
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
svg.ico{display:block}

/* ---------- APPBAR ---------- */
header.appbar{
  position:sticky; top:0; z-index:50;
  min-height:var(--appbar);
  backdrop-filter: blur(8px) saturate(1.06);
  background: var(--glass-bg);
  border-bottom:1px solid var(--border);
}
.appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand{
  padding:10px 14px;border-radius:999px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);
  box-shadow:inset 0 1px 0 #fff, var(--shadow-1);
  display:inline-flex;align-items:center;gap:10px;
  font-weight:1000;letter-spacing:.2px;
}
.brand-dot{width:10px;height:10px;border-radius:50%;background:var(--gold-500)}
h1#title{
  margin:0;font-size:clamp(18px,2.2vw,22px);
  font-weight:1000;letter-spacing:.2px;color:#0e1624;
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.05));
}

/* ---------- CARDS ---------- */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(255,255,255,.82) 100%);
  backdrop-filter: blur(8px) saturate(1.06);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  box-shadow: 0 18px 36px rgba(60,100,180,.12);
  overflow:hidden; contain:content;
}
.card-h{
  position:relative; padding:16px 18px 18px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid color-mix(in oklab,#000,transparent 90%);
  background:#fff; isolation:isolate; overflow:hidden;
  box-shadow:
    inset 0 0 0 1px color-mix(in oklab,var(--ink),transparent 92%),
    inset 0 0 0 8px rgba(255,255,255,.65);
  outline: 1px solid rgba(140,160,220,.18); outline-offset: -6px;
}
.card-h::before{
  content:""; position:absolute; inset:0 0 auto 0;
  height:46px; z-index:0; opacity:.95;
  background: var(--gx-neutral, linear-gradient(135deg,#F3F6FB 0%, #EDF2F9 100%));
}
.card-h::after{
  content:""; position:absolute; inset:-20% -10% auto -10%;
  height:160%; background: var(--rim-ambient);
  mix-blend-mode:screen; opacity:.6; z-index:0;
}
.card-h > *{position:relative; z-index:2}
.card-h h2{
  margin:0;font-size:var(--h2);font-weight:1000;
  letter-spacing:.2px;color:#0b1220;line-height:1.15;
  transform:translateY(-1px);
}
.card-h h2::after{
  content:""; position:absolute; left:-2px; right:-2px; bottom:-8px;
  height:6px; border-radius:999px;
  background: color-mix(in oklab, var(--accent, #6b7280), white 45%);
  box-shadow: 0 0 14px color-mix(in oklab, var(--accent, #6b7280), white 10%);
  z-index:-1; pointer-events:none;
}
.card-b{position:relative;z-index:1;padding:12px}

.h-planta{ --gx-neutral: var(--gx-planta); --accent: var(--lav-700) }
.h-inter { --gx-neutral: var(--gx-inter);  --accent: var(--ora-700) }
.h-tareas{ --gx-neutral: var(--gx-tareas); --accent: var(--coral-700) }
.h-green { --gx-neutral: var(--gx-green);  --accent: var(--green-700) }
.h-dir   { --gx-neutral: var(--gx-dir);    --accent: var(--gold-500) }
.h-bib   { --gx-neutral: var(--gx-bib);    --accent: var(--indigo-600) }
.h-celeste{ --gx-neutral: var(--gx-celeste); --accent:#3B82F6 }
.h-turq   { --gx-neutral: var(--gx-turq);    --accent: var(--mint-600) }
.h-coral  { --gx-neutral: var(--gx-coral);   --accent: var(--coral-700) }

/* ---------- CONTENIDO Y BOTONES ---------- */
.chip{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border:1px solid var(--border);
  border-radius:999px;font-size:.84rem;
  background:var(--surface-2);box-shadow:inset 0 1px 0 #fff;
}
.chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
.chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}
.btn{
  appearance:none;border:1px solid var(--border);
  background:#fff;color:var(--ink);
  padding:10px 12px;border-radius:14px;
  box-shadow:var(--shadow-1);
  min-height:var(--touch);
  display:inline-flex;align-items:center;gap:8px;
  cursor:pointer;font-weight:800;
}
.btn.primary{
  background:linear-gradient(180deg,#fffdf3 0%, #fff7d1 100%);
  border-color:color-mix(in oklab,var(--gold-500),transparent 65%);
  box-shadow:var(--shadow-2);
}
.btn.icon{
  min-width:36px;height:36px;padding:0;
  display:grid;place-items:center;
}
.btn.icon .ico{width:20px;height:20px}
.btn.icon.swap .ico{width:23px;height:23px}

/* ---------- LISTAS / INPUTS ---------- */
ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
li.item{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px;
  align-items:flex-start; /* mejor para textos multilínea */
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  background:#fff;
}

/* Habitación en una sola línea */
.pill{
  display:inline-flex;align-items:center;justify-content:center;
  font-weight:900;font-size:14px;
  padding:7px 12px;border-radius:14px;line-height:1;
  border:1px solid transparent;color:#0d1726;
  background:var(--surface-2);box-shadow:inset 0 1px 0 #fff;
}
.pill.room{
  font-family: ui-monospace,Consolas,Menlo,monospace;
  font-size:clamp(22px,3.2vw,26px);
  padding:12px 16px; letter-spacing:.3px; color:#07101f;
  background:#fff; white-space:nowrap;
  border:1px solid color-mix(in oklab,var(--lav-700),transparent 78%);
  box-shadow:0 0 0 1px color-mix(in oklab,#000,transparent 90%),
             inset 0 1px 0 #fff,
             0 14px 30px rgba(7,16,31,.08);
}
.pill.room[data-group="planta"]{
  background: linear-gradient(180deg,#ffffff 0%, #faf7ff 100%);
  border-color: color-mix(in oklab,var(--lav-700),transparent 65%);
  box-shadow: 0 0 0 6px color-mix(in oklab,var(--lav),transparent 60%),
              inset 0 1px 0 #fff,
              0 14px 30px rgba(7,16,31,.08);
}
.pill.room[data-group="interconsulta"]{
  background: linear-gradient(180deg,#ffffff 0%, #fff7f0 100%);
  border-color: color-mix(in oklab,var(--ora-700),transparent 60%);
  box-shadow: 0 0 0 6px color-mix(in oklab,var(--ora),transparent 58%),
              inset 0 1px 0 #fff,
              0 14px 30px rgba(7,16,31,.08);
}
.pill.date{font-weight:1000}
.pill.tel{font-weight:800}

/* Texto: ahora multilínea, sin truncado */
.item .text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:4px;
  min-width:0;
}
.item .text > *{
  /* REGION: CSS-TEXT-FIX-START */
/* Evitar cortes feos de palabras en todas las tarjetas */
.item .text,
.item .text *{
  word-break: normal !important;
  overflow-wrap: anywhere;
  hyphens: auto;
}
/* REGION: CSS-TEXT-FIX-END */

  white-space: normal;
  overflow: visible;
  text-overflow: clip;
  max-width: 100%;
  /* >>> aquí cambiamos el comportamiento de corte <<< */
  word-break: normal;
  overflow-wrap: anywhere;
  line-height: 1.25;
}
.item .text .muted{opacity:.8}

/* Acciones */
.item .actions{
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  gap:6px;
  min-width:114px;
}

/* Inputs */
label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
input,textarea,select{
  width:100%;border:1px solid var(--border);
  border-radius:12px;padding:12px;
  background:#fff;color:var(--ink);
  font:inherit;min-height:var(--touch);
  box-shadow:inset 0 1px 0 #fff;
}
textarea{min-height:90px;resize:vertical}

/* ---------- VISOR ---------- */
.viewer{
  width:100%;
  block-size: min(72vh, calc(100dvh - var(--appbar) - var(--bottom-h) - env(safe-area-inset-bottom) - 48px));
  border:1px solid var(--border);
  border-radius:16px;
  background:#fff;
  box-shadow:var(--shadow-1);
}

/* ---------- DIRECTORIO ---------- */
.dir-wrap{
  display:grid;
  grid-template-columns:minmax(0,1fr) min(30px,6.5vw);
  gap:12px;align-items:start;
}
.dir-wrap > div:first-child{min-width:0}

/* Índice A–Z */
.az{
  position:sticky; top:calc(var(--appbar) + 10px);
  display:grid; gap:6px; align-content:start;
  z-index:1;
  padding:4px; border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(245,248,253,.85));
  border:1px solid var(--border);
  backdrop-filter: blur(6px);
}
.az a{
  display:grid;place-items:center;
  width:100%; aspect-ratio:1/1;
  border:1px solid var(--border);
  border-radius:10px;
  text-decoration:none;
  color:#1d2838;
  font-weight:1000;font-size:11px;
  background:#fff;
  box-shadow:inset 0 1px 0 #fff;
  transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease, background .18s ease;
}
.az a:hover,
.az a:focus-visible{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(15,23,42,.18);
  border-color:color-mix(in oklab,var(--gold-500),transparent 60%);
}
.az a.is-active{
  background:radial-gradient(circle at 30% 0%,#fffbe5,#fde68a);
  border-color:color-mix(in oklab,var(--gold-500),transparent 45%);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 10px 24px rgba(15,23,42,.25);
}

/* Encabezado por letra con glow */
/* REGION: CSS-DIRECTORIO-START */

/* Cuando uses la barra A-Z, que la sección baje un poco para no pegarse al appbar */
#panel-directorio section{
  scroll-margin-top: calc(var(--appbar) + 16px);
}

/* Cabecera por letra: A / ADMISIÓN (14) con glow elegante, pero sin solapar */
.section-tag{
  position: relative;      /* ya NO es sticky */
  top: auto;
  z-index: 0;

  display: inline-flex;
  align-items: center;
  gap: 8px;

  margin: 6px 0 10px 0;    /* espacio arriba y abajo */
  padding: 8px 18px;

  border-radius: 999px;
  background: #fff9e5;     /* amarillo suave */
  box-shadow: 0 10px 26px rgba(0,0,0,.06);  /* glow premium */
}

/* Lista de contactos de cada letra: un poco de aire debajo del chip */
#panel-directorio section > ul{
  margin: 0;
  padding-top: 4px;        /* separa el primer contacto del chip */
}

/* REGION: CSS-DIRECTORIO-END */
.section-main{
  display:flex;
  align-items:center;
  gap:12px;
}
.section-letter-pill{
  position:relative;
  min-width:40px;min-height:40px;
  border-radius:999px;
  display:grid;place-items:center;
  font-size:20px;font-weight:1000;
  letter-spacing:.12em;
  background:
    radial-gradient(120% 120% at 0% 0%,rgba(255,255,255,.95),rgba(250,232,255,0)),
    radial-gradient(120% 120% at 100% 0%,rgba(253,246,178,.95),rgba(252,211,77,0));
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 0 0 1px color-mix(in oklab,var(--gold-500),transparent 40%),
    0 10px 24px rgba(15,23,42,.22);
}
.section-letter-pill::after{
  content:"";
  position:absolute;
  inset:-30%;
  border-radius:inherit;
  background:radial-gradient(70% 50% at 50% 0%,rgba(255,255,255,.9),transparent);
  mix-blend-mode:screen;
  opacity:.7;
  pointer-events:none;
}
.section-letter-pill span{transform:translateY(1px)}
.section-meta{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.section-name{
  font-size:.78rem;
  text-transform:uppercase;
  letter-spacing:.16em;
  opacity:.85;
}
.section-tag .count{
  font-size:.78rem;
  font-weight:900;
  opacity:.7;
}
section[id^="sec-"]{ scroll-margin-top: calc(var(--appbar) + 56px) }

/* Lista directorio */
#panel-directorio .list{grid-template-columns:1fr}
@media (min-width:900px){
  #panel-directorio .list{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  #panel-directorio .list > li.item{
    grid-template-columns:auto 1fr auto;
  }
}

/* Píldora de sección en cada contacto */
.dir-sec-pill{
  display:inline-flex;
  align-items:center;
  padding:3px 8px;
  margin-left:8px;
  border-radius:999px;
  font-size:.78rem;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.12em;
  background:linear-gradient(135deg,#fff7ed,#fffbeb);
  border:1px solid color-mix(in oklab,var(--gold-500),transparent 60%);
  box-shadow:0 1px 3px rgba(15,23,42,.16);
}
.dir-phones{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.dir-notes{font-size:.86em}

/* ---------- BOTTOM NAV ---------- */
nav.bottom{
  position:fixed;left:0;right:0;bottom:0;
  z-index:60;
  background:#fff;
  border-top:1px solid var(--border);
  backdrop-filter: blur(6px) saturate(1.02);
}
.bottom-inner{
  display:flex;align-items:center;gap:12px;
  height:calc(var(--bottom-h) + env(safe-area-inset-bottom));
  padding:10px clamp(10px,5vw,18px);
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.icons-left{display:flex;align-items:center;gap:12px;}
.nav-btn{
  appearance:none;
  border:1px solid var(--border);
  background:var(--surface-2);
  border-radius:999px;
  box-shadow:var(--shadow-1);
  width:var(--nav-btn);height:var(--nav-btn);
  display:grid;place-items:center;
  cursor:pointer;
}
.nav-btn[aria-current="page"]{
  background:#fff;
  border-color:color-mix(in oklab,var(--gold-500),transparent 58%);
  box-shadow:0 8px 22px rgba(0,0,0,.08), inset 0 1px 0 #fff;
}
.nav-btn .ico{width:var(--ico-bottom);height:var(--ico-bottom)}
.divider{
  flex:1;height:1px;
  background:linear-gradient(90deg,transparent, var(--border), transparent);
}
.active-chip{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;
  border:1px solid var(--border);
  border-radius:999px;
  background:var(--surface-2);
  font-weight:900;
}
main.container{
  padding-bottom: calc(var(--bottom-h) + env(safe-area-inset-bottom) + 22px);
}

/* ---------- Reduced motion ---------- */
@media (prefers-reduced-motion: reduce){
  *{animation:none !important; transition:none !important}
  header.appbar, .card{backdrop-filter:none}
}
/* REGION: CSS-TEXT-FIX-STRONG-START */
/* En TODAS las tarjetas (.item) evitamos cortes feos de palabras */
.item,
.item *{
  white-space: normal !important;
  word-break: normal !important;      /* nada de break-all */
  overflow-wrap: break-word !important;
  hyphens: none !important;
  max-height: none !important;
  overflow: visible !important;
  -webkit-line-clamp: unset !important;
  -webkit-box-orient: unset !important;
}
/* REGION: CSS-TEXT-FIX-STRONG-END */
/* REGION: CSS-FORMS-MOBILE-START */
@media (max-width: 720px){

  /* PLANTA · tarjeta "Habitación" */
  #panel-planta .card:first-of-type .card-b{
    grid-template-columns: 1fr !important; /* una sola columna */
  }
  #panel-planta .card:first-of-type .card-b > div{
    min-width: 0;
  }
  #panel-planta .card:first-of-type .card-b .g2{
    grid-template-columns: 1fr !important; /* pendientes / grupo, uno debajo del otro */
  }

  /* TAREAS · tarjeta "Añadir tarea" */
  #panel-tareas .card:first-of-type .grid{
    grid-template-columns: 1fr !important; /* fecha, descripción y botón en columna */
  }

  /* DIRECTORIO · buscador + botones */
  #panel-directorio .card:first-of-type .card-b{
    grid-template-columns: 1fr !important; /* buscador arriba, botones debajo */
  }
  #panel-directorio #d-q{
    width: 100%;
  }
}
/* REGION: CSS-FORMS-MOBILE-END */
/* REGION: CSS-ITEMS-MOBILE-START */
@media (max-width: 720px){

  .list > li.item{
    display: grid;
    grid-template-columns: auto minmax(0, 1fr) auto; /* pill | texto | iconos */
    column-gap: 8px;
    align-items: center;
  }

  .list > li.item > span.pill{
    padding: 3px 9px;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .list > li.item > .text{
    width: 100%;
    font-size: 0.95rem;
    line-height: 1.25;
  }

  .list > li.item > .actions{
    justify-self: flex-end;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* ⬇️ Aquí hacemos la caja más pequeña y más pegada al icono */
  .list > li.item > .actions button,
  .list > li.item > .actions .btn{
    width: 22px;      /* antes 28 */
    height: 22px;     /* antes 28 */
    padding: 0;
    border-radius: 10px;   /* caja más compacta */
  }

  .list > li.item > .actions svg{
    width: 14px;
    height: 14px;
  }

  /* El icono de las dos flechas aún un poco más pequeño si quieres */
  .list > li.item > .actions button:first-child svg{
    transform: scale(0.7);
  }
}
/* REGION: CSS-ITEMS-MOBILE-END */

/* REGION: CSS-ACTIONS-ANDROID-OVERRIDE-START */
@media (max-width: 720px){

  /* Recuadros de los 3 iconos en todas las listas (Planta, Interconsultas, Completados, Tareas, etc.) */
  .list .actions > button,
  .list .actions > .btn{
    width: 30px !important;       /* caja más pequeña */
    height: 36px !important;
    min-width: 24px !important;
    min-height: 24px !important;
    padding: 0 !important;
    border-radius: 10px !important;  /* esquinas algo más cerradas */
  }

  /* Iconos dentro del botón: tamaño fijo, hueco alrededor más pequeño */
  .list .actions > button svg,
  .list .actions > .btn svg{
    width: 14px;
    height: 14px;
  }

  /* Icono de las dos flechas aún un poco más pequeño visualmente */
  .list .actions > button:first-child svg{
    transform: scale(0.7);
  }
}
/* REGION: CSS-ACTIONS-ANDROID-OVERRIDE-END */

/* REGION: CSS-TAREAS-ACTIVAS-MOBILE-START */
@media (max-width: 720px){

  /* Cada tarea activa: fecha | texto | iconos */
  #panel-tareas .list > li.item{
    display: grid;
    grid-template-columns: auto minmax(0, 1fr) auto; /* pill fecha | descripción | iconos */
    column-gap: 2px;              /* casi sin espacio entre texto e iconos */
    align-items: center;
    padding: 6px 8px;
    width: 100%;
  }

  /* Pastilla de fecha compacta, para dejar más ancho al texto */
  #panel-tareas .list > li.item > span.pill{
    padding: 3px 8px;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  /* DESCRIPCIÓN:
     - usa TODO el ancho central
     - sin cortes raros tipo "serolo gía"
     - el texto fluye de forma normal
  */
  #panel-tareas .list > li.item > .text{
    display: block;               /* ya no es una columna flex, es un bloque normal */
    min-width: 0;
    margin-right: 0;
    width: 100%;
    font-size: 0.95rem;
    line-height: 1.25;
    word-break: normal !important;
    overflow-wrap: break-word !important;
    hyphens: none !important;
  }

  /* Todo lo que esté dentro del .text se muestra en línea,
     para que "Serología de Irwin" se comporte como una frase normal.
  */
  #panel-tareas .list > li.item > .text > *{
    display: inline;
  }

  /* ICONOS:
     - pegados a la derecha del todo
     - poco espacio entre ellos
     - recuadro pequeño
  */
  #panel-tareas .list > li.item > .actions{
    grid-column: 3;
    justify-self: flex-end;       /* lo MÁS a la derecha posible */
    display: flex;
    align-items: center;
    gap: 2px;                     /* casi sin hueco entre iconos */
    margin-left: 0;
  }

  #panel-tareas .list > li.item > .actions > button,
  #panel-tareas .list > li.item > .actions > .btn{
    width: 24px !important;
    height: 24px !important;
    min-width: 24px !important;
    min-height: 24px !important;
    padding: 0 !important;
    border-radius: 10px !important;
  }
}
/* REGION: CSS-TAREAS-ACTIVAS-MOBILE-END */

/* REGION: CSS-ACTIONS-MOBILE-GAP-START */
@media (max-width: 720px){

  /* En todas las listas (Planta, Tareas, Directorio, Completados…)
     la zona de iconos ya NO obliga a 114px de ancho */
  .list .actions{
    min-width: 0 !important;   /* quitamos el ancho mínimo que generaba tanto hueco */
  }
}
/* REGION: CSS-ACTIONS-MOBILE-GAP-END */

</style>
</head>

<body>
<!-- ===== SVG sprite ===== -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;pointer-events:none">
  <defs>
    <linearGradient id="gLav" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#d9cbff"/><stop offset="1" stop-color="#8B5CF6"/>
    </linearGradient>
    <linearGradient id="gOra" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffd7b0"/><stop offset="1" stop-color="#FB923C"/>
    </linearGradient>
    <linearGradient id="gInd" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#d6dbff"/><stop offset="1" stop-color="#6F7BF7"/>
    </linearGradient>
    <linearGradient id="gGold" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffeaa8"/><stop offset="1" stop-color="#FACC15"/>
    </linearGradient>

    <!-- Fonendoscopio premium -->
    <symbol id="i-stetho" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="url(#gInd)"/>
      <path fill="#F9FAFB" d="M9.25 5.5a.75.75 0 0 0-1.5 0v4a3.75 3.75 0 0 0 7.5 0v-4a.75.75 0 0 0-1.5 0v4a2.25 2.25 0 0 1-4.5 0v-4Z"/>
      <path fill="#FFFFFF" d="M16.5 6.75A1.75 1.75 0 1 1 18 8.48v2.52a4.75 4.75 0 0 1-3.78 4.64l-.72.15a2.25 2.25 0 1 1-2.25 2.21.75.75 0 0 1 1.5 0 .75.75 0 1 0 1.5 0 1 1 0 1 0-1-1l1.02-.2A6.25 6.25 0 0 0 18 11V8.48a1.75 1.75 0 0 1-1.5-1.73Z" opacity=".96"/>
      <circle cx="18" cy="6.75" r="1.4" fill="url(#gGold)"/>
    </symbol>

    <!-- swap -->
    <symbol id="i-swap" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M7.1 7.5a6 6 0 0 1 10.6-2.4l1.5-1.5v5.8H13l2-2A4 4 0 1 0 7.9 9.7a1 1 0 1 1-0.8 1.8A6 6 0 0 1 7.1 7.5z"/>
      <path fill="url(#gOra)" d="M16.9 16.5a6 6 0 0 1-10.6 2.4l-1.5 1.5V14.6H11l-2 2A4 4 0 1 0 16.1 14a1 1 0 1 1 .8-1.8 6 6 0 0 1 0 4.3z"/>
    </symbol>
    <!-- edit (pencil) -->
    <symbol id="i-edit" viewBox="0 0 24 24">
      <path fill="url(#gLav)" d="M3 17.25V21h3.75L18.81 8.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
    </symbol>
    <!-- check (complete) -->
    <symbol id="i-check" viewBox="0 0 24 24">
      <path fill="url(#gGold)" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm-1.2 13.2-3.6-3.6 1.4-1.4 2.2 2.2 4.6-4.6 1.4 1.4-6 6z"/>
    </symbol>
    <!-- herramientas -->
    <symbol id="i-tools" viewBox="0 0 24 24">
      <path fill="url(#gOra)" d="M4 14l6 6 2-2-6-6-2 2zm3-7a4 4 0 0 1 5.7-3.6l-2.5 2.5 2.2 2.2 2.5-2.5A4 4 0 0 1 10 10L8 8l-1 1-2-2 2-2 1 1z"/>
      <path fill="url(#gGold)" d="M13.5 11.5l1-1 6 6-1 1-2 2-6-6 2-2z"/>
      <path fill="#fff" opacity=".35" d="M9 3.6c1-.6 2.4-.8 3.6-.4l-1.6 1.6 1.1 1.1 1.6-1.6c.3.9.2 2-.2 2.8-1.2-1.2-3.1-2.9-4.5-3.5z"/>
      <path fill="#000" opacity=".10" d="M6 13.8l4.2 4.2.8-.8-4.2-4.2-0.8.8z"/>
    </symbol>
    <!-- handset -->
    <symbol id="i-handset" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M6.6 10.8c1.8 3 4.5 5.5 7.5 7.5.7.5 1.7.4 2.3-.2l1.7-1.7a1.6 1.6 0 0 0 0-2.2l-2-2a1.6 1.6 0 0 0-2.3 0l-.8.8a17.7 17.7 0 0 1-3.8-3.8l.8-.8a1.6 1.6 0 0 0 0-2.3l-2-2a1.6 1.6 0 0 0-2.2 0L4.5 4.6c-.6.6-.7 1.6-.2 2.3z"/>
    </symbol>
    <!-- libros -->
    <symbol id="i-books" viewBox="0 0 24 24">
      <rect x="2.5" y="5" width="5.5" height="14" rx="1" fill="url(#gInd)"/>
      <rect x="9.5" y="4" width="5.5" height="15" rx="1" fill="url(#gGold)"/>
      <rect x="16.5" y="6" width="5" height="13" rx="1" fill="url(#gLav)"/>
    </symbol>
  </defs>
</svg>

<header class="appbar" role="banner">
  <div class="container">
    <span class="brand"><span class="brand-dot" aria-hidden="true"></span>INFECCIOSAS</span>
    <h1 id="title">Planta</h1>
    <div class="grow"></div>
    <div class="statusRow" aria-live="polite" style="margin-left:12px">
      <span id="badge-online" class="chip bad">Offline</span>
      <span id="badge-auth" class="chip bad">Google: desconectado</span>
    </div>
    <div id="userGroup" class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto">
      <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
        <img id="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-1)">
        <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
        <span id="notifBadge" class="chip" title="Tareas activas">0</span>
      </div>
      <button id="installBtn" class="btn" aria-label="Instalar">➕ Instalar</button>
      <button id="signin"  class="btn primary">Acceder</button>
      <button id="signout" class="btn hide">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <div id="updateBanner" class="chip" style="display:none">
    Nueva versión disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
  </div>
  <div id="installBanner" class="chip" style="display:none">
    Instala la app para acceso más rápido. <button id="installAction" class="btn primary">Instalar</button>
  </div>

  <!-- Gate -->
  <section id="gate" class="card" role="region" aria-live="polite">
    <div class="card-h h-bib"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
    <div class="card-b">
      <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
      <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
      <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
    </div>
  </section>

  <!-- App -->
  <section id="app" class="hide">
    <!-- ===== PLANTA ===== -->
    <div id="panel-planta" role="region" aria-label="Planta" tabindex="-1">
      <div class="card">
        <div class="card-h h-celeste"><h2>Habitación</h2><span class="subtitle">Añadir nueva</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
          <div><label for="p-room">Habitación</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
          <div><label for="p-desc">Descripción</label><input id="p-desc" placeholder="Resumen clínico, motivo…"></div>
          <div style="align-self:end"><button id="p-add" class="btn primary">Añadir</button></div>
          <div class="g2" style="grid-column:1/-1;display:grid;gap:12px;grid-template-columns:1fr 1fr">
            <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, analítica… (opcional)"></div>
            <div>
              <label>Grupo</label>
              <div role="group" aria-label="Grupo" style="display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:inset 0 1px 0 #fff">
                <button id="p-group-planta" type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--lav);border-color:color-mix(in oklab,var(--lav-700),transparent 60%)">Planta</button>
                <button id="p-group-inter"  type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--ora);border-color:color-mix(in oklab,var(--ora-700),transparent 55%)">Interconsulta</button>
              </div>
              <span id="addTarget" class="chip" aria-live="polite" style="margin-left:8px">Añadiendo a: Planta</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-planta"><h2>Planta</h2><span id="p-count-planta" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-planta" class="list"></ul>
          <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Interconsultas</h2><span id="p-count-inter" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-inter" class="list"></ul>
          <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completados</h2><span id="p-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-done" class="list"></ul>
          <p id="p-done-empty" class="muted">Nada completado.</p>
        </div>
      </div>
    </div>

    <!-- ===== TAREAS ===== -->
    <div id="panel-tareas" class="hide" role="region" aria-label="Tareas" tabindex="-1">
      <div class="card">
        <div class="card-h h-celeste"><h2>Añadir tarea</h2><span class="subtitle">Fecha → Descripción</span></div>
        <div class="card-b">
          <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
            <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
            <div><label for="t-text">Descripción</label><input id="t-text" type="text" placeholder="Describe la tarea…" maxlength="400"></div>
            <div style="align-self:end"><button id="t-add" class="btn primary">Añadir</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-tareas"><h2>Tareas activas</h2><span id="t-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-list" class="list"></ul>
          <p id="t-empty" class="muted">No hay tareas activas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completadas</h2><span id="t-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-done" class="list"></ul>
          <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
        <div class="card-b">
          <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
          <ul id="t-trash" class="list"></ul>
          <p id="t-trash-empty" class="muted">Papelera vacía.</p>
        </div>
      </div>
    </div>

    <!-- ===== DIRECTORIO ===== -->
    <div id="panel-directorio" class="hide" role="region" aria-label="Directorio" tabindex="-1">
      <div class="card">
        <div class="card-h h-coral"><h2>Directorio telefónico</h2><span id="d-count" class="chip">0</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr auto">
          <div><label for="d-q">Búsqueda inteligente</label><input id="d-q" type="search" placeholder="Sección, nombre o extensión…"></div>
          <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap; gap:6px">
            <button id="d-add" class="btn primary">Añadir</button>
            <button id="d-import" class="btn">Importar JSON</button>
            <button id="d-export" class="btn">Exportar JSON</button>
            <button id="d-dedupe" class="btn">Eliminar duplicados</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-b dir-wrap">
          <div>
            <div id="d-list-wrap"></div>
            <p id="d-empty" class="muted">Sin registros.</p>
          </div>
          <nav class="az" aria-label="Índice alfabético" id="d-az"></nav>
        </div>
      </div>
    </div>

    <!-- ===== BIBLIOTECA ===== -->
    <div id="panel-biblioteca" class="hide" role="region" aria-label="Biblioteca" tabindex="-1">
      <div class="card">
        <div class="card-h h-bib"><h2>Biblioteca</h2><span class="subtitle">Campo libre + enlaces + visor PDF</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:2fr 1fr">
          <div>
            <label for="b-notes">Notas rápidas</label>
            <textarea id="b-notes" placeholder="Pega aquí fragmentos o URLs. Se guardan en tu usuario."></textarea>
            <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
              <button id="b-notes-save" class="btn primary">Guardar notas</button>
              <button id="b-open-file" class="btn">Abrir PDF local…</button>
              <button id="b-clear-view" class="btn">Vaciar visor</button>
            </div>
          </div>
          <div>
            <label for="b-url">Nuevo enlace (PDF o web)</label>
            <input id="b-url" type="url" placeholder="https://… o *.pdf">
            <label for="b-title">Título</label>
            <input id="b-title" type="text" placeholder="Nombre del recurso">
            <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
              <button id="b-add-link" class="btn primary">Añadir a lista</button>
              <button id="b-export-links" class="btn">Exportar JSON</button>
              <button id="b-import-links" class="btn">Importar JSON</button>
            </div>
            <div style="margin-top:10px">
              <label for="b-select">Mis enlaces</label>
              <select id="b-select"></select>
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="b-open" class="btn">Abrir en visor</button>
                <button id="b-remove" class="btn">Eliminar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-bib"><h2>Visor</h2><span class="subtitle">Detecta PDF y lo muestra integrado</span></div>
        <div class="card-b">
          <iframe id="b-viewer" class="viewer" title="Visor de documentos" sandbox="allow-same-origin allow-downloads"></iframe>
          <p class="muted" style="margin-top:8px">Consejo: para PDFs externos con restricciones CORS, usa “Abrir PDF local…”.</p>
        </div>
      </div>
    </div>

    <!-- ===== Barra inferior única ===== -->
    <nav class="bottom" aria-label="Secciones">
      <div class="bottom-inner" id="bottomNav">
        <div class="icons-left" role="tablist" aria-label="Secciones">
          <button class="nav-btn" id="b-planta" role="tab" aria-label="Planta" aria-current="page" tabindex="0">
            <svg class="ico" aria-hidden="true"><use href="#i-stetho"/></svg>
          </button>
          <button class="nav-btn" id="b-tareas" role="tab" aria-label="Tareas" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-tools"/></svg>
          </button>
          <button class="nav-btn" id="b-directorio" role="tab" aria-label="Directorio" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-handset"/></svg>
          </button>
          <button class="nav-btn" id="b-biblioteca" role="tab" aria-label="Biblioteca" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-books"/></svg>
          </button>
        </div>
        <span class="divider" aria-hidden="true"></span>
        <span id="activeLabel" class="active-chip" aria-live="polite">Planta</span>
      </div>
    </nav>
  </section>
</main>

<!-- ===== FAB SOS ===== -->
<button id="fab" class="btn primary" style="position:fixed;left:auto;right:16px;bottom:calc(16px + env(safe-area-inset-bottom) + var(--bottom-h));z-index:70;border-radius:999px;padding:14px 16px;display:flex;align-items:center;gap:10px;touch-action:none" aria-haspopup="dialog" aria-controls="fabPanel" aria-expanded="false">
  SOS
</button>
<div id="fabPanel" class="card" role="dialog" aria-modal="false" aria-label="SOS" style="position:fixed;display:none;z-index:69; width:min(460px,96vw)">
  <div class="card-h h-inter" style="border-bottom:none"><h2>SOS</h2><button id="fabCfg" class="btn" aria-label="Configurar">⚙ Configurar</button></div>
  <div class="card-b">
    <div id="fabList"></div>
    <div id="fabPager" class="toolbar" style="margin-top:8px;gap:6px;display:flex;justify-content:space-between"></div>
  </div>
</div>

<dialog id="fabConfigDlg" style="padding:16px;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow-2)">
  <h3 style="margin:0 0 8px 0">Configurar SOS</h3>
  <div style="display:grid;gap:8px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label for="e-name" style="display:block;font-size:12px;color:#777">Nombre</label><input id="e-name"></div>
      <div><label for="e-tel" style="display:block;font-size:12px;color:#777">Teléfono</label><input id="e-tel" inputmode="tel"></div>
    </div>
    <div class="toolbar" style="gap:8px;justify-content:flex-end"><button id="e-add" class="btn primary">Añadir</button></div>
    <div style="margin-top:6px"><small class="muted">No se permitirán duplicados (Nombre+Teléfono).</small></div>
  </div>
  <div class="toolbar" style="margin-top:12px;gap:8px;justify-content:flex-end"><button id="e-close" class="btn">Cerrar</button></div>
</dialog>

<div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* ===== Helpers ===== */
const BASE = new URL('./', location).pathname;
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const toast=(m)=>{const t=$('#toast');t.textContent=m;t.hidden=false;setTimeout(()=>t.hidden=true,2200)};
const todayISO=()=>new Date().toISOString().slice(0,10);
const setVH=()=>document.documentElement.style.setProperty('--vh',(innerHeight*0.01)+'px');
setVH(); addEventListener('resize', setVH, {passive:true});
addEventListener('orientationchange', setVH, {passive:true});

const isMobile = matchMedia('(max-width: 720px)').matches;
   
const setOnline=(on)=>{const b=$('#badge-online');b.textContent=on?'Online':'Offline';b.className='chip '+(on?'ok':'bad')};
setOnline(navigator.onLine);
addEventListener('online',()=>setOnline(true),{passive:true});
addEventListener('offline',()=>setOnline(false),{passive:true});

const esc=(s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

/* ===== Firebase ===== */
const appMod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
const authMod= await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
const { firebaseConfig } = await import(BASE + 'firebase-config.js');
const fbApp=appMod.initializeApp(firebaseConfig);
const auth =authMod.getAuth(fbApp);
const db   =fsMod.initializeFirestore(fbApp,{localCache:fsMod.persistentLocalCache({tabManager:fsMod.persistentMultipleTabManager()})});
const serverTS=fsMod.serverTimestamp;

/* ===== Auth ===== */
const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
const gate=$('#gate'), appUI=$('#app');
const provider=new authMod.GoogleAuthProvider();
const doSignIn=async()=>{
  try{
    if(matchMedia('(display-mode: standalone)').matches)
      await authMod.signInWithRedirect(auth,provider);
    else
      await authMod.signInWithPopup(auth,provider);
  }catch(e){$('#authErr').textContent=e.message||String(e)}
};
$('#signin').onclick=doSignIn;
$('#signin2').onclick=doSignIn;
$('#signout').onclick=async()=>authMod.signOut(auth);

authMod.onAuthStateChanged(auth, user=>{
  if(user){
    badgeAuth.textContent='Google: '+(user.displayName||user.email);
    badgeAuth.className='chip ok';
    if(avatar) avatar.src=user.photoURL||'';
    if(displayname) displayname.textContent=user.displayName||user.email||'';
    userchip?.classList.remove('hide');
    $('#signout')?.classList.remove('hide');
    $('#signin')?.classList.add('hide');
    gate.classList.add('hide');
    appUI.classList.remove('hide');
    mount(user.uid);
  }else{
    badgeAuth.textContent='Google: desconectado';
    badgeAuth.className='chip bad';
    userchip?.classList.add('hide');
    $('#signout')?.classList.add('hide');
    $('#signin')?.classList.remove('hide');
    appUI.classList.add('hide');
    gate.classList.remove('hide');
    unmount();
  }
});

/* ===== Colecciones ===== */
const col={
  planta:(uid)=>fsMod.collection(db,'users',uid,'planta'),
  tareas:(uid)=>fsMod.collection(db,'users',uid,'tareas'),
  dir:(uid)=>fsMod.collection(db,'users',uid,'directorio'),
  biblio:(uid)=>fsMod.collection(db,'users',uid,'biblioteca'),
  notes:(uid)=>fsMod.doc(db,'users',uid,'biblioteca','__notes__'),
};
let unsubs=[];
const currentUid=()=>auth.currentUser?.uid;
function unmount(){unsubs.forEach(u=>u&&u()); unsubs=[];}
const pushRetry=(job)=>{
  try{
    const q=JSON.parse(localStorage.getItem('aurora.retry')||'[]');
    q.push(job);
    localStorage.setItem('aurora.retry',JSON.stringify(q));
  }catch{}
};
async function upd(kind,id,patch){
  const ref=fsMod.doc(db,'users',currentUid(),kind,id);
  const data={...patch,updatedAt:serverTS()};
  try{
    await fsMod.updateDoc(ref,data);
  }catch{
    pushRetry({path:ref.path,data});
    toast('Se guardará al recuperar conexión');
  }
}
async function del(kind,id){
  const ref=fsMod.doc(db,'users',currentUid(),kind,id);
  try{
    await fsMod.deleteDoc(ref);
  }catch{
    pushRetry({path:ref.path,data:{__delete__:true}});
    toast('Se eliminará al reconectar');
  }
}

/* ===== NAV ===== */
const activeLabel=$('#activeLabel');
const mapTabs={
  planta:['panel-planta','b-planta','Planta'],
  tareas:['panel-tareas','b-tareas','Tareas'],
  directorio:['panel-directorio','b-directorio','Directorio'],
  biblioteca:['panel-biblioteca','b-biblioteca','Biblioteca']
};
function selectTab(id){
  for(const k in mapTabs){
    const [p,b,l]=mapTabs[k];
    const sel=(k===id);
    $('#'+p)?.classList.toggle('hide',!sel);
    const btn=$('#'+b);
    if(btn){
      btn.setAttribute('aria-current', sel?'page':'false');
      btn.tabIndex=sel?0:-1;
    }
    if(sel){
      $('#title').textContent=l;
      activeLabel.textContent=l;
    }
  }
  localStorage.setItem('tab', id);
  location.hash=id;
}
$('#b-planta').onclick =()=>selectTab('planta');
$('#b-tareas').onclick =()=>selectTab('tareas');
$('#b-directorio').onclick=()=>selectTab('directorio');
$('#b-biblioteca').onclick=()=>selectTab('biblioteca');

const orderBottom=['b-planta','b-tareas','b-directorio','b-biblioteca'];
$('#bottomNav').addEventListener('keydown',(e)=>{
  const active=document.activeElement;
  const i=orderBottom.indexOf(active?.id);
  if(i<0) return;
  let j=i;
  if(e.key==='ArrowRight') j=(i+1)%orderBottom.length;
  else if(e.key==='ArrowLeft') j=(i-1+orderBottom.length)%orderBottom.length;
  else if(e.key==='Home') j=0;
  else if(e.key==='End') j=orderBottom.length-1;
  else if(e.key==='Enter'||e.key===' '){
    active.click(); return;
  }else return;
  e.preventDefault();
  const btn=$('#'+orderBottom[j]);
  btn?.focus();
  btn?.click();
});
addEventListener('hashchange',()=>{
  const h=location.hash.slice(1);
  if(mapTabs[h]) selectTab(h);
},{passive:true});

/* ===== Planta ===== */
let currentGroup='planta';
const updateAddTarget=()=>$('#addTarget').textContent=currentGroup==='planta'?'Añadiendo a: Planta':'Añadiendo a: Interconsulta';
$('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget();};
$('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget();};

const plantaDoc=(d)=>({
  room:(d.room||'').trim(),
  desc:(d.desc||'').trim(),
  pendiente:(d.pendiente||'').trim(),
  grupo:d.grupo||'planta',
  status:d.status||'active',
  createdAt:d.createdAt||serverTS(),
  updatedAt:serverTS()
});
const roomSortKey=(s)=>{
  if(!s) return 1e9;
  const m=String(s).match(/\d+/g);
  if(!m) return 1e9;
  const a=parseInt(m[0],10);
  const b=m[1]?parseInt(m[1],10)/100:0;
  return a+b;
};

const btn=(t,fn,cls='btn')=>{
  const b=document.createElement('button');
  b.className=cls;
  if(t) b.textContent=t;
  b.onclick=(e)=>{e.preventDefault();fn?.(e)};
  b.type='button';
  return b;
};

function plantaItem(x,done=false){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=
    `<span class="pill room" data-group="${x.grupo||'planta'}">${esc(x.room||'—')}</span>
     <div class="text">
       ${done
         ? `<div class="line" style="text-decoration:line-through">${esc(x.desc||'')}</div>`
         : `<div class="line">${esc(x.desc||'')}</div>`}
       ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}
     </div>
     <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');

  const swap=document.createElement('button');
  swap.className='btn icon swap';
  swap.title='Cambiar entre Planta e Interconsulta';
  swap.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-swap"/></svg>`;
  swap.onclick=()=>upd('planta',x.__id,{grupo:(x.grupo==='interconsulta')?'planta':'interconsulta'});

  const editB=btn('',()=>editPlanta(x),'btn icon');
  editB.title='Editar';
  editB.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`;

  const actB=btn('',()=> done?del('planta',x.__id):upd('planta',x.__id,{status:'done'}),'btn icon');
  actB.title=done?'Eliminar':'Marcar completado';
  actB.innerHTML = done
    ? '✖'
    : `<svg class="ico" aria-hidden="true"><use href="#i-check"/></svg>`;

  a.append(swap, editB, actB);
  return li;
}

const val=(id)=>document.getElementById(id)?.value||'';
const editPlanta=(x)=>openEdit(
  [
    {l:'Habitación',id:'p_room',v:x.room||''},
    {l:'Descripción',id:'p_desc',v:x.desc||''},
    {l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}
  ],
  async()=>upd('planta',x.__id,{
    room:val('p_room'),
    desc:val('p_desc'),
    pendiente:val('p_pend')
  })
);

function setupPlanta(uid){
  $('#p-add').onclick=async()=>{
    const d=plantaDoc({
      room:val('p-room'),
      desc:val('p-desc'),
      pendiente:val('p-pend'),
      grupo:currentGroup
    });
    if(!d.room && !d.desc) return;
    await fsMod.addDoc(col.planta(uid),d);
    ['p-room','p-desc','p-pend'].forEach(i=>$('#'+i).value='');
  };
  const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));
  const u1=fsMod.onSnapshot(qA,(s)=>{
    const all=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x)});
    const arrP=all
      .filter(x=>(x.grupo||'planta')==='planta')
      .sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const arrI=all
      .filter(x=>(x.grupo||'planta')==='interconsulta')
      .sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const lp=$('#p-list-planta'), li=$('#p-list-inter');
    lp.innerHTML=''; li.innerHTML='';
    arrP.forEach(x=>lp.appendChild(plantaItem(x)));
    arrI.forEach(x=>li.appendChild(plantaItem(x)));
    $('#p-empty-planta').style.display=arrP.length?'none':'block';
    $('#p-empty-inter').style.display=arrI.length?'none':'block';
    $('#p-count-planta').textContent=arrP.length;
    $('#p-count-inter').textContent=arrI.length;
  });
  const u2=fsMod.onSnapshot(qD,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x)});
    arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0));
    const l=$('#p-done'); l.innerHTML='';
    arr.forEach(x=>l.appendChild(plantaItem(x,true)));
    $('#p-done-empty').style.display=arr.length?'none':'block';
    $('#p-done-count').textContent=arr.length;
  });
  unsubs.push(u1,u2);
}

/* ===== Tareas ===== */
const tareaDoc=(d)=>({
  date:d.date||todayISO(),
  text:(d.text||'').trim(),
  status:d.status||'active',
  createdAt:d.createdAt||serverTS(),
  updatedAt:serverTS()
});
const daysFromToday=(iso)=>{
  try{
    const d=new Date(iso+'T00:00:00');
    const t=new Date(); t.setHours(0,0,0,0);
    return Math.round((d - t)/(1000*60*60*24));
  }catch{return 0}
};
const fmtDate = (iso) => {
  try {
    const d = new Date(iso + 'T00:00:00');

    if (isMobile) {
      // 📱 ANDROID / móviles: L, 12 NOV
      const letrasDia = ['D', 'L', 'M', 'X', 'J', 'V', 'S']; // 0=Dom,1=Lun...
      const letra = letrasDia[d.getDay()];
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = new Intl.DateTimeFormat('es-ES', { month: 'short' })
        .format(d)
        .toUpperCase()
        .replace(/\./g, '');

      return `${letra}, ${dia} ${mes}`;
    } else {
      // 🖥️ PC: formato "de antes": LUN, 12 NOV
      return new Intl.DateTimeFormat('es-ES', {
        weekday: 'short',
        day: '2-digit',
        month: 'short'
      })
        .format(d)
        .toUpperCase()
        .replace(/\./g, '');
    }
  } catch {
    return iso;
  }
};

function tareaItem(x){
  const li=document.createElement('li'); li.className='item';
  const diff=daysFromToday(x.date);
  const h=isNaN(diff)?205:(diff<=-7?0:(diff<0?10:Math.round(10+(Math.min(diff,30)/30)*120)));
  li.style.borderLeft=`6px solid hsl(${h} 72% 46%)`;
  li.innerHTML=
    `<span class="pill date">${fmtDate(x.date)}</span>
     <div class="text"><div class="line">${esc(x.text||'')}</div></div>
     <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');

  const doneBtn=btn('',()=>upd('tareas',x.__id,{status:'done'}),'btn icon');
  doneBtn.title='Marcar completada';
  doneBtn.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-check"/></svg>`;

  const editBtn=btn('',()=>editTarea(x),'btn icon');
  editBtn.title='Editar';
  editBtn.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`;

  const trashBtn=btn('🗑️',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon');
  trashBtn.title='Enviar a papelera';

  a.append(doneBtn, editBtn, trashBtn);
  return li;
}

function tareaDone(x){
  const li=document.createElement('li'); li.className='item';
  li.style.borderLeft=`6px solid hsl(150 50% 38%)`;
  li.innerHTML=
    `<span class="pill date">${fmtDate(x.date)}</span>
     <div class="text">
       <div class="line" style="text-decoration:line-through">${esc(x.text||'')}</div>
     </div>
     <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');
  a.append(
    btn('↩',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),
    btn('✖',()=>del('tareas',x.__id),'btn icon')
  );
  return li;
}

function tareaTrash(x){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=
    `<span class="pill date">${fmtDate(x.date)}</span>
     <div class="text muted"><div class="line">${esc(x.text||'')}</div></div>
     <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');
  a.append(
    btn('⤴',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),
    btn('✖',()=>del('tareas',x.__id),'btn icon')
  );
  return li;
}

const editTarea=(x)=>openEdit(
  [
    {l:'Fecha',id:'t_date',v:x.date||todayISO()},
    {l:'Descripción',id:'t_text',v:x.text||''}
  ],
  async()=>upd('tareas',x.__id,{
    date:$('#t_date').value,
    text:$('#t_text').value
  })
);

function setupTareas(uid){
  $('#t-date').value=todayISO();
  $('#t-add').onclick=async()=>{
    const date=$('#t-date').value;
    const text=$('#t-text').value.trim();
    if(!text) return;
    await fsMod.addDoc(col.tareas(uid),tareaDoc({date,text}));
    $('#t-text').value='';
  };
  const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
  const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));

  const u1=fsMod.onSnapshot(qA,(snap)=>{
    const arr=[];
    snap.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)});
    arr.sort((a,b)=>daysFromToday(a.date)-daysFromToday(b.date)||(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    const list=$('#t-list'); list.innerHTML='';
    arr.forEach(x=>list.appendChild(tareaItem(x)));
    $('#t-count').textContent=arr.length;
    $('#t-empty').style.display=arr.length?'none':'block';
    setNotif(arr.length);
  });

  const u2=fsMod.onSnapshot(qD,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)});
    arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0));
    const l=$('#t-done'); l.innerHTML='';
    arr.forEach(x=>l.appendChild(tareaDone(x)));
    $('#t-done-empty').style.display=arr.length?'none':'block';
    $('#t-done-count').textContent=arr.length;
  });

  const u3=fsMod.onSnapshot(qT,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x)});
    arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0));
    const l=$('#t-trash'); l.innerHTML='';
    arr.forEach(x=>l.appendChild(tareaTrash(x)));
    $('#t-trash-empty').style.display=arr.length?'none':'block';
    $('#t-trash-count').textContent=arr.length;
  });

  $('#t-emptyTrash').onclick=async()=>{
    const q=fsMod.query(fsMod.collection(db,'users',uid,'tareas'),fsMod.where('status','==','trash'));
    const s=await fsMod.getDocs(q);
    await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref)));
    toast('Papelera vaciada');
  };

  unsubs.push(u1,u2,u3);
}
const setNotif=(n)=>{
  $('#notifBadge').textContent=String(n);
  $('#notifBadge').title=n?`${n} tareas activas`:'Sin avisos';
};

/* ===== Directorio ===== */
let dirCache=[];
const telHref=(raw)=>{
  const s=String(raw||'').replace(/[^\d+]/g,'');
  return s?`tel:${s}`:null;
};
const norm=(s)=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');

const dirDoc=(d)=>({
  seccion:String(d.seccion||'').trim()||'Sin sección',
  nombre:String(d.nombre||'').trim()||'Sin nombre',
  telefono:String(d.telefono||'').trim(),
  notas:String(d.notas||'').trim(),
  createdAt:d.createdAt||serverTS(),
  updatedAt:serverTS()
});

function phonesToChips(raw){
  const parts=String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{
    const href=telHref(p);
    return href
      ? `<a class="pill tel" href="${href}" dir="ltr">${esc(p)}</a>`
      : `<span class="pill tel" dir="ltr">${esc(p)}</span>`;
  }).join(' ');
}

function renderDir(){
  const v=norm($('#d-q')?.value||'');
  const wrap=$('#d-list-wrap'); if(!wrap) return;
  wrap.innerHTML='';
  let arr=[...dirCache];
  arr.sort((a,b)=>(a.nombre||'').localeCompare(b.nombre||'')||(a.seccion||'').localeCompare(b.seccion||''));
  const filtered=v
    ? arr.filter(x=>[x.seccion,x.nombre,String(x.telefono||''),x.notas].some(y=>norm(y).includes(v)))
    : arr;

  const groups=new Map();
  for(const x of filtered){
    const k=/^[A-Za-zÁÉÍÓÚÜÑ]/.test(x.nombre||'')
      ? norm(x.nombre)[0].toUpperCase()
      : '#';
    if(!groups.has(k)) groups.set(k,[]);
    groups.get(k).push(x);
  }

  const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');
  const az=$('#d-az');
  if(az){
    az.innerHTML=letters
      .map(ch=>`<a href="#sec-${ch}" aria-label="Ir a ${ch}">${ch}</a>`)
      .join('');
  }

  let total=0;
  let firstLetterWithData=null;

  for(const ch of letters){
    const list=groups.get(ch)||[];
    if(!list.length) continue;
    if(!firstLetterWithData) firstLetterWithData=ch;
    total+=list.length;

    const sec=document.createElement('section');
    sec.id=`sec-${ch}`;
    sec.setAttribute('aria-labelledby',`lbl-${ch}`);

    const header=document.createElement('div');
    header.className='section-tag';
    header.id=`lbl-${ch}`;
    const mainSec=list[0]?.seccion || 'Sin sección';
    header.innerHTML=
      `<div class="section-main">
         <div class="section-letter-pill"><span>${ch}</span></div>
         <div class="section-meta">
           <span class="section-name">${esc(mainSec)}</span>
           <span class="count">${list.length}</span>
         </div>
       </div>`;
    sec.appendChild(header);

    const ul=document.createElement('ul');
    ul.className='list';

    list.forEach(x=>{
      const li=document.createElement('li');
      li.className='item';
      li.innerHTML=
        `<div class="text">
           <div class="line">
             <strong>${esc(x.nombre||'')}</strong>
             <span class="dir-sec-pill">${esc(x.seccion||'')}</span>
           </div>
           <div class="line dir-phones">${phonesToChips(x.telefono)}</div>
           ${x.notas ? `<div class="muted dir-notes">${esc(x.notas)}</div>` : ''}
         </div>
         <div class="toolbar actions"></div>`;
      const a=li.querySelector('.actions');
      const edit=btn('',()=>editDir(x),'btn icon');
      edit.title='Editar';
      edit.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`;
      const delBtn=btn('✖',()=>del('directorio',x.__id),'btn icon');
      delBtn.title='Eliminar';
      a.append(edit,delBtn);
      ul.appendChild(li);
    });

    sec.appendChild(ul);
    wrap.appendChild(sec);
  }

  $('#d-count').textContent=total+" registros";
  $('#d-empty').style.display=total?'none':'block';

  if(firstLetterWithData && az){
    const firstLink=az.querySelector(`a[href="#sec-${firstLetterWithData}"]`);
    if(firstLink) firstLink.classList.add('is-active');
  }
}

const editDir=(x)=>openEdit(
  [
    {l:'Sección',id:'d_sec',v:x.seccion||''},
    {l:'Nombre',id:'d_nom',v:x.nombre||''},
    {l:'Teléfonos',id:'d_tel',v:x.telefono||''},
    {l:'Notas',id:'d_not',v:x.notas||''}
  ],
  async()=>upd('directorio',x.__id,{
    seccion:$('#d_sec').value,
    nombre:$('#d_nom').value,
    telefono:$('#d_tel').value,
    notas:$('#d_not').value
  })
);

function setupDir(uid){
  $('#d-add').onclick=async()=>{
    const d=dirDoc({
      seccion:prompt('Sección')||'',
      nombre:prompt('Nombre')||'',
      telefono:prompt('Teléfonos')||''
    });
    await fsMod.addDoc(col.dir(uid),d);
  };
  $('#d-import').onclick=importDir(uid);
  $('#d-export').onclick=exportDir(uid);
  $('#d-dedupe').onclick=()=>dedupeDir(uid);

  const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{
    dirCache=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x)});
    renderDir();
  });

  $('#d-q').addEventListener('input',renderDir,{passive:true});
  unsubs.push(u);
}

/* Estado activo visual para A–Z (evento delegado) */
const dirAzNav=$('#d-az');
if(dirAzNav){
  dirAzNav.addEventListener('click',(e)=>{
    const target=e.target;
    if(!(target instanceof Element)) return;
    const link=target.closest('a');
    if(!link) return;
    $$('#d-az a').forEach(a=>a.classList.toggle('is-active',a===link));
  });
}

function importDir(uid){
  return async()=>{
    try{
      const txt=await pickReadText();
      const arr=JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error('JSON inválido');
      const snap=await fsMod.getDocs(col.dir(uid));
      const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
      const set=new Set(snap.docs.map(d=>key(d.data())));
      const ops=[];
      for(const o of arr){
        if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o)));
      }
      await Promise.all(ops);
      toast('Importado ('+ops.length+')');
    }catch(e){
      toast(e.message||String(e));
    }
  };
}

function exportDir(uid){
  return async()=>{
    const snap=await fsMod.getDocs(fsMod.query(col.dir(uid)));
    const out=snap.docs.map(d=>({id:d.id,...d.data()}));
    const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
    await pickWriteBlob(blob,'directorio-'+todayISO()+'.json');
    toast('Exportado');
  };
}
const normTel=(s)=>String(s||'').replace(/[^\d+]/g,'');
const keyDir=(o)=>(String(o.nombre||'').trim().toLowerCase().replace(/\s+/g,' '))+'|'+normTel(o.telefono);
async function dedupeDir(uid){
  const snap=await fsMod.getDocs(fsMod.query(col.dir(uid)));
  const seen=new Set(); const rm=[];
  for(const d of snap.docs){
    const k=keyDir(d.data());
    if(seen.has(k)) rm.push(d.ref);
    else seen.add(k);
  }
  if(!rm.length){toast('Sin duplicados');return}
  await Promise.all(rm.map(r=>fsMod.deleteDoc(r)));
  toast(`Eliminados ${rm.length} duplicados`);
}

/* ===== Biblioteca ===== */
let bCache=[]; let localObjectURL=null;
const bDoc=(d)=>({
  title:String(d.title||'').trim()||'Sin título',
  url:String(d.url||'').trim(),
  createdAt:d.createdAt||serverTS(),
  updatedAt:serverTS()
});
function setViewer(src){
  const iframe=$('#b-viewer');
  if(!src){iframe.removeAttribute('src');return}
  iframe.src=src;
}
function clearLocalURL(){
  if(localObjectURL){
    URL.revokeObjectURL(localObjectURL);
    localObjectURL=null;
  }
}
function renderBiblioSelect(){
  const sel=$('#b-select'); sel.innerHTML='';
  bCache.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  bCache.forEach(x=>{
    const o=document.createElement('option');
    o.value=x.__id;
    o.textContent=x.title;
    sel.appendChild(o);
  });
}
function setupBiblio(uid){
  fsMod.getDoc(col.notes(uid)).then(s=>{
    $('#b-notes').value=s.exists()?String(s.data().text||''):'';
  });
  $('#b-notes-save').onclick=async()=>{
    const ref=col.notes(uid);
    const data={text:$('#b-notes').value,updatedAt:serverTS()};
    try{
      await fsMod.setDoc(ref,data,{merge:true});
    }catch{
      pushRetry({path:ref.path,data});
    }
    toast('Notas guardadas');
  };
  $('#b-add-link').onclick=async()=>{
    const url=$('#b-url').value.trim();
    const title=$('#b-title').value.trim();
    if(!url) return;
    await fsMod.addDoc(col.biblio(uid),bDoc({url,title}));
    $('#b-url').value='';
    $('#b-title').value='';
  };
  $('#b-open').onclick=async()=>{
    const id=$('#b-select').value;
    const item=bCache.find(x=>x.__id===id);
    if(!item) return;
    clearLocalURL();
    setViewer(item.url);
  };
  $('#b-remove').onclick=async()=>{
    const id=$('#b-select').value;
    if(!id) return;
    await fsMod.deleteDoc(fsMod.doc(db,'users',uid,'biblioteca',id));
  };
  $('#b-open-file').onclick=async()=>{
    try{
      const [h]=await showOpenFilePicker({types:[{description:'PDF',accept:{'application/pdf':['.pdf']}}]});
      const f=await h.getFile();
      clearLocalURL();
      localObjectURL=URL.createObjectURL(f);
      setViewer(localObjectURL);
    }catch{}
  };
  $('#b-clear-view').onclick=()=>{
    clearLocalURL();
    setViewer(null);
  };
  $('#b-export-links').onclick=async()=>{
    const snap=await fsMod.getDocs(fsMod.query(col.biblio(uid)));
    const out=snap.docs.map(d=>({id:d.id,...d.data()}));
    const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
    await pickWriteBlob(blob,'biblioteca-links-'+todayISO()+'.json');
    toast('Exportado');
  };
  $('#b-import-links').onclick=async()=>{
    try{
      const txt=await pickReadText();
      const arr=JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error('JSON inválido');
      const snap=await fsMod.getDocs(col.biblio(uid));
      const key=o=>(String(o.title||'').trim()+'|'+String(o.url||'').trim()).toLowerCase();
      const set=new Set(snap.docs.map(d=>key(d.data())));
      const ops=[];
      for(const o of arr){
        const k=key(o);
        if(!set.has(k)) ops.push(fsMod.addDoc(col.biblio(uid), bDoc(o)));
      }
      await Promise.all(ops);
      toast('Importado ('+ops.length+')');
    }catch(e){
      toast(e.message||String(e));
    }
  };
  const u=fsMod.onSnapshot(fsMod.query(col.biblio(uid)),(s)=>{
    bCache=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; bCache.push(x)});
    renderBiblioSelect();
  });
  unsubs.push(u);
}

/* ===== Modal simple / Pickers / PWA / FAB / Montaje ===== */
function openEdit(fields,onOk){
  const dlg=document.createElement('dialog');
  dlg.style.padding='16px';
  dlg.style.border='1px solid var(--border)';
  dlg.style.borderRadius='14px';
  dlg.style.boxShadow='var(--shadow-2)';

  const h=document.createElement('h3');
  h.textContent='Editar';
  h.style.margin='0 0 8px 0';
  dlg.appendChild(h);

  const body=document.createElement('div');
  body.style.display='grid';
  body.style.gap='8px';
  fields.forEach(f=>{
    const w=document.createElement('div');
    w.innerHTML=
      `<label for="${f.id}" style="display:block;font-size:12px;color:#777">${f.l}</label>
       <input id="${f.id}" value="${esc(f.v||'')}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px">`;
    body.append(w);
  });
  dlg.appendChild(body);

  const row=document.createElement('div');
  row.style.display='flex';
  row.style.gap='8px';
  row.style.justifyContent='flex-end';
  row.style.marginTop='12px';

  const b1=document.createElement('button');
  b1.className='btn';
  b1.textContent='Cancelar';
  b1.onclick=()=>dlg.close();

  const b2=document.createElement('button');
  b2.className='btn primary';
  b2.textContent='Guardar';
  b2.onclick=async()=>{
    await onOk();
    dlg.close();
  };

  row.append(b1,b2);
  dlg.appendChild(row);
  document.body.appendChild(dlg);
  dlg.showModal();
  dlg.addEventListener('close',()=>dlg.remove(),{once:true});
}

async function pickReadText(){
  if('showOpenFilePicker' in window){
    const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]});
    const f=await h.getFile();
    return await f.text();
  }
  return await new Promise((res,rej)=>{
    const i=document.createElement('input');
    i.type='file';
    i.accept='.json,application/json';
    i.onchange=()=>{
      const f=i.files?.[0];
      if(!f) return rej(new Error('Cancelado'));
      const r=new FileReader();
      r.onload=()=>res(String(r.result||''));
      r.onerror=()=>rej(new Error('Error leyendo'));
      r.readAsText(f);
    };
    i.click();
  });
}
async function pickWriteBlob(blob,name){
  if('showSaveFilePicker' in window){
    const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]});
    const w=await h.createWritable();
    await w.write(blob);
    await w.close();
    return;
  }
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
  URL.revokeObjectURL(a.href);
}

let deferredPrompt=null;
addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  $('#installBanner').style.display='inline-flex';
});
$('#installAction').onclick=async()=>{
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt=null;
    $('#installBanner').style.display='none';
  }
};
$('#installBtn').onclick=()=>$('#installAction').click();

if('serviceWorker' in navigator){
  const reg=await navigator.serviceWorker.register(BASE+'sw.js');
  navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
  const showUpdate=()=>{
    $('#updateBanner').style.display='inline-flex';
    $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'});
  };
  if(reg.waiting) showUpdate();
  reg.addEventListener('updatefound',()=>{
    const sw=reg.installing;
    sw?.addEventListener('statechange',()=>{
      if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();
    });
  });
}

/* FAB SOS */
let emergency=[]; let page=0; const PAGE_SIZE=10;
function renderEmergency(){
  const box=$('#fabList');
  const start=page*PAGE_SIZE;
  const slice=emergency.slice(start,start+PAGE_SIZE);
  box.innerHTML = slice.length
    ? slice.map((e,i)=>
        `<div style="display:flex;align-items:center;gap:10px;margin:6px 0">
           <input type="checkbox" data-i="${start+i}" style="margin-right:6px">
           <strong>${esc(e.name||'')}</strong>
           <a class="pill tel" href="tel:${String(e.tel||'').replace(/[^\\d+]/g,'')}" dir="ltr">${esc(e.tel||'')}</a>
           <button class="btn icon" aria-label="Eliminar" data-del="${start+i}">✖</button>
         </div>`
      ).join('')
    : '<p class="muted">Añade accesos rápidos desde ⚙ Configurar.</p>';

  const pager=$('#fabPager');
  const pages=Math.ceil(emergency.length/PAGE_SIZE)||1;
  pager.innerHTML=
    `<div>
       <button class="btn" id="fabPrev" ${page<=0?'disabled':''}>◀</button>
       <span class="chip">${page+1}/${pages}</span>
       <button class="btn" id="fabNext" ${page>=pages-1?'disabled':''}>▶</button>
     </div>
     <div><button class="btn" id="fabDelSel">Eliminar seleccionados</button></div>`;

  $('#fabPrev')?.addEventListener('click',()=>{
    if(page>0){page--;renderEmergency();}
  });
  $('#fabNext')?.addEventListener('click',()=>{
    const pages=Math.ceil(emergency.length/PAGE_SIZE)||1;
    if(page<pages-1){page++;renderEmergency();}
  });
  $$('#fabList [data-del]')?.forEach(b=>{
    b.addEventListener('click',()=>{
      const i=Number(b.getAttribute('data-del'));
      emergency.splice(i,1);
      saveEmergencies();
      renderEmergency();
    });
  });
  $('#fabDelSel')?.addEventListener('click',()=>{
    const idx=$$('#fabList input[type="checkbox"]:checked')
      .map(c=>Number(c.getAttribute('data-i')))
      .sort((a,b)=>b-a);
    if(!idx.length) return;
    idx.forEach(i=>emergency.splice(i,1));
    saveEmergencies();
    renderEmergency();
  });
}
function saveEmergencies(){localStorage.setItem('aurora.emerg', JSON.stringify(emergency))}
function loadEmergencies(){
  try{emergency=JSON.parse(localStorage.getItem('aurora.emerg')||'[]')||[]}
  catch{emergency=[]}
}
$('#fab').onclick=()=>{
  const p=$('#fabPanel');
  const open=p.style.display!=='block';
  if(open){
    placePanelNearFab();
    renderEmergency();
  }
  p.style.display=open?'block':'none';
  $('#fab').setAttribute('aria-expanded',String(open));
};
$('#fabCfg').onclick=()=>$('#fabConfigDlg').showModal();
$('#e-close').onclick=()=>$('#fabConfigDlg').close();
$('#e-add').onclick=()=>{
  const name=$('#e-name').value.trim();
  const tel=$('#e-tel').value.trim();
  if(!name||!tel) return;
  const key=(name+'|'+tel).toLowerCase();
  if(emergency.some(x=>(x.name+'|'+x.tel).toLowerCase()===key)){
    toast('Duplicado: ya existe'); return;
  }
  emergency.push({name,tel});
  saveEmergencies();
  $('#e-name').value='';
  $('#e-tel').value='';
  renderEmergency();
  toast('Añadido');
};

(function enableFabDrag(){
  const fab=$('#fab');
  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  const bounds=()=>({ w:innerWidth, h:innerHeight });
  const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);
  function setPos(x,y){
    fab.style.left=x+'px'; fab.style.right='auto';
    fab.style.top=y+'px';  fab.style.bottom='auto';
  }
  const p=(()=>{
    try{return JSON.parse(localStorage.getItem('aurora.fabpos')||'')}
    catch{return null}
  })();
  if(p && Number.isFinite(p.x) && Number.isFinite(p.y)) setPos(p.x,p.y);
  const savePos=(x,y)=>localStorage.setItem('aurora.fabpos', JSON.stringify({x,y}));

  const onDown=(e)=>{
    dragging=true;
    const r=fab.getBoundingClientRect();
    sx=(e.touches?e.touches[0].clientX:e.clientX);
    sy=(e.touches?e.touches[0].clientY:e.clientY);
    ox=r.left; oy=r.top;
    e.preventDefault();
  };
  const onMove=(e)=>{
    if(!dragging) return;
    const {w,h}=bounds();
    const x0=(e.touches?e.touches[0].clientX:e.clientX);
    const y0=(e.touches?e.touches[0].clientY:e.clientY);
    let nx=ox+(x0-sx);
    let ny=oy+(y0-sy);
    const margin=8;
    const bh=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bottom-h'))||68;
    ny=clamp(ny, margin, h - bh - fab.offsetHeight - 8);
    nx=clamp(nx, margin, w - fab.offsetWidth - margin);
    setPos(nx,ny);
  };
  const onUp=()=>{
    if(!dragging) return;
    dragging=false;
    const r=fab.getBoundingClientRect();
    savePos(r.left,r.top);
  };
  fab.addEventListener('pointerdown',onDown);
  addEventListener('pointermove',onMove);
  addEventListener('pointerup',onUp);
  addEventListener('pointercancel',onUp);
})();

function placePanelNearFab(){
  const fab=$('#fab'), panel=$('#fabPanel');
  const r=fab.getBoundingClientRect();
  const pad=8;
  const pw=Math.min(460, innerWidth*0.96);
  const ph=Math.min(420, innerHeight*0.7);
  let left = Math.min(Math.max(r.left, pad), innerWidth - pw - pad);
  let top  = Math.max( pad, r.top - ph - 12 );
  panel.style.width=pw+'px';
  panel.style.left=left+'px';
  panel.style.top=top+'px';
  panel.style.right='auto';
  panel.style.bottom='auto';
}

/* ===== Montaje ===== */
function mount(uid){
  loadEmergencies();
  renderEmergency();
  setupPlanta(uid);
  setupTareas(uid);
  setupDir(uid);
  setupBiblio(uid);
  const first=location.hash?.slice(1);
  if(mapTabs[first]) selectTab(first);
  else selectTab(localStorage.getItem('tab')||'planta');
}
</script>
</body>
</html>
