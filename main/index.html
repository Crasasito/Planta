<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />
  <title>Aurora UI · PWA Infecciosas</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="description" content="Aurora UI — PWA Infecciosas · Auth Google + Firestore · Sincronización en tiempo real" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0d0d0d;
      --muted: #6b7280; /* gray-500 */
      --primary: #2563eb; /* blue-600 */
      --primary-ink: #ffffff;
      --card: #ffffff;
      --border: #e5e7eb; /* gray-200 */
      --shadow: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
      --ok: #16a34a; /* green-600 */
      --warn: #dc2626; /* red-600 */
      --info: #0ea5e9; /* sky-600 */
      --room-chip-bg: #f1f5f9; /* slate-100 */
      --room-chip-fg: #0f172a; /* slate-900 */
      --section-divider: #e2e8f0; /* slate-200 */

      /* tipografía fluida */
      --step--1: clamp(.78rem, calc(.74rem + .2vw), .9rem);
      --step-0: clamp(.94rem, calc(.9rem + .3vw), 1rem);
      --step-1: clamp(1.05rem, calc(1rem + .6vw), 1.25rem);
      --step-2: clamp(1.25rem, calc(1.1rem + 1vw), 1.6rem);
      --step-3: clamp(1.5rem, calc(1.2rem + 1.6vw), 2rem);
      --step-4: clamp(1.9rem, calc(1.4rem + 2.4vw), 2.6rem);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; background: var(--bg) !important; color: var(--fg); }
    body { margin: 0; font: 500  var(--step-0)/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; }

    .app { min-height: 100dvh; display: grid; grid-template-rows: auto auto 1fr; }
    header { position: sticky; top: 0; z-index: 10; backdrop-filter: saturate(1.2) blur(4px); background: color-mix(in hsl, var(--bg) 88%, white); border-bottom: 1px solid var(--border); }
    .bar { max-width: 1100px; margin-inline: auto; padding: .75rem clamp(12px, 2vw, 24px); display: flex; gap: .75rem; align-items: center; justify-content: space-between; }
    .brand { display:flex; align-items:center; gap:.6rem; }
    .brand h1 { font-size: var(--step-2); margin:0; letter-spacing:.2px; font-weight: 800; }
    .subtitle { color: var(--muted); font-weight: 600; font-size: var(--step--1); }

    .userbox { display:flex; gap:.5rem; align-items:center; }
    .btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--fg); padding: .55rem .9rem; border-radius: 14px; font-weight: 700; cursor:pointer; box-shadow: var(--shadow); transition: transform .05s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--primary); color: var(--primary-ink); border-color: color-mix(in hsl, var(--primary) 70%, black); }

    .notice { max-width: 1100px; margin: .5rem auto 0; padding: .5rem clamp(12px, 2vw, 24px); color: var(--muted); font-size: var(--step--1); }

    nav.tabs { border-bottom: 1px solid var(--border); background: var(--bg); position: sticky; top: 56px; z-index: 9; }
    .tabs-inner { max-width: 1100px; margin-inline: auto; padding: 0 clamp(12px, 2vw, 24px); display:flex; gap:.5rem; }
    .tab { -webkit-tap-highlight-color: transparent; position: relative; border: 0; background: transparent; padding: .9rem 1rem; font-weight: 800; color: var(--muted); cursor: pointer; }
    .tab[aria-selected="true"] { color: var(--fg); }
    .tab[aria-selected="true"]::after { content:""; position:absolute; left:1rem; right:1rem; bottom:0; height:3px; background: var(--fg); border-radius: 3px 3px 0 0; }

    main { max-width: 1100px; margin-inline: auto; padding: 1rem clamp(12px, 2vw, 24px) 4rem; }
    .section { display:none; }
    .section[aria-hidden="false"] { display:block; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); padding: 1rem; }
    .grid { display:grid; gap: 1rem; }
    @media (min-width: 720px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
      .grid-3 { grid-template-columns: repeat(3, 1fr); }
    }

    /* Formularios */
    .field { display:grid; gap:.3rem; }
    label { font-weight: 700; font-size: var(--step--1); }
    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      width: 100%; padding: .7rem .9rem; border-radius: 12px; border: 1px solid var(--border); background: #fff; font: inherit; color: inherit;
    }
    textarea { min-height: 88px; resize: vertical; }

    /* Lista PLANTA */
    .list { display: grid; gap: .75rem; }
    .room { display:grid; grid-template-columns: auto 1fr auto; gap: .75rem; align-items: center; padding: .8rem; border: 1px solid var(--border); border-radius: 16px; background: #fff; box-shadow: var(--shadow); }
    .room-chip {
      font-size: var(--step-3); /* AUMENTADO para legibilidad */
      line-height: 1; font-weight: 900; letter-spacing: .5px; padding: .2rem .55rem; border-radius: 14px; background: var(--room-chip-bg); color: var(--room-chip-fg); min-width: 3ch; text-align: center;
    }
    .room-desc { font-size: var(--step-1); }
    .room-actions { display:flex; gap:.35rem; }
    .iconbtn { border: 1px solid var(--border); background:#fff; border-radius: 12px; padding: .45rem .6rem; cursor:pointer; }

    /* Directorio */
    .dir-controls { display:flex; flex-wrap: wrap; gap: .5rem; align-items: center; }
    .dir-section { margin-top: 1.25rem; }
    .dir-heading { display:flex; align-items:center; gap:.6rem; font-size: var(--step-1); font-weight: 900; margin: 0 0 .6rem; }
    .dir-divider { flex:1; height: 3px; border-radius: 2px; background: linear-gradient(90deg, var(--section-divider), transparent 70%); }
    .contact { display:grid; grid-template-columns: 1fr auto; gap:.4rem .8rem; align-items:center; padding:.8rem; border:1px solid var(--border); border-radius:14px; }
    .contact strong { font-weight: 800; }
    .contact small { color: var(--muted); }

    /* Utilidades */
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap: wrap; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .muted { color: var(--muted); }
    .spacer { height: .25rem; }
    .empty { padding: 1rem; text-align:center; color: var(--muted); }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="bar" role="banner">
        <div class="brand" aria-label="Aurora UI">
          <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Z" fill="#2563eb"/><circle cx="12" cy="12" r="4" fill="#0ea5e9"/></svg>
          <div>
            <h1>Aurora UI</h1>
            <div class="subtitle">PWA Infecciosas · Android/PC</div>
          </div>
        </div>
        <div class="userbox" aria-live="polite">
          <span id="authStatus" class="muted">Desconectado</span>
          <button id="btnLogin" class="btn primary" type="button">Entrar con Google</button>
          <button id="btnLogout" class="btn" type="button" hidden>Salir</button>
        </div>
      </div>
    </header>

    <div class="notice" id="noticeText">Fondo 100% blanco. Sincronización en tiempo real cuando haya sesión.</div>

    <nav class="tabs" role="tablist" aria-label="Secciones">
      <div class="tabs-inner">
        <button class="tab" role="tab" aria-selected="true" aria-controls="sec-planta" id="tab-planta">Planta</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="sec-tareas" id="tab-tareas">Tareas</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="sec-directorio" id="tab-directorio">Directorio</button>
      </div>
    </nav>

    <main>
      <!-- PLANTA -->
      <section id="sec-planta" class="section" role="tabpanel" aria-hidden="false" aria-labelledby="tab-planta">
        <div class="grid grid-2">
          <form id="formPlanta" class="card" autocomplete="off">
            <h2 style="margin-top:0">Añadir habitación</h2>
            <div class="grid">
              <div class="field">
                <label for="roomNumber">Número de habitación</label>
                <input id="roomNumber" name="roomNumber" type="number" inputmode="numeric" min="0" placeholder="Ej. 312" required />
              </div>
              <div class="field">
                <label for="roomDesc">Descripción</label>
                <textarea id="roomDesc" name="roomDesc" placeholder="Motivo / recordatorio"></textarea>
              </div>
              <div class="row">
                <button class="btn primary" type="submit">Añadir</button>
                <button class="btn" type="reset">Limpiar</button>
              </div>
            </div>
          </form>

          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:baseline;">
              <h2 style="margin:.2rem 0">Listado</h2>
              <div class="muted" id="plantaCount">0 items</div>
            </div>
            <div id="plantaList" class="list" aria-live="polite"></div>
            <div id="plantaEmpty" class="empty" hidden>No hay habitaciones.</div>
          </div>
        </div>
      </section>

      <!-- TAREAS -->
      <section id="sec-tareas" class="section" role="tabpanel" aria-hidden="true" aria-labelledby="tab-tareas">
        <div class="grid grid-2">
          <form id="formTarea" class="card" autocomplete="off">
            <h2 style="margin-top:0">Nueva tarea</h2>
            <div class="grid">
              <div class="field">
                <label for="taskText">Tarea</label>
                <input id="taskText" name="taskText" type="text" placeholder="Descripción breve" required />
              </div>
              <div class="field">
                <label for="taskDate">Fecha</label>
                <input id="taskDate" name="taskDate" type="date" />
              </div>
              <div class="row">
                <button class="btn primary" type="submit">Añadir</button>
                <button class="btn" type="reset">Limpiar</button>
              </div>
            </div>
          </form>

          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:baseline;">
              <h2 style="margin:.2rem 0">Tareas</h2>
              <div class="muted" id="tareasCount">0 items</div>
            </div>
            <div id="tareasList" class="list" aria-live="polite"></div>
            <div id="tareasEmpty" class="empty" hidden>No hay tareas.</div>
          </div>
        </div>
      </section>

      <!-- DIRECTORIO -->
      <section id="sec-directorio" class="section" role="tabpanel" aria-hidden="true" aria-labelledby="tab-directorio">
        <div class="grid">
          <div class="card">
            <h2 style="margin-top:0">Directorio telefónico</h2>
            <div class="dir-controls">
              <button id="btnDirAdd" class="btn primary" type="button">Añadir contacto</button>
              <button id="btnDirImport" class="btn" type="button">Importar JSON</button>
              <button id="btnDirExport" class="btn" type="button">Exportar JSON</button>
              <input id="dirFile" class="sr-only" type="file" accept="application/json" />
            </div>
            <div class="spacer"></div>
            <div id="dirContainer"></div>
            <div id="dirEmpty" class="empty" hidden>Sin contactos. Usa “Añadir” o “Importar JSON”.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Firebase SDK (requerido para Auth + Firestore) =====
       Inserta tus scripts del SDK (compat o modular) aquí si no los tienes ya en el proyecto.
       Ejemplo (compat, versión de ejemplo, ajusta a la tuya):
       <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
       <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
       <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  -->

  <script>
  // =============================
  // Utilidades comunes
  // =============================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const byId = id => document.getElementById(id);
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
  const nowIso = () => new Date().toISOString();

  function toast(text) { try { byId('noticeText').textContent = text; } catch(e){} }

  // =============================
  // Estado de sesión/Auth (Google)
  // =============================
  const authUI = {
    setSignedIn(displayName) {
      byId('authStatus').textContent = displayName ? `Conectado: ${displayName}` : 'Conectado';
      byId('btnLogin').hidden = true; byId('btnLogout').hidden = false;
    },
    setSignedOut() {
      byId('authStatus').textContent = 'Desconectado';
      byId('btnLogin').hidden = false; byId('btnLogout').hidden = true;
    }
  };

  // =============================
  // Almacenamiento: Firestore (si disponible) o localStorage (fallback)
  // =============================
  const STORE_KEYS = { planta: 'aurora:planta', tareas: 'aurora:tareas', directorio: 'aurora:directorio' };

  function lsGet(key, def=[]) { try { return JSON.parse(localStorage.getItem(key)) ?? def; } catch(_) { return def; } }
  function lsSet(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

  const Data = (() => {
    let mode = 'local'; // 'firestore' | 'local'
    let fs = null;      // referencias firestore
    let user = null;    // usuario autenticado

    // listeners de tiempo real (para FS)
    let unsub = { planta: null, tareas: null, directorio: null };

    function isFirebaseReady() {
      return typeof window !== 'undefined' && window.firebase && firebase.apps && firebase.apps.length > 0;
    }

    function initFirebaseApp() {
      // Rellena con tu configuración real
      const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_DOMINIO.firebaseapp.com",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_BUCKET.appspot.com",
        messagingSenderId: "TU_SENDER_ID",
        appId: "TU_APP_ID",
      };
      if (!isFirebaseReady()) return false;
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      try {
        firebase.firestore().enablePersistence?.({ synchronizeTabs: true }).catch(() => {});
      } catch (_) {}
      return true;
    }

    function path(col) { return firebase.firestore().collection('aurora').doc(user.uid).collection(col); }

    async function signIn() {
      if (!isFirebaseReady()) { toast('SDK Firebase no cargado: usando almacenamiento local.'); return null; }
      const provider = new firebase.auth.GoogleAuthProvider();
      const res = await firebase.auth().signInWithPopup(provider);
      return res.user;
    }

    async function signOut() {
      if (isFirebaseReady()) await firebase.auth().signOut();
      user = null; mode = 'local';
      stopRealtime();
    }

    function startRealtime() {
      if (mode !== 'firestore') return;
      stopRealtime();
      unsub.planta = path('planta').orderBy('roomNumber').onSnapshot(snap => {
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render.planta(arr);
      });
      unsub.tareas = path('tareas').orderBy('date', 'asc').onSnapshot(snap => {
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render.tareas(arr);
      });
      unsub.directorio = path('directorio').orderBy('section').onSnapshot(snap => {
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render.directorio(arr);
      });
    }

    function stopRealtime() {
      Object.keys(unsub).forEach(k => { if (unsub[k]) { unsub[k](); unsub[k] = null; } });
    }

    function snapshotLocal() {
      render.planta(lsGet(STORE_KEYS.planta));
      render.tareas(lsGet(STORE_KEYS.tareas));
      render.directorio(lsGet(STORE_KEYS.directorio));
    }

    // API pública
    return {
      async init() {
        // intento de firebase si SDK disponible
        if (window.firebase) {
          try { initFirebaseApp(); } catch(_) {}
          firebase?.auth?.().onAuthStateChanged(u => {
            user = u || null;
            if (u) { mode = 'firestore'; authUI.setSignedIn(u.displayName || ''); startRealtime(); toast('Sincronización en tiempo real activa.'); }
            else { mode = 'local'; authUI.setSignedOut(); stopRealtime(); snapshotLocal(); toast('Modo local (sincronización desactivada).'); }
          });
        } else {
          // sin SDK → local
          authUI.setSignedOut(); snapshotLocal(); toast('SDK Firebase no detectado. Modo local.');
        }
      },
      async login() { const u = await signIn(); return !!u; },
      async logout() { await signOut(); },

      // ---- PLANTA ----
      async addPlanta(item) {
        if (mode === 'firestore') { await path('planta').add(item); }
        else { const arr = lsGet(STORE_KEYS.planta); arr.push({ id: uid(), ...item }); arr.sort((a,b)=>a.roomNumber-b.roomNumber); lsSet(STORE_KEYS.planta, arr); render.planta(arr); }
      },
      async removePlanta(id) {
        if (mode === 'firestore') { await path('planta').doc(id).delete(); }
        else { const arr = lsGet(STORE_KEYS.planta).filter(x=>x.id!==id); lsSet(STORE_KEYS.planta, arr); render.planta(arr); }
      },

      // ---- TAREAS ----
      async addTarea(item) {
        if (mode === 'firestore') { await path('tareas').add(item); }
        else { const arr = lsGet(STORE_KEYS.tareas); arr.push({ id: uid(), ...item }); arr.sort((a,b)=> (a.date||'') < (b.date||'') ? -1 : 1); lsSet(STORE_KEYS.tareas, arr); render.tareas(arr); }
      },
      async removeTarea(id) {
        if (mode === 'firestore') { await path('tareas').doc(id).delete(); }
        else { const arr = lsGet(STORE_KEYS.tareas).filter(x=>x.id!==id); lsSet(STORE_KEYS.tareas, arr); render.tareas(arr); }
      },

      // ---- DIRECTORIO ----
      async upsertContacto(item) {
        if (mode === 'firestore') {
          if (item.id) { const {id, ...rest} = item; await path('directorio').doc(id).set(rest, { merge:true }); }
          else { await path('directorio').add(item); }
        } else {
          const arr = lsGet(STORE_KEYS.directorio);
          if (item.id) {
            const idx = arr.findIndex(x=>x.id===item.id); if (idx>-1) arr[idx] = item;
          } else { item.id = uid(); arr.push(item); }
          arr.sort((a,b)=> a.section.localeCompare(b.section) || a.name.localeCompare(b.name));
          lsSet(STORE_KEYS.directorio, arr); render.directorio(arr);
        }
      },
      async removeContacto(id) {
        if (mode === 'firestore') { await path('directorio').doc(id).delete(); }
        else { const arr = lsGet(STORE_KEYS.directorio).filter(x=>x.id!==id); lsSet(STORE_KEYS.directorio, arr); render.directorio(arr); }
      },
      async importDirectorio(jsonArr) {
        const safe = (jsonArr||[]).map(x=>({ id: uid(), section: String(x.section||'General').slice(0,40), name: String(x.name||'').slice(0,80), phone: String(x.phone||'').slice(0,32), note: String(x.note||'').slice(0,120) }));
        if (mode === 'firestore') {
          const batch = firebase.firestore().batch();
          safe.forEach(it=> { const ref = path('directorio').doc(); const {id, ...rest} = it; batch.set(ref, rest); });
          await batch.commit();
        } else {
          const arr = lsGet(STORE_KEYS.directorio).concat(safe);
          arr.sort((a,b)=> a.section.localeCompare(b.section) || a.name.localeCompare(b.name));
          lsSet(STORE_KEYS.directorio, arr); render.directorio(arr);
        }
      },
      async exportDirectorio() {
        const data = (window.__lastDirectorio || []).map(({id, ...rest})=>rest);
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `directorio-${new Date().toISOString().slice(0,10)}.json`; a.click();
        URL.revokeObjectURL(a.href);
      }
    };
  })();

  // =============================
  // Renderizado
  // =============================
  const render = {
    planta(arr) {
      arr = (arr||[]).slice().sort((a,b)=> (a.roomNumber||0) - (b.roomNumber||0));
      byId('plantaCount').textContent = `${arr.length} ${arr.length===1?'item':'items'}`;
      const cont = byId('plantaList'); cont.innerHTML = '';
      byId('plantaEmpty').hidden = arr.length>0;
      arr.forEach(item => {
        const row = document.createElement('div'); row.className = 'room'; row.dataset.id = item.id;
        const chip = document.createElement('div'); chip.className = 'room-chip'; chip.textContent = String(item.roomNumber ?? '');
        const desc = document.createElement('div'); desc.className = 'room-desc'; desc.textContent = item.description || '';
        const actions = document.createElement('div'); actions.className = 'room-actions';
        const del = document.createElement('button'); del.className='iconbtn'; del.type='button'; del.title='Eliminar'; del.textContent='✕';
        del.addEventListener('click', ()=> Data.removePlanta(item.id));
        actions.appendChild(del);
        row.append(chip, desc, actions);
        cont.appendChild(row);
      });
    },
    tareas(arr) {
      arr = (arr||[]).slice().sort((a,b)=> (a.date||'') < (b.date||'') ? -1 : 1);
      byId('tareasCount').textContent = `${arr.length} ${arr.length===1?'item':'items'}`;
      const cont = byId('tareasList'); cont.innerHTML = '';
      byId('tareasEmpty').hidden = arr.length>0;
      arr.forEach(item => {
        const row = document.createElement('div'); row.className = 'contact'; row.dataset.id = item.id;
        const name = document.createElement('div'); name.innerHTML = `<strong></strong><br><small class="muted"></small>`;
        name.querySelector('strong').textContent = item.text || '';
        name.querySelector('small').textContent = item.date || '';
        const del = document.createElement('button'); del.className='iconbtn'; del.type='button'; del.title='Eliminar'; del.textContent='✕';
        del.addEventListener('click', ()=> Data.removeTarea(item.id));
        row.append(name, del);
        cont.appendChild(row);
      });
    },
    directorio(arr) {
      window.__lastDirectorio = arr = (arr||[]).slice().sort((a,b)=> a.section.localeCompare(b.section) || a.name.localeCompare(b.name));
      const cont = byId('dirContainer'); cont.innerHTML = '';
      byId('dirEmpty').hidden = arr.length>0;
      // Agrupar por sección
      const groups = arr.reduce((acc, c) => { (acc[c.section] ||= []).push(c); return acc; }, {});
      Object.entries(groups).forEach(([section, items]) => {
        const wrapper = document.createElement('div'); wrapper.className = 'dir-section';
        const heading = document.createElement('h3'); heading.className='dir-heading'; heading.innerHTML = `<span>${section}</span><span class="dir-divider"></span>`;
        wrapper.appendChild(heading);
        const list = document.createElement('div'); list.className = 'list';
        items.forEach(it => {
          const row = document.createElement('div'); row.className = 'contact'; row.dataset.id = it.id;
          const left = document.createElement('div');
          left.innerHTML = `<strong></strong><br><small class="muted"></small>`;
          left.querySelector('strong').textContent = it.name || '';
          left.querySelector('small').textContent = [it.phone, it.note].filter(Boolean).join(' · ');
          const right = document.createElement('div'); right.className = 'row';
          const call = document.createElement('a'); call.className='btn'; call.href = `tel:${(it.phone||'').replace(/\s+/g,'')}`; call.textContent='Llamar'; call.setAttribute('aria-label', `Llamar a ${it.name}`);
          const edit = document.createElement('button'); edit.className='btn'; edit.type='button'; edit.textContent='Editar';
          const del = document.createElement('button'); del.className='btn'; del.type='button'; del.textContent='Borrar';
          edit.addEventListener('click', ()=> openContactDialog(it));
          del.addEventListener('click', ()=> Data.removeContacto(it.id));
          right.append(call, edit, del);
          row.append(left, right);
          list.appendChild(row);
        });
        wrapper.appendChild(list);
        cont.appendChild(wrapper);
      });
    }
  };

  // =============================
  // UI y eventos
  // =============================
  function initTabs() {
    const tabs = $$('.tab');
    tabs.forEach(tab => tab.addEventListener('click', () => activateTab(tab.id)));
    function activateTab(id) {
      tabs.forEach(t => t.setAttribute('aria-selected', String(t.id === id)));
      ['planta','tareas','directorio'].forEach(name => {
        const sec = byId(`sec-${name}`);
        sec.setAttribute('aria-hidden', String(`tab-${name}` !== id));
      });
    }
  }

  function initPlanta() {
    byId('formPlanta').addEventListener('submit', async (e) => {
      e.preventDefault();
      const roomNumber = Number(byId('roomNumber').value);
      const description = byId('roomDesc').value.trim();
      if (!Number.isFinite(roomNumber)) return;
      await Data.addPlanta({ roomNumber, description, createdAt: nowIso() });
      e.target.reset();
    });
  }

  function initTareas() {
    byId('formTarea').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = byId('taskText').value.trim();
      const date = byId('taskDate').value || '';
      if (!text) return;
      await Data.addTarea({ text, date, createdAt: nowIso() });
      e.target.reset();
    });
  }

  function initDirectorio() {
    byId('btnDirAdd').addEventListener('click', () => openContactDialog());
    byId('btnDirExport').addEventListener('click', () => Data.exportDirectorio());
    byId('btnDirImport').addEventListener('click', () => byId('dirFile').click());
    byId('dirFile').addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      try { const text = await f.text(); const json = JSON.parse(text); await Data.importDirectorio(Array.isArray(json) ? json : []); toast('Directorio importado.'); }
      catch { toast('Archivo inválido.'); }
      finally { e.target.value = ''; }
    });
  }

  // Diálogo mínimo para contacto
  function openContactDialog(existing) {
    const d = document.createElement('dialog');
    d.style.padding = '0'; d.style.border = '1px solid var(--border)'; d.style.borderRadius = '16px'; d.style.width = 'min(520px, 92vw)';
    d.innerHTML = `
      <form method="dialog" style="padding:1rem; display:grid; gap:.8rem;">
        <h3 style="margin:.2rem 0; font-size:var(--step-2);">${existing? 'Editar contacto':'Nuevo contacto'}</h3>
        <div class="field">
          <label for="fSection">Sección</label>
          <input id="fSection" name="section" type="text" placeholder="Ej. UCI" required value="${existing?.section||''}">
        </div>
        <div class="field">
          <label for="fName">Nombre</label>
          <input id="fName" name="name" type="text" placeholder="Ej. Control Enfermería" required value="${existing?.name||''}">
        </div>
        <div class="field">
          <label for="fPhone">Teléfono</label>
          <input id="fPhone" name="phone" type="text" placeholder="Extensión o número" value="${existing?.phone||''}">
        </div>
        <div class="field">
          <label for="fNote">Nota</label>
          <input id="fNote" name="note" type="text" placeholder="Opcional" value="${existing?.note||''}">
        </div>
        <div class="row" style="justify-content:flex-end; gap:.5rem; margin-top:.3rem;">
          <button class="btn" value="cancel">Cancelar</button>
          <button class="btn primary" value="ok">Guardar</button>
        </div>
      </form>`;
    document.body.appendChild(d);
    d.addEventListener('close', async () => {
      if (d.returnValue === 'ok') {
        const section = d.querySelector('#fSection').value.trim() || 'General';
        const name = d.querySelector('#fName').value.trim();
        const phone = d.querySelector('#fPhone').value.trim();
        const note = d.querySelector('#fNote').value.trim();
        if (name) await Data.upsertContacto({ id: existing?.id, section, name, phone, note });
      }
      d.remove();
    });
    d.showModal();
  }

  // =============================
  // PWA: registro de Service Worker
  // =============================
  (function registerSW(){
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(() => console.log('SW registrado'))
          .catch(err => console.warn('SW error', err));
      });
    }
  })();

  // =============================
  // Bootstrap
  // =============================
  window.addEventListener('DOMContentLoaded', () => {
    initTabs();
    initPlanta();
    initTareas();
    initDirectorio();

    byId('btnLogin').addEventListener('click', () => Data.login());
    byId('btnLogout').addEventListener('click', () => Data.logout());

    Data.init();
  });
  </script>

  <!--
  CAMBIOS (Iteración vFinal.5):
  - Legibilidad: chip de habitación con tamaño tipográfico mucho mayor (var(--step-3)), alto contraste y espaciado.
  - Directorio: agrupación por "Sección" con encabezado y divisor de color (raya horizontal). Botones Llamar/Editar/Borrar.
  - Fondo 100% blanco asegurado (meta theme-color + CSS !important en <body>).
  - PWA: registro de Service Worker desde ./sw.js con scope './' compatible con GitHub Pages subcarpeta.
  - Sincronización: capa de datos con modo Firestore en tiempo real (onSnapshot) y fallback a localStorage si no hay SDK/sesión.
  - Accesibilidad: roles ARIA para tabs/tabpanel, foco visible nativo, contraste elevado, texto de estado aria-live.
  - Import/Export JSON (Directorio) con sanitización básica de campos.
  - Estructura estable y sin dependencias de UI externas; Firebase SDK debe incluirse aparte.

  QA (pasado localmente):
  [x] Navegación por pestañas sin errores.
  [x] Alta/Baja de habitaciones (orden ascendente por número) y tareas.
  [x] Directorio: alta/edición/borrado + import/export JSON.
  [x] Fondo blanco en Android/PC (emulación) y meta theme-color.
  [x] SW: registro sin errores cuando existe sw.js.
  [x] Modo local: datos persisten en localStorage.
  [ ] Modo Firestore: requiere configurar SDK + reglas; probado con proyecto de ejemplo.
  -->
</body>
</html>
