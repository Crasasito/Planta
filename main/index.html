<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="color-scheme" content="light"/>
  <title>Aurora UI ‚Äî Infecciosas ¬∑ Planta ¬∑ Tareas ¬∑ Directorio ¬∑ Biblioteca ¬∑ *</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <style>
    /* ===================  TOKENS ¬∑ One UI 8 Premium 2.0 =================== */
    :root{
      --ink:#0b1220;           /* texto principal */
      --muted:#5b677c;         /* texto secundario */
      --surface:#ffffff;       /* fondo base */
      --surface-2:#f7f9fc;     /* paneles sutiles */
      --border:#e6ecf3;        /* bordes claros */

      /* Paleta base (pastel, elegancia casual) */
      --brand-1:#1B9AAA; /* teal */
      --brand-2:#06D6A0; /* mint */
      --brand-3:#FACC15; /* gold */
      --brand-4:#EF476F; /* coral */
      --brand-5:#6F7BF7; /* indigo */
      --brand-6:#A78BFA; /* violeta suave */

      /* Gradientes por secci√≥n (pastel + glow controlado) */
      --g-add:     linear-gradient(135deg,#E0F2FF 0%, #38BDF8 55%, #0EA5E9 100%);
      --g-planta:  linear-gradient(135deg,#EDE9FE 0%, #C4B5FD 55%, #8B5CF6 100%);     /* violeta */
      --g-inter:   linear-gradient(135deg,#FFF1D6 0%, #FBBF24 55%, #F59E0B 100%);     /* √°mbar */
      --g-tareas:  linear-gradient(135deg,#FFE4E9 0%, #FCA5A5 55%, #F43F5E 100%);     /* coral/rojo elegante */
      --g-green:   linear-gradient(135deg,#DCFCE7 0%, #34D399 55%, #10B981 100%);     /* verde */
      --g-dir:     linear-gradient(135deg,#FEF9C3 0%, #FDE047 55%, #FACC15 100%);     /* dorado */
      --g-biblio:  linear-gradient(135deg,#E0E7FF 0%, #A5B4FC 55%, #6366F1 100%);     /* √≠ndigo */
      --g-extra:   linear-gradient(135deg,#FCE7F3 0%, #F0ABFC 55%, #D946EF 100%);     /* rosa-magenta */

      /* Dimensiones */
      --radius:14px; --radius-xl:22px; --appbar:64px; --touch:44px; --safe-bottom:calc(88px + env(safe-area-inset-bottom));

      /* Sombras premium (glow externo, sin halos en texto) */
      --shadow-1: 0 1px 2px rgba(6,16,30,.05),0 8px 24px rgba(6,16,30,.06);
      --shadow-2: 0 2px 10px rgba(6,16,30,.10),0 20px 40px rgba(6,16,30,.14);
      --glow: 0 12px 26px rgba(16,40,80,.10);

      /* Tipograf√≠a fluida + viewport real en Android */
      --fs: clamp(15px, 0.85vw + 0.35vh, 18px);
      --h2: clamp(20px, 2.6vw, 26px);
      --vh: 1vh;
    }

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--surface);
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--fs); line-height:1.65; min-height:calc(var(--vh) * 100);
      padding-bottom: var(--safe-bottom);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color:transparent; overflow-x:hidden;
      text-rendering: optimizeLegibility;
    }
    :focus-visible{outline:3px solid color-mix(in oklab,var(--brand-3),var(--brand-2) 35%); outline-offset:2px; border-radius:12px}
    .container{max-width:min(1180px,98vw); margin:0 auto; padding:8px clamp(12px,4vw,20px); container-type:inline-size}
    .grow{flex:1;min-width:0}
    .hide{display:none !important}

    /* ===================  APPBAR GLASS (sin rim en texto) =================== */
    header.appbar{
      position:sticky; top:0; z-index:50; min-height:var(--appbar);
      backdrop-filter: blur(8px) saturate(1.06);
      background:linear-gradient(180deg,rgba(255,255,255,.92) 0%, rgba(247,249,252,.82) 100%);
      border-bottom:1px solid var(--border);
    }
    .appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand-chip{
      padding:12px 18px; font-size:clamp(16px,2.2vw,18px); font-weight:1000;
      display:inline-flex;align-items:center;gap:10px;border-radius:999px; color:#0E121A;
      background:linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);
      border:1px solid #eef4df; box-shadow: var(--shadow-1), inset 0 1px 0 #fff;
    }
    .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--brand-3);box-shadow:0 0 0 2px rgba(0,0,0,.06)}
    header.appbar h1{
      margin:0; font-size:clamp(18px,2.2vw,22px); font-weight:1000; letter-spacing:.2px;
      color:#0d1726;
      /* SIN stroke ni sombras blancas; s√≥lo un drop-shadow muy suave para lectura sobre fondos claros */
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.05));
    }

    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;font-size:.84rem;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
    .chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
    .chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}

    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
      padding:10px 12px;border-radius:14px;box-shadow:var(--shadow-1);
      min-height:var(--touch);min-width:44px;display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#fffdf3 0%, #fff7d1 100%); border-color:color-mix(in oklab,var(--brand-3),transparent 65%); box-shadow:var(--shadow-2)}
    .btn.icon{min-width:var(--touch);aspect-ratio:1/1;padding:0 10px}

    /* ===================  TARJETAS GLASMORFISMO =================== */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.86) 0%, rgba(255,255,255,.78) 100%);
      backdrop-filter: blur(8px) saturate(1.06);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--glow);
      overflow:hidden; contain:content;
    }
    .card-b{padding:12px}
    .card-h{
      position:relative; padding:16px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid color-mix(in oklab,#000,transparent 90%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
      isolation:isolate; overflow:hidden;
    }
    .card-h::after{
      /* Rim light ambiental (no en el texto) */
      content:""; position:absolute; inset:-20% -10% auto -10%; height:160%;
      background: radial-gradient(60% 40% at 50% 0%, rgba(255,255,255,.35), rgba(255,255,255,0));
      pointer-events:none; mix-blend-mode:screen; opacity:.6;
    }
    .card-h h2{
      margin:0; font-size:var(--h2); font-weight:1000; letter-spacing:.2px; color:#0b1220;
      /* SIN stroke; sombra externa muy leve para separar de gradiente */
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.05)) drop-shadow(0 8px 22px rgba(0,0,0,.10));
    }
    /* Etiqueta relieve bajo el h2 para jerarqu√≠a y contraste */
    .subtitle{ color:#06121fcc; font-weight:800 }
    .card-h h2 + .subtitle::before{
      content:""; display:inline-block; vertical-align:middle; width:6px; height:6px; margin-right:8px; border-radius:50%;
      background:color-mix(in oklab,var(--ink),transparent 75%);
      box-shadow: inset 0 1px 0 #fff;
    }

    /* Colores por secci√≥n */
    .hdr-add{    background:var(--g-add) }
    .hdr-planta{ background:var(--g-planta) }
    .hdr-inter{  background:var(--g-inter) }
    .hdr-tareas{ background:var(--g-tareas) }
    .hdr-green{  background:var(--g-green) }
    .hdr-dir{    background:var(--g-dir) }
    .hdr-biblio{ background:var(--g-biblio) }
    .hdr-extra{  background:var(--g-extra) }

    /* ===================  TABS =================== */
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tab{
      padding:12px;border-radius:16px;border:1px solid var(--border);background:var(--surface-2);
      cursor:pointer;font-weight:900;letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:12px
    }
    .tab[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--brand-1),transparent 65%);box-shadow:0 10px 24px rgba(20,70,120,.08), inset 0 1px 0 #fff}
    nav.bottom{position:fixed;left:0;right:0;bottom:0;z-index:30;background:#fff;border-top:1px solid var(--border)}
    .tabs-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-items:center;padding:8px 12px}
    .tab-bottom{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);cursor:pointer;font-weight:800;
      display:flex;align-items:center;justify-content:center;gap:10px
    }
    .tab-bottom[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--brand-3),transparent 60%);box-shadow:0 8px 22px rgba(0,0,0,.08), inset 0 1px 0 #fff}

    .ico{ width:30px; height:30px }
    .tab-bottom .ico{ width:26px; height:26px }
    .ico-wrap{ position:relative; display:inline-grid; place-items:center }
    .ico-wrap::before{
      content:""; position:absolute; inset:-8px; border-radius:14px;
      background: radial-gradient(60% 60% at 50% 40%, #ffffff 0%, #ffffff 55%, rgba(255,255,255,0) 100%);
      box-shadow: 0 12px 28px rgba(0,0,0,.10); z-index:0;
    }
    .ico-wrap > svg{ position:relative; z-index:1 }

    /* ===================  LISTAS / FORM =================== */
    ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
    li.item{display:grid;grid-template-columns:auto minmax(140px,1fr) auto;gap:12px;align-items:center;border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
    label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
    input,textarea,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;color:var(--ink);font:inherit;min-height:var(--touch);box-shadow:inset 0 1px 0 #fff}
    textarea{min-height:90px;resize:vertical}

    /* P√≠ldoras de habitaciones ‚Äî mayor contraste + sin halos de texto */
    .pill{display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;padding:7px 12px;border-radius:14px;line-height:1;border:1px solid transparent;color:#0d1726;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
    .pill.room{
      font-family: ui-monospace,Consolas,Menlo,monospace;
      font-size:clamp(22px,3.2vw,26px);
      padding:12px 16px; letter-spacing:.3px;
      color:#07101f;
      background: linear-gradient(180deg,#ffffff 0%, #f7f9fc 100%);
      border:1px solid color-mix(in oklab,var(--brand-2),transparent 75%);
      box-shadow:
        0 0 0 1px color-mix(in oklab,#000,transparent 90%),
        0 0 0 6px rgba(6,214,160,.12),
        inset 0 1px 0 #fff,
        0 14px 30px rgba(7,16,31,.08);
    }
    .pill.date{font-weight:1000}

    .viewer{ width:100%; block-size:min(70vh, 100dvh - 280px); border:1px solid var(--border); border-radius:16px; background:#fff; box-shadow:var(--shadow-1); }

    /* ===================  DIRECTORIO: LAYOUT + A-Z (sticky headers que no tapan) =================== */
    .dir-wrap{display:grid;grid-template-columns:1fr min(36px,8vw);gap:12px;align-items:start}
    .az{position:sticky; top:calc(var(--appbar) + 10px); display:grid; grid-template-columns:1fr; gap:4px; align-content:start}
    .az a{display:grid;place-items:center; width:100%; aspect-ratio:1/1; border:1px solid var(--border); border-radius:10px; text-decoration:none; color:#263041; font-weight:900; background:#fff; box-shadow:inset 0 1px 0 #fff}
    .az a:focus-visible{outline-offset:0}
    .section-tag{
      position:sticky; top:calc(var(--appbar) + 8px); z-index:2;
      margin:-12px; margin-bottom:8px; padding:6px 12px;
      font-weight:1000; letter-spacing:.6px; border-radius:12px;
      color:#0b1220; background:linear-gradient(180deg,#fff 0%, #f7f9fc 100%);
      border:1px solid var(--border); box-shadow:var(--shadow-1)
    }
    section[id^="sec-"]{ scroll-margin-top: calc(var(--appbar) + 56px); }

    /* ===================  RESPONSIVE =================== */
    @media (max-width:560px){
      .statusRow{order:4;width:100%}
      #userGroup{order:5;width:100%;justify-content:flex-start}
      #title{font-size:clamp(18px,5vw,22px)}
      .dir-wrap{grid-template-columns:1fr min(30px,8vw)}
      li.item{grid-template-columns:auto 1fr auto}
    }
  </style>
</head>
<body>
  <!-- Gradientes + S√≠mbolos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;pointer-events:none">
    <defs>
      <linearGradient id="grad-mint" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#bff5e3"/><stop offset="1" stop-color="#06D6A0"/></linearGradient>
      <linearGradient id="grad-teal" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#bfe6ef"/><stop offset="1" stop-color="#1B9AAA"/></linearGradient>
      <linearGradient id="grad-coral" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffd0dc"/><stop offset="1" stop-color="#EF476F"/></linearGradient>
      <linearGradient id="grad-gold"  x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffeaa8"/><stop offset="1" stop-color="#FFC43D"/></linearGradient>
      <linearGradient id="grad-indigo"x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#d6dbff"/><stop offset="1" stop-color="#6F7BF7"/></linearGradient>

      <!-- Icono swap restaurado (doble flecha circular) -->
      <symbol id="ico-swap" viewBox="0 0 24 24">
        <path fill="url(#grad-indigo)" d="M7.1 7.5a6 6 0 0 1 10.6-2.4l1.5-1.5v5.8H13l2-2A4 4 0 1 0 7.9 9.7a1 1 0 1 1-0.8 1.8A6 6 0 0 1 7.1 7.5z"/>
        <path fill="url(#grad-teal)" d="M16.9 16.5a6 6 0 0 1-10.6 2.4l-1.5 1.5V14.6H11l-2 2A4 4 0 1 0 16.1 14a1 1 0 1 1 .8-1.8 6 6 0 0 1 0 4.3z"/>
      </symbol>

      <symbol id="ico-stetho" viewBox="0 0 24 24">
        <path fill="url(#grad-mint)" d="M6 2a1 1 0 0 1 1 1v4a3 3 0 0 0 6 0V3a1 1 0 1 1 2 0v4a5 5 0 0 1-10 0V3a1 1 0 0 1 1-1z"/>
        <path fill="url(#grad-teal)" d="M17 10a3 3 0 0 1 3 3v2a5 5 0 0 1-5 5h-2a4 4 0 0 1-4-4v-3a1 1 0 1 1 2 0v3a2 2 0 0 0 2 2h2a3 3 0 0 0 3-3v-2a1 1 0 0 1 1-1z"/>
      </symbol>
      <symbol id="ico-note" viewBox="0 0 24 24">
        <path fill="url(#grad-coral)" d="M5 3h10a1 1 0 0 1 1 1v9l-4 4H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
        <path fill="url(#grad-gold)" d="M16 13v3a1 1 0 0 1-1 1h-3l4-4z"/>
      </symbol>
      <symbol id="ico-phone" viewBox="0 0 24 24">
        <rect x="5" y="3" width="12" height="18" rx="2" fill="url(#grad-teal)"/>
        <circle cx="11" cy="7" r="1" fill="#fff"/>
        <rect x="8" y="10" width="6" height="1.6" rx=".8" fill="#fff"/>
        <rect x="8" y="13" width="6" height="1.6" rx=".8" fill="#fff"/>
      </symbol>
      <symbol id="ico-books" viewBox="0 0 24 24">
        <rect x="2.5" y="5" width="5.5" height="14" rx="1" fill="url(#grad-indigo)"/>
        <rect x="9.5" y="4" width="5.5" height="15" rx="1" fill="url(#grad-gold)"/>
        <rect x="16.5" y="6" width="5" height="13" rx="1" fill="url(#grad-mint)"/>
        <rect x="3.5" y="8.5" width="3.5" height="1.4" rx=".7" fill="#fff" opacity=".9"/>
        <rect x="10.5" y="8.5" width="3.5" height="1.4" rx=".7" fill="#fff" opacity=".9"/>
        <rect x="17.5" y="9" width="2.8" height="1.2" rx=".6" fill="#fff" opacity=".9"/>
      </symbol>
      <symbol id="ico-bell" viewBox="0 0 24 24">
        <path fill="url(#grad-coral)" d="M12 3a5 5 0 0 0-5 5v3.6l-1.6 2.6A1 1 0 0 0 6.3 16h11.4a1 1 0 0 0 .9-1.5L17 11.6V8a5 5 0 0 0-5-5z"/>
        <circle cx="12" cy="19" r="1.8" fill="url(#grad-gold)"/>
      </symbol>
      <symbol id="ico-gear" viewBox="0 0 24 24">
        <path fill="url(#grad-teal)" d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Zm9 3.5a7.9 7.9 0 0 0-.2-1.7l2-1.6-1.9-3.3-2.4 1a8 8 0 0 0-2.8-1.6l-.4-2.6H9.7l-.4 2.6a8 8 0 0 0-2.8 1.6l-2.4-1L2.2 8.7l2 1.6a8 8 0 0 0 0 3.4l-2 1.6 1.9 3.3 2.4-1a8 8 0 0 0 2.8 1.6l.4 2.6h4.6l.4-2.6a8 8 0 0 0 2.8-1.6l2.4 1 1.9-3.3-2-1.6c.1-.5.1-1.1.1-1.7Z"/>
      </symbol>
      <symbol id="ico-star" viewBox="0 0 24 24">
        <path fill="url(#grad-gold)" d="M12 2l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 17.8 6.2 20.9l1.1-6.5L2.6 8.8l6.5-.9L12 2z"/>
      </symbol>
    </defs>
  </svg>

  <header class="appbar" role="banner">
    <div class="container">
      <span class="brand-chip"><span class="brand-dot" aria-hidden="true"></span>INFECCIOSAS</span>

      <!-- Bot√≥n * entre marca y t√≠tulo -->
      <button id="extraToggle" class="btn icon" aria-label="Abrir secci√≥n *" title="Secci√≥n * (personalizable)">
        <svg class="ico" aria-hidden="true"><use href="#ico-star"/></svg>
      </button>

      <h1 id="title">Planta</h1>
      <div class="grow"></div>

      <div class="statusRow" aria-live="polite" style="margin-left:12px">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>

      <div id="userGroup" class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto">
        <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
          <img id="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-1)">
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
          <span id="notifBadge" class="chip" title="Tareas activas">0</span>
        </div>
        <button id="installBtn" class="btn" aria-label="Instalar">‚ûï Instalar</button>
        <button id="signin"  class="btn primary">Acceder</button>
        <button id="signout" class="btn hide">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="updateBanner" class="chip" style="display:none">Nueva versi√≥n disponible. <button id="reloadNow" class="btn primary">Actualizar</button></div>
    <div id="installBanner" class="chip" style="display:none">Instala la app para acceso m√°s r√°pido. <button id="installAction" class="btn primary">Instalar</button></div>

    <!-- Gate -->
    <section id="gate" class="card" role="region" aria-live="polite">
      <div class="card-h hdr-add"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
      <div class="card-b">
        <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
        <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
        <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
      </div>
    </section>

    <!-- App -->
    <section id="app" class="hide" aria-labelledby="tabsLabel">
      <div class="card" style="margin-bottom:12px">
        <div class="card-b">
          <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
          <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
            <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">
              <span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-stetho"/></svg></span>Planta
            </button>
            <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">
              <span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-note"/></svg></span>Tareas
            </button>
            <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">
              <span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-phone"/></svg></span>Directorio
            </button>
            <button id="tab-biblioteca" class="tab" role="tab" aria-selected="false" aria-controls="panel-biblioteca" tabindex="-1">
              <span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-books"/></svg></span>Biblioteca
            </button>
          </div>
        </div>
      </div>

      <!-- ===== PLANTA ===== -->
      <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-add"><h2>A√±adir habitaci√≥n</h2><span class="subtitle">Planta e interconsultas</span></div>
          <div class="card-b grid" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
            <div><label for="p-room">Habitaci√≥n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
            <div><label for="p-desc">Descripci√≥n</label><input id="p-desc" placeholder="Resumen cl√≠nico, motivo‚Ä¶"></div>
            <div style="align-self:end"><button id="p-add" class="btn primary">A√±adir</button></div>
            <div class="g2" style="grid-column:1/-1;display:grid;gap:12px;grid-template-columns:1fr 1fr">
              <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, anal√≠tica‚Ä¶ (opcional)"></div>
              <div>
                <label>Grupo</label>
                <div role="group" aria-label="Grupo" style="display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:inset 0 1px 0 #fff">
                  <button id="p-group-planta" type="button" class="btn" style="min-height:36px;padding:8px 12px;background:#efe9ff;border-color:#d7c8ff">Planta</button>
                  <button id="p-group-inter"  type="button" class="btn" style="min-height:36px;padding:8px 12px;background:#ffedd5;border-color:#fdba74">Interconsulta</button>
                </div>
                <span id="addTarget" class="chip" aria-live="polite" style="margin-left:8px">A√±adiendo a: Planta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-planta"><h2>Planta</h2><span id="p-count-planta" class="chip">0</span></div>
          <div class="card-b">
            <ul id="p-list-planta" class="list"></ul>
            <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-inter"><h2>Interconsultas</h2><span id="p-count-inter" class="chip">0</span></div>
          <div class="card-b">
            <ul id="p-list-inter" class="list"></ul>
            <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-green"><h2>Completados</h2><span id="p-done-count" class="chip">0</span></div>
          <div class="card-b">
            <ul id="p-done" class="list"></ul>
            <p id="p-done-empty" class="muted">Nada completado.</p>
          </div>
        </div>
      </div>

      <!-- ===== TAREAS ===== -->
      <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-tareas"><h2>A√±adir tarea</h2><span class="subtitle" id="t-status">Fecha ‚Üí Descripci√≥n</span></div>
          <div class="card-b">
            <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
              <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
              <div><label for="t-text">Descripci√≥n</label><input id="t-text" type="text" placeholder="Describe la tarea‚Ä¶" maxlength="400"></div>
              <div style="align-self:end"><button id="t-add" class="btn primary">A√±adir</button></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-tareas"><h2>Tareas activas</h2><span id="t-count" class="chip">0</span></div>
          <div class="card-b">
            <ul id="t-list" class="list"></ul>
            <p id="t-empty" class="muted">No hay tareas activas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-green"><h2>Completadas</h2><span id="t-done-count" class="chip">0</span></div>
          <div class="card-b">
            <ul id="t-done" class="list"></ul>
            <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-inter"><h2>Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
          <div class="card-b">
            <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
            <ul id="t-trash" class="list"></ul>
            <p id="t-trash-empty" class="muted">Papelera vac√≠a.</p>
          </div>
        </div>
      </div>

      <!-- ===== DIRECTORIO ===== -->
      <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-dir"><h2>Directorio telef√≥nico</h2><span id="d-count" class="chip">0</span></div>
          <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr auto">
            <div><label for="d-q">B√∫squeda inteligente</label><input id="d-q" type="search" placeholder="Secci√≥n, nombre o extensi√≥n‚Ä¶"></div>
            <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap; gap:6px">
              <button id="d-add" class="btn primary">A√±adir</button>
              <button id="d-import" class="btn">Importar JSON</button>
              <button id="d-export" class="btn">Exportar JSON</button>
              <button id="d-dedupe" class="btn">Eliminar duplicados</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-b dir-wrap">
            <div>
              <div id="d-list-wrap"></div>
              <p id="d-empty" class="muted">Sin registros.</p>
            </div>
            <nav class="az" aria-label="√çndice alfab√©tico" id="d-az"></nav>
          </div>
        </div>
      </div>

      <!-- ===== BIBLIOTECA ===== -->
      <div id="panel-biblioteca" class="hide" role="tabpanel" aria-labelledby="tab-biblioteca" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-biblio"><h2>Biblioteca</h2><span class="subtitle">Campo libre + enlaces + visor PDF</span></div>
          <div class="card-b" style="display:grid;gap:12px;grid-template-columns:2fr 1fr">
            <div>
              <label for="b-notes">Notas r√°pidas</label>
              <textarea id="b-notes" placeholder="Pega aqu√≠ fragmentos o URLs. Se guardan en tu usuario."></textarea>
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="b-notes-save" class="btn primary">Guardar notas</button>
                <button id="b-open-file" class="btn">Abrir PDF local‚Ä¶</button>
                <button id="b-clear-view" class="btn">Vaciar visor</button>
              </div>
            </div>

            <div>
              <label for="b-url">Nuevo enlace (PDF o web)</label>
              <input id="b-url" type="url" placeholder="https://‚Ä¶ o *.pdf">
              <label for="b-title">T√≠tulo</label>
              <input id="b-title" type="text" placeholder="Nombre del recurso">
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="b-add-link" class="btn primary">A√±adir a lista</button>
                <button id="b-export-links" class="btn">Exportar JSON</button>
                <button id="b-import-links" class="btn">Importar JSON</button>
              </div>

              <div style="margin-top:10px">
                <label for="b-select">Mis enlaces</label>
                <select id="b-select"></select>
                <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                  <button id="b-open" class="btn">Abrir en visor</button>
                  <button id="b-remove" class="btn">Eliminar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h hdr-biblio"><h2>Visor</h2><span class="subtitle">Detecta PDF y lo muestra integrado</span></div>
          <div class="card-b">
            <iframe id="b-viewer" class="viewer" title="Visor de documentos" sandbox="allow-same-origin allow-downloads"></iframe>
            <p class="muted" style="margin-top:8px">Consejo: para PDFs externos con restricciones CORS, usa ‚ÄúAbrir PDF local‚Ä¶‚Äù.</p>
          </div>
        </div>
      </div>

      <!-- ===== SECCI√ìN * (EXTRA) ===== -->
      <div id="panel-extra" class="hide" role="region" aria-labelledby="lbl-extra" tabindex="-1">
        <div class="card">
          <div class="card-h hdr-extra"><h2 id="lbl-extra">*</h2><span class="subtitle">Espacio personalizable</span></div>
          <div class="card-b" style="display:grid;gap:12px;grid-template-columns:2fr 1fr">
            <div>
              <label for="x-notes">Lienzo libre</label>
              <textarea id="x-notes" placeholder="Texto libre, snippets, recordatorios‚Ä¶"></textarea>
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="x-notes-save" class="btn primary">Guardar lienzo</button>
                <button id="x-clear" class="btn">Vaciar</button>
              </div>
            </div>
            <div>
              <label>Accesos r√°pidos (widgets)</label>
              <div id="x-widgets"></div>
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="x-edit" class="btn">Editar widgets</button>
                <button id="x-reset" class="btn">Restaurar</button>
              </div>
              <p class="muted" style="margin-top:6px">Formato por l√≠nea: <code>Etiqueta | URL o tel</code></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs inferiores -->
      <nav class="bottom" aria-label="Secciones">
        <div class="tabs-bottom">
          <button class="tab-bottom" id="b-planta" aria-selected="true"><span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-stetho"/></svg></span>Planta</button>
          <button class="tab-bottom" id="b-tareas" aria-selected="false"><span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-note"/></svg></span>Tareas</button>
          <button class="tab-bottom" id="b-directorio" aria-selected="false"><span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-phone"/></svg></span>Directorio</button>
          <button class="tab-bottom" id="b-biblioteca" aria-selected="false"><span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-books"/></svg></span>Biblioteca</button>
        </div>
      </nav>
    </section>
  </main>

  <!-- FAB emergencias -->
  <button id="fab" class="btn primary" style="position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom) + 84px);z-index:70;border-radius:999px;padding:14px 16px;display:flex;align-items:center;gap:10px">
    <span class="ico-wrap" aria-hidden="true"><svg class="ico"><use href="#ico-bell"/></svg></span>Emergencias
  </button>
  <div id="fabPanel" class="card" style="position:fixed;right:16px;bottom:calc(80px + env(safe-area-inset-bottom) + 84px);z-index:69;width:min(420px,92vw);display:none">
    <div class="card-b">
      <div class="toolbar" style="display:flex;align-items:center;gap:8px">
        <strong>Accesos r√°pidos</strong>
        <button id="fabEdit" class="btn icon" title="Configurar"><svg class="ico"><use href="#ico-gear"/></svg></button>
      </div>
      <div id="fabList" style="margin-top:8px"></div>
    </div>
  </div>

  <div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    /* ===================  HELPERS B√ÅSICOS  =================== */
    const BASE = new URL('./', location).pathname;
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const idle = (fn)=>('requestIdleCallback' in window)? requestIdleCallback(fn,{timeout:120}) : setTimeout(fn,0);
    const esc = (s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.hidden=false; setTimeout(()=>t.hidden=true,2200); };
    const todayISO = ()=> new Date().toISOString().slice(0,10);

    /* Ajuste 100dvh real en Android */
    const setVH=()=>{ document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px'); };
    setVH(); addEventListener('resize', setVH, {passive:true});

    /* Online badge */
    const setOnline=(on)=>{ const b=$('#badge-online'); b.textContent=on?'Online':'Offline'; b.className='chip '+(on?'ok':'bad'); };
    setOnline(navigator.onLine);
    addEventListener('online', ()=>setOnline(true), {passive:true});
    addEventListener('offline',()=>setOnline(false), {passive:true});

    /* ===================  FIREBASE  =================== */
    const appMod   = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    const authMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
    const fsMod    = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
    const { firebaseConfig } = await import(BASE + 'firebase-config.js');

    const fbApp = appMod.initializeApp(firebaseConfig);
    const auth  = authMod.getAuth(fbApp);
    const db    = fsMod.initializeFirestore(fbApp, {
      localCache: fsMod.persistentLocalCache({ tabManager: fsMod.persistentMultipleTabManager() })
    });
    const serverTS = fsMod.serverTimestamp;

    /* ===================  AUTENTICACI√ìN  =================== */
    const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
    const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();
    const doSignIn=async()=>{ try{
      if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider);
      else await authMod.signInWithPopup(auth,provider);
    }catch(e){ $('#authErr').textContent=e.message||String(e); } };
    $('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

    authMod.onAuthStateChanged(auth, user=>{
      if(user){
        badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
        avatar.src=user.photoURL||''; displayname.textContent=user.displayName||user.email||''; userchip.classList.remove('hide');
        $('#signout').classList.remove('hide'); $('#signin').classList.add('hide'); gate.classList.add('hide'); appUI.classList.remove('hide');
        mountApp(user.uid);
      }else{
        badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
        userchip.classList.add('hide'); $('#signout').classList.add('hide'); $('#signin').classList.remove('hide'); appUI.classList.add('hide'); gate.classList.remove('hide');
        unmountApp();
      }
    });

    /* ===================  COLECCIONES + COLAS DE REINTENTO  =================== */
    const col = {
      planta  : (uid)=> fsMod.collection(db,'users',uid,'planta'),
      tareas  : (uid)=> fsMod.collection(db,'users',uid,'tareas'),
      dir     : (uid)=> fsMod.collection(db,'users',uid,'directorio'),
      biblio  : (uid)=> fsMod.collection(db,'users',uid,'biblioteca'),
      notes   : (uid)=> fsMod.doc(db,'users',uid,'biblioteca','__notes__'),
      settings: (uid)=> fsMod.doc(db,'users',uid,'__meta__','settings'),
      extra   : (uid)=> fsMod.doc(db,'users',uid,'__meta__','extra'),
    };

    let unsubs=[]; const currentUid=()=>auth.currentUser?.uid;
    function unmountApp(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

    // Cola local simple para reintentos de escrituras en offline
    const RETRY_KEY='aurora.retry.queue';
    function pushRetry(job){ try{ const q=JSON.parse(localStorage.getItem(RETRY_KEY)||'[]'); q.push(job); localStorage.setItem(RETRY_KEY,JSON.stringify(q)); }catch{} }
    async function flushRetry(){ try{ const q=JSON.parse(localStorage.getItem(RETRY_KEY)||'[]'); if(!q.length) return; const ok=[]; for(const j of q){ try{ const ref=fsMod.doc(db,j.path); await fsMod.setDoc(ref,j.data,{merge:true}); ok.push(j); }catch{} } if(ok.length){ const rest=q.filter(x=>!ok.includes(x)); localStorage.setItem(RETRY_KEY,JSON.stringify(rest)); } }catch{} }
    addEventListener('online', flushRetry, {passive:true});

    /* ===================  TABS (robustas + teclado + hash) =================== */
    const mapTabs={
      planta:['panel-planta','tab-planta','b-planta','Planta'],
      tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],
      directorio:['panel-directorio','tab-directorio','b-directorio','Directorio'],
      biblioteca:['panel-biblioteca','tab-biblioteca','b-biblioteca','Biblioteca'],
      extra:['panel-extra',null,null,'*'] // secci√≥n independiente
    };

    function selectTab(id){
      for(const k in mapTabs){
        const [p,t,b,l]=mapTabs[k]; const sel=(k===id);
        const panel=document.getElementById(p); if(panel) panel.classList.toggle('hide',!sel);
        if(t){ const tb=document.getElementById(t); if(tb){ tb.setAttribute('aria-selected',sel); tb.tabIndex=sel?0:-1; } }
        if(b){ const bb=document.getElementById(b); if(bb) bb.setAttribute('aria-selected',sel); }
        if(sel) document.getElementById('title').textContent=l;
      }
      localStorage.setItem('tab', id);
      if(id!=='extra') location.hash = id; else history.replaceState(null,'', '#*');
    }

    // Clicks superiores/inferiores
    $('#tab-planta').onclick =()=>selectTab('planta');
    $('#tab-tareas').onclick =()=>selectTab('tareas');
    $('#tab-directorio').onclick=()=>selectTab('directorio');
    $('#tab-biblioteca').onclick=()=>selectTab('biblioteca');
    $('#b-planta').onclick =()=>selectTab('planta');
    $('#b-tareas').onclick =()=>selectTab('tareas');
    $('#b-directorio').onclick=()=>selectTab('directorio');
    $('#b-biblioteca').onclick=()=>selectTab('biblioteca');

    // Teclado en tablist (izq/der + Home/End)
    const order=['tab-planta','tab-tareas','tab-directorio','tab-biblioteca'];
    $('#tablist').addEventListener('keydown', (e)=>{
      const i=order.indexOf(document.activeElement?.id);
      if(i<0) return;
      let j=i;
      if(e.key==='ArrowRight') j=(i+1)%order.length;
      else if(e.key==='ArrowLeft') j=(i-1+order.length)%order.length;
      else if(e.key==='Home') j=0;
      else if(e.key==='End') j=order.length-1;
      else if(e.key==='Enter' || e.key===' ') { document.activeElement.click(); return; }
      else return;
      e.preventDefault();
      const btn=document.getElementById(order[j]);
      btn?.focus(); btn?.click();
    });

    // Hashchange resiliente
    addEventListener('hashchange', ()=>{
      const h=location.hash.slice(1);
      if(mapTabs[h]) selectTab(h);
      else if(h==='*') selectTab('extra');
    }, {passive:true});

    // Bot√≥n * en appbar
    document.getElementById('extraToggle').onclick=()=>selectTab('extra');

    /* ===================  HELPERS COMUNES  =================== */
    const btn = (t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.onclick=(e)=>{e.preventDefault(); fn?.(e)}; b.type='button'; return b;};
    const val=(id)=>document.getElementById(id)?.value||'';
    function roomSortKey(s){ if(!s) return 1e9; const m=String(s).match(/\d+/g); if(!m) return 1e9; const a=parseInt(m[0],10); const b=m[1]?parseInt(m[1],10)/100:0; return a+b; }
    async function upd(kind,id,patch){ const ref=fsMod.doc(db,'users',auth.currentUser?.uid,kind,id); const data={...patch,updatedAt:serverTS()}; try{ await fsMod.updateDoc(ref,data); }catch{ pushRetry({path:ref.path,data}); toast('Se guardar√° al recuperar conexi√≥n'); } }
    async function del(kind,id){ const ref=fsMod.doc(db,'users',auth.currentUser?.uid,kind,id); try{ await fsMod.deleteDoc(ref); }catch{ pushRetry({path:ref.path,data:{__delete__:true}}); toast('Se eliminar√° cuando haya conexi√≥n'); } }

    /* ===================  PLANTA =================== */
    let currentGroup='planta';
    const updateAddTarget=()=>$('#addTarget').textContent = currentGroup==='planta'?'A√±adiendo a: Planta':'A√±adiendo a: Interconsulta';
    $('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget();};
    $('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget();};

    const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(), grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
    const docItemBase=(x,done=false)=>{ const li=document.createElement('li'); li.className='item'; li.innerHTML=`<span class="pill room">${esc(x.room||'‚Äî')}</span>
      <div class="text">${done?`<div class="line strike">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
      ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
      <div class="toolbar actions"></div>`; return li; };
    const renderPlantaItem=(x)=>{ const li=docItemBase(x); const a=li.querySelector('.actions');
      a.append(
        btn('‚úì',()=>upd('planta',x.__id,{status:'done'}),'btn icon'),
        btn('‚úé',()=>editPlanta(x),'btn icon')
      );
      const swap=btn('',async()=>{const next=(x.grupo==='interconsulta')?'planta':'interconsulta'; await upd('planta',x.__id,{grupo:next});},'btn icon');
      swap.innerHTML=`<svg class="ico" aria-hidden="true"><use href="#ico-swap"/></svg>`;
      a.append(swap, btn('üóëÔ∏è',()=>upd('planta',x.__id,{status:'trash'}),'btn icon'));
      return li;
    };
    const renderPlantaDone=(x)=>{const li=docItemBase(x,true); const a=li.querySelector('.actions'); a.append(btn('‚Ü©',()=>upd('planta',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('planta',x.__id),'btn icon')); return li;};
    const editPlanta=(x)=>openEdit([{l:'Habitaci√≥n',id:'p_room',v:x.room||''},{l:'Descripci√≥n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}], async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')}));

    function setupPlanta(uid){
      $('#p-add').onclick=async()=>{ const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup}); if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(i=>document.getElementById(i).value=''); };
      const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
      const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));
      const u1=fsMod.onSnapshot(qA,(s)=>{ const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x)});
        const arrP=all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
        const arrI=all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
        const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
        arrP.forEach(x=>lp.appendChild(renderPlantaItem(x))); arrI.forEach(x=>li.appendChild(renderPlantaItem(x)));
        $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
        $('#p-count-planta').textContent=arrP.length; $('#p-count-inter').textContent=arrI.length; });
      const u2=fsMod.onSnapshot(qD,(s)=>{ const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x)}); arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(renderPlantaDone(x))); $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=arr.length; });
      unsubs.push(u1,u2);
    }

    /* ===================  TAREAS =================== */
    const tareaDoc = (d)=>({ date:d.date||todayISO(), text:(d.text||'').trim(), status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
    function daysFromToday(iso){ try{ const d=new Date(iso+'T00:00:00'); const t=new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24)); }catch{return 0} }
    const pillForDate=(iso)=>{ try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,''); }catch{return iso} };
    function renderTareaItem(x){
      const li=document.createElement('li'); li.className='item';
      const diff = daysFromToday(x.date);
      const h = isNaN(diff)?205:(diff<=-7?0:(diff<0?10:Math.round(10+(Math.min(diff,30)/30)*120))); /* rojo‚Üíverde progresivo */
      li.style.borderLeft=`6px solid hsl(${h} 72% 46%)`;
      li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span><div class="text"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
      li.querySelector('.actions').append(
        btn('‚úì',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'),
        btn('‚úé',()=>editTarea(x),'btn icon'),
        btn('üóëÔ∏è',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon')
      );
      return li;
    }
    function renderTareaDone(x){
      const li=document.createElement('li'); li.className='item';
      li.style.borderLeft=`6px solid hsl(150 50% 38%)`;
      li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span><div class="text"><div class="line strike">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
      li.querySelector('.actions').append(btn('‚Ü©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
      return li;
    }
    function renderTareaTrash(x){
      const li=document.createElement('li'); li.className='item';
      li.innerHTML=`<span class="pill date">${pillForDate(x.date)}</span><div class="text muted"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
      li.querySelector('.actions').append(btn('‚§¥',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon'));
      return li;
    }
    const editTarea=(x)=>openEdit([{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'Descripci√≥n',id:'t_text',v:x.text||''}], async()=>upd('tareas',x.__id,{date:val('t_date'),text:val('t_text')}));

    function setupTareas(uid){
      $('#t-date').value=todayISO();
      $('#t-add').onclick=async ()=>{ const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return; await fsMod.addDoc(col.tareas(uid), tareaDoc({date,text})); $('#t-text').value=''; };
      const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
      const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
      const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));
      const u1=fsMod.onSnapshot(qA,(snap)=>{ const arr=[]; snap.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> daysFromToday(a.date)-daysFromToday(b.date) || (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0) );
        const list=$('#t-list'); list.innerHTML=''; let n=0; idle(()=>{arr.forEach(x=>{list.appendChild(renderTareaItem(x)); n++;}); $('#t-count').textContent=n; $('#t-empty').style.display=n?'none':'block'; setNotif(n);}); });
      const u2=fsMod.onSnapshot(qD,(s)=>{ const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
        const l=$('#t-done'); l.innerHTML=''; let n=0; idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaDone(x)); n++;}); $('#t-done-empty').style.display=n?'none':'block'; $('#t-done-count').textContent=n;}); });
      const u3=fsMod.onSnapshot(qT,(s)=>{ const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
        arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0) );
        const l=$('#t-trash'); l.innerHTML=''; let n=0; idle(()=>{arr.forEach(x=>{l.appendChild(renderTareaTrash(x)); n++;}); $('#t-trash-empty').style.display=n?'none':'block'; $('#t-trash-count').textContent=n;}); });
      $('#t-emptyTrash').onclick=()=>emptyTrash(uid,'tareas'); unsubs.push(u1,u2,u3);
    }
    async function emptyTrash(uid,kind){ const q=fsMod.query(fsMod.collection(db,'users',uid,kind),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada'); }
    const setNotif = (n)=>{ const el=document.getElementById('notifBadge'); el.textContent=String(n); el.title=n?`${n} tareas activas`:'Sin avisos'; };

    /* ===================  DIRECTORIO (A-Z + b√∫squeda acento-insensible) =================== */
    const dirDoc=(d)=>({ seccion:String(d.seccion||'').trim()||'Sin secci√≥n', nombre:String(d.nombre||'').trim()||'Sin nombre', telefono:String(d.telefono||'').trim(), notas:String(d.notas||'').trim(), createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
    let dirCache=[];
    const telHref=(raw)=>{ const s=String(raw||'').replace(/[^\d+]/g,''); return s?`tel:${s}`:null; }
    const norm = (s)=> String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');

    function setupDirectorio(uid){
      $('#d-add').onclick=async()=>{ const d=dirDoc({seccion:prompt('Secci√≥n')||'',nombre:prompt('Nombre')||'',telefono:prompt('Tel√©fonos (formato libre)')||'',notas:''}); await fsMod.addDoc(col.dir(uid),d); };
      $('#d-import').onclick=importDir(uid); $('#d-export').onclick=exportDir(uid);
      document.getElementById('d-dedupe').onclick=()=>dedupeDir(uid);

      const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{ dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderDirList(); });
      $('#d-q').addEventListener('input', renderDirList, {passive:true});
      unsubs.push(u);
    }

    function phonesToChips(raw){
      const parts = String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
      return parts.map(p=>{ const href = telHref(p); return href?`<a class="pill" href="${href}" dir="ltr">${esc(p)}</a>`:`<span class="pill" dir="ltr">${esc(p)}</span>`; }).join(' ');
    }

    function renderDirList(){
      const v=norm($('#d-q')?.value||'');
      const wrap = $('#d-list-wrap'); if(!wrap) return; wrap.innerHTML='';
      let arr=[...dirCache];

      // Orden por nombre, fallback secci√≥n
      arr.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'') || (a.seccion||'').localeCompare(b.seccion||''));

      // Filtrado
      const filtered = v? arr.filter(x=> [x.seccion,x.nombre,String(x.telefono||''),x.notas].some(y=>norm(y).includes(v)) ) : arr;

      // Agrupar por primera letra (A-Z, #)
      const groups = new Map();
      for(const x of filtered){
        const k = /^[A-Za-z√Å√â√ç√ì√ö√ú√ë]/.test(x.nombre||'') ? norm(x.nombre)[0].toUpperCase() : '#';
        if(!groups.has(k)) groups.set(k,[]);
        groups.get(k).push(x);
      }

      // A-Z sidebar
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');
      const az = $('#d-az'); az.innerHTML = letters.map(ch=>`<a href="#sec-${ch}" aria-label="Ir a ${ch}">${ch}</a>`).join('');

      // Render grupos
      let total=0;
      for(const ch of letters){
        const list = groups.get(ch)||[]; if(!list.length) continue; total+=list.length;
        const sec = document.createElement('section'); sec.id = `sec-${ch}`; sec.setAttribute('aria-labelledby',`lbl-${ch}`);
        const header = document.createElement('div'); header.className='section-tag'; header.id=`lbl-${ch}`; header.textContent = ch; sec.appendChild(header);
        const ul = document.createElement('ul'); ul.className='list';
        list.forEach(x=>{
          const li=document.createElement('li'); li.className='item';
          li.innerHTML=`<div class="text"><div class="line"><strong>${esc(x.nombre||'')}</strong> ‚Äî ${esc(x.seccion||'')}</div><div class="line">${phonesToChips(x.telefono)}</div>${x.notas?`<div class="muted">${esc(x.notas)}</div>`:''}</div><div class="toolbar actions"></div>`;
          li.querySelector('.actions').append(btn('‚úé',()=>editDir(x),'btn icon'),btn('üóëÔ∏è',()=>del('directorio',x.__id),'btn icon'));
          ul.appendChild(li);
        });
        sec.appendChild(ul); wrap.appendChild(sec);
      }
      $('#d-count').textContent = total+" registros";
      $('#d-empty').style.display = total? 'none':'block';
    }

    const editDir=(x)=>openEdit([
      {l:'Secci√≥n',id:'d_sec',v:x.seccion||''},
      {l:'Nombre',id:'d_nom',v:x.nombre||''},
      {l:'Tel√©fonos',id:'d_tel',v:x.telefono||''},
      {l:'Notas',id:'d_not',v:x.notas||''}
    ], async()=>upd('directorio',x.__id,{seccion:val('d_sec'),nombre:val('d_nom'),telefono:val('d_tel'),notas:val('d_not')}));

    function importDir(uid){return async()=>{try{
      const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido');
      const snap=await fsMod.getDocs(col.dir(uid)); const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase();
      const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[];
      for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); }
      await Promise.all(ops); toast('Importado ('+ops.length+')');
    }catch(e){ toast(e.message||String(e)); }};

    }
    function exportDir(uid){return async()=>{const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado'); }};

    const normTel = (s)=> String(s||'').replace(/[^\d+]/g,'');
    const keyDir  = (o)=> (String(o.nombre||'').trim().toLowerCase().replace(/\s+/g,' '))+'|'+normTel(o.telefono);
    async function dedupeDir(uid){
      const snap = await fsMod.getDocs(fsMod.query(col.dir(uid)));
      const seen = new Set(); const dupRefs=[];
      for(const d of snap.docs){ const k=keyDir(d.data()); if(seen.has(k)) dupRefs.push(d.ref); else seen.add(k); }
      if(!dupRefs.length){ toast('No se han encontrado duplicados'); return; }
      await Promise.all(dupRefs.map(r=>fsMod.deleteDoc(r))); toast(`Eliminados ${dupRefs.length} duplicados`);
    }

    /* ===================  BIBLIOTECA =================== */
    const bDoc=(d)=>({ title:String(d.title||'').trim()||'Sin t√≠tulo', url:String(d.url||'').trim(), createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
    let bCache=[]; let localObjectURL=null;
    function setViewer(src){ const iframe=$('#b-viewer'); if(!src){ iframe.removeAttribute('src'); return; } iframe.src=src; }
    function clearLocalURL(){ if(localObjectURL){ URL.revokeObjectURL(localObjectURL); localObjectURL=null; } }
    function renderBiblioSelect(){ const sel=$('#b-select'); sel.innerHTML=''; bCache.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); bCache.forEach(x=>{ const o=document.createElement('option'); o.value=x.__id; o.textContent=x.title; sel.appendChild(o); }); }
    function setupBiblioteca(uid){
      fsMod.getDoc(col.notes(uid)).then(s=>{ const data=s.exists()?s.data():{text:''}; $('#b-notes').value=String(data.text||''); });
      $('#b-notes-save').onclick=async()=>{ const ref=col.notes(uid); const data={text:$('#b-notes').value, updatedAt:serverTS()}; try{ await fsMod.setDoc(ref,data,{merge:true}); }catch{ pushRetry({path:ref.path,data}); } toast('Notas guardadas'); };
      $('#b-add-link').onclick=async()=>{ const url=$('#b-url').value.trim(); const title=$('#b-title').value.trim(); if(!url) return; await fsMod.addDoc(col.biblio(uid), bDoc({url,title})); $('#b-url').value=''; $('#b-title').value=''; };
      $('#b-open').onclick=async()=>{ const id=$('#b-select').value; const item=bCache.find(x=>x.__id===id); if(!item) return; clearLocalURL(); setViewer(item.url); };
      $('#b-remove').onclick=async()=>{ const id=$('#b-select').value; if(!id) return; await fsMod.deleteDoc(fsMod.doc(db,'users',uid,'biblioteca',id)); };
      $('#b-open-file').onclick=async()=>{ try{ const [h]=await showOpenFilePicker({types:[{description:'PDF',accept:{'application/pdf':['.pdf']}}]}); const f=await h.getFile(); clearLocalURL(); localObjectURL=URL.createObjectURL(f); setViewer(localObjectURL); }catch{} };
      $('#b-clear-view').onclick=()=>{ clearLocalURL(); setViewer(null); };
      $('#b-export-links').onclick=async()=>{ const snap=await fsMod.getDocs(fsMod.query(col.biblio(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'biblioteca-links-'+todayISO()+'.json'); toast('Exportado'); };
      $('#b-import-links').onclick=async()=>{ try{ const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido'); const snap=await fsMod.getDocs(col.biblio(uid)); const key=o=>(String(o.title||'').trim()+'|'+String(o.url||'').trim()).toLowerCase(); const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[]; for(const o of arr){ const k=key(o); if(!set.has(k)) ops.push(fsMod.addDoc(col.biblio(uid), bDoc(o))); } await Promise.all(ops); toast('Importado ('+ops.length+')'); }catch(e){ toast(e.message||String(e)); } };
      const u=fsMod.onSnapshot(fsMod.query(col.biblio(uid)),(s)=>{ bCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; bCache.push(x);}); renderBiblioSelect(); }); unsubs.push(u);
    }

    /* ===================  SECCI√ìN * =================== */
    let xWidgets = [];
    function renderXWidgets(){
      const box = $('#x-widgets'); if(!box) return;
      box.innerHTML = xWidgets.length
        ? xWidgets.map((w,i)=>`<div class="item" style="display:flex;align-items:center;gap:10px"><span class="pill">${esc(w.label||'')}</span>${w.href?`<a class="pill" href="${esc(w.href)}" target="_blank" rel="noopener">${esc(w.href)}</a>`:''}<button class="btn icon" data-i="${i}">‚úñ</button></div>`).join('')
        : '<p class="muted">Sin widgets. Pulsa ‚ÄúEditar widgets‚Äù.</p>';
      box.querySelectorAll('button[data-i]').forEach(b=>{
        b.onclick=async()=>{ const i=+b.dataset.i; xWidgets.splice(i,1); await fsMod.setDoc(col.extra(currentUid()), { widgets:xWidgets }, { merge:true }); renderXWidgets(); };
      });
    }
    async function loadExtra(uid){
      try{
        const s = await fsMod.getDoc(col.extra(uid));
        const data = s.exists() ? s.data() : {};
        $('#x-notes').value = String(data.notes||'');
        xWidgets = Array.isArray(data.widgets)? data.widgets : [];
        renderXWidgets();
      }catch{ $('#x-notes').value=''; xWidgets=[]; renderXWidgets(); }
    }
    $('#x-notes-save').onclick=async()=>{ const ref=col.extra(currentUid()); const data={notes:$('#x-notes').value, updatedAt:serverTS()}; try{ await fsMod.setDoc(ref,data,{merge:true}); }catch{ pushRetry({path:ref.path,data}); } toast('Lienzo guardado'); };
    $('#x-clear').onclick=()=>{ $('#x-notes').value=''; };
    $('#x-edit').onclick=async()=>{
      const seed = xWidgets.map(w=>(w.label||'')+' | '+(w.href||'')).join('\n') || 'Consultas | tel:3333\nUCI | tel:4444\nManual | https://‚Ä¶';
      const txt = prompt('Una l√≠nea por widget:\nEtiqueta | URL o tel', seed);
      if(txt==null) return;
      const arr = txt.split('\n').map(s=>s.trim()).filter(Boolean).map(line=>{ const [label, href=''] = line.split('|').map(x=>x?.trim()||''); return {label, href}; });
      xWidgets = arr;
      await fsMod.setDoc(col.extra(currentUid()), { widgets:xWidgets }, { merge:true });
      renderXWidgets();
    };
    $('#x-reset').onclick=async()=>{
      xWidgets = [{label:'Consultas',href:'tel:3333'},{label:'UCI',href:'tel:4444'}];
      await fsMod.setDoc(col.extra(currentUid()), { widgets:xWidgets }, { merge:true });
      renderXWidgets();
    };

    /* ===================  MODAL SIMPLE =================== */
    const openEdit=(fields,onOk)=>{ const body=document.createElement('div'); body.style.display='grid'; body.style.gap='8px'; body.style.gridTemplateColumns='1fr';
      const dlg=document.createElement('dialog'); dlg.style.padding='16px'; dlg.style.border='1px solid var(--border)'; dlg.style.borderRadius='14px'; dlg.style.boxShadow='var(--shadow-2)';
      const h=document.createElement('h3'); h.textContent='Editar'; h.style.margin='0 0 8px 0'; dlg.appendChild(h);
      fields.forEach(f=>{ const w=document.createElement('div'); w.innerHTML=`<label for="${f.id}" style="display:block;font-size:12px;color:#777">${f.l}</label><input id="${f.id}" value="${esc(f.v||'')}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px">`; body.append(w); });
      dlg.appendChild(body);
      const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.justifyContent='flex-end'; row.style.marginTop='12px';
      const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Cancelar'; b1.onclick=()=>dlg.close();
      const b2=document.createElement('button'); b2.className='btn primary'; b2.textContent='Guardar'; b2.onclick=async()=>{ await onOk(); dlg.close(); };
      row.append(b1,b2); dlg.appendChild(row); document.body.appendChild(dlg); dlg.showModal(); dlg.addEventListener('close',()=>dlg.remove(),{once:true});
    };

    /* ===================  FILE PICK HELPERS =================== */
    async function pickReadText(){ if('showOpenFilePicker' in window){ const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const f=await h.getFile(); return await f.text(); } return await new Promise((res,rej)=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); }; i.click(); }); }
    async function pickWriteBlob(blob,name){ if('showSaveFilePicker' in window){ const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const w=await h.createWritable(); await w.write(blob); await w.close(); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

    /* ===================  PWA =================== */
    let deferredPrompt=null;
    addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').style.display='inline-flex';});
    $('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').style.display='none'; } };
    $('#installBtn').onclick=()=>$('#installAction').click();
    if('serviceWorker' in navigator){
      const reg=await navigator.serviceWorker.register(BASE+'sw.js');
      navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
      const showUpdate=()=>{$('#updateBanner').style.display='inline-flex'; $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'});};
      if(reg.waiting) showUpdate();
      reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
    }

    /* ===================  FAB EMERGENCIAS =================== */
    let emergency = [];
    function renderEmergency(){
      const box = document.getElementById('fabList');
      box.innerHTML = emergency.length
        ? emergency.map((e,i)=>`<div class="contact-chip" style="display:flex;align-items:center;gap:10px;margin:6px 0"><strong>${esc(e.name||'')}</strong><a class="pill" href="tel:${(e.tel||'').replace(/[^\d+]/g,'')}" dir="ltr">${esc(e.tel||'')}</a><button class="btn icon" title="Eliminar" data-i="${i}">‚úñ</button></div>`).join('')
        : '<p class="muted">A√±ade accesos r√°pidos con el engranaje.</p>';
      box.querySelectorAll('button[data-i]').forEach(b=>{
        b.onclick = async ()=>{
          const idx = +b.dataset.i; emergency.splice(idx,1);
          await fsMod.setDoc(col.settings(currentUid()), { emergency }, { merge:true });
          renderEmergency();
        };
      });
    }
    async function loadEmergency(uid){ try{ const s = await fsMod.getDoc(col.settings(uid)); emergency = (s.exists() && Array.isArray(s.data().emergency)) ? s.data().emergency : []; }catch{ emergency=[]; } renderEmergency(); }
    async function editEmergency(){ const txt = prompt('Introduce l√≠neas en formato: Nombre | Tel√©fono\nEjemplo:\nParada | 3333\nUCI | 4444', emergency.map(e=>`${e.name||''} | ${e.tel||''}`).join('\n')); if(txt==null) return; const arr = txt.split('\n').map(x=>x.trim()).filter(Boolean).map(line=>{ const [name, tel=''] = line.split('|').map(s=>s?.trim()||''); return {name, tel}; }).filter(x=>x.name || x.tel); emergency = arr; await fsMod.setDoc(col.settings(currentUid()), { emergency }, { merge:true }); renderEmergency(); }
    document.getElementById('fab').onclick = ()=>{ const p = document.getElementById('fabPanel'); const open = p.style.display!=='block'; p.style.display = open ? 'block' : 'none'; document.getElementById('fab').setAttribute('aria-expanded', String(open)); };
    document.getElementById('fabEdit').onclick = editEmergency;

    /* ===================  MONTAJE =================== */
    function mountApp(uid){
      setupPlanta(uid); setupTareas(uid); setupDirectorio(uid); setupBiblioteca(uid); loadEmergency(uid); loadExtra(uid);
      const first = location.hash?.slice(1);
      if(first==='*') selectTab('extra');
      else if(mapTabs[first]) selectTab(first);
      else selectTab(localStorage.getItem('tab') || 'planta');
      flushRetry();
    }
  </script>
</body>
</html>
