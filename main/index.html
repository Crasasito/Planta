<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#ffffff"/>
<title>Aurora UI — Infecciosas 2.0 (v3.4)</title>
<link rel="manifest" href="manifest.webmanifest"/>
<link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<style>
/* ===== AJUSTES SOLICITADOS ==========================
   - Mantener estructura y colores de secciones
   - Descripciones completas (sin truncado)
   - Directorio sin solapes, encabezado por letra con glow
   - Barra A–Z premium a la derecha
   - Iconos inferiores premium (fonendo, reloj de arena, teléfono, libros)
   - Máxima visibilidad en Android + compatibilidad PC
===================================================== */

/* ---------- TOKENS & BASE ---------- */
:root{
  --ink:#0b1220; --muted:#5a667a;
  --surface:#ffffff; --surface-2:#f7f9fc; --border:#e8eef5;

  --lav:#EAE2FF; --lav-700:#8B5CF6;
  --ora:#FFE5D1; --ora-700:#FB923C;
  --coral-700:#F43F5E; --green-700:#10B981;
  --indigo-600:#6366F1; --gold-500:#FACC15;
  --mint-600:#06D6A0; --teal-600:#1B9AAA;

  --gx-planta: linear-gradient(135deg,#F5F0FF 0%, #EAE2FF 55%, #C4B5FD 100%);
  --gx-tareas: linear-gradient(135deg,#FFE7D4 0%, #FED7AA 55%, #FB923C 100%);
  --gx-dir:    linear-gradient(135deg,#FFE4E6 0%, #FDA4AF 50%, #FB7185 100%);
  --gx-bib:    linear-gradient(135deg,#DCFCE7 0%, #A7F3D0 55%, #34D399 100%);

  --appbar: 68px;
  --bottom-h: 68px; --nav-btn: 56px; --ico-bottom: 28px;
}
@media (max-width:480px){ :root{ --appbar:64px; --bottom-h:64px; --nav-btn:52px; --ico-bottom:26px } }
@media (min-width:1025px){ :root{ --appbar:72px; --nav-btn:60px; --ico-bottom:30px } }

*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;scroll-behavior:smooth}
body{
  font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  color:var(--ink);
  background:#f1f5f9;
  -webkit-font-smoothing:antialiased;
}
img{max-width:100%;display:block}
button,input,textarea,select{font:inherit}

/* ---------- LAYOUT ---------- */
main.container{
  max-width:1100px;
  margin:0 auto;
  padding:12px clamp(12px,4vw,20px) calc(16px +  env(safe-area-inset-bottom));
  padding-bottom: calc(var(--bottom-h) + env(safe-area-inset-bottom) + 22px);
}

/* ---------- APPBAR ---------- */
header.appbar{
  position:sticky; top:0; z-index:50;
  min-height:var(--appbar);
  backdrop-filter: blur(8px) saturate(1.06);
  background: var(--surface);
  border-bottom:1px solid var(--border);
}
.appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand{
  padding:10px 14px;border-radius:999px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);
  box-shadow:inset 0 1px 0 #fff, 0 10px 26px rgba(15,23,42,.08);
  display:inline-flex;align-items:center;gap:10px;
  font-weight:1000;letter-spacing:.2px;
}
.brand-dot{width:10px;height:10px;border-radius:50%;background:var(--gold-500)}
h1#title{
  margin:0;font-size:clamp(18px,2.2vw,22px);
  font-weight:1000;letter-spacing:.2px;color:#0e1624;
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.05));
}

.appbar-right{
  margin-left:auto;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 9px;border-radius:999px;
  font-size:12px;
  background:#e5e7eb;
  color:#111827;
}
.chip.ok{background:#dcfce7;color:#166534}
.chip.bad{background:#fee2e2;color:#991b1b}

/* ---------- CARDS ---------- */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(255,255,255,.82) 100%);
  backdrop-filter: blur(8px) saturate(1.06);
  border: 1px solid var(--border);
  border-radius: 22px;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.7),
    0 22px 40px rgba(15,23,42,.12);
  padding:14px 16px 16px 16px;
}
.card-h{
  display:flex;align-items:center;gap:10px;
  margin-bottom:8px;
}
.card-h h2{
  margin:0;
  font-size:clamp(16px,1.9vw,18px);
  font-weight:900;
}
.card-h .subtitle{
  font-size:12px;
  color:var(--muted);
}
.card-b{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Tiras de color por sección */
.h-planta::before,
.h-tareas::before,
.h-coral::before,
.h-bib::before,
.h-green::before,
.h-inter::before{
  content:"";
  width:6px;height:26px;border-radius:999px;
  margin-right:6px;
  box-shadow:0 0 0 1px rgba(255,255,255,.75),0 8px 16px rgba(15,23,42,.25);
}
.h-planta::before{background:var(--gx-planta);}
.h-tareas::before{background:var(--gx-tareas);}
.h-coral::before{background:var(--gx-dir);}
.h-bib::before{background:var(--gx-bib);}
.h-green::before{background:linear-gradient(135deg,#bbf7d0,#22c55e);}
.h-inter::before{background:linear-gradient(135deg,#e0f2fe,#3b82f6);}

/* ---------- BOTONES ---------- */
.btn{
  appearance:none;
  border-radius:999px;
  border:1px solid var(--border);
  background:#f8fafc;
  padding:7px 13px;
  font-size:13px;
  display:inline-flex;align-items:center;justify-content:center;
  gap:6px;
  cursor:pointer;
  transition:background .18s ease, box-shadow .18s ease, transform .16s ease, border-color .18s ease;
}
.btn:hover{
  background:#ffffff;
  box-shadow:0 12px 26px rgba(15,23,42,.14);
  transform:translateY(-0.5px);
}
.btn.primary{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#ffffff;
  border-color:color-mix(in oklab,#4f46e5,transparent 40%);
  box-shadow:0 14px 30px rgba(79,70,229,.45);
}
.btn.primary:hover{
  background:linear-gradient(135deg,#4338ca,#4f46e5);
}
.btn.icon{
  min-width:36px;height:36px;padding:0;
  display:grid;place-items:center;
}
.btn.icon .ico{width:20px;height:20px}
.btn.icon.swap .ico{width:23px;height:23px}
.btn[disabled]{opacity:.5;cursor:default;box-shadow:none}

/* ---------- LISTAS / INPUTS ---------- */
ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
li.item{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px;
  align-items:flex-start;
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  background:#fff;
}

.pill{
  display:inline-flex;align-items:center;justify-content:center;
  font-weight:900;font-size:14px;
  padding:7px 12px;border-radius:14px;line-height:1;
  border:1px solid transparent;color:#0d1726;
  background:var(--surface-2);box-shadow:inset 0 1px 0 #fff;
}
.pill.room{
  font-family: ui-monospace,Consolas,Menlo,monospace;
  font-size:clamp(22px,3.2vw,26px);
  padding:12px 16px; letter-spacing:.3px; color:#07101f;
  background:#fff; white-space:nowrap;
  border:1px solid color-mix(in oklab,var(--lav-700),transparent 78%);
  box-shadow:0 0 0 1px color-mix(in oklab,#000,transparent 90%),
             inset 0 1px 0 #fff,
             0 18px 30px rgba(88,28,135,.25);
}
.pill.tel{
  font-family: ui-monospace,Consolas,Menlo,monospace;
  font-size:13px;
  padding:6px 10px;
  border-radius:999px;
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  color:#0f172a;
  border-color:color-mix(in oklab,#1d4ed8,transparent 70%);
}

.item .text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:4px;
  min-width:0;
}
.item .text > *{
  white-space:normal;
  overflow:visible;
  text-overflow:clip;
  max-width:100%;
  word-break:break-word;
}
.item .text .muted{opacity:.8}

.item .actions{
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  gap:6px;
  min-width:114px;
}

/* Inputs */
label{font-size:13px;font-weight:600;color:#0f172a}
input[type="text"],
input[type="search"],
input[type="date"],
input[type="url"],
textarea{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  padding:7px 10px;
  font-size:14px;
  background:#f9fafb;
  transition:border-color .16s ease, box-shadow .16s ease, background .16s ease;
}
input:focus,textarea:focus{
  outline:none;
  border-color:color-mix(in oklab,#6366f1,transparent 40%);
  background:#ffffff;
  box-shadow:0 0 0 1px rgba(129,140,248,.35),0 0 0 4px rgba(199,210,254,.6);
}
textarea{min-height:120px;resize:vertical}

/* ---------- DIRECTORIO ---------- */
.dir-wrap{
  display:grid;
  grid-template-columns:minmax(0,1fr) min(30px,6.5vw);
  gap:12px;align-items:start;
}
@media (max-width:640px){
  .dir-wrap{
    grid-template-columns:minmax(0,1fr) auto;
    align-items:flex-start;
  }
}
.dir-wrap > div:first-child{min-width:0}

/* Índice A–Z */
.az{
  position:sticky; top:calc(var(--appbar) + 10px);
  display:grid; gap:6px; align-content:start;
  z-index:1;
  padding:4px; border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(245,248,253,.85));
  border:1px solid var(--border);
  backdrop-filter: blur(6px);
}
.az a{
  width:26px;height:26px;border-radius:999px;
  display:grid;place-items:center;
  font-size:11px;font-weight:700;
  color:#4b5563;
  text-decoration:none;
  border:1px solid transparent;
  background:#fff;
  box-shadow:var(--shadow-1);
  transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease, background .18s ease;
}
.az a:hover,
.az a:focus-visible{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(15,23,42,.18);
  border-color:color-mix(in oklab,var(--gold-500),transparent 60%);
}
.az a.is-active{
  background:radial-gradient(circle at 30% 0%,#fffbe5,#fde68a);
  border-color:color-mix(in oklab,var(--gold-500),transparent 45%);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 14px 30px rgba(15,23,42,.16),
    0 0 26px rgba(250,204,21,.28);
  backdrop-filter: blur(10px);
}

/* Cabecera por letra: GLOW + RIM LIGHT, sin solapar contactos */
.section-tag{
  position:relative;
  margin:12px 0 10px 0;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
  font-weight:1000;
  letter-spacing:.2px;
  border-radius:16px;
  color:#0b1220;
  background:
    radial-gradient(140% 160% at 0% 0%,rgba(255,255,255,.98),rgba(245,248,255,.96)),
    radial-gradient(160% 140% at 100% 0%,rgba(253,242,213,.96),rgba(252,211,77,0.18));
  border:1px solid color-mix(in oklab,var(--gold-500),transparent 70%);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 10px 28px rgba(15,23,42,.14),
    0 0 32px rgba(250,204,21,.16);
  backdrop-filter: blur(10px);
}
.section-main{
  display:flex;
  align-items:center;
  gap:12px;
}
.section-letter-pill{
  position:relative;
  min-width:40px;min-height:40px;
  border-radius:999px;
  display:grid;place-items:center;
  font-size:20px;font-weight:1000;
  letter-spacing:.12em;
  background:
    radial-gradient(140% 140% at 0% 0%,rgba(255,255,255,.98),rgba(250,232,255,0.3)),
    radial-gradient(140% 140% at 100% 0%,rgba(253,246,213,.96),rgba(252,211,77,0.24));
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 0 0 1px color-mix(in oklab,var(--gold-500),transparent 55%),
    0 14px 30px rgba(15,23,42,.16),
    0 0 36px rgba(250,204,21,.18);
}
.section-letter-pill::after{
  content:"";
  position:absolute;
  inset:-30%;
  border-radius:inherit;
  background:radial-gradient(70% 50% at 50% 0%,rgba(255,255,255,.9),transparent);
  mix-blend-mode:screen;
  opacity:.7;
  pointer-events:none;
}
.section-letter-pill span{transform:translateY(1px)}
.section-meta{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.section-name{
  font-size:.78rem;
  text-transform:uppercase;
  letter-spacing:.16em;
  opacity:.85;
}
.section-tag .count{
  font-size:.78rem;
  font-weight:900;
  opacity:.7;
}
section[id^="sec-"]{
  scroll-margin-top: calc(var(--appbar) + 56px);
  padding-top:2px;
  padding-bottom:8px;
}
#d-list-wrap section + section{
  margin-top:10px;
}

/* Lista directorio */
#panel-directorio .list{grid-template-columns:1fr}
@media (min-width:900px){
  #panel-directorio .list{
    display:grid;
    grid-template-columns:1fr 1fr;
  }
}
.dir-sec-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  padding:3px 8px;
  font-size:11px;
  background:rgba(248,250,252,.9);
  border:1px solid rgba(148,163,184,.35);
}

/* ---------- NAV INFERIOR ---------- */
nav.bottom{
  position:fixed;left:0;right:0;bottom:0;
  z-index:60;
  background:#fff;
  border-top:1px solid var(--border);
  backdrop-filter: blur(6px) saturate(1.02);
}
.bottom-inner{
  display:flex;align-items:center;gap:12px;
  height:calc(var(--bottom-h) + env(safe-area-inset-bottom));
  padding:10px clamp(10px,5vw,18px);
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.icons-left{display:flex;align-items:center;gap:12px;}
.nav-btn{
  appearance:none;
  border:1px solid var(--border);
  background:var(--surface-2);
  border-radius:999px;
  box-shadow:0 10px 20px rgba(15,23,42,.16);
  width:var(--nav-btn);height:var(--nav-btn);
  display:grid;place-items:center;
  cursor:pointer;
  transition:transform .16s ease, box-shadow .18s ease, border-color .18s ease, background .16s ease;
}
.nav-btn .ico{
  width:var(--ico-bottom);
  height:var(--ico-bottom);
}
.nav-btn[aria-current="page"]{
  background:#fff;
  border-color:color-mix(in oklab,#6366f1,transparent 40%);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.9),
    0 16px 30px rgba(79,70,229,.35);
  transform:translateY(-1px);
}
.nav-btn:focus-visible{
  outline:2px solid #4f46e5;
  outline-offset:2px;
}
.divider{
  flex:1;
  min-width:24px;
  height:1px;
  background:linear-gradient(90deg,transparent,#e5e7eb,transparent);
}
.active-chip{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  color:#111827;
  background:linear-gradient(135deg,#eef2ff,#e0f2fe);
  border:1px solid color-mix(in oklab,#6366f1,transparent 65%);
  box-shadow:0 10px 24px rgba(15,23,42,.18);
}

/* ---------- FAB Emergencias ---------- */
#fab{
  position:fixed;
  left:16px;bottom:calc(var(--bottom-h) + env(safe-area-inset-bottom) + 16px);
  z-index:65;
}

/* Utilidades */
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.muted{color:var(--muted);font-size:13px}
.hide{display:none!important}

/* Sombras base */
:root{
  --shadow-1:0 10px 18px rgba(15,23,42,.13);
}
</style>
</head>
<body>
<svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
  <defs>
    <linearGradient id="gLav" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#e5e0ff"/><stop offset="1" stop-color="#8B5CF6"/>
    </linearGradient>
    <linearGradient id="gOra" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffd7b0"/><stop offset="1" stop-color="#FB923C"/>
    </linearGradient>
    <linearGradient id="gInd" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#d6dbff"/><stop offset="1" stop-color="#6F7BF7"/>
    </linearGradient>
    <linearGradient id="gGold" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffeaa8"/><stop offset="1" stop-color="#FACC15"/>
    </linearGradient>

    <!-- Fonendoscopio premium minimalista -->
    <symbol id="i-stetho" viewBox="0 0 24 24">
      <defs>
        <radialGradient id="stethoBg" cx="0.2" cy="0" r="1.2">
          <stop offset="0" stop-color="#EEF2FF"/>
          <stop offset="1" stop-color="#6366F1"/>
        </radialGradient>
      </defs>
      <circle cx="12" cy="12" r="10" fill="url(#stethoBg)"/>
      <g fill="none" stroke="#FFFFFF" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8 5v4a3 3 0 0 0 6 0V5"/>
        <path d="M10 5h-2.2A1.8 1.8 0 0 0 6 6.8V9"/>
        <path d="M14 5h2.2A1.8 1.8 0 0 1 18 6.8V9.5A3.5 3.5 0 0 1 14.5 13h-1.1A3.4 3.4 0 0 1 10 16.4"/>
        <circle cx="18" cy="7" r="1.6" stroke="url(#gGold)" stroke-width="1.4" fill="none"/>
        <circle cx="10" cy="17.2" r="2.1" fill="#FFFFFF" fill-opacity=".98"/>
        <circle cx="10" cy="17.2" r="1.1" fill="url(#gInd)"/>
      </g>
    </symbol>

    <!-- Icono tareas: reloj de arena premium -->
    <symbol id="i-tools" viewBox="0 0 24 24">
      <defs>
        <linearGradient id="hgTop" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="#E5E7EB"/>
          <stop offset="1" stop-color="#9CA3AF"/>
        </linearGradient>
        <linearGradient id="hgSand" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#FBBF24"/>
          <stop offset="1" stop-color="#F97316"/>
        </linearGradient>
      </defs>
      <g fill="none" stroke-linecap="round" stroke-linejoin="round">
        <rect x="6" y="3.5" width="12" height="3" rx="1.5" fill="url(#hgTop)"/>
        <rect x="6" y="17.5" width="12" height="3" rx="1.5" fill="url(#hgTop)"/>
        <path d="M10 6.5 12 9l2-2.5" stroke="url(#gInd)" stroke-width="1.6"/>
        <path d="M10 17.5 12 15l2 2.5" stroke="url(#gOra)" stroke-width="1.6"/>
        <path d="M9.2 9.8c.7.7 1.7 1.3 2.8 1.3 1.1 0 2.1-.6 2.8-1.3" stroke="url(#hgSand)" stroke-width="1.4"/>
        <path d="M9.2 14.2c.7-.7 1.7-1.3 2.8-1.3 1.1 0 2.1.6 2.8 1.3" stroke="url(#hgSand)" stroke-width="1.4"/>
        <circle cx="12" cy="12" r="4.6" stroke="rgba(15,23,42,.25)" stroke-width="1.1"/>
      </g>
    </symbol>

    <!-- edit (pencil) -->
    <symbol id="i-edit" viewBox="0 0 24 24">
      <path fill="url(#gLav)" d="M3 17.25V21h3.75L18.81 8.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
    </symbol>

    <!-- check (complete) -->
    <symbol id="i-check" viewBox="0 0 24 24">
      <path fill="url(#gGold)" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm-1.2 13.2-3.6-3.6 1.4-1.4 2.2 2.2 4.6-4.6 1.4 1.4-6 6z"/>
    </symbol>

    <!-- Teléfono premium -->
    <symbol id="i-handset" viewBox="0 0 24 24">
      <defs>
        <radialGradient id="telBg" cx="0.1" cy="0" r="1.2">
          <stop offset="0" stop-color="#ECFEFF"/>
          <stop offset="1" stop-color="#0EA5E9"/>
        </radialGradient>
      </defs>
      <rect x="2.5" y="2.5" width="19" height="19" rx="5" fill="url(#telBg)"/>
      <path d="M7 9.2c1.2 2.2 2.8 3.8 5 5l1.2-1.2a1.4 1.4 0 0 1 1.5-.3l2.4 1a1.4 1.4 0 0 1 .9 1.6c-.2.9-.8 1.8-1.7 2.3-1 .6-2.3.7-3.5.3-1.7-.5-3.4-1.5-5-3.1-1.6-1.6-2.7-3.3-3.1-5-.4-1.2-.3-2.5.3-3.5.5-.9 1.4-1.5 2.3-1.7a1.4 1.4 0 0 1 1.6.9l1 2.4c.2.5.1 1.1-.3 1.5L7 9.2Z"
            fill="#0F172A" fill-opacity=".92"/>
      <path d="M15 5.2a4 4 0 0 1 4 4" stroke="#E0F2FE" stroke-width="1.3" stroke-linecap="round"/>
      <path d="M15 7.1a2.2 2.2 0 0 1 2.2 2.2" stroke="#E0F2FE" stroke-width="1.1" stroke-linecap="round"/>
    </symbol>

    <!-- libros premium -->
    <symbol id="i-books" viewBox="0 0 24 24">
      <g>
        <linearGradient id="bk1" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#A5B4FC"/>
          <stop offset="1" stop-color="#4F46E5"/>
        </linearGradient>
        <linearGradient id="bk2" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#FDBA74"/>
          <stop offset="1" stop-color="#EA580C"/>
        </linearGradient>
        <linearGradient id="bk3" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#6EE7B7"/>
          <stop offset="1" stop-color="#059669"/>
        </linearGradient>
      </g>
      <rect x="3" y="5" width="5.3" height="14" rx="1.4" fill="url(#bk1)"/>
      <rect x="9.4" y="4" width="5.3" height="15" rx="1.4" fill="url(#bk2)"/>
      <rect x="15.8" y="6" width="5" height="13" rx="1.3" fill="url(#bk3)"/>
      <rect x="3.4" y="7" width="4.5" height="0.9" rx="0.45" fill="#E5E7EB" opacity=".9"/>
      <rect x="9.8" y="7" width="4.5" height="0.9" rx="0.45" fill="#FEF3C7" opacity=".9"/>
      <rect x="16.1" y="8.5" width="3.8" height="0.9" rx="0.45" fill="#DCFCE7" opacity=".9"/>
    </symbol>
  </defs>
</svg>

<header class="appbar">
  <div class="container">
    <div class="brand">
      <span class="brand-dot"></span>
      <div>
        <h1 id="title">Aurora UI — Infecciosas 2.0</h1>
        <div class="muted" style="font-size:11px">Planta · Tareas · Directorio · Biblioteca · v3.4</div>
      </div>
    </div>
    <div class="appbar-right">
      <div id="statusGroup" class="toolbar">
        <span id="badge-online" class="chip bad">Offline</span>
        <span id="badge-auth" class="chip bad">Google: desconectado</span>
      </div>
      <div id="userGroup" class="toolbar" style="margin-left:auto">
        <div id="userchip" class="hide" style="display:flex;align-items:center;gap:6px">
          <img id="avatar" alt="" style="width:26px;height:26px;border-radius:50%;box-shadow:var(--shadow-1)"/>
          <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
        </div>
        <span id="notifBadge" class="chip" title="Tareas activas">0</span>
      </div>
      <button id="installBtn" class="btn" aria-label="Instalar">➕ Instalar</button>
      <button id="signin"  class="btn primary">Acceder</button>
      <button id="signout" class="btn hide">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <div id="updateBanner" class="chip" style="display:none">
    Nueva versión disponible. <button id="reloadNow" class="btn primary">Actualizar</button>
  </div>
  <div id="installBanner" class="chip" style="display:none">
    Instala la app para acceso más rápido. <button id="installAction" class="btn primary">Instalar</button>
  </div>

  <!-- Gate -->
  <section id="gate" class="card" role="region" aria-live="polite">
    <div class="card-h h-bib"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
    <div class="card-b">
      <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
      <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
      <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
    </div>
  </section>

  <!-- App -->
  <section id="app" class="hide">
    <!-- ===== PLANTA ===== -->
    <div id="panel-planta" role="region" aria-label="Planta" tabindex="-1">
      <div class="card">
        <div class="card-h h-planta"><h2>Planta</h2><span class="subtitle">Habitaciones e interconsultas</span></div>
        <div class="card-b">
          <div class="toolbar" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px">
            <div>
              <label for="p-room">Habitación</label>
              <input id="p-room" placeholder="Ej. 421-2" autocomplete="off">
            </div>
            <div>
              <label for="p-desc">Descripción</label>
              <input id="p-desc" placeholder="Resumen clínico, motivo…">
            </div>
            <div style="align-self:end">
              <button id="p-add" class="btn primary">Añadir</button>
            </div>
          </div>
          <div class="toolbar" style="justify-content:flex-start;margin-top:4px">
            <button id="p-filter-planta" class="btn primary">Planta</button>
            <button id="p-filter-inter" class="btn">Interconsultas</button>
            <button id="p-filter-all" class="btn">Todo</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-planta"><h2>Censo planta</h2><span id="p-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-planta" class="list"></ul>
          <p id="p-empty-planta" class="muted">Sin habitaciones activas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Interconsultas</h2><span id="p-count-inter" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-inter" class="list"></ul>
          <p id="p-empty-inter" class="muted">Sin interconsultas activas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completados</h2><span id="p-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-done" class="list"></ul>
          <p id="p-empty-done" class="muted">Sin habitaciones cerradas.</p>
        </div>
      </div>
    </div>

    <!-- ===== TAREAS ===== -->
    <div id="panel-tareas" class="hide" role="region" aria-label="Tareas" tabindex="-1">
      <div class="card">
        <div class="card-h h-tareas"><h2>Tareas</h2><span class="subtitle">Agenda por fechas</span></div>
        <div class="card-b">
          <div class="toolbar" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px">
            <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
            <div><label for="t-text">Descripción</label><input id="t-text" type="text" placeholder="Describe la tarea…" maxlength="400"></div>
            <div style="align-self:end"><button id="t-add" class="btn primary">Añadir</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-tareas"><h2>Activas</h2><span id="t-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-list" class="list"></ul>
          <p id="t-empty" class="muted">No hay tareas activas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completadas</h2><span id="t-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-done" class="list"></ul>
          <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
        <div class="card-b">
          <div class="toolbar" style="margin-bottom:8px">
            <button id="t-emptyTrash" class="btn primary">Vaciar papelera</button>
          </div>
          <ul id="t-trash" class="list"></ul>
          <p id="t-trash-empty" class="muted">Papelera vacía.</p>
        </div>
      </div>
    </div>

    <!-- ===== DIRECTORIO ===== -->
    <div id="panel-directorio" class="hide" role="region" aria-label="Directorio" tabindex="-1">
      <div class="card">
        <div class="card-h h-coral"><h2>Directorio telefónico</h2><span id="d-count" class="chip">0</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr auto">
          <div>
            <label for="d-q">Búsqueda inteligente</label>
            <input id="d-q" type="search" placeholder="Sección, nombre o extensión…">
          </div>
          <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap; gap:6px">
            <button id="d-add" class="btn primary">Añadir</button>
            <button id="d-import" class="btn">Importar JSON</button>
            <button id="d-export" class="btn">Exportar JSON</button>
            <button id="d-dedupe" class="btn">Eliminar duplicados</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-b dir-wrap">
          <div>
            <div id="d-list-wrap"></div>
            <p id="d-empty" class="muted">Sin registros.</p>
          </div>
          <nav class="az" aria-label="Índice alfabético" id="d-az"></nav>
        </div>
      </div>
    </div>

    <!-- ===== BIBLIOTECA ===== -->
    <div id="panel-biblioteca" class="hide" role="region" aria-label="Biblioteca" tabindex="-1">
      <div class="card">
        <div class="card-h h-bib"><h2>Biblioteca</h2><span class="subtitle">Campo libre + enlaces + visor PDF</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:2fr 1fr">
          <div>
            <label for="b-notes">Notas rápidas</label>
            <textarea id="b-notes" placeholder="Pega aquí fragmentos o URLs. Se guardan en tu usuario."></textarea>
            <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
              <button id="b-notes-save" class="btn primary">Guardar notas</button>
              <button id="b-open-file" class="btn">Abrir PDF local…</button>
              <button id="b-clear-view" class="btn">Vaciar visor</button>
            </div>
          </div>
          <div>
            <label for="b-url">Nuevo enlace (PDF o web)</label>
            <input id="b-url" type="url" placeholder="https://… o *.pdf">
            <label for="b-title">Título</label>
            <input id="b-title" type="text" placeholder="Nombre del recurso">
            <div class="toolbar" style="margin-top:8px">
              <button id="b-add-link" class="btn primary">Añadir enlace</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-bib"><h2>Recursos</h2></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:minmax(0,1.2fr) minmax(0,1.4fr)">
          <div>
            <ul id="b-link-list" class="list"></ul>
            <p id="b-link-empty" class="muted">Sin enlaces guardados.</p>
          </div>
          <div>
            <iframe id="b-viewer" title="Visor de recursos" style="width:100%;min-height:260px;border-radius:18px;border:1px solid var(--border);background:#0f172a"></iframe>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Barra inferior única ===== -->
    <nav class="bottom" aria-label="Secciones">
      <div class="bottom-inner" id="bottomNav">
        <div class="icons-left" role="tablist" aria-label="Secciones">
          <button class="nav-btn" id="b-planta" role="tab" aria-label="Planta" aria-current="page" tabindex="0">
            <svg class="ico" aria-hidden="true"><use href="#i-stetho"/></svg>
          </button>
          <button class="nav-btn" id="b-tareas" role="tab" aria-label="Tareas" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-tools"/></svg>
          </button>
          <button class="nav-btn" id="b-directorio" role="tab" aria-label="Directorio" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-handset"/></svg>
          </button>
          <button class="nav-btn" id="b-biblioteca" role="tab" aria-label="Biblioteca" aria-current="false" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-books"/></svg>
          </button>
        </div>
        <span class="divider" aria-hidden="true"></span>
        <span id="activeLabel" class="active-chip" aria-live="polite">Planta</span>
      </div>
    </nav>
  </section>
</main>

<!-- FAB Emergencias -->
<button id="fab" class="btn primary" style="position:fixed;left:16px;bottom:calc(var(--bottom-h) + env(safe-area-inset-bottom) + 16px)" aria-haspopup="dialog" aria-controls="fabPanel" aria-expanded="false">
  Emergencias
</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import * as authMod from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import * as fsMod from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js";

const app = initializeApp(firebaseConfig);
const auth = authMod.getAuth(app);
const db   = fsMod.getFirestore(app);
const serverTS = fsMod.serverTimestamp;

const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const esc = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
const norm = (s)=>String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();

const appUI   = $("#app");
const gate    = $("#gate");
const badgeOnline = $("#badge-online");
const badgeAuth   = $("#badge-auth");
const userchip    = $("#userchip");
const avatar      = $("#avatar");
const displayname = $("#displayname");
const notifBadge  = $("#notifBadge");
const updateBanner = $("#updateBanner");
const installBanner = $("#installBanner");
const reloadNow   = $("#reloadNow");
const installBtn  = $("#installBtn");
const installAction = $("#installAction");

let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  if(installBtn) installBtn.classList.remove("hide");
  if(installBanner) installBanner.style.display = "inline-flex";
});
async function doInstall(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBanner.style.display = "none";
}
installBtn?.addEventListener("click",doInstall);
installAction?.addEventListener("click",doInstall);

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js").catch(console.error);
  navigator.serviceWorker.addEventListener("controllerchange",()=>{
    updateBanner.style.display="inline-flex";
  });
  reloadNow?.addEventListener("click",()=>location.reload());
}

function updateOnlineStatus(){
  const on = navigator.onLine;
  badgeOnline.textContent = on ? "Online" : "Offline";
  badgeOnline.className   = "chip " + (on ? "ok" : "bad");
}
window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);
updateOnlineStatus();

/* ===== NAV BOTTOM ===== */
const panels = {
  planta: $("#panel-planta"),
  tareas: $("#panel-tareas"),
  directorio: $("#panel-directorio"),
  biblioteca: $("#panel-biblioteca")
};
const buttons = {
  planta: $("#b-planta"),
  tareas: $("#b-tareas"),
  directorio: $("#b-directorio"),
  biblioteca: $("#b-biblioteca")
};
const activeLabel = $("#activeLabel");

function setSection(name){
  Object.entries(panels).forEach(([k,el])=>{
    if(!el) return;
    if(k===name) el.classList.remove("hide");
    else el.classList.add("hide");
  });
  Object.entries(buttons).forEach(([k,btn])=>{
    if(!btn) return;
    if(k===name){
      btn.setAttribute("aria-current","page");
      btn.tabIndex = 0;
    }else{
      btn.setAttribute("aria-current","false");
      btn.tabIndex = -1;
    }
  });
  if(activeLabel){
    const map = { planta:"Planta", tareas:"Tareas", directorio:"Directorio", biblioteca:"Biblioteca" };
    activeLabel.textContent = map[name]||"";
  }
}
Object.entries(buttons).forEach(([name,btn])=>{
  btn?.addEventListener("click",()=>setSection(name));
});
$("#bottomNav")?.addEventListener("keydown",(e)=>{
  const order = ["planta","tareas","directorio","biblioteca"];
  const current = order.find(n=>buttons[n]?.getAttribute("aria-current")==="page") || "planta";
  const idx = order.indexOf(current);
  let next = null;
  if(e.key==="ArrowRight") next = order[Math.min(order.length-1, idx+1)];
  else if(e.key==="ArrowLeft") next = order[Math.max(0, idx-1)];
  else if(e.key==="Home") next = order[0];
  else if(e.key==="End") next = order[order.length-1];
  if(next){
    e.preventDefault();
    buttons[next]?.focus();
    setSection(next);
  }
});
setSection("planta");

/* ===== AUTH ===== */
async function doSignIn(){
  try{
    const provider = new authMod.GoogleAuthProvider();
    await authMod.signInWithPopup(auth, provider);
  }catch(e){
    $("#authErr").textContent = e.message || String(e);
  }
}
$("#signin")?.addEventListener("click",doSignIn);
$("#signin2")?.addEventListener("click",doSignIn);
$("#signout")?.addEventListener("click",()=>authMod.signOut(auth));

let unsubMount = null;
function unmount(){
  if(typeof unsubMount==="function") unsubMount();
  unsubMount = null;
}
function currentUid(){
  const user = auth.currentUser;
  return user ? user.uid : null;
}

const col = {
  planta: (uid)=>fsMod.collection(db,"users",uid,"planta"),
  tareas: (uid)=>fsMod.collection(db,"users",uid,"tareas"),
  dir:    (uid)=>fsMod.collection(db,"users",uid,"directorio"),
  biblio: (uid)=>fsMod.collection(db,"users",uid,"biblioteca")
};

authMod.onAuthStateChanged(auth, user=>{
  if(user){
    badgeAuth.textContent = "Google: " + (user.displayName||user.email);
    badgeAuth.className   = "chip ok";
    if(avatar) avatar.src = user.photoURL || "";
    if(displayname) displayname.textContent = user.displayName||user.email||"";
    userchip?.classList.remove("hide");
    $("#signout")?.classList.remove("hide");
    $("#signin")?.classList.add("hide");
    gate.classList.add("hide");
    appUI.classList.remove("hide");
    mount(user.uid);
  }else{
    badgeAuth.textContent = "Google: desconectado";
    badgeAuth.className   = "chip bad";
    userchip?.classList.add("hide");
    $("#signout")?.classList.add("hide");
    $("#signin")?.classList.remove("hide");
    appUI.classList.add("hide");
    gate.classList.remove("hide");
    unmount();
  }
});

/* ===== PLANTA ===== */
function roomSortKey(room){
  if(!room) return 999999;
  const m = String(room).match(/^(\d+)/);
  return m ? Number(m[1]) : 999999;
}
function plantaDoc(base){
  return {
    ...base,
    createdAt: serverTS(),
    updatedAt: serverTS(),
    status: base.status || "active",
    grupo: base.grupo || "planta"
  };
}
function btn(label,onclick,cls="btn"){
  const b = document.createElement("button");
  b.className = cls;
  b.type="button";
  if(label) b.textContent = label;
  b.addEventListener("click",onclick);
  return b;
}

function setupPlanta(uid,unsubs){
  $("#p-add")?.addEventListener("click",async()=>{
    const room = $("#p-room").value.trim();
    const desc = $("#p-desc").value.trim();
    if(!room && !desc) return;
    const d = plantaDoc({ room, desc });
    await fsMod.addDoc(col.planta(uid), d);
    $("#p-room").value = "";
    $("#p-desc").value = "";
  });

  const qActive = fsMod.query(col.planta(uid), fsMod.where("status","==","active"));
  const qDone   = fsMod.query(col.planta(uid), fsMod.where("status","==","done"));

  const u1 = fsMod.onSnapshot(qActive,(s)=>{
    const all=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x);});
    const arrP = all.filter(x=>(x.grupo||"planta")==="planta")
      .sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||"").localeCompare(String(b.room||"")));
    const arrI = all.filter(x=>(x.grupo||"planta")==="interconsulta")
      .sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||"").localeCompare(String(b.room||"")));

    const lp = $("#p-list-planta"), li = $("#p-list-inter");
    const ep = $("#p-empty-planta"), ei = $("#p-empty-inter");
    lp.innerHTML = ""; li.innerHTML="";
    for(const x of arrP){
      lp.append(renderPlantaItem(uid,x));
    }
    for(const x of arrI){
      li.append(renderPlantaItem(uid,x));
    }
    $("#p-count").textContent = arrP.length+" habitaciones";
    $("#p-count-inter").textContent = arrI.length+" interconsultas";
    ep.style.display = arrP.length?"none":"block";
    ei.style.display = arrI.length?"none":"block";
  });

  const u2 = fsMod.onSnapshot(qDone,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room));
    const ld = $("#p-list-done"), ed = $("#p-empty-done");
    ld.innerHTML = "";
    for(const x of arr){
      ld.append(renderPlantaItem(uid,x,true));
    }
    $("#p-done-count").textContent = arr.length+" cerradas";
    ed.style.display = arr.length?"none":"block";
  });

  unsubs.push(u1,u2);
}
function renderPlantaItem(uid,x,done=false){
  const li = document.createElement("li");
  li.className = "item";
  li.innerHTML = `
    <div>
      <span class="pill room">${esc(x.room||"")}</span>
    </div>
    <div class="text">
      <div>${esc(x.desc||"")}</div>
      <div class="muted">${x.grupo==="interconsulta"?"Interconsulta":"Planta"}</div>
    </div>
    <div class="actions toolbar"></div>
  `;
  const wrap = li.querySelector(".actions");
  const toggle = btn("", async()=>{
    const ref = fsMod.doc(db,"users",uid,"planta",x.__id);
    await fsMod.updateDoc(ref,{ status: done?"active":"done", updatedAt: serverTS() });
  },"btn icon");
  toggle.title = done ? "Reabrir" : "Cerrar";
  toggle.innerHTML = done
    ? `<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`
    : `<svg class="ico" aria-hidden="true"><use href="#i-check"/></svg>`;
  const delB = btn("✖", async()=>{
    const ref = fsMod.doc(db,"users",uid,"planta",x.__id);
    await fsMod.deleteDoc(ref);
  },"btn icon");
  delB.title = "Eliminar";
  wrap.append(toggle,delB);
  return li;
}

/* ===== TAREAS ===== */
function tareaDoc(base){
  return {
    ...base,
    createdAt: serverTS(),
    updatedAt: serverTS(),
    status: base.status||"active"
  };
}
function setupTareas(uid,unsubs){
  $("#t-add")?.addEventListener("click",async()=>{
    const date = $("#t-date").value;
    const text = $("#t-text").value.trim();
    if(!text) return;
    const d = tareaDoc({ date, text });
    await fsMod.addDoc(col.tareas(uid), d);
    $("#t-text").value="";
  });

  const qA = fsMod.query(col.tareas(uid), fsMod.where("status","==","active"));
  const qD = fsMod.query(col.tareas(uid), fsMod.where("status","==","done"));
  const qT = fsMod.query(col.tareas(uid), fsMod.where("status","==","trash"));

  const u1 = fsMod.onSnapshot(qA,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=>String(a.date||"").localeCompare(String(b.date||"")));
    const ul = $("#t-list"), empty = $("#t-empty");
    ul.innerHTML="";
    for(const x of arr){ ul.append(renderTareaItem(uid,x)); }
    $("#t-count").textContent = arr.length+" activas";
    empty.style.display = arr.length?"none":"block";
    setNotif(arr.length);
  });
  const u2 = fsMod.onSnapshot(qD,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=>String(b.updatedAt?.seconds||0)-String(a.updatedAt?.seconds||0));
    const ul = $("#t-done"), empty = $("#t-done-empty");
    ul.innerHTML="";
    for(const x of arr){ ul.append(renderTareaItem(uid,x,true)); }
    $("#t-done-count").textContent = arr.length+" completadas";
    empty.style.display = arr.length?"none":"block";
  });
  const u3 = fsMod.onSnapshot(qT,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=>String(b.updatedAt?.seconds||0)-String(a.updatedAt?.seconds||0));
    const ul = $("#t-trash"), empty = $("#t-trash-empty");
    ul.innerHTML="";
    for(const x of arr){ ul.append(renderTareaItem(uid,x,false,true)); }
    $("#t-trash-count").textContent = arr.length+" en papelera";
    empty.style.display = arr.length?"none":"block";
  });

  $("#t-emptyTrash")?.addEventListener("click",async()=>{
    const snap = await fsMod.getDocs(fsMod.query(col.tareas(uid), fsMod.where("status","==","trash")));
    await Promise.all(snap.docs.map(d=>fsMod.deleteDoc(d.ref)));
  });

  unsubs.push(u1,u2,u3);
}
function renderTareaItem(uid,x,done=false,trash=false){
  const li = document.createElement("li");
  li.className = "item";
  li.innerHTML = `
    <div>
      <span class="pill">${esc(x.date||"Sin fecha")}</span>
    </div>
    <div class="text">
      <div>${esc(x.text||"")}</div>
    </div>
    <div class="actions toolbar"></div>
  `;
  const wrap = li.querySelector(".actions");
  if(!trash){
    const toggle = btn("",async()=>{
      const ref = fsMod.doc(db,"users",uid,"tareas",x.__id);
      await fsMod.updateDoc(ref,{ status: done?"active":"done", updatedAt: serverTS() });
    },"btn icon");
    toggle.title = done ? "Marcar como activa" : "Marcar como completada";
    toggle.innerHTML = done
      ? `<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`
      : `<svg class="ico" aria-hidden="true"><use href="#i-check"/></svg>`;
    wrap.append(toggle);
  }
  const delB = btn("✖",async()=>{
    const ref = fsMod.doc(db,"users",uid,"tareas",x.__id);
    await fsMod.updateDoc(ref,{ status: trash?"deleted":"trash", updatedAt: serverTS() });
  },"btn icon");
  delB.title = trash ? "Eliminar definitivamente" : "Enviar a papelera";
  wrap.append(delB);
  return li;
}

function setNotif(n){
  notifBadge.textContent = String(n);
  notifBadge.title = n ? `${n} tareas activas` : "Sin avisos";
}

/* ===== DIRECTORIO ===== */
let dirCache = [];

const telHref = (raw)=>{
  if(!raw) return "";
  const digits = String(raw).replace(/[^\d+]/g,"");
  if(!digits) return "";
  return "tel:"+digits;
};

function phonesToChips(raw){
  const parts = String(raw||"").split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{
    const href = telHref(p);
    return href
      ? `<a class="pill tel" href="${href}" dir="ltr">${esc(p)}</a>`
      : `<span class="pill tel" dir="ltr">${esc(p)}</span>`;
  }).join(" ");
}

function renderDir(){
  const v = norm($("#d-q")?.value||"");
  const wrap = $("#d-list-wrap"); if(!wrap) return;
  wrap.innerHTML = "";
  let arr = [...dirCache];
  arr.sort((a,b)=>(a.nombre||"").localeCompare(b.nombre||"")||(a.seccion||"").localeCompare(b.seccion||""));
  const filtered = v
    ? arr.filter(x=>[x.seccion,x.nombre,String(x.telefono||""),x.notas].some(y=>norm(y).includes(v)))
    : arr;

  const groups = new Map();
  for(const x of filtered){
    const k = /^[A-Za-zÁÉÍÓÚÜÑ]/.test(x.nombre||"")
      ? norm(x.nombre)[0].toUpperCase()
      : "#";
    if(!groups.has(k)) groups.set(k,[]);
    groups.get(k).push(x);
  }

  const letters = "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ#".split("");
  const az = $("#d-az");
  if(az){
    az.innerHTML = letters
      .map(ch=>`<a href="#sec-${ch}" aria-label="Ir a ${ch}">${ch}</a>`)
      .join("");
  }

  let total = 0;
  let firstLetterWithData = null;

  for(const ch of letters){
    const list = groups.get(ch)||[];
    if(!list.length) continue;
    if(!firstLetterWithData) firstLetterWithData = ch;
    total += list.length;

    const sec = document.createElement("section");
    sec.id = `sec-${ch}`;
    sec.setAttribute("aria-labelledby",`lbl-${ch}`);

    const header = document.createElement("div");
    header.className = "section-tag";
    header.id = `lbl-${ch}`;
    const mainSec = list[0]?.seccion || "Sin sección";
    header.innerHTML =
      `<div class="section-main">
         <div class="section-letter-pill"><span>${ch}</span></div>
         <div class="section-meta">
           <span class="section-name">${esc(mainSec)}</span>
           <span class="count">${list.length}</span>
         </div>
       </div>`;
    sec.appendChild(header);

    const ul = document.createElement("ul");
    ul.className = "list";

    list.forEach(x=>{
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML =
        `<div class="text">
           <div class="line">
             <strong>${esc(x.nombre||"")}</strong>
             <span class="dir-sec-pill">${esc(x.seccion||"")}</span>
           </div>
           <div class="line dir-phones">${phonesToChips(x.telefono)}</div>
           ${x.notas ? `<div class="muted dir-notes">${esc(x.notas)}</div>` : ""}
         </div>
         <div class="toolbar actions"></div>`;
      const a = li.querySelector(".actions");
      const edit = btn("",()=>editDir(x),"btn icon");
      edit.title = "Editar";
      edit.innerHTML = `<svg class="ico" aria-hidden="true"><use href="#i-edit"/></svg>`;
      const delBtn = btn("✖",()=>delDir(x),"btn icon");
      delBtn.title = "Eliminar";
      a.append(edit,delBtn);
      ul.appendChild(li);
    });

    sec.appendChild(ul);
    wrap.appendChild(sec);
  }

  $("#d-count").textContent = total+" registros";
  $("#d-empty").style.display = total ? "none" : "block";

  if(firstLetterWithData && az){
    const firstLink = az.querySelector(`a[href="#sec-${firstLetterWithData}"]`);
    if(firstLink) firstLink.classList.add("is-active");
  }
}

function editDir(x){
  const seccion = prompt("Sección", x.seccion||"") ?? x.seccion;
  const nombre  = prompt("Nombre",  x.nombre||"") ?? x.nombre;
  const tel     = prompt("Teléfonos", x.telefono||"") ?? x.telefono;
  const notas   = prompt("Notas", x.notas||"") ?? x.notas;
  if(!currentUid()) return;
  const ref = fsMod.doc(db,"users",currentUid(),"directorio",x.__id);
  fsMod.updateDoc(ref,{
    seccion,
    nombre,
    telefono: tel,
    notas,
    updatedAt: serverTS()
  });
}
function delDir(x){
  if(!currentUid()) return;
  if(!confirm("¿Eliminar este registro?")) return;
  const ref = fsMod.doc(db,"users",currentUid(),"directorio",x.__id);
  fsMod.deleteDoc(ref);
}

function setupDir(uid,unsubs){
  $("#d-q")?.addEventListener("input",renderDir);
  $("#d-add")?.addEventListener("click",async()=>{
    const seccion = prompt("Sección")||"";
    const nombre  = prompt("Nombre")||"";
    const telefono= prompt("Teléfonos")||"";
    if(!nombre && !telefono) return;
    const d = {
      seccion,
      nombre,
      telefono,
      notas:"",
      createdAt: serverTS(),
      updatedAt: serverTS()
    };
    await fsMod.addDoc(col.dir(uid), d);
  });

  $("#d-import")?.addEventListener("click",async()=>{
    const input = document.createElement("input");
    input.type="file";
    input.accept=".json,application/json";
    input.onchange = async()=>{
      const file = input.files?.[0];
      if(!file) return;
      const text = await file.text();
      let data;
      try{
        data = JSON.parse(text);
      }catch{
        alert("JSON inválido");
        return;
      }
      if(!Array.isArray(data)) return;
      const batch = fsMod.writeBatch(db);
      data.forEach(x=>{
        const ref = fsMod.doc(col.dir(uid));
        batch.set(ref,{
          seccion: x.seccion||"",
          nombre: x.nombre||"",
          telefono: x.telefono||"",
          notas: x.notas||"",
          createdAt: serverTS(),
          updatedAt: serverTS()
        });
      });
      await batch.commit();
    };
    input.click();
  });

  $("#d-export")?.addEventListener("click",async()=>{
    const snap = await fsMod.getDocs(fsMod.query(col.dir(uid)));
    const out = snap.docs.map(d=>({id:d.id, ...d.data()}));
    const blob = new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "directorio.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  $("#d-dedupe")?.addEventListener("click",async()=>{
    const snap = await fsMod.getDocs(fsMod.query(col.dir(uid)));
    const seen = new Set();
    const batch = fsMod.writeBatch(db);
    snap.docs.forEach(d=>{
      const x = d.data();
      const key = `${x.seccion||""}|${x.nombre||""}|${x.telefono||""}`;
      if(seen.has(key)){
        batch.delete(d.ref);
      }else{
        seen.add(key);
      }
    });
    await batch.commit();
  });

  const q = fsMod.query(col.dir(uid));
  const u = fsMod.onSnapshot(q,(s)=>{
    dirCache = [];
    s.forEach(d=>{
      const x = d.data();
      x.__id = d.id;
      dirCache.push(x);
    });
    renderDir();
  });
  unsubs.push(u);
}

/* ===== BIBLIOTECA ===== */
function setupBiblio(uid,unsubs){
  $("#b-notes-save")?.addEventListener("click",async()=>{
    const ref = fsMod.doc(db,"users",uid,"meta","notas");
    await fsMod.setDoc(ref,{ text: $("#b-notes").value, updatedAt: serverTS() });
  });
  $("#b-open-file")?.addEventListener("click",()=>{
    const input = document.createElement("input");
    input.type="file";
    input.accept="application/pdf";
    input.onchange = ()=>{
      const file = input.files?.[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      $("#b-viewer").src = url;
    };
    input.click();
  });
  $("#b-clear-view")?.addEventListener("click",()=>{
    $("#b-viewer").removeAttribute("src");
  });
  $("#b-add-link")?.addEventListener("click",async()=>{
    const url = $("#b-url").value.trim();
    const title = $("#b-title").value.trim() || url;
    if(!url) return;
    await fsMod.addDoc(col.biblio(uid),{
      url, title,
      createdAt: serverTS(),
      updatedAt: serverTS()
    });
    $("#b-url").value = "";
    $("#b-title").value = "";
  });

  const refNotes = fsMod.doc(db,"users",uid,"meta","notas");
  fsMod.getDoc(refNotes).then(s=>{
    if(s.exists()) $("#b-notes").value = s.data().text||"";
  });

  const q = fsMod.query(col.biblio(uid));
  const u = fsMod.onSnapshot(q,(s)=>{
    const arr=[];
    s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x);});
    arr.sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
    const ul = $("#b-link-list"), empty = $("#b-link-empty");
    ul.innerHTML="";
    for(const x of arr){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="text">
          <strong>${esc(x.title||"")}</strong>
          <div class="muted">${esc(x.url||"")}</div>
        </div>
        <div class="toolbar actions"></div>
      `;
      const wrap = li.querySelector(".actions");
      const open = btn("Abrir",()=>{
        $("#b-viewer").src = x.url;
      },"btn");
      const delB = btn("✖",async()=>{
        if(!confirm("¿Eliminar enlace?")) return;
        const ref = fsMod.doc(db,"users",uid,"biblioteca",x.__id);
        await fsMod.deleteDoc(ref);
      },"btn icon");
      wrap.append(open,delB);
      ul.appendChild(li);
    }
    empty.style.display = arr.length?"none":"block";
  });
  unsubs.push(u);
}

/* ===== MOUNT / UNMOUNT ===== */
function mount(uid){
  const unsubs = [];
  setupPlanta(uid,unsubs);
  setupTareas(uid,unsubs);
  setupDir(uid,unsubs);
  setupBiblio(uid,unsubs);
  unsubMount = ()=>unsubs.forEach(fn=>fn&&fn());
}
</script>
</body>
</html>
