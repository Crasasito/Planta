<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light only" />
  <title>Infecciosas — Aurora UI</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --appbar-h: 64px;
      --bottomnav: 76px; /* dentro del rango 72–78px */
      --radius-xl: 16px;
      --radius-2xl: 24px;
      --shadow-soft: 0 6px 18px rgba(0,0,0,.06);
      --shadow-heavy: 0 12px 28px rgba(0,0,0,.12);
      --surface: #ffffff;
      --text: #0f172a;
      --text-sub: #475569;
      --brand: #4f46e5;
      --ok: #10b981;
      --warn: #f59e0b;
      --accent: #38bdf8;
      /* paleta pastel por sección */
      --planta-grad-a:#c8d4ff; --planta-grad-b:#e8f0ff;
      --tareas-grad-a:#ffd7c2; --tareas-grad-b:#fff1e6;
      --directorio-grad-a:#c9f1ff; --directorio-grad-b:#e9fbff;
      --biblioteca-grad-a:#e6d9ff; --biblioteca-grad-b:#f5efff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--surface); color:var(--text);
      font: 400 clamp(15px, 1.5vw, 17px)/1.65 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      -webkit-tap-highlight-color: transparent;
    }
    .app{
      min-height:100dvh; padding-bottom: calc(var(--bottomnav) + env(safe-area-inset-bottom) + 24px);
    }
    /* Appbar superior */
    .appbar{
      position: sticky; top:0; z-index: 50;
      height: var(--appbar-h); background: #fff; border-bottom: 1px solid rgba(15,23,42,.06);
      display:flex; align-items:center; justify-content:space-between; padding:0 12px; gap:8px;
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .appbar h1{
      font-size: clamp(17px,1.8vw,20px);
      margin:0; font-weight: 700; letter-spacing:.2px;
    }
    .user-actions{display:flex; gap:8px; align-items:center}
    .btn{
      height:40px; min-width:40px; padding:0 14px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid rgba(15,23,42,.08); background:#fff; color:var(--text);
      border-radius: 999px; box-shadow: var(--shadow-soft);
      font-weight:600; cursor:pointer;
    }
    .btn:focus-visible{outline:3px solid #9dd6ff; outline-offset:2px}
    .btn.icon{min-width:40px; padding:0}
    /* Header “glass-metal” por sección (sin z-fight) */
    .section{
      padding: 16px clamp(12px,2.4vw,20px) 24px;
    }
    .hdr{
      position: relative; border-radius: var(--radius-2xl);
      padding: 18px 16px; overflow: clip; isolation:isolate; /* evita stacking extra sin transform/filter */
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.75), var(--shadow-soft);
    }
    .hdr::before{ /* banda cromática */
      content:""; position:absolute; inset:0; z-index:0;
      background: linear-gradient(135deg, var(--grad-a), var(--grad-b));
    }
    .hdr::after{ /* rim-light + glow frame interior */
      content:""; position:absolute; inset:0; z-index:0;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.85),
        inset 0 -1px 0 rgba(255,255,255,.55),
        inset 0 0 24px rgba(255,255,255,.45);
      outline: 1px solid rgba(255,255,255,.6);
      outline-offset: -6px;
      border-radius: inherit;
    }
    .hdr h2, .hdr .sub, .hdr .chips{position:relative; z-index:1}
    .hdr h2{
      margin:0 0 6px; font-weight: 800; letter-spacing:.2px;
      font-size: clamp(18px,2vw,22px);
      color: #0b1220; text-shadow: 0 1px 0 rgba(255,255,255,.85);
    }
    .sub{color:#1e293b; opacity:.9; font-weight:600}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9em;
      background: rgba(255,255,255,.75); border:1px solid rgba(15,23,42,.08); backdrop-filter: blur(4px);
    }
    /* Toolbars */
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin: 12px 0}
    .toolbar .grow{flex:1 1 280px}
    .input, input[type="search"]{
      height: 48px; padding: 0 14px; border-radius: 12px; width:100%;
      border:1px solid rgba(15,23,42,.12); background:#fff; box-shadow: var(--shadow-soft);
      font: inherit;
    }
    .input:focus-visible, input[type="search"]:focus-visible{outline:3px solid #9dd6ff; outline-offset:2px}
    /* Paneles */
    .panel{display:none}
    .panel[aria-hidden="false"]{display:block}
    /* Directorio — A-Z y secciones */
    .dir-wrap{position:relative}
    .az{
      position: sticky; top: calc(var(--appbar-h) + 12px);
      float: right; width: 44px; z-index: 5; /* por encima de contenido, por debajo de appbar */
      display:flex; flex-direction:column; align-items:center; gap:2px; user-select:none;
    }
    .az a{
      width:100%; height:28px; display:flex; align-items:center; justify-content:center;
      border-radius:8px; font-weight:800; color:#334155; text-decoration:none;
      border:1px solid transparent;
    }
    .az a:focus-visible{outline:3px solid #9dd6ff; outline-offset:2px}
    .dir-list{margin-right: 52px} /* deja sitio a la columna A-Z */
    .section-tag{
      position: sticky; top: calc(var(--appbar-h) + 8px);
      background:#fff; border-bottom:1px solid rgba(15,23,42,.08);
      padding:10px 8px; font-weight:900; letter-spacing:.4px; z-index:1;
    }
    section[id^="sec-"]{scroll-margin-top: calc(var(--appbar-h) + 60px)}
    .card{
      border:1px solid rgba(15,23,42,.08); border-radius: 14px; padding: 12px;
      margin: 8px 0; box-shadow: var(--shadow-soft); background:#fff;
    }
    /* FAB Emergencias */
    .fab{
      position: fixed; right: 16px; z-index: 60;
      bottom: calc(16px + var(--bottomnav) + env(safe-area-inset-bottom));
      width: 60px; height: 60px; border-radius: 999px;
      background: linear-gradient(135deg,#ff7a7a,#ffb199); color:#fff;
      border:0; box-shadow: 0 6px 18px rgba(255,122,122,.35), var(--shadow-heavy);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .fab:focus-visible{outline:3px solid rgba(255,187,187,.8); outline-offset:2px}
    /* Sheet emergencias */
    .sheet{
      position: fixed; inset: 0; z-index: 80; display:none;
      background: rgba(15,23,42,.28);
    }
    .sheet[open]{display:block}
    .sheet .panel{
      position: absolute; right:0; bottom:0; left:0;
      background:#fff; border-radius: 20px 20px 0 0; padding: 16px;
      box-shadow: var(--shadow-heavy); max-height: 80dvh; overflow:auto;
    }
    .sheet h3{margin:0 0 8px; font-size: clamp(16px,1.8vw,19px)}
    .list{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center}
    .list .row{display:contents}
    .muted{color:var(--text-sub); font-weight:600}
    .row .del{border:none; background:#ffeeee; color:#b42318; border-radius:10px; height:40px; padding:0 10px; cursor:pointer}
    /* Bottom navigation */
    .bottom{
      position: fixed; left:0; right:0; bottom:0; z-index: 70;
      height: calc(var(--bottomnav) + env(safe-area-inset-bottom));
      background: #fff; border-top:1px solid rgba(15,23,42,.08);
      display:flex; align-items:center; padding: 0 10px calc(env(safe-area-inset-bottom));
      gap: 12px;
    }
    .tablist{display:flex; gap:8px}
    .tab{
      width:58px; height:58px; border-radius:14px;
      border:1px solid rgba(15,23,42,.08); background:#fff; box-shadow: var(--shadow-soft);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .tab[aria-selected="true"]{border-color: rgba(79,70,229,.35); box-shadow: 0 0 0 3px rgba(79,70,229,.15), var(--shadow-soft)}
    .divider{flex:1; height:1px; background: linear-gradient(90deg, rgba(15,23,42,.12), rgba(15,23,42,.04)); margin:0 8px}
    .active-chip{
      height:44px; padding:0 14px; border-radius:999px; background:#f8fafc; border:1px solid rgba(15,23,42,.08);
      font-weight:800; display:inline-flex; align-items:center; gap:8px; white-space:nowrap; max-width: 55vw; overflow:hidden; text-overflow:ellipsis;
    }
    /* Iconos inline: aseguran peso y consistencia */
    .icon{width:28px; height:28px}
    .tab .icon{transform: scale(1.3);} /* +30% respecto a iteración previa */
    /* Responsivo toolbars Directorio */
    @media (max-width: 720px){
      .toolbar{flex-direction:column}
      .toolbar .grow{flex-basis:100%}
    }
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior: auto !important; animation: none !important; transition:none !important}
    }
    /* Focus */
    :focus-visible{scroll-margin-top: calc(var(--appbar-h) + 24px)}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Appbar -->
    <header class="appbar" role="banner" aria-label="Barra de la aplicación">
      <h1 id="title">Planta</h1>
      <div class="user-actions">
        <button class="btn icon" id="btnLogin" aria-label="Iniciar sesión Google" title="Iniciar sesión">
          <!-- user icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </header>

    <main id="main" role="main">
      <!-- PLANTA -->
      <section id="panel-planta" class="panel section" aria-hidden="false">
        <header class="hdr" style="--grad-a:var(--planta-grad-a);--grad-b:var(--planta-grad-b)">
          <h2>Planta / Interconsultas</h2>
          <div class="sub">Gestión de habitaciones y estado del día</div>
          <div class="chips">
            <span class="chip" id="chipPlanta">Habitaciones: 0</span>
            <span class="chip" id="chipInter">Interconsultas: 0</span>
            <span class="chip" id="chipCompletados">Completados: 0</span>
          </div>
        </header>

        <div class="toolbar">
          <div class="grow"><input class="input" type="search" placeholder="Buscar habitación o paciente…" aria-label="Buscar en planta"></div>
          <button class="btn" id="btnAddRoom">Añadir habitación</button>
          <button class="btn" id="btnToggleView" title="Cambiar Planta/Interconsulta" aria-label="Cambiar lista">↺ Cambiar vista</button>
        </div>

        <div id="plantaList" class="card">Sin datos aún.</div>
      </section>

      <!-- TAREAS -->
      <section id="panel-tareas" class="panel section" aria-hidden="true">
        <header class="hdr" style="--grad-a:var(--tareas-grad-a);--grad-b:var(--tareas-grad-b)">
          <h2>Tareas</h2>
          <div class="sub">Activas por fecha (rojo = próximas / urgente; verde = completadas o lejanas)</div>
          <div class="chips">
            <span class="chip" id="chipTareasActivas">Activas: 0</span>
            <span class="chip" id="chipTareasHoy">Hoy: 0</span>
          </div>
        </header>

        <div class="toolbar">
          <div class="grow"><input class="input" type="search" placeholder="Buscar tarea…" aria-label="Buscar en tareas"></div>
          <button class="btn" id="btnNuevaTarea">Nueva tarea</button>
          <button class="btn" id="btnPapeles">Papelera</button>
        </div>

        <div id="tareasList" class="card">Sin tareas por ahora.</div>
      </section>

      <!-- DIRECTORIO -->
      <section id="panel-directorio" class="panel section" aria-hidden="true">
        <header class="hdr" style="--grad-a:var(--directorio-grad-a);--grad-b:var(--directorio-grad-b)">
          <h2>Directorio telefónico</h2>
          <div class="sub">Importa/Exporta JSON — A-Z sticky — Búsqueda full-width en móvil</div>
          <div class="chips">
            <span class="chip" id="chipDir">Contactos: 0</span>
          </div>
        </header>

        <div class="toolbar">
          <div class="grow"><input id="searchDir" class="input" type="search" placeholder="Buscar nombre o teléfono…" aria-label="Buscar en directorio"></div>
          <button class="btn" id="btnImport">Importar JSON</button>
          <button class="btn" id="btnExport">Exportar JSON</button>
        </div>

        <div class="dir-wrap">
          <nav class="az" aria-label="Índice alfabético">
            <!-- generado por JS -->
          </nav>

          <div class="dir-list" id="dirList" role="list">
            <!-- Secciones A-Z -->
          </div>
        </div>
      </section>

      <!-- BIBLIOTECA -->
      <section id="panel-biblioteca" class="panel section" aria-hidden="true">
        <header class="hdr" style="--grad-a:var(--biblioteca-grad-a);--grad-b:var(--biblioteca-grad-b)">
          <h2>Biblioteca</h2>
          <div class="sub">Notas personales, visor PDF y enlaces guardados</div>
          <div class="chips">
            <span class="chip" id="chipLib">Ítems: 0</span>
          </div>
        </header>

        <div class="toolbar">
          <div class="grow"><input class="input" type="search" placeholder="Buscar en biblioteca…" aria-label="Buscar en biblioteca"></div>
          <button class="btn" id="btnNuevoItem">Nuevo</button>
          <button class="btn" id="btnAbrirRuta" title="Abrir archivo o ruta del dispositivo">Abrir archivo/ruta</button>
        </div>

        <div id="libList" class="card">Tu biblioteca aparecerá aquí.</div>
      </section>
    </main>

    <!-- FAB Emergencias -->
    <button class="fab" id="fabEmergencias" aria-haspopup="dialog" aria-controls="sheetEmergencias" aria-label="Abrir Emergencias">SOS</button>

    <!-- Sheet Emergencias -->
    <div class="sheet" id="sheetEmergencias" role="dialog" aria-modal="true" aria-labelledby="emgTitle">
      <div class="panel">
        <h3 id="emgTitle">Emergencias</h3>
        <div class="toolbar" role="group" aria-label="Controles de emergencias">
          <div class="grow"><input id="emgSearch" class="input" type="search" placeholder="Buscar emergencias…" aria-label="Buscar en emergencias"></div>
          <button class="btn" id="emgCfg">⚙ Configurar</button>
          <button class="btn" id="emgCerrar">Cerrar</button>
        </div>
        <div id="emgList" class="list" aria-live="polite"></div>

        <details id="emgConfigArea" style="margin-top:12px">
          <summary class="btn" style="display:inline-flex">Configuración avanzada</summary>
          <div class="card">
            <div class="toolbar">
              <div class="muted">Selección múltiple (página)</div>
              <button class="btn" id="selAll">Seleccionar todo</button>
              <button class="btn" id="selNone">Ninguno</button>
              <button class="btn" id="delSel" style="background:#ffeeee;color:#b42318">Borrar seleccionados</button>
            </div>
            <form id="emgAlta" class="toolbar" autocomplete="off">
              <input class="input" name="nombre" placeholder="Nombre" required style="flex:1 1 220px">
              <input class="input" name="telefono" placeholder="Teléfono" required style="flex:1 1 180px" inputmode="tel" pattern="[0-9+\s()-]{6,}">
              <button class="btn" type="submit">Añadir</button>
            </form>
            <div class="toolbar">
              <span class="muted">Página:</span>
              <button class="btn" id="prevPage" type="button">Anterior</button>
              <button class="btn" id="nextPage" type="button">Siguiente</button>
              <span class="muted" id="pageInfo">1 / 1</span>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Bottom Navigation única -->
    <nav class="bottom" aria-label="Navegación inferior">
      <div class="tablist" role="tablist" aria-label="Secciones">
        <button class="tab" role="tab" aria-label="Planta" data-target="planta" aria-selected="true" tabindex="0">
          <!-- Estetoscopio -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#99a8ff"/><stop offset="1" stop-color="#c6d2ff"/>
              </linearGradient>
            </defs>
            <path d="M6 3v5a4 4 0 0 0 8 0V3" stroke="url(#g1)" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 3h6M15 3h6" stroke="#0f172a" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M14 12a5 5 0 1 0 10 0 2 2 0 0 0-4 0 1 1 0 0 1-2 0" stroke="#0f172a" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="tab" role="tab" aria-label="Tareas" data-target="tareas" aria-selected="false" tabindex="-1">
          <!-- Herramientas -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <defs><linearGradient id="g2" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#ffd1b3"/><stop offset="1" stop-color="#ffe8d9"/></linearGradient></defs>
            <path d="M3 21l6-6M7 7l4 4" stroke="#0f172a" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M6 3a4 4 0 0 1 4 4l9 9a3 3 0 0 1-4 4l-9-9A4 4 0 0 1 6 3Z" stroke="url(#g2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="tab" role="tab" aria-label="Directorio" data-target="directorio" aria-selected="false" tabindex="-1">
          <!-- Handset -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <defs><linearGradient id="g3" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#bfefff"/><stop offset="1" stop-color="#e5fbff"/></linearGradient></defs>
            <path d="M4 5c3 5 7 9 12 12l2-2a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2C10 21 3 14 2 6a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2l-2 2Z" stroke="url(#g3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="tab" role="tab" aria-label="Biblioteca" data-target="biblioteca" aria-selected="false" tabindex="-1">
          <!-- Libros -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <defs><linearGradient id="g4" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#e7dbff"/><stop offset="1" stop-color="#f5efff"/></linearGradient></defs>
            <path d="M4 5h6a2 2 0 0 1 2 2v12H6a2 2 0 0 1-2-2V5Z" stroke="url(#g4)" stroke-width="2" stroke-linejoin="round"/>
            <path d="M12 7a2 2 0 0 1 2-2h6v14a2 2 0 0 1-2 2h-6" stroke="#0f172a" stroke-width="1.8" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="divider" aria-hidden="true"></div>
      <div class="active-chip" id="activeChip" aria-live="polite">Planta</div>
    </nav>
  </div>

  <script type="module">
    /************
     * Firebase *
     ************/
    // Mantiene rutas/APIs intactas: usa tu firebase-config.js existente
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const btnLogin = document.getElementById('btnLogin');
    let user = null;

    onAuthStateChanged(auth, (u)=>{
      user = u || null;
      btnLogin.title = user ? `Cerrar sesión (${user.displayName||user.email})` : 'Iniciar sesión';
    });

    btnLogin.addEventListener('click', async ()=>{
      if(!user){
        try{
          const prov = new GoogleAuthProvider();
          await signInWithPopup(auth, prov);
        }catch(e){ console.error(e); }
      }else{
        try{ await signOut(auth); }catch(e){ console.error(e); }
      }
    });

    /*********************
     * Navegación inferior
     *********************/
    const TABS = ['planta','tareas','directorio','biblioteca'];
    const tabBtns = [...document.querySelectorAll('.tab[role="tab"]')];
    const panels = {
      planta: document.getElementById('panel-planta'),
      tareas: document.getElementById('panel-tareas'),
      directorio: document.getElementById('panel-directorio'),
      biblioteca: document.getElementById('panel-biblioteca')
    };
    const title = document.getElementById('title');
    const activeChip = document.getElementById('activeChip');

    const labels = {planta:'Planta', tareas:'Tareas', directorio:'Directorio', biblioteca:'Biblioteca'};
    let active = 'planta';

    function setActive(key){
      if(!panels[key]) return;
      active = key;
      // ARIA / visibilidad
      for(const k of TABS){
        panels[k].setAttribute('aria-hidden', String(k!==key));
      }
      tabBtns.forEach(b=>{
        const on = b.dataset.target===key;
        b.setAttribute('aria-selected', String(on));
        b.tabIndex = on ? 0 : -1;
      });
      // Título + chip
      title.textContent = labels[key];
      activeChip.textContent = labels[key];
      // Scroll decente
      panels[key].scrollIntoView({block:'start', behavior:'smooth'});
      // Foco accesible al tab activo
      const btn = tabBtns.find(b=>b.dataset.target===key);
      if(btn) btn.focus({preventScroll:true});
    }

    tabBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> setActive(btn.dataset.target));
      btn.addEventListener('keydown', (e)=>{
        const i = TABS.indexOf(active);
        if(e.key==='ArrowRight'){ e.preventDefault(); setActive(TABS[(i+1)%TABS.length]); }
        else if(e.key==='ArrowLeft'){ e.preventDefault(); setActive(TABS[(i-1+TABS.length)%TABS.length]); }
        else if(e.key==='Home'){ e.preventDefault(); setActive(TABS[0]); }
        else if(e.key==='End'){ e.preventDefault(); setActive(TABS[TABS.length-1]); }
      });
    });

    /*****************
     * Directorio A-Z
     *****************/
    const dirList = document.getElementById('dirList');
    const az = document.querySelector('.az');
    const searchDir = document.getElementById('searchDir');
    const chipDir = document.getElementById('chipDir');

    // Datos mock locales (manteniendo tu integración real tal como está)
    const contacts = (JSON.parse(localStorage.getItem('aurora_dir')))||[
      {n:'Admisión', t:'+34 968 000 001'}, {n:'Anestesia', t:'+34 968 000 002'},
      {n:'Cirugía', t:'+34 968 000 101'}, {n:'Farmacia', t:'+34 968 000 210'},
      {n:'UCI', t:'+34 968 000 900'}, {n:'Urgencias', t:'+34 968 000 112'},
    ];

    function indexByLetter(list){
      const map = {};
      for(const c of list){
        const L = (c.n?.[0]||'#').toUpperCase();
        const key = /[A-ZÁÉÍÓÚÑ]/.test(L) ? L.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : '#';
        (map[key] ||= []).push(c);
      }
      // Orden alfabético con # al final
      const keys = Object.keys(map).sort((a,b)=>{
        if(a==='#') return 1;
        if(b==='#') return -1;
        return a.localeCompare(b, 'es');
      });
      return {map, keys};
    }

    function renderAZ(keys){
      az.innerHTML = '';
      for(const k of keys){
        const a = document.createElement('a');
        a.href = `#sec-${k}`;
        a.textContent = k;
        a.setAttribute('role','link');
        az.appendChild(a);
      }
    }

    function renderDirectory(query=''){
      const q = query.trim().toLowerCase();
      const filtered = q ? contacts.filter(c=> (c.n||'').toLowerCase().includes(q) || (c.t||'').toLowerCase().includes(q)) : contacts.slice();
      chipDir.textContent = `Contactos: ${filtered.length}`;
      const {map, keys} = indexByLetter(filtered);
      renderAZ(keys);
      dirList.innerHTML = '';
      for(const k of keys){
        const sec = document.createElement('section'); sec.id = `sec-${k}`;
        const tag = document.createElement('div'); tag.className='section-tag'; tag.textContent = k;
        sec.appendChild(tag);
        for(const c of map[k]){
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `<strong>${c.n}</strong><br><span class="muted">${c.t}</span>`;
          sec.appendChild(card);
        }
        dirList.appendChild(sec);
      }
      localStorage.setItem('aurora_dir', JSON.stringify(contacts));
    }

    searchDir.addEventListener('input', e=> renderDirectory(e.target.value));
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(contacts, null, 2)], {type:'application/json'});
      const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download:'directorio.json'});
      a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    });
    document.getElementById('btnImport').addEventListener('click', async ()=>{
      const inp = Object.assign(document.createElement('input'), {type:'file', accept:'application/json'});
      inp.onchange = async ()=>{
        const file = inp.files?.[0]; if(!file) return;
        const txt = await file.text();
        try{
          const arr = JSON.parse(txt);
          if(Array.isArray(arr)){ contacts.splice(0, contacts.length, ...arr); renderDirectory(searchDir.value||''); }
        }catch(e){ console.error(e) }
      };
      inp.click();
    });

    /***********************
     * FAB y panel Emergencias
     ***********************/
    const fab = document.getElementById('fabEmergencias');
    const sheet = document.getElementById('sheetEmergencias');
    const emgList = document.getElementById('emgList');
    const emgSearch = document.getElementById('emgSearch');
    const emgCfgBtn = document.getElementById('emgCfg');
    const emgCfgArea = document.getElementById('emgConfigArea');
    const pageInfo = document.getElementById('pageInfo');

    const emgSelAll = document.getElementById('selAll');
    const emgSelNone = document.getElementById('selNone');
    const emgDelSel = document.getElementById('delSel');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const emgCerrar = document.getElementById('emgCerrar');

    const emgAlta = document.getElementById('emgAlta');

    const normalizePhone = (t)=> (t||'').replace(/[^\d+]/g,'').replace(/^00/, '+');

    const EMG_PAGE = 50;
    const emergencias = JSON.parse(localStorage.getItem('aurora_emg')) || [
      {n:'Código Sepsis', t:'+34 968 000 113'},
      {n:'Código Ictus', t:'+34 968 000 114'},
      {n:'Prevención Riesgos', t:'+34 968 000 200'},
      {n:'Seguridad', t:'+34 968 000 300'}
    ];
    let emgPage = 1;
    let emgQuery = '';
    let emgChecked = new Set();

    function filteredEmg(){
      const q = emgQuery.trim().toLowerCase();
      return q ? emergencias.filter(e=> (e.n||'').toLowerCase().includes(q) || (e.t||'').toLowerCase().includes(q)) : emergencias.slice();
    }
    function totalPages(){ return Math.max(1, Math.ceil(filteredEmg().length / EMG_PAGE)); }

    function renderEmg(){
      const data = filteredEmg();
      const pages = totalPages();
      if(emgPage>pages) emgPage = pages;
      const start = (emgPage-1)*EMG_PAGE, end = start+EMG_PAGE;
      const slice = data.slice(start, end);

      emgList.innerHTML = '';
      for(const e of slice){
        const id = normalizePhone(e.t)+'_'+(e.n||'');
        const row = document.createElement('div'); row.className='row';
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" data-id="${id}" ${emgChecked.has(id)?'checked':''} style="margin-right:10px"> <strong>${e.n}</strong><br><span class="muted">${e.t}</span>`;
        const del = document.createElement('button'); del.className='del'; del.textContent='Borrar';
        del.addEventListener('click', ()=>{
          const idx = emergencias.findIndex(x=> normalizePhone(x.t)===normalizePhone(e.t) && x.n===e.n);
          if(idx>-1){ emergencias.splice(idx,1); persistEmg(); emgChecked.delete(id); renderEmg(); }
        });
        emgList.append(label, del);
      }
      pageInfo.textContent = `${emgPage} / ${pages}`;
    }
    function persistEmg(){ localStorage.setItem('aurora_emg', JSON.stringify(emergencias)); }

    fab.addEventListener('click', ()=>{
      sheet.setAttribute('open','');
      emgCfgArea.open = false;
      renderEmg();
      sheet.querySelector('.panel').scrollTop = 0;
    });
    emgCerrar.addEventListener('click', ()=> sheet.removeAttribute('open'));
    sheet.addEventListener('click', (e)=>{ if(e.target===sheet) sheet.removeAttribute('open') });

    emgSearch.addEventListener('input', (e)=>{ emgQuery = e.target.value; emgPage=1; renderEmg(); });
    emgCfgBtn.addEventListener('click', ()=> emgCfgArea.open = !emgCfgArea.open);

    prevPage.addEventListener('click', ()=> { emgPage = Math.max(1, emgPage-1); renderEmg(); });
    nextPage.addEventListener('click', ()=> { emgPage = Math.min(totalPages(), emgPage+1); renderEmg(); });

    emgSelAll.addEventListener('click', ()=>{
      const data = filteredEmg(); const start = (emgPage-1)*EMG_PAGE, end = start+EMG_PAGE;
      for(const e of data.slice(start,end)){
        emgChecked.add(normalizePhone(e.t)+'_'+(e.n||''));
      }
      renderEmg();
    });
    emgSelNone.addEventListener('click', ()=>{
      const data = filteredEmg(); const start = (emgPage-1)*EMG_PAGE, end = start+EMG_PAGE;
      for(const e of data.slice(start,end)){
        emgChecked.delete(normalizePhone(e.t)+'_'+(e.n||''));
      }
      renderEmg();
    });
    emgDelSel.addEventListener('click', ()=>{
      const toKeep = emergencias.filter(e=> !emgChecked.has(normalizePhone(e.t)+'_'+(e.n||'')));
      emergencias.splice(0, emergencias.length, ...toKeep);
      emgChecked.clear(); persistEmg(); renderEmg();
    });

    emgList.addEventListener('change', (e)=>{
      if(e.target?.type==='checkbox'){
        const id = e.target.getAttribute('data-id');
        if(e.target.checked) emgChecked.add(id); else emgChecked.delete(id);
      }
    });

    emgAlta.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(emgAlta);
      const n = String(fd.get('nombre')||'').trim();
      const t = normalizePhone(String(fd.get('telefono')||'').trim());
      if(!n || !t) return;
      // evita duplicados por teléfono normalizado
      if(!emergencias.some(x=> normalizePhone(x.t)===t)){
        emergencias.push({n, t}); persistEmg(); emgQuery=''; emgSearch.value=''; emgPage = totalPages(); renderEmg();
        emgAlta.reset();
      }
    });

    /***********************
     * Planta / Tareas / Lib
     * (placeholder funcional con contadores y estados)
     ***********************/
    const chipPlanta = document.getElementById('chipPlanta');
    const chipInter = document.getElementById('chipInter');
    const chipCompletados = document.getElementById('chipCompletados');
    const plantaList = document.getElementById('plantaList');
    const rooms = JSON.parse(localStorage.getItem('aurora_rooms'))||[];
    function renderRooms(){
      chipPlanta.textContent = `Habitaciones: ${rooms.length}`;
      chipInter.textContent = `Interconsultas: ${Math.floor(rooms.length/3)}`;
      chipCompletados.textContent = `Completados: ${Math.floor(rooms.length/4)}`;
      if(!rooms.length){ plantaList.textContent = 'Sin datos aún.'; return;}
      plantaList.innerHTML = '';
      for(const r of rooms){
        const c = document.createElement('div'); c.className='card';
        c.innerHTML = `<strong>Hab. ${r.num}</strong> — <span class="muted">${r.tipo||'Planta'}</span>`;
        plantaList.appendChild(c);
      }
      localStorage.setItem('aurora_rooms', JSON.stringify(rooms));
    }
    document.getElementById('btnAddRoom').addEventListener('click', ()=>{
      const num = prompt('Número de habitación'); if(!num) return;
      rooms.push({num: num.replace(/[^\d]/g,''), tipo: 'Planta'});
      renderRooms();
    });
    document.getElementById('btnToggleView').addEventListener('click', ()=>{
      rooms.forEach(r=> r.tipo = r.tipo==='Planta' ? 'Interconsulta' : 'Planta'); renderRooms();
    });

    const chipTareasActivas = document.getElementById('chipTareasActivas');
    const chipTareasHoy = document.getElementById('chipTareasHoy');
    const tareasList = document.getElementById('tareasList');
    const tareas = JSON.parse(localStorage.getItem('aurora_tasks'))||[];
    function renderTareas(){
      chipTareasActivas.textContent = `Activas: ${tareas.length}`;
      const hoy = new Date().toISOString().slice(0,10);
      chipTareasHoy.textContent = `Hoy: ${tareas.filter(t=>t.fecha===hoy).length}`;
      tareasList.innerHTML = tareas.length? '' : 'Sin tareas por ahora.';
      for(const t of tareas){
        const c = document.createElement('div'); c.className='card';
        c.innerHTML = `<strong>${t.txt}</strong><br><span class="muted">${t.fecha}</span>`;
        tareasList.appendChild(c);
      }
      localStorage.setItem('aurora_tasks', JSON.stringify(tareas));
    }
    document.getElementById('btnNuevaTarea').addEventListener('click', ()=>{
      const txt = prompt('Tarea'); if(!txt) return;
      const fecha = prompt('Fecha (YYYY-MM-DD)', new Date().toISOString().slice(0,10))||'';
      tareas.push({txt, fecha}); renderTareas();
    });

    const libList = document.getElementById('libList');
    const chipLib = document.getElementById('chipLib');
    const lib = JSON.parse(localStorage.getItem('aurora_lib'))||[];
    function renderLib(){
      chipLib.textContent = `Ítems: ${lib.length}`;
      libList.innerHTML = lib.length? '' : 'Tu biblioteca aparecerá aquí.';
      for(const it of lib){
        const c = document.createElement('div'); c.className='card';
        c.innerHTML = `<strong>${it.tit}</strong><br><span class="muted">${it.tipo||'nota'}</span>`;
        libList.appendChild(c);
      }
      localStorage.setItem('aurora_lib', JSON.stringify(lib));
    }
    document.getElementById('btnNuevoItem').addEventListener('click', ()=>{
      const tit = prompt('Título'); if(!tit) return;
      lib.push({tit, tipo:'nota'}); renderLib();
    });
    document.getElementById('btnAbrirRuta').addEventListener('click', ()=>{
      alert('Abrir archivo/ruta: usa el selector del sistema.\n(Placeholder seguro en PWA).');
    });

    /****************
     * QA inicial & SW
     ****************/
    function boot(){
      renderDirectory('');
      renderRooms();
      renderTareas();
      renderLib();
      // Garantiza que Biblioteca aparece en la barra y conmuta panel
      setActive('planta');
    }
    boot();

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    }
  </script>
</body>
</html>
