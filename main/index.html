<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="white" />
  <title>Aurora UI — PWA Infecciosas (vFinal)</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      /* Base */
      --bg:#ffffff; --surface:#FFFFFC; --card:#ffffff; --text:#0b0f18; --muted:#5c6470;
      /* Paleta usuario */
      --rose-300:#FFADAD; --peach-300:#FFD6A5; --yell-200:#FDFFB6; --mint-200:#CAFFBF;
      --cyan-200:#9BF6FF; --corn-200:#A0C4FF; --lila-200:#BDB2FF; --pink-200:#FFC6FF;
      /* Derivados accesibles (AAA aplicado) */
      --brand-50:#E6F0FF; --brand-200:var(--corn-200);
      --brand-500:#3D7BEB;        /* AA */
      --brand-600:#245AC9;        /* AA+ reforzado */
      --brand-700:#1E4FB5;        /* AAA con texto #fff */

      /* Acentos por sección */
      --accent-planta:var(--mint-200);
      --accent-tareas:var(--peach-300);
      --accent-directorio:var(--corn-200);
      --accent-biblioteca:var(--lila-200);

      /* Componentes */
      --chip:#f5f7fb; --divider:#e9edf3; --shadow:0 2px 12px rgba(0,0,0,.06);

      /* Tipografía fluida */
      --font-base:clamp(16px,1.0vw + 0.6rem,20px);
      --font-sm:clamp(14px,0.7vw + 0.45rem,18px);
      --font-lg:clamp(20px,1.5vw + 0.8rem,28px);
      --font-xl:clamp(24px,2vw + 1rem,34px);

      --radius-xl:20px; --radius-lg:16px; --radius-md:12px; --radius-sm:10px;
      --pad:clamp(12px,1.2vw,18px); --pad-lg:clamp(16px,1.8vw,24px);

      --duration:120ms; --ease:cubic-bezier(.2,.7,.2,1);
    }

    html, body { background:#fff !important; }
    * { box-sizing:border-box; }
    body{
      margin:0; color:var(--text); background:var(--bg);
      font:400 var(--font-base)/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{ min-height:100svh; display:flex; flex-direction:column; gap:0; container-type:inline-size; }

    /* Reduce motion: respeta preferencias del usuario */
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important; }
    }

    header{ position:sticky; top:0; z-index:5; background:var(--bg); border-bottom:1px solid var(--divider); backdrop-filter:saturate(1.1); }
    .topbar{ display:flex; align-items:center; gap:12px; padding: env(safe-area-inset-top) var(--pad) var(--pad); }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--brand-600),var(--brand-700)); box-shadow:var(--shadow); }
    .title{ font-size:var(--font-lg); font-weight:700; letter-spacing:.2px; }
    .subtitle{ color:var(--muted); font-size:var(--font-sm); }

    .tabs{ display:grid; grid-auto-flow:column; grid-auto-columns:1fr; gap:8px; padding:0 var(--pad) var(--pad); }
    .tab{
      position:relative; padding:10px 14px; text-align:center; border-radius:14px; background:var(--chip); color:var(--text);
      transition:transform var(--duration) var(--ease), background var(--duration) var(--ease), box-shadow var(--duration) var(--ease);
      cursor:pointer; user-select:none; outline:none; border:1px solid transparent;
    }
    .tab[aria-selected="true"]{ background:linear-gradient(180deg,#fff,#f6f8fc); box-shadow:var(--shadow); border-color:#e8eef8; }
    .tab:focus-visible{ border-color:var(--brand-600); box-shadow:0 0 0 3px rgba(36,90,201,.22); }
    .tab:hover{ transform:translateY(-1px); }

    /* Tonos por pestaña ACTIVA */
    #tabPlanta[aria-selected="true"]{ background:linear-gradient(180deg,#fff,var(--accent-planta)); }
    #tabTareas[aria-selected="true"]{ background:linear-gradient(180deg,#fff,var(--accent-tareas)); }
    #tabDirectorio[aria-selected="true"]{ background:linear-gradient(180deg,#fff,var(--accent-directorio)); }
    #tabBiblioteca[aria-selected="true"]{ background:linear-gradient(180deg,#fff,var(--accent-biblioteca)); }

    main{ padding:var(--pad); display:grid; gap:var(--pad-lg); }
    section.view{ display:none; }
    section.view.active{ display:block; }

    .h-stack{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .spacer{ flex:1; }

    .chip{
      background:linear-gradient(180deg,#fff,#f7faff); border-radius:999px; padding:8px 12px; font-size:var(--font-sm);
      display:inline-flex; align-items:center; gap:8px; border:1px solid #ecf0f6; box-shadow:0 1px 4px rgba(0,0,0,.04);
      transition:transform var(--duration) var(--ease), box-shadow var(--duration) var(--ease);
    }
    .chip:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }

    .btn{
      border:1px solid #dfe6f2; border-radius:14px; padding:10px 14px; background:#fff; cursor:pointer;
      transition:transform var(--duration) var(--ease), box-shadow var(--duration) var(--ease), background var(--duration) var(--ease);
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--brand-600), var(--brand-700));
      color:#fff; border-color: transparent;
      text-shadow: 0 1px 0 rgba(0,0,0,.12);
      box-shadow: 0 2px 10px rgba(30,79,181,.15);
    }
    .btn:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(36,90,201,.22); }
    .btn.primary:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(36,90,201,.22), 0 2px 10px rgba(30,79,181,.15); }
    .btn:active{ transform:translateY(0); }

    .card{
      background:var(--card); border:1px solid #eef2f8; border-radius:var(--radius-xl); box-shadow:var(--shadow);
      padding:var(--pad-lg); display:grid; gap:14px;
    }
    .card.soft{ background:var(--surface); }
    .card h3{ margin:0; font-size:var(--font-lg); }
    .divider{ height:1px; background:var(--divider); border-radius:1px; }

    /* ===== PLANTA ===== */
    .room-list{ display:grid; gap:12px; }
    .room{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
      padding:12px 14px; border-radius:var(--radius-lg); border:1px solid #e9eef6; background:#fff; box-shadow:var(--shadow);
      transition:transform var(--duration) var(--ease), box-shadow var(--duration) var(--ease);
    }
    .room:hover{ transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.08); }
    .room-num{
      font-weight:800; font-size:clamp(28px,3.4vw + 1rem,40px); line-height:1; letter-spacing:.3px;
      background:linear-gradient(135deg,var(--brand-700),var(--brand-600)); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .room-badge{ font:600 var(--font-sm)/1 system-ui; color:#2a3240; }
    .room-actions .btn{ padding:8px 10px; }

    .subgrid{ display:grid; gap:14px; grid-template-columns:1fr; }
    @container (min-width:780px){ .subgrid{ grid-template-columns:1fr 1fr; } }

    .section-head{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .section-head .chip{ background:linear-gradient(180deg,#fff,#f6f9ff); }

    /* ===== TAREAS ===== */
    .task-group{ display:grid; gap:10px; }
    .task-date{
      display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:14px;
      background:linear-gradient(180deg,#fff,#f6f9ff); border:1px solid #e6edf8; font-weight:700;
    }
    .task{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:12px;
      padding:10px 12px; border:1px solid #e9eef6; border-radius:14px; background:#fff; box-shadow:var(--shadow);
    }

    /* ===== DIRECTORIO ===== */
    .dir-controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .dir-section{ margin:8px 0 16px 0; border-left:6px solid var(--brand-500); padding-left:12px; }
    .dir-section h4{
      margin:0 0 8px 0; font-size:var(--font-base); letter-spacing:.2px;
      position:sticky; top:8px; z-index:1; background:var(--surface);
      padding:6px 8px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,.05); border:1px solid #eef2f8;
    }
    .dir-divider{
      height:10px; background:linear-gradient(90deg,var(--brand-700),var(--brand-200));
      border-radius:999px; margin:10px 0 16px 0; opacity:.20;
    }
    .contact{
      display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid #e9eef6; border-radius:14px; background:#fff; box-shadow:var(--shadow);
    }
    .contact small{ color:var(--muted); }

    /* ===== BIBLIOTECA ===== */
    .lib-form{ display:grid; gap:10px; grid-template-columns:1fr 2fr auto; }
    .lib-list{ display:grid; gap:10px; }
    .lib-link a{ word-break:break-all; }

    /* A11y foco */
    a,button,input,select,textarea{ accent-color:var(--brand-600); }
    input,select,textarea{
      border:1px solid #dfe6f2; border-radius:12px; padding:10px 12px; background:#fff; color:var(--text);
      transition:box-shadow var(--duration) var(--ease), border var(--duration) var(--ease);
      font-size:var(--font-base);
    }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:var(--brand-600); box-shadow:0 0 0 3px rgba(36,90,201,.22); }

    /* Evitar scroll lateral */
    html, body, .app{ overflow-x:hidden; }

    /* Visually hidden utility (para etiquetas accesibles si hiciera falta) */
    .sr-only{ position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }
  </style>
</head>
<body>
<noscript><p style="padding:12px;color:#b00020">Esta app necesita JavaScript para funcionar.</p></noscript>
<div class="app" id="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Aurora UI · Infecciosas</div>
          <div class="subtitle">PWA · Fondo 100% blanco · vFinal</div>
        </div>
      </div>
      <div class="spacer"></div>
      <button id="loginBtn" class="btn" type="button">Acceder</button>
      <button id="logoutBtn" class="btn" type="button" style="display:none">Salir</button>
    </div>

    <!-- Tabs accesibles con teclado -->
    <nav class="tabs" role="tablist" aria-label="Secciones" aria-orientation="horizontal">
      <button class="tab" role="tab" id="tabPlanta" aria-controls="plantaView"
              aria-selected="true" aria-current="page" tabindex="0" type="button">Planta</button>
      <button class="tab" role="tab" id="tabTareas" aria-controls="tareasView"
              aria-selected="false" tabindex="-1" type="button">Tareas</button>
      <button class="tab" role="tab" id="tabDirectorio" aria-controls="directorioView"
              aria-selected="false" tabindex="-1" type="button">Directorio</button>
      <button class="tab" role="tab" id="tabBiblioteca" aria-controls="bibliotecaView"
              aria-selected="false" tabindex="-1" type="button">Biblioteca</button>
    </nav>
  </header>

  <main>
    <!-- PLANTA -->
    <section id="plantaView" class="view active" role="tabpanel" aria-labelledby="tabPlanta">
      <div class="card">
        <div class="section-head">
          <h3>Planta</h3>
          <span class="chip">UI Premium</span>
          <div class="spacer"></div>
          <button class="btn primary" id="addRoomBtn" type="button">Añadir habitación</button>
        </div>

        <div class="subgrid">
          <div class="card">
            <div class="section-head">
              <strong>Planta</strong>
              <div class="spacer"></div>
              <label for="roomFilter" class="sr-only">Filtrar habitaciones</label>
              <input id="roomFilter" placeholder="Filtrar por nº o texto…" aria-label="Filtrar habitaciones" />
            </div>
            <div id="roomList" class="room-list" aria-live="polite"></div>
          </div>

          <div class="card">
            <div class="section-head"><strong>Interconsultas</strong></div>
            <div id="icList" class="room-list" aria-live="polite"></div>
          </div>
        </div>

        <div class="card">
          <div class="section-head"><strong>Completados</strong></div>
          <div id="doneList" class="room-list" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- TAREAS -->
    <section id="tareasView" class="view" role="tabpanel" aria-labelledby="tabTareas">
      <div class="card">
        <div class="section-head">
          <h3>Tareas</h3>
          <div class="spacer"></div>
          <button class="btn primary" id="addTaskBtn" type="button">Añadir tarea</button>
        </div>
        <div id="taskGroups" class="task-groups"></div>
      </div>
    </section>

    <!-- DIRECTORIO -->
    <section id="directorioView" class="view" role="tabpanel" aria-labelledby="tabDirectorio">
      <div class="card soft">
        <div class="section-head">
          <h3>Directorio telefónico</h3>
          <div class="spacer"></div>
          <div class="h-stack dir-controls">
            <label for="importJson" class="sr-only">Importar JSON</label>
            <input type="file" id="importJson" accept="application/json" aria-label="Importar JSON" />
            <button class="btn" id="exportJsonBtn" type="button">Exportar JSON</button>
          </div>
        </div>

        <div class="dir-section" data-section="Urgencias">
          <h4>Urgencias</h4>
          <div class="dir-divider" aria-hidden="true"></div>
          <div class="dir-list" id="dirUrgencias"></div>
        </div>

        <div class="dir-section" data-section="Planta">
          <h4>Planta</h4>
          <div class="dir-divider" aria-hidden="true"></div>
          <div class="dir-list" id="dirPlanta"></div>
        </div>

        <div class="dir-section" data-section="UCI">
          <h4>UCI</h4>
          <div class="dir-divider" aria-hidden="true"></div>
          <div class="dir-list" id="dirUci"></div>
        </div>

        <div class="dir-section" data-section="Administración">
          <h4>Administración</h4>
          <div class="dir-divider" aria-hidden="true"></div>
          <div class="dir-list" id="dirAdmin"></div>
        </div>
      </div>
    </section>

    <!-- BIBLIOTECA -->
    <section id="bibliotecaView" class="view" role="tabpanel" aria-labelledby="tabBiblioteca">
      <div class="card soft">
        <div class="section-head">
          <h3>Biblioteca</h3>
          <span class="chip">Enlaces locales / web</span>
        </div>
        <div class="lib-form">
          <label for="libLabel" class="sr-only">Título del enlace</label>
          <input id="libLabel" placeholder="Título (p.ej., Guía C. difficile)" aria-label="Título del enlace" />
          <label for="libUrl" class="sr-only">URL o ruta</label>
          <input id="libUrl" placeholder="URL o ruta (https:// … o file:///…)" aria-label="URL o ruta" />
          <button class="btn primary" id="addLib" type="button">Añadir</button>
        </div>
        <div class="divider"></div>
        <div id="libList" class="lib-list" aria-live="polite"></div>
        <p class="subtitle" style="margin:6px 0 0">
          Nota: los enlaces <code>file://</code> pueden requerir permisos del sistema o abrirse solo desde el navegador.
        </p>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  "use strict";
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const uidKey = 'aurora_uid';
  const ls = {
    get: (k, d=null)=>{ try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
    set: (k,v)=>localStorage.setItem(k, JSON.stringify(v)),
  };

  // ===== Tabs accesibles (click + teclado con roving tabindex) =====
  const tabButtons = $$('#tabPlanta, #tabTareas, #tabDirectorio, #tabBiblioteca');
  const views = {
    Planta: $('#plantaView'),
    Tareas: $('#tareasView'),
    Directorio: $('#directorioView'),
    Biblioteca: $('#bibliotecaView')
  };

  function activateTab(btn){
    tabButtons.forEach(t=>{
      const selected = t === btn;
      t.setAttribute('aria-selected', String(selected));
      t.setAttribute('tabindex', selected ? '0' : '-1');
      t.toggleAttribute('aria-current', selected);
    });
    Object.values(views).forEach(v => v.classList.remove('active'));
    const view = views[btn.textContent];
    if(view){ view.classList.add('active'); }
    btn.focus({preventScroll:true});
  }

  tabButtons.forEach(tab=>{
    tab.addEventListener('click', ()=> activateTab(tab));
    tab.addEventListener('keydown', (e)=>{
      const i = tabButtons.indexOf(e.currentTarget);
      if(e.key === 'ArrowRight' || e.key === 'ArrowDown'){ e.preventDefault(); activateTab(tabButtons[(i+1)%tabButtons.length]); }
      if(e.key === 'ArrowLeft'  || e.key === 'ArrowUp'){   e.preventDefault(); activateTab(tabButtons[(i-1+tabButtons.length)%tabButtons.length]); }
      if(e.key === 'Home'){ e.preventDefault(); activateTab(tabButtons[0]); }
      if(e.key === 'End'){  e.preventDefault(); activateTab(tabButtons[tabButtons.length-1]); }
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); activateTab(tab); }
    });
  });

  // ===== Estado local (fallback) =====
  const state = {
    rooms: ls.get('rooms', []),       // {id, num, texto, tipo}
    tasks: ls.get('tasks', []),       // {id, dateISO, text, done}
    directory: ls.get('directory', {Urgencias:[], Planta:[], UCI:[], Administración:[]}),
    library: ls.get('library', [])    // {id, label, url}
  };
  function persist(){ ls.set('rooms', state.rooms); ls.set('tasks', state.tasks); ls.set('directory', state.directory); ls.set('library', state.library); }

  // ===== PLANTA =====
  const roomList = $('#roomList'), icList = $('#icList'), doneList = $('#doneList');
  const roomFilter = $('#roomFilter');
  $('#addRoomBtn').addEventListener('click', () => {
    const num = prompt('Número de habitación'); if(!num) return;
    const texto = prompt('Descripción breve');
    state.rooms.push({ id: crypto.randomUUID(), num: String(num).trim(), texto: texto?.trim() ?? '', tipo:'planta' });
    persist(); renderRooms(); syncUp('rooms');
  });
  roomFilter.addEventListener('input', renderRooms);

  function renderRooms(){
    const q = roomFilter.value?.toLowerCase() ?? '';
    const filtered = state.rooms.filter(r => !q || r.num.toLowerCase().includes(q) || r.texto.toLowerCase().includes(q));
    const planta = filtered.filter(r=>r.tipo==='planta').sort((a,b)=> +a.num - +b.num);
    const ic     = filtered.filter(r=>r.tipo==='ic').sort((a,b)=> +a.num - +b.num);
    const done   = filtered.filter(r=>r.tipo==='done').sort((a,b)=> +a.num - +b.num);

    roomList.innerHTML = planta.map(roomTpl).join('');
    icList.innerHTML   = ic.map(roomTpl).join('');
    doneList.innerHTML = done.map(roomTpl).join('');

    $$('.room .move').forEach(btn=>btn.addEventListener('change', (e)=>{
      const id = e.target.dataset.id, to = e.target.value;
      const r = state.rooms.find(x=>x.id===id); if(!r) return;
      r.tipo = to; persist(); renderRooms(); syncUp('rooms');
    }));
    $$('.room .del').forEach(btn=>btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id;
      const i = state.rooms.findIndex(x=>x.id===id); if(i>-1){ state.rooms.splice(i,1); persist(); renderRooms(); syncUp('rooms'); }
    }));
    $$('.room .edit').forEach(btn=>btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id; const r = state.rooms.find(x=>x.id===id); if(!r) return;
      const newNum = prompt('Número', r.num) ?? r.num;
      const newTxt = prompt('Descripción', r.texto) ?? r.texto;
      r.num = String(newNum).trim(); r.texto = String(newTxt).trim();
      persist(); renderRooms(); syncUp('rooms');
    }));
  }
  function roomTpl(r){
    return `
      <div class="room" data-id="${r.id}">
        <div class="room-num" aria-label="Habitación">${escapeHtml(r.num)}</div>
        <div class="room-badge">${escapeHtml(r.texto || '—')}</div>
        <div class="room-actions h-stack">
          <select class="move" data-id="${r.id}" aria-label="Mover a">
            <option value="planta" ${r.tipo==='planta'?'selected':''}>Planta</option>
            <option value="ic" ${r.tipo==='ic'?'selected':''}>Interconsultas</option>
            <option value="done" ${r.tipo==='done'?'selected':''}>Completados</option>
          </select>
          <button class="btn edit" data-id="${r.id}" type="button">Editar</button>
          <button class="btn del" data-id="${r.id}" type="button">Borrar</button>
        </div>
      </div>
    `;
  }

  // ===== TAREAS =====
  const taskGroups = $('#taskGroups');
  $('#addTaskBtn').addEventListener('click', ()=>{
    const text = prompt('Tarea'); if(!text) return;
    const date = prompt('Fecha (YYYY-MM-DD)', new Date().toISOString().slice(0,10)) || new Date().toISOString().slice(0,10);
    state.tasks.push({ id: crypto.randomUUID(), text: text.trim(), dateISO: date, done:false });
    persist(); renderTasks(); syncUp('tasks');
  });
  function renderTasks(){
    const groups = {};
    for(const t of state.tasks) (groups[t.dateISO] ??= []).push(t);
    const dates = Object.keys(groups).sort();
    taskGroups.innerHTML = dates.map(d=>{
      const items = groups[d].map(t=>`
        <div class="task">
          <div><label><input type="checkbox" data-id="${t.id}" class="taskDone" ${t.done?'checked':''}/> ${escapeHtml(t.text)}</label></div>
          <button class="btn delTask" data-id="${t.id}" type="button">Borrar</button>
        </div>
      `).join('');
      return `<div class="task-group"><div class="task-date">${d}</div>${items}</div>`;
    }).join('');
    $$('.taskDone').forEach(c=>c.addEventListener('change',(e)=>{
      const id=e.target.dataset.id; const t = state.tasks.find(x=>x.id===id); if(!t) return;
      t.done = e.target.checked; persist(); syncUp('tasks');
    }));
    $$('.delTask').forEach(b=>b.addEventListener('click',(e)=>{
      const id = e.currentTarget.dataset.id;
      const i = state.tasks.findIndex(x=>x.id===id); if(i>-1){ state.tasks.splice(i,1); persist(); renderTasks(); syncUp('tasks');}
    }));
  }

  // ===== DIRECTORIO =====
  const dirEls = { 'Urgencias': $('#dirUrgencias'), 'Planta': $('#dirPlanta'), 'UCI': $('#dirUci'), 'Administración': $('#dirAdmin') };
  $('#importJson').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      const allowedSections = Object.keys(dirEls);
      const clean = {Urgencias:[], Planta:[], UCI:[], Administración:[]};
      for(const key of allowedSections){
        const arr = Array.isArray(obj[key]) ? obj[key] : [];
        clean[key] = arr.slice(0, 200).map(x=>({
          nombre: String(x?.nombre ?? '').slice(0,80),
          telefono: String(x?.telefono ?? '').slice(0,24),
          nota: String(x?.nota ?? '').slice(0,120)
        }));
      }
      state.directory = clean; persist(); renderDirectory(); syncUp('directory');
      e.target.value = '';
    }catch(err){ alert('JSON inválido'); console.error(err); }
  });
  $('#exportJsonBtn').addEventListener('click', ()=>{
    const data = JSON.stringify(state.directory, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'directorio.json'; a.rel = 'noopener'; a.click(); URL.revokeObjectURL(url);
  });
  function renderDirectory(){
    for(const [section, el] of Object.entries(dirEls)){
      const list = state.directory[section] ?? [];
      el.innerHTML = list.map(c => `
        <div class="contact">
          <div><div><strong>${escapeHtml(c.nombre || '—')}</strong></div><small>${escapeHtml(c.nota || '')}</small></div>
          <div class="h-stack">${c.telefono ? `<a class="btn" href="tel:${encodeURI(c.telefono)}" rel="noopener">Llamar</a>` : ''}</div>
        </div>`).join('') || `<div class="subtitle">Sin contactos</div>`;
    }
  }

  // ===== BIBLIOTECA =====
  const libList = $('#libList');
  $('#addLib').addEventListener('click', ()=>{
    const label = $('#libLabel').value.trim();
    const url = $('#libUrl').value.trim();
    if(!label || !url) return;
    state.library.push({ id: crypto.randomUUID(), label, url });
    $('#libLabel').value=''; $('#libUrl').value='';
    persist(); renderLibrary(); syncUp('library');
  });
  function renderLibrary(){
    libList.innerHTML = state.library.map(x=>`
      <div class="contact lib-link">
        <div><strong>${escapeHtml(x.label)}</strong><div class="subtitle">${escapeHtml(x.url)}</div></div>
        <div class="h-stack">
          <a class="btn" target="_blank" rel="noopener" href="${escapeAttr(x.url)}">Abrir</a>
          <button class="btn" data-id="${x.id}" onclick="removeLib('${x.id}')" type="button">Borrar</button>
        </div>
      </div>`).join('') || `<div class="subtitle">Sin enlaces</div>`;
  }
  window.removeLib = (id)=>{
    const i = state.library.findIndex(x=>x.id===id);
    if(i>-1){ state.library.splice(i,1); persist(); renderLibrary(); syncUp('library'); }
  };

  // ===== Auth + Firestore (con persistencia offline) =====
  let currentUser = null;
  const loginBtn = $('#loginBtn'), logoutBtn = $('#logoutBtn');

  async function tryInitFirebase(){
    if(!(window.firebase?.apps || window.firebase?.initializeApp)) return false;
    try{
      const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(window.firebaseConfig || {});
      const auth = firebase.auth?.() || null;
      const db   = firebase.firestore?.() || null;

      // Persistencia offline (best effort)
      if (db && typeof firebase.firestore().enablePersistence === 'function') {
        try { await firebase.firestore().enablePersistence({ synchronizeTabs: true }); }
        catch (err) { console.warn('IndexedDB persistence no disponible, seguimos online-only:', err?.code || err); }
      }

      if(auth){
        auth.onAuthStateChanged(user=>{
          currentUser = user || null;
          loginBtn.style.display = user ? 'none':'';
          logoutBtn.style.display = user ? '':'none';
          if(user){ ls.set(uidKey, user.uid); attachRealtime(db, user.uid); }
        });
      }
      loginBtn.addEventListener('click', async ()=>{
        if(!auth){ alert('SDK de Firebase no cargado'); return; }
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      });
      logoutBtn.addEventListener('click', async ()=>{ if(auth) await auth.signOut(); });

      return true;
    }catch(e){
      console.warn('Firebase init falló (local fallback):', e);
      return false;
    }
  }

  function attachRealtime(db, uid){
    if(!db || !uid) return;
    const col = (k)=> db.collection('projects').doc('aurora').collection('users').doc(uid).collection(k);

    Promise.all(['rooms','tasks','directory','library'].map(async k=>{
      const snap = await col(k).get();
      const arr = []; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      if(k==='directory'){
        const doc = await col('meta').doc('directoryTree').get();
        if(doc.exists){ state.directory = doc.data()?.tree || state.directory; }
      }else{ state[k] = arr; }
    })).then(()=>{ persist(); renderAll(); });

    col('rooms').onSnapshot(s=>{ state.rooms = s.docs.map(d=>({id:d.id, ...d.data()})); persist(); renderRooms(); });
    col('tasks').onSnapshot(s=>{ state.tasks = s.docs.map(d=>({id:d.id, ...d.data()})); persist(); renderTasks(); });
    col('library').onSnapshot(s=>{ state.library = s.docs.map(d=>({id:d.id, ...d.data()})); persist(); renderLibrary(); });
    col('meta').doc('directoryTree').onSnapshot(doc=>{
      if(doc.exists){ state.directory = doc.data()?.tree || state.directory; persist(); renderDirectory(); }
    });
  }

  let syncTimer=null;
  function debounceSync(fn){ clearTimeout(syncTimer); syncTimer = setTimeout(fn, 180); }
  function syncUp(key){
    debounceSync(async ()=>{
      if(!(window.firebase?.firestore) || !currentUser) return;
      try{
        const db = firebase.firestore();
        const col = db.collection('projects').doc('aurora').collection('users').doc(currentUser.uid);
        if(key==='directory'){
          await col.collection('meta').doc('directoryTree').set({ tree: state.directory, ts: Date.now() }, { merge:true });
        }else{
          const target = col.collection(key);
          const batch = db.batch();
          const snap = await target.get();
          snap.forEach(d=>batch.delete(d.ref));
          for(const item of state[key]){
            const {id, ...rest} = item;
            batch.set(target.doc(id), rest);
          }
          await batch.commit();
        }
      }catch(e){ console.warn('syncUp fallo (local permanece):', e); }
    });
  }

  function renderAll(){ renderRooms(); renderTasks(); renderDirectory(); renderLibrary(); }
  renderAll(); tryInitFirebase();

  function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function escapeAttr(s){ return String(s ?? '').replace(/"/g,'&quot;'); }

  // ===== PWA: registro SW =====
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .then(reg => {
          if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
          reg.addEventListener('updatefound', ()=>{
            const nw = reg.installing;
            if(nw){ nw.addEventListener('statechange', ()=>{ if(nw.state==='installed' && navigator.serviceWorker.controller){ console.log('PWA actualizada'); } }); }
          });
        })
        .catch(err => console.warn('SW registro fallo:', err));
    });
  }
})();
</script>
</body>
</html>
