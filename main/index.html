<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#ffffff"/>
<title>Aurora UI ‚Äî Infecciosas 3.1</title>
<link rel="manifest" href="manifest.webmanifest"/>
<link rel="icon" href="icons/icon-192.png" sizes="192x192"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<style>
/* ================= TOKENS ================= */
:root{
  --ink:#0b1220; --muted:#5a667a;
  --surface:#ffffff; --surface-2:#f7f9fc; --border:#e8eef5;

  --lav:#EAE2FF; --lav-700:#8B5CF6;
  --ora:#FFE5D1; --ora-700:#FB923C;
  --coral-700:#F43F5E; --green-700:#10B981;
  --indigo-600:#6366F1; --gold-500:#FACC15;
  --mint-600:#06D6A0; --teal-600:#1B9AAA;

  --gx-planta: linear-gradient(135deg,#F5F0FF 0%, #EAE2FF 55%, #C7B8FF 100%);
  --gx-inter:  linear-gradient(135deg,#FFF3E4 0%, #FFE5D1 55%, #FFD0A3 100%);
  --gx-tareas: linear-gradient(135deg,#FFE4E9 0%, #FFC9D4 55%, #FFA9B9 100%);
  --gx-turq:   linear-gradient(135deg,#D7FFF6 0%, #BFF8EA 55%, #9BF0E0 100%);
  --gx-green:  linear-gradient(135deg,#E9FFF1 0%, #CFFAE2 55%, #B2F5D4 100%);
  --gx-dir:    linear-gradient(135deg,#FFFBE5 0%, #FFF1B5 55%, #FFE783 100%);
  --gx-bib:    linear-gradient(135deg,#EDF2FF 0%, #DDE4FF 55%, #C7D3FF 100%);
  --gx-extra:  linear-gradient(135deg,#FDE7FA 0%, #F9CEF5 55%, #F3B1EF 100%);

  --radius:14px; --radius-xl:22px; --appbar:64px; --touch:48px; --bottomnav:78px;
  --shadow-1: 0 1px 2px rgba(7,16,31,.05), 0 8px 24px rgba(7,16,31,.06);
  --shadow-2: 0 2px 10px rgba(7,16,31,.10), 0 20px 40px rgba(7,16,31,.14);
  --glow:     0 18px 36px rgba(60,100,180,.12);

  --fs: clamp(15px, 0.85vw + 0.35vh, 18px);
  --h2: clamp(20px, 2.6vw, 26px);
  --vh: 1vh;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--surface);
  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  font-size:var(--fs); line-height:1.65; min-height:calc(var(--vh)*100);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent; overflow-x:hidden; text-rendering:optimizeLegibility;
}
:focus-visible{outline:3px solid color-mix(in oklab,var(--lav-700),white 70%); outline-offset:2px; border-radius:12px}
.container{max-width:min(1180px,98vw); margin:0 auto; padding:8px clamp(12px,4vw,20px); container-type:inline-size}
.grow{flex:1;min-width:0}
.hide{display:none !important}

/* ================= Appbar ================= */
header.appbar{
  position:sticky; top:0; z-index:50; min-height:var(--appbar);
  backdrop-filter: blur(8px) saturate(1.06);
  background:linear-gradient(180deg,rgba(255,255,255,.94) 0%, rgba(247,249,252,.86) 100%);
  border-bottom:1px solid var(--border);
}
.appbar .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand{
  padding:10px 14px;border-radius:999px;border:1px solid var(--border);
  background:linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);
  box-shadow:inset 0 1px 0 #fff, var(--shadow-1);
  display:inline-flex;align-items:center;gap:10px;font-weight:1000;letter-spacing:.2px
}
.brand-dot{width:10px;height:10px;border-radius:50%;background:var(--gold-500);box-shadow:0 0 0 2px rgba(0,0,0,.06)}
h1#title{
  margin:0;font-size:clamp(20px,2.6vw,24px);font-weight:1000;letter-spacing:.2px;color:#0e1624;
  text-shadow: 0 .5px 0 rgba(255,255,255,.8), 0 1px 1px rgba(0,0,0,.05);
  position:relative;
}
h1#title::after{
  content: attr(data-tag);
  position:absolute; left:-8px; bottom:-14px;
  font-size:12px; font-weight:900; letter-spacing:.6px; padding:3px 8px;
  border-radius:8px;
  background:linear-gradient(180deg,#fff 0%, #f4f7fc 100%);
  border:1px solid var(--border); color:#172036;
}

/* ================= Chips y botones ================= */
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);
  border-radius:999px;font-size:.84rem;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
.chip.ok{background:#ecfdf5;color:#065F46;border-color:#a7f3d0}
.chip.bad{background:#fef2f2;color:#991B1B;border-color:#fecaca}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
  padding:12px 14px;border-radius:14px;box-shadow:var(--shadow-1);
  min-height:var(--touch);display:inline-flex;align-items:center;gap:10px;cursor:pointer;font-weight:800}
.btn.primary{background:linear-gradient(180deg,#fffdf3 0%, #fff7d1 100%); border-color:color-mix(in oklab,var(--gold-500),transparent 65%); box-shadow:var(--shadow-2)}
.btn.icon{min-width:var(--touch);aspect-ratio:1/1;padding:0 12px}

/* ================= Card + encabezado glass-metal ================= */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(255,255,255,.82) 100%);
  backdrop-filter: blur(8px) saturate(1.06);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  box-shadow: var(--glow);
  overflow:hidden; contain:content;
}
.card-h{
  position:relative; padding:16px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid color-mix(in oklab,#000,transparent 90%);
  background:#fff; isolation:isolate; overflow:hidden;
}
.card-h::before{ /* banda crom√°tica */
  content:""; position:absolute; inset:0 0 auto 0; height:52px; z-index:0; opacity:.95;
  background: var(--gx-neutral, linear-gradient(135deg,#F3F6FB 0%, #EDF2F9 100%));
}
.card-h::after{ /* brillo curvo ‚Äúmetal‚Äù controlado */
  content:""; position:absolute; inset:-18% -10% auto -10%; height:170%;
  background:
    radial-gradient(60% 42% at 50% -6%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
    radial-gradient(42% 28% at 80% 0%, rgba(255,255,255,.35), rgba(255,255,255,0) 65%);
  pointer-events:none; mix-blend-mode:screen; opacity:.7; z-index:0;
  filter: blur(.2px);
}
.card-h h2{
  margin:0;font-size:var(--h2);font-weight:1000;letter-spacing:.2px;color:#0b1220;position:relative;z-index:1;
  text-shadow: 0 .5px 0 rgba(255,255,255,.9), 0 1px 1px rgba(0,0,0,.06);
}
.card-b{position:relative;z-index:1;padding:12px}
.subtitle{ color:#06121fcc; font-weight:800 }

/* Mapear banda por secci√≥n */
.h-planta{ --gx-neutral: var(--gx-planta) }
.h-inter { --gx-neutral: var(--gx-inter) }
.h-tareas{ --gx-neutral: var(--gx-tareas) }
.h-cyan  { --gx-neutral: var(--gx-turq) }
.h-green { --gx-neutral: var(--gx-green) }
.h-dir   { --gx-neutral: var(--gx-dir) }
.h-bib   { --gx-neutral: var(--gx-bib) }
.h-extra { --gx-neutral: var(--gx-extra) }

/* ================= Tabs ================= */
.tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.tab{
  padding:12px;border-radius:16px;border:1px solid var(--border);background:var(--surface-2);
  cursor:pointer;font-weight:900;letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:12px
}
.tab[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--lav-700),transparent 65%);box-shadow:0 10px 24px rgba(20,70,120,.08), inset 0 1px 0 #fff}

nav.bottom{
  position:fixed;left:0;right:0;bottom:0;z-index:40;background:#fff;border-top:1px solid var(--border); height:calc(var(--bottomnav) + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
}
.tabs-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-items:center;padding:8px 12px}
.tab-bottom{
  padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);cursor:pointer;font-weight:800;
  display:flex;align-items:center;justify-content:center;gap:10px
}
.tab-bottom[aria-selected="true"]{background:#fff;border-color:color-mix(in oklab,var(--gold-500),transparent 60%);box-shadow:0 8px 22px rgba(0,0,0,.08), inset 0 1px 0 #fff}

/* Iconos +30% */
.ico{width:36px;height:36px}
.tab-bottom .ico{width:31px;height:31px}

/* ================= Listas / Inputs ================= */
ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
li.item{display:grid;grid-template-columns:auto minmax(160px,1fr) auto;gap:12px;align-items:center;border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
label{font-size:12px;color:color-mix(in oklab,var(--ink),transparent 42%)}
input,textarea,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;color:var(--ink);font:inherit;min-height:var(--touch);box-shadow:inset 0 1px 0 #fff}
textarea{min-height:96px;resize:vertical}

/* P√≠ldoras */
.pill{display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;padding:7px 12px;border-radius:14px;line-height:1;border:1px solid transparent;color:#0d1726;background:var(--surface-2);box-shadow:inset 0 1px 0 #fff}
.pill.room{
  font-family: ui-monospace,Consolas,Menlo,monospace;
  font-size:clamp(22px,3.2vw,26px);
  padding:12px 16px; letter-spacing:.3px; color:#07101f; background:#fff;
  border:1px solid color-mix(in oklab,var(--lav-700),transparent 78%);
  box-shadow:0 0 0 1px color-mix(in oklab,#000,transparent 90%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08);
}
.pill.room[data-group="planta"]{
  background: linear-gradient(180deg,#ffffff 0%, #faf7ff 100%);
  border-color: color-mix(in oklab,var(--lav-700),transparent 65%);
  box-shadow: 0 0 0 6px color-mix(in oklab,var(--lav),transparent 60%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08);
}
.pill.room[data-group="interconsulta"]{
  background: linear-gradient(180deg,#ffffff 0%, #fff7f0 100%);
  border-color: color-mix(in oklab,var(--ora-700),transparent 60%);
  box-shadow: 0 0 0 6px color-mix(in oklab,var(--ora),transparent 58%), inset 0 1px 0 #fff, 0 14px 30px rgba(7,16,31,.08);
}
.pill.date{font-weight:1000}
.pill.tel{font-weight:800}

/* Visor */
.viewer{ width:100%; block-size:min(70vh, 100dvh - 320px); border:1px solid var(--border); border-radius:16px; background:#fff; box-shadow:var(--shadow-1); }

/* Directorio A-Z */
.dir-wrap{display:grid;grid-template-columns:1fr min(42px,10vw);gap:12px;align-items:start}
.az{
  position:sticky; top:calc(var(--appbar) + 10px);
  display:grid; grid-template-columns:1fr; gap:6px; align-content:start; z-index:1;
}
.az a{
  display:grid;place-items:center; width:100%; aspect-ratio:1/1;
  border:1px solid var(--border); border-radius:12px; text-decoration:none; color:#263041; font-weight:1000; background:#fff; box-shadow:inset 0 1px 0 #fff
}
.section-tag{
  position:sticky; top:calc(var(--appbar) + 8px); z-index:2;
  margin:-8px; margin-bottom:8px; padding:6px 12px;
  font-weight:1000; letter-spacing:.6px; border-radius:12px;
  color:#0b1220; background:linear-gradient(180deg,#fff 0%, #f7f9fc 100%);
  border:1px solid var(--border); box-shadow:var(--shadow-1)
}
section[id^="sec-"]{ scroll-margin-top: calc(var(--appbar) + 56px); }

/* ======= Espacio inferior ======= */
main.container{ padding-bottom: calc(var(--bottomnav) + 28px + env(safe-area-inset-bottom)); }

/* Responsive */
@media (max-width:720px){
  .statusRow{order:4;width:100%}
  #userGroup{order:5;width:100%;justify-content:flex-start}
  #title{font-size:clamp(20px,5.4vw,24px)}
  .dir-wrap{grid-template-columns:1fr min(40px,12vw)}
  li.item{grid-template-columns:auto 1fr auto}
  #panel-directorio .card:first-child .card-b{display:grid;grid-template-columns:1fr;gap:10px}
  #panel-directorio .toolbar{display:flex;gap:6px;overflow-x:auto; white-space:nowrap; scrollbar-width:thin}
  #panel-directorio .toolbar > *{flex:0 0 auto}
}
@media (prefers-reduced-motion: reduce){ *{scroll-behavior:auto} }
</style>
</head>
<body>
<!-- Gradientes e iconos -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;pointer-events:none">
  <defs>
    <linearGradient id="gLav" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#d9cbff"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
    <linearGradient id="gOra" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffd7b0"/><stop offset="1" stop-color="#FB923C"/></linearGradient>
    <linearGradient id="gInd" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#d6dbff"/><stop offset="1" stop-color="#6F7BF7"/></linearGradient>
    <linearGradient id="gGold" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffeaa8"/><stop offset="1" stop-color="#FACC15"/></linearGradient>

    <!-- Iconos -->
    <symbol id="i-swap" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M7.1 7.5a6 6 0 0 1 10.6-2.4l1.5-1.5v5.8H13l2-2A4 4 0 1 0 7.9 9.7a1 1 0 1 1-0.8 1.8A6 6 0 0 1 7.1 7.5z"/>
      <path fill="url(#gOra)" d="M16.9 16.5a6 6 0 0 1-10.6 2.4l-1.5 1.5V14.6H11l-2 2A4 4 0 1 0 16.1 14a1 1 0 1 1 .8-1.8 6 6 0 0 1 0 4.3z"/>
    </symbol>
    <symbol id="i-stetho" viewBox="0 0 24 24">
      <path fill="url(#gLav)" d="M6 2a1 1 0 0 1 1 1v4a3 3 0 0 0 6 0V3a1 1 0 1 1 2 0v4a5 5 0 0 1-10 0V3a1 1 0 0 1 1-1z"/>
      <path fill="url(#gInd)" d="M17 10a3 3 0 0 1 3 3v2a5 5 0 0 1-5 5h-2a4 4 0 0 1-4-4v-3a1 1 0 1 1 2 0v3a2 2 0 0 0 2 2h2a3 3 0 0 0 3-3v-2a1 1 0 0 1 1-1z"/>
    </symbol>
    <!-- Herramientas pro -->
    <symbol id="i-tools-pro" viewBox="0 0 24 24">
      <path fill="url(#gOra)" d="M21 7.5a3.5 3.5 0 0 1-5.22 3.06l-6.96 6.96a2 2 0 0 1-2.83 0l-1.5-1.5a2 2 0 0 1 0-2.83l6.96-6.96A3.5 3.5 0 1 1 21 7.5z"/>
      <path fill="url(#gInd)" d="M8 5l2 2-6.5 6.5a1 1 0 0 1-1.41 0l-.59-.59a1 1 0 0 1 0-1.41L8 5z"/>
      <circle cx="18" cy="6" r="1.6" fill="#fff"/>
    </symbol>
    <!-- Tel√©fono handset claro -->
    <symbol id="i-phone-handset" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M2 7c0-1.1.9-2 2-2h2c.9 0 1.7.6 1.9 1.5l.5 2.2c.1.6-.1 1.2-.6 1.6L6.8 12c1.3 2.6 3.6 4.9 6.2 6.2l1.7-1.9c.4-.5 1-.7 1.6-.6l2.2.5c.9.2 1.5 1 1.5 1.9v2c0 1.1-.9 2-2 2h-1C9.4 23 3 16.6 3 9V8c0-.6.2-1.1.6-1.5C4 6.2 4.5 6 5 6H4c-1.1 0-2 .9-2 2z"/>
      <circle cx="16.5" cy="4.5" r="1.5" fill="url(#gGold)"/>
    </symbol>
    <symbol id="i-books" viewBox="0 0 24 24">
      <rect x="2.5" y="5" width="5.5" height="14" rx="1" fill="url(#gInd)"/>
      <rect x="9.5" y="4" width="5.5" height="15" rx="1" fill="url(#gGold)"/>
      <rect x="16.5" y="6" width="5" height="13" rx="1" fill="url(#gLav)"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24">
      <path fill="url(#gInd)" d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm8.5 3.5-.9-.5.1-1a8 8 0 0 0-1.8-3.2l-.9.3-.7-.7.3-.9A8 8 0 0 0 13.5 3l-1 .1-.5.9h-1l-.5-.9-1-.1A8 8 0 0 0 5.8 5.5l.3.9-.7.7-.9-.3A8 8 0 0 0 3 10.5l.1 1 .9.5v1l-.9.5L3 14.5a8 8 0 0 0 1.8 3.2l.9-.3.7.7-.3.9A8 8 0 0 0 10.5 21l1-.1.5-.9h1l.5.9 1 .1a8 8 0 0 0 3.2-1.8l-.3-.9.7-.7.9.3A8 8 0 0 0 21 13.5l-.1-1-.9-.5v-1z"/>
    </symbol>
  </defs>
</svg>

<header class="appbar" role="banner">
  <div class="container">
    <span class="brand"><span class="brand-dot" aria-hidden="true"></span>INFECCIOSAS</span>
    <h1 id="title" data-tag="Aurora UI">Planta</h1>
    <div class="grow"></div>
    <div class="statusRow" aria-live="polite" style="margin-left:12px">
      <span id="badge-online" class="chip bad">Offline</span>
      <span id="badge-auth" class="chip bad">Google: desconectado</span>
    </div>
    <div id="userGroup" class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto">
      <div id="userchip" class="hide" style="display:flex;align-items:center;gap:8px">
        <img id="avatar" alt="" referrerpolicy="no-referrer" style="width:32px;height:32px;border-radius:50%;box-shadow:var(--shadow-1)">
        <strong id="displayname" style="max-width:26ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></strong>
        <span id="notifBadge" class="chip" title="Tareas activas">0</span>
      </div>
      <button id="installBtn" class="btn" aria-label="Instalar">‚ûï Instalar</button>
      <button id="signin"  class="btn primary">Acceder</button>
      <button id="signout" class="btn hide">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <div id="updateBanner" class="chip" style="display:none">Nueva versi√≥n disponible. <button id="reloadNow" class="btn primary">Actualizar</button></div>
  <div id="installBanner" class="chip" style="display:none">Instala la app para acceso m√°s r√°pido. <button id="installAction" class="btn primary">Instalar</button></div>

  <!-- Gate -->
  <section id="gate" class="card" role="region" aria-live="polite">
    <div class="card-h h-bib"><h2>Bienvenido</h2><span class="subtitle">Sincroniza con Google</span></div>
    <div class="card-b">
      <p class="muted">La app funciona offline tras la primera carga. Accede para sincronizar entre Android y PC.</p>
      <div class="toolbar"><button id="signin2" class="btn primary">Acceder con Google</button></div>
      <div id="authErr" class="muted" style="margin-top:8px; min-height:1.2em"></div>
    </div>
  </section>

  <!-- App -->
  <section id="app" class="hide" aria-labelledby="tabsLabel">
    <div class="card" style="margin-bottom:12px">
      <div class="card-b">
        <div id="tabsLabel" class="muted" style="font-weight:700; margin-bottom:8px">Secciones</div>
        <div role="tablist" class="tabs" aria-label="Secciones" id="tablist" aria-orientation="horizontal">
          <button id="tab-planta" class="tab" role="tab" aria-selected="true" aria-controls="panel-planta" tabindex="0">
            <svg class="ico" aria-hidden="true"><use href="#i-stetho"/></svg>Planta
          </button>
          <button id="tab-tareas" class="tab" role="tab" aria-selected="false" aria-controls="panel-tareas" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-tools-pro"/></svg>Tareas
          </button>
          <button id="tab-directorio" class="tab" role="tab" aria-selected="false" aria-controls="panel-directorio" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-phone-handset"/></svg>Directorio
          </button>
          <button id="tab-biblioteca" class="tab" role="tab" aria-selected="false" aria-controls="panel-biblioteca" tabindex="-1">
            <svg class="ico" aria-hidden="true"><use href="#i-books"/></svg>Biblioteca
          </button>
        </div>
      </div>
    </div>

    <!-- ===== PLANTA ===== -->
    <div id="panel-planta" role="tabpanel" aria-labelledby="tab-planta" tabindex="-1">
      <div class="card">
        <div class="card-h h-planta"><h2>A√±adir habitaci√≥n</h2><span class="subtitle">Planta e Interconsulta</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
          <div><label for="p-room">Habitaci√≥n</label><input id="p-room" placeholder="Ej. 421-2" autocomplete="off"></div>
          <div><label for="p-desc">Descripci√≥n</label><input id="p-desc" placeholder="Resumen cl√≠nico, motivo‚Ä¶"></div>
          <div style="align-self:end"><button id="p-add" class="btn primary">A√±adir</button></div>
          <div class="g2" style="grid-column:1/-1;display:grid;gap:12px;grid-template-columns:1fr 1fr">
            <div><label for="p-pend">Cosas pendientes</label><input id="p-pend" placeholder="Rx, anal√≠tica‚Ä¶ (opcional)"></div>
            <div>
              <label>Grupo</label>
              <div role="group" aria-label="Grupo" style="display:inline-flex;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:2px;box-shadow:inset 0 1px 0 #fff">
                <button id="p-group-planta" type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--lav);border-color:color-mix(in oklab,var(--lav-700),transparent 60%)">Planta</button>
                <button id="p-group-inter"  type="button" class="btn" style="min-height:36px;padding:8px 12px;background:var(--ora);border-color:color-mix(in oklab,var(--ora-700),transparent 55%)">Interconsulta</button>
              </div>
              <span id="addTarget" class="chip" aria-live="polite" style="margin-left:8px">A√±adiendo a: Planta</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-planta"><h2>Planta</h2><span id="p-count-planta" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-planta" class="list"></ul>
          <p id="p-empty-planta" class="muted">Sin elementos en Planta.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Interconsultas</h2><span id="p-count-inter" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-list-inter" class="list"></ul>
          <p id="p-empty-inter" class="muted">Sin elementos en Interconsulta.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completados</h2><span id="p-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="p-done" class="list"></ul>
          <p id="p-done-empty" class="muted">Nada completado.</p>
        </div>
      </div>
    </div>

    <!-- ===== TAREAS ===== -->
    <div id="panel-tareas" class="hide" role="tabpanel" aria-labelledby="tab-tareas" tabindex="-1">
      <div class="card">
        <div class="card-h h-cyan"><h2>A√±adir tarea</h2><span class="subtitle">Fecha ‚Üí Descripci√≥n</span></div>
        <div class="card-b">
          <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 2fr auto">
            <div><label for="t-date">Fecha</label><input id="t-date" type="date" required></div>
            <div><label for="t-text">Descripci√≥n</label><input id="t-text" type="text" placeholder="Describe la tarea‚Ä¶" maxlength="400"></div>
            <div style="align-self:end"><button id="t-add" class="btn primary">A√±adir</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-tareas"><h2>Tareas activas</h2><span id="t-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-list" class="list"></ul>
          <p id="t-empty" class="muted">No hay tareas activas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-green"><h2>Completadas</h2><span id="t-done-count" class="chip">0</span></div>
        <div class="card-b">
          <ul id="t-done" class="list"></ul>
          <p id="t-done-empty" class="muted">No hay tareas completadas.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-inter"><h2>Papelera</h2><span id="t-trash-count" class="chip">0</span></div>
        <div class="card-b">
          <div class="toolbar" style="margin-bottom:8px"><button id="t-emptyTrash" class="btn primary">Vaciar papelera</button></div>
          <ul id="t-trash" class="list"></ul>
          <p id="t-trash-empty" class="muted">Papelera vac√≠a.</p>
        </div>
      </div>
    </div>

    <!-- ===== DIRECTORIO ===== -->
    <div id="panel-directorio" class="hide" role="tabpanel" aria-labelledby="tab-directorio" tabindex="-1">
      <div class="card">
        <div class="card-h h-dir"><h2>Directorio telef√≥nico</h2><span id="d-count" class="chip">0</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr auto">
          <div><label for="d-q">B√∫squeda inteligente</label><input id="d-q" type="search" placeholder="Secci√≥n, nombre o extensi√≥n‚Ä¶"></div>
          <div class="toolbar" style="align-self:end; justify-content:flex-end;flex-wrap:wrap; gap:6px; overflow-x:auto; white-space:nowrap">
            <button id="d-add" class="btn primary">A√±adir</button>
            <button id="d-import" class="btn">Importar JSON</button>
            <button id="d-export" class="btn">Exportar JSON</button>
            <button id="d-dedupe" class="btn">Eliminar duplicados</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-b dir-wrap">
          <div>
            <div id="d-list-wrap"></div>
            <p id="d-empty" class="muted">Sin registros.</p>
          </div>
          <nav class="az" aria-label="√çndice alfab√©tico" id="d-az"></nav>
        </div>
      </div>
    </div>

    <!-- ===== BIBLIOTECA ===== -->
    <div id="panel-biblioteca" class="hide" role="tabpanel" aria-labelledby="tab-biblioteca" tabindex="-1">
      <div class="card">
        <div class="card-h h-bib"><h2>Biblioteca</h2><span class="subtitle">Notas + enlaces + visor</span></div>
        <div class="card-b" style="display:grid;gap:12px;grid-template-columns:2fr 1fr">
          <div>
            <label for="b-notes">Notas r√°pidas</label>
            <textarea id="b-notes" placeholder="Pega aqu√≠ fragmentos o URLs. Se guardan en tu usuario."></textarea>
            <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
              <button id="b-notes-save" class="btn primary">Guardar notas</button>
              <button id="b-open-file" class="btn">Abrir PDF local‚Ä¶</button>
              <button id="b-clear-view" class="btn">Vaciar visor</button>
              <span id="b-save-state" class="chip" aria-live="polite">Listo</span>
            </div>
          </div>
          <div>
            <label for="b-url">Nuevo enlace (PDF o web)</label>
            <input id="b-url" type="url" placeholder="https://‚Ä¶ o *.pdf">
            <label for="b-title">T√≠tulo</label>
            <input id="b-title" type="text" placeholder="Nombre del recurso">
            <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
              <button id="b-add-link" class="btn primary">A√±adir a lista</button>
              <button id="b-export-links" class="btn">Exportar JSON</button>
              <button id="b-import-links" class="btn">Importar JSON</button>
            </div>
            <div style="margin-top:10px">
              <label for="b-select">Mis enlaces</label>
              <select id="b-select"></select>
              <div class="toolbar" style="margin-top:8px;gap:6px;flex-wrap:wrap">
                <button id="b-open" class="btn">Abrir en visor</button>
                <button id="b-open-ext" class="btn">Abrir en pesta√±a</button>
                <button id="b-remove" class="btn">Eliminar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h h-bib"><h2>Visor</h2><span class="subtitle">Arrastra aqu√≠ un PDF</span></div>
        <div class="card-b">
          <iframe id="b-viewer" class="viewer" title="Visor de documentos" sandbox="allow-same-origin allow-downloads"></iframe>
          <p class="muted" style="margin-top:8px">Consejo: para PDFs con CORS, usa ‚ÄúAbrir PDF local‚Ä¶‚Äù.</p>
        </div>
      </div>
    </div>

    <!-- Tabs inferiores -->
    <nav class="bottom" aria-label="Secciones">
      <div class="tabs-bottom">
        <button class="tab-bottom" id="b-planta" aria-selected="true"><svg class="ico"><use href="#i-stetho"/></svg>Planta</button>
        <button class="tab-bottom" id="b-tareas" aria-selected="false"><svg class="ico"><use href="#i-tools-pro"/></svg>Tareas</button>
        <button class="tab-bottom" id="b-directorio" aria-selected="false"><svg class="ico"><use href="#i-phone-handset"/></svg>Directorio</button>
        <button class="tab-bottom" id="b-biblioteca" aria-selected="false"><svg class="ico"><use href="#i-books"/></svg>Biblioteca</button>
      </div>
    </nav>
  </section>
</main>

<!-- FAB Emergencias con panel y engranaje -->
<button id="fab" class="btn primary" style="position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom) + var(--bottomnav));z-index:70;border-radius:999px;padding:14px 16px;display:flex;align-items:center;gap:10px">
  Emergencias
</button>
<div id="fabPanel" class="card" style="position:fixed;right:16px;bottom:calc(92px + env(safe-area-inset-bottom) + var(--bottomnav));z-index:69;width:min(520px,96vw);display:none">
  <div class="card-h h-extra"><h2>Emergencias</h2><button id="fab-config" class="btn icon" title="Configurar"><svg class="ico"><use href="#i-gear"/></svg></button></div>
  <div class="card-b"><div id="fabList"></div></div>
</div>

<div id="toast" hidden role="status" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* ===== Helpers ===== */
const BASE = new URL('./', location).pathname;
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const toast=(m)=>{const t=$('#toast');t.textContent=m;t.hidden=false;setTimeout(()=>t.hidden=true,2200);};
const todayISO=()=>new Date().toISOString().slice(0,10);
const setVH=()=>document.documentElement.style.setProperty('--vh',(innerHeight*0.01)+'px');
setVH(); addEventListener('resize', setVH, {passive:true});

const setOnline=(on)=>{const b=$('#badge-online');b.textContent=on?'Online':'Offline';b.className='chip '+(on?'ok':'bad');};
setOnline(navigator.onLine); addEventListener('online',()=>setOnline(true),{passive:true}); addEventListener('offline',()=>setOnline(false),{passive:true});

const esc=(s)=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

/* ===== Firebase ===== */
const appMod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
const authMod= await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');
const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
const { firebaseConfig } = await import(BASE + 'firebase-config.js');
const fbApp=appMod.initializeApp(firebaseConfig);
const auth =authMod.getAuth(fbApp);
const db   =fsMod.initializeFirestore(fbApp,{localCache:fsMod.persistentLocalCache({tabManager:fsMod.persistentMultipleTabManager()})});
const serverTS=fsMod.serverTimestamp;

/* ===== Auth ===== */
const badgeAuth=$('#badge-auth'), userchip=$('#userchip'), avatar=$('#avatar'), displayname=$('#displayname');
const gate=$('#gate'), appUI=$('#app'); const provider=new authMod.GoogleAuthProvider();
const doSignIn=async()=>{try{ if(matchMedia('(display-mode: standalone)').matches) await authMod.signInWithRedirect(auth,provider); else await authMod.signInWithPopup(auth,provider);}catch(e){$('#authErr').textContent=e.message||String(e)}};
$('#signin').onclick=doSignIn; $('#signin2').onclick=doSignIn; $('#signout').onclick=async()=>authMod.signOut(auth);

authMod.onAuthStateChanged(auth, user=>{
  if(user){
    badgeAuth.textContent='Google: '+(user.displayName||user.email); badgeAuth.className='chip ok';
    if($('#avatar')) avatar.src=user.photoURL||''; if($('#displayname')) displayname.textContent=user.displayName||user.email||'';
    userchip?.classList.remove('hide'); $('#signout')?.classList.remove('hide'); $('#signin')?.classList.add('hide');
    gate.classList.add('hide'); appUI.classList.remove('hide'); mount(user.uid);
  }else{
    badgeAuth.textContent='Google: desconectado'; badgeAuth.className='chip bad';
    userchip?.classList.add('hide'); $('#signout')?.classList.add('hide'); $('#signin')?.classList.remove('hide');
    appUI.classList.add('hide'); gate.classList.removeClass?.('hide'); // harmless
    unmount();
  }
});

/* ===== Colecciones ===== */
const col={
  planta:(uid)=>fsMod.collection(db,'users',uid,'planta'),
  tareas:(uid)=>fsMod.collection(db,'users',uid,'tareas'),
  dir:(uid)=>fsMod.collection(db,'users',uid,'directorio'),
  biblio:(uid)=>fsMod.collection(db,'users',uid,'biblioteca'),
  notes:(uid)=>fsMod.doc(db,'users',uid,'biblioteca','__notes__'),
  emerg:(uid)=>fsMod.collection(db,'users',uid,'emergencias'),
};
let unsubs=[]; const currentUid=()=>auth.currentUser?.uid; function unmount(){unsubs.forEach(u=>u&&u()); unsubs=[];}
const pushRetry=(job)=>{try{const q=JSON.parse(localStorage.getItem('aurora.retry')||'[]'); q.push(job); localStorage.setItem('aurora.retry',JSON.stringify(q));}catch{}};
async function upd(kind,id,patch){const ref=fsMod.doc(db,'users',currentUid(),kind,id);const data={...patch,updatedAt:serverTS()};try{await fsMod.updateDoc(ref,data);}catch{pushRetry({path:ref.path,data});toast('Se guardar√° al recuperar conexi√≥n');}}
async function del(kind,id){const ref=fsMod.doc(db,'users',currentUid(),kind,id);try{await fsMod.deleteDoc(ref);}catch{pushRetry({path:ref.path,data:{__delete__:true}});toast('Se eliminar√° al reconectar');}}

/* ===== Tabs + hash ===== */
const mapTabs={planta:['panel-planta','tab-planta','b-planta','Planta'],tareas:['panel-tareas','tab-tareas','b-tareas','Tareas'],directorio:['panel-directorio','tab-directorio','b-directorio','Directorio'],biblioteca:['panel-biblioteca','tab-biblioteca','b-biblioteca','Biblioteca']};
function selectTab(id){
  for(const k in mapTabs){
    const [p,t,b,l]=mapTabs[k]; const sel=(k===id);
    $('#'+p)?.classList.toggle('hide',!sel);
    if(t){ const tb=$('#'+t); tb?.setAttribute('aria-selected',sel); tb.tabIndex=sel?0:-1; }
    if(b){ $('#'+b)?.setAttribute('aria-selected',sel); }
    if(sel){ $('#title').textContent=l; $('#title').setAttribute('data-tag','Aurora UI'); }
  }
  localStorage.setItem('tab', id); location.hash=id;
}
$('#tab-planta').onclick =()=>selectTab('planta');
$('#tab-tareas').onclick =()=>selectTab('tareas');
$('#tab-directorio').onclick=()=>selectTab('directorio');
$('#tab-biblioteca').onclick=()=>selectTab('biblioteca');
$('#b-planta').onclick =()=>selectTab('planta');
$('#b-tareas').onclick =()=>selectTab('tareas');
$('#b-directorio').onclick=()=>selectTab('directorio');
$('#b-biblioteca').onclick=()=>selectTab('biblioteca');
addEventListener('hashchange',()=>{const h=location.hash.slice(1); if(mapTabs[h]) selectTab(h);},{passive:true});
const order=['tab-planta','tab-tareas','tab-directorio','tab-biblioteca'];
$('#tablist').addEventListener('keydown',(e)=>{const i=order.indexOf(document.activeElement?.id); if(i<0) return; let j=i;
  if(e.key==='ArrowRight') j=(i+1)%order.length; else if(e.key==='ArrowLeft') j=(i-1+order.length)%order.length;
  else if(e.key==='Home') j=0; else if(e.key==='End') j=order.length-1; else if(e.key==='Enter'||e.key===' '){document.activeElement.click();return;}
  e.preventDefault(); const btn=$('#'+order[j]); btn?.focus(); btn?.click();
});

/* ===== Planta ===== */
let currentGroup='planta';
const updateAddTarget=()=>$('#addTarget').textContent=currentGroup==='planta'?'A√±adiendo a: Planta':'A√±adiendo a: Interconsulta';
$('#p-group-planta').onclick=()=>{currentGroup='planta'; updateAddTarget();};
$('#p-group-inter').onclick =()=>{currentGroup='interconsulta'; updateAddTarget();};

const plantaDoc = (d)=>({ room:(d.room||'').trim(), desc:(d.desc||'').trim(), pendiente:(d.pendiente||'').trim(), grupo:d.grupo||'planta', status:d.status||'active', createdAt:d.createdAt||serverTS(), updatedAt:serverTS() });
const roomSortKey=(s)=>{ if(!s) return 1e9; const m=String(s).match(/\d+/g); if(!m) return 1e9; const a=parseInt(m[0],10); const b=m[1]?parseInt(m[1],10)/100:0; return a+b; };

function plantaItem(x,done=false){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<span class="pill room" data-group="${x.grupo||'planta'}">${esc(x.room||'‚Äî')}</span>
  <div class="text">${done?`<div class="line" style="text-decoration:line-through">${esc(x.desc||'')}</div>`:`<div class="line">${esc(x.desc||'')}</div>`}
  ${x.pendiente?`<div class="muted">${esc(x.pendiente)}</div>`:''}</div>
  <div class="toolbar actions"></div>`;
  const a=li.querySelector('.actions');
  const swap=document.createElement('button'); swap.className='btn icon'; swap.innerHTML=`<svg class="ico"><use href="#i-swap"/></svg>`; swap.onclick=()=>upd('planta',x.__id,{grupo:(x.grupo==='interconsulta')?'planta':'interconsulta'});
  a.append(swap, btn('‚úé',()=>editPlanta(x),'btn icon'), btn(done?'‚úñ':'‚úì',()=> done?del('planta',x.__id):upd('planta',x.__id,{status:'done'}),'btn icon'));
  return li;
}
const btn=(t,fn,cls='btn')=>{const b=document.createElement('button'); b.className=cls; b.textContent=t; b.onclick=(e)=>{e.preventDefault();fn?.(e)}; b.type='button'; return b;};
const val=(id)=>document.getElementById(id)?.value||'';
const editPlanta=(x)=>openEdit([{l:'Habitaci√≥n',id:'p_room',v:x.room||''},{l:'Descripci√≥n',id:'p_desc',v:x.desc||''},{l:'Cosas pendientes',id:'p_pend',v:x.pendiente||''}], async()=>upd('planta',x.__id,{room:val('p_room'),desc:val('p_desc'),pendiente:val('p_pend')}));

function setupPlanta(uid){
  $('#p-add').onclick=async()=>{ const d=plantaDoc({room:val('p-room'),desc:val('p-desc'),pendiente:val('p-pend'),grupo:currentGroup}); if(!d.room && !d.desc) return; await fsMod.addDoc(col.planta(uid),d); ['p-room','p-desc','p-pend'].forEach(i=>$('#'+i).value=''); };
  const qA=fsMod.query(col.planta(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.planta(uid),fsMod.where('status','==','done'));
  const u1=fsMod.onSnapshot(qA,(s)=>{ const all=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; all.push(x)});
    const arrP=all.filter(x=>(x.grupo||'planta')==='planta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const arrI=all.filter(x=>(x.grupo||'planta')==='interconsulta').sort((a,b)=>roomSortKey(a.room)-roomSortKey(b.room)||String(a.room||'').localeCompare(String(b.room||'')));
    const lp=$('#p-list-planta'), li=$('#p-list-inter'); lp.innerHTML=''; li.innerHTML='';
    arrP.forEach(x=>lp.appendChild(plantaItem(x))); arrI.forEach(x=>li.appendChild(plantaItem(x)));
    $('#p-empty-planta').style.display=arrP.length?'none':'block'; $('#p-empty-inter').style.display=arrI.length?'none':'block';
    $('#p-count-planta').textContent=arrP.length; $('#p-count-inter').textContent=arrI.length; });
  const u2=fsMod.onSnapshot(qD,(s)=>{ const arr=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; arr.push(x)}); arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#p-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(plantaItem(x,true))); $('#p-done-empty').style.display=arr.length?'none':'block'; $('#p-done-count').textContent=arr.length; });
  unsubs.push(u1,u2);
}

/* ===== Tareas ===== */
const tareaDoc=(d)=>({date:d.date||todayISO(),text:(d.text||'').trim(),status:d.status||'active',createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});
const daysFromToday=(iso)=>{try{const d=new Date(iso+'T00:00:00'); const t=new Date(); t.setHours(0,0,0,0); return Math.round((d - t)/(1000*60*60*24));}catch{return 0}};
const fmtDate=(iso)=>{try{const d=new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(d).toUpperCase().replace(/\./g,'');}catch{return iso}};
function tareaItem(x){
  const li=document.createElement('li'); li.className='item';
  const diff=daysFromToday(x.date);
  const h=isNaN(diff)?205:(diff<=-7?0:(diff<0?10:Math.round(10+(Math.min(diff,30)/30)*120)));
  li.style.borderLeft=`6px solid hsl(${h} 72% 46%)`;
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(
    btn('‚úì',()=>upd('tareas',x.__id,{status:'done'}),'btn icon'),
    btn('‚úé',()=>editTarea(x),'btn icon'),
    btn('üóëÔ∏è',()=>upd('tareas',x.__id,{status:'trash'}),'btn icon')
  ); return li;
}
function tareaDone(x){
  const li=document.createElement('li'); li.className='item'; li.style.borderLeft=`6px solid hsl(150 50% 38%)`;
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text"><div class="line" style="text-decoration:line-through">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(btn('‚Ü©',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon')); return li;
}
function tareaTrash(x){
  const li=document.createElement('li'); li.className='item';
  li.innerHTML=`<span class="pill date">${fmtDate(x.date)}</span><div class="text muted"><div class="line">${esc(x.text||'')}</div></div><div class="toolbar actions"></div>`;
  li.querySelector('.actions').append(btn('‚§¥',()=>upd('tareas',x.__id,{status:'active'}),'btn icon'),btn('‚úñ',()=>del('tareas',x.__id),'btn icon')); return li;
}
const editTarea=(x)=>openEdit([{l:'Fecha',id:'t_date',v:x.date||todayISO()},{l:'Descripci√≥n',id:'t_text',v:x.text||''}], async()=>upd('tareas',x.__id,{date:$('#t_date').value,text:$('#t_text').value}));

function setupTareas(uid){
  $('#t-date').value=todayISO();
  $('#t-add').onclick=async()=>{const date=$('#t-date').value, text=$('#t-text').value.trim(); if(!text) return; await fsMod.addDoc(col.tareas(uid),tareaDoc({date,text})); $('#t-text').value='';};
  const qA=fsMod.query(col.tareas(uid),fsMod.where('status','==','active'));
  const qD=fsMod.query(col.tareas(uid),fsMod.where('status','==','done'));
  const qT=fsMod.query(col.tareas(uid),fsMod.where('status','==','trash'));
  const u1=fsMod.onSnapshot(qA,(snap)=>{const arr=[];snap.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x);});
    arr.sort((a,b)=>daysFromToday(a.date)-daysFromToday(b.date)||(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    const list=$('#t-list'); list.innerHTML=''; arr.forEach(x=>list.appendChild(tareaItem(x))); $('#t-count').textContent=arr.length; $('#t-empty').style.display=arr.length?'none':'block'; setNotif(arr.length);});
  const u2=fsMod.onSnapshot(qD,(s)=>{const arr=[];s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x);}); arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#t-done'); l.innerHTML=''; arr.forEach(x=>l.appendChild(tareaDone(x))); $('#t-done-empty').style.display=arr.length?'none':'block'; $('#t-done-count').textContent=arr.length;});
  const u3=fsMod.onSnapshot(qT,(s)=>{const arr=[];s.forEach(d=>{const x=d.data();x.__id=d.id;arr.push(x);}); arr.sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)); const l=$('#t-trash'); l.innerHTML=''; arr.forEach(x=>l.appendChild(tareaTrash(x))); $('#t-trash-empty').style.display=arr.length?'none':'block'; $('#t-trash-count').textContent=arr.length;});
  $('#t-emptyTrash').onclick=async()=>{const q=fsMod.query(fsMod.collection(db,'users',uid,'tareas'),fsMod.where('status','==','trash')); const s=await fsMod.getDocs(q); await Promise.all(s.docs.map(x=>fsMod.deleteDoc(x.ref))); toast('Papelera vaciada');};
  unsubs.push(u1,u2,u3);
}
const setNotif=(n)=>{$('#notifBadge').textContent=String(n); $('#notifBadge').title=n?`${n} tareas activas`:'Sin avisos';};

/* ===== Directorio ===== */
let dirCache=[];
const telHref=(raw)=>{const s=String(raw||'').replace(/[^\d+]/g,''); return s?`tel:${s}`:null; }
const norm=(s)=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
const dirDoc=(d)=>({seccion:String(d.seccion||'').trim()||'Sin secci√≥n',nombre:String(d.nombre||'').trim()||'Sin nombre',telefono:String(d.telefono||'').trim(),notas:String(d.notas||'').trim(),createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});

function phonesToChips(raw){
  const parts=String(raw||'').split(/[,;\n]| {2,}/).map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{const href=telHref(p); return href?`<a class="pill tel" href="${href}" dir="ltr">${esc(p)}</a>`:`<span class="pill tel" dir="ltr">${esc(p)}</span>`}).join(' ');
}
function renderDir(){
  const v=norm($('#d-q')?.value||''); const wrap=$('#d-list-wrap'); if(!wrap) return; wrap.innerHTML='';
  let arr=[...dirCache];
  arr.sort((a,b)=>(a.nombre||'').localeCompare(b.nombre||'')||(a.seccion||'').localeCompare(b.seccion||''));
  const filtered=v?arr.filter(x=>[x.seccion,x.nombre,String(x.telefono||''),x.notas].some(y=>norm(y).includes(v))):arr;
  const groups=new Map();
  for(const x of filtered){const k=/^[A-Za-z√Å√â√ç√ì√ö√ú√ë]/.test(x.nombre||'')?norm(x.nombre)[0].toUpperCase():'#'; if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(x);}
  const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split(''); const az=$('#d-az'); az.innerHTML=letters.map(ch=>`<a href="#sec-${ch}" aria-label="Ir a ${ch}">${ch}</a>`).join('');
  let total=0;
  for(const ch of letters){
    const list=groups.get(ch)||[]; if(!list.length) continue; total+=list.length;
    const sec=document.createElement('section'); sec.id=`sec-${ch}`; sec.setAttribute('aria-labelledby',`lbl-${ch}`);
    const header=document.createElement('div'); header.className='section-tag'; header.id=`lbl-${ch}`; header.textContent=ch; sec.appendChild(header);
    const ul=document.createElement('ul'); ul.className='list';
    list.forEach(x=>{
      const li=document.createElement('li'); li.className='item';
      li.innerHTML=`<div class="text"><div class="line"><strong>${esc(x.nombre||'')}</strong> ‚Äî ${esc(x.seccion||'')}</div><div class="line">${phonesToChips(x.telefono)}</div>${x.notas?`<div class="muted">${esc(x.notas)}</div>`:''}</div><div class="toolbar actions"></div>`;
      const edit=btn('‚úé',()=>editDir(x),'btn icon'), delBtn=btn('üóëÔ∏è',()=>del('directorio',x.__id),'btn icon');
      li.querySelector('.actions').append(edit,delBtn);
      ul.appendChild(li);
    });
    sec.appendChild(ul); wrap.appendChild(sec);
  }
  $('#d-count').textContent=total+" registros"; $('#d-empty').style.display=total?'none':'block';
}
const editDir=(x)=>openEdit([{l:'Secci√≥n',id:'d_sec',v:x.seccion||''},{l:'Nombre',id:'d_nom',v:x.nombre||''},{l:'Tel√©fonos',id:'d_tel',v:x.telefono||''},{l:'Notas',id:'d_not',v:x.notas||''}], async()=>upd('directorio',x.__id,{seccion:$('#d_sec').value,nombre:$('#d_nom').value,telefono:$('#d_tel').value,notas:$('#d_not').value}));
function setupDir(uid){
  $('#d-add').onclick=async()=>{const d=dirDoc({seccion:prompt('Secci√≥n')||'',nombre:prompt('Nombre')||'',telefono:prompt('Tel√©fonos')||''}); await fsMod.addDoc(col.dir(uid),d);};
  $('#d-import').onclick=importDir(uid); $('#d-export').onclick=exportDir(uid);
  $('#d-dedupe').onclick=()=>dedupeDir(uid);
  const u=fsMod.onSnapshot(fsMod.query(col.dir(uid)),(s)=>{dirCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; dirCache.push(x);}); renderDir();});
  $('#d-q').addEventListener('input',renderDir,{passive:true}); unsubs.push(u);
}
function importDir(uid){return async()=>{try{const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido');
  const snap=await fsMod.getDocs(col.dir(uid)); const key=o=>(String(o.nombre||'').trim()+'|'+String(o.telefono||'').trim()).toLowerCase(); const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[];
  for(const o of arr){ if(!set.has(key(o))) ops.push(fsMod.addDoc(col.dir(uid),dirDoc(o))); } await Promise.all(ops); toast('Importado ('+ops.length+')');
}catch(e){toast(e.message||String(e));}}}
function exportDir(uid){return async()=>{const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'directorio-'+todayISO()+'.json'); toast('Exportado');}}
const normTel=(s)=>String(s||'').replace(/[^\d+]/g,''); const keyDir=(o)=>(String(o.nombre||'').trim().toLowerCase().replace(/\s+/g,' '))+'|'+normTel(o.telefono);
async function dedupeDir(uid){const snap=await fsMod.getDocs(fsMod.query(col.dir(uid))); const seen=new Set(); const rm=[]; for(const d of snap.docs){const k=keyDir(d.data()); if(seen.has(k)) rm.push(d.ref); else seen.add(k);} if(!rm.length){toast('Sin duplicados');return;} await Promise.all(rm.map(r=>fsMod.deleteDoc(r))); toast(`Eliminados ${rm.length} duplicados`);}

/* ===== Biblioteca ===== */
let bCache=[]; let localObjectURL=null; let notesTimer=null;
const bDoc=(d)=>({title:String(d.title||'').trim()||'Sin t√≠tulo',url:String(d.url||'').trim(),createdAt:d.createdAt||serverTS(),updatedAt:serverTS()});
function setViewer(src){const iframe=$('#b-viewer'); if(!src){iframe.removeAttribute('src');return;} iframe.src=src;}
function clearLocalURL(){if(localObjectURL){URL.revokeObjectURL(localObjectURL);localObjectURL=null;}}
function renderBiblioSelect(){const sel=$('#b-select'); sel.innerHTML=''; bCache.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); bCache.forEach(x=>{const o=document.createElement('option'); o.value=x.__id; o.textContent=x.title; sel.appendChild(o);});}
function setupBiblio(uid){
  fsMod.getDoc(col.notes(uid)).then(s=>{$('#b-notes').value=s.exists()?String(s.data().text||''):'';});
  const saveNotes=async(force=false)=>{const el=$('#b-notes'); if(!el) return; const text=el.value;
    $('#b-save-state').textContent='Guardando‚Ä¶';
    try{await fsMod.setDoc(col.notes(uid),{text,updatedAt:serverTS()},{merge:true});
      $('#b-save-state').textContent='Guardado'; if(force) toast('Notas guardadas');
    }catch{ $('#b-save-state').textContent='Offline (se guardar√°)'; }};
  $('#b-notes').addEventListener('input',()=>{clearTimeout(notesTimer); notesTimer=setTimeout(()=>saveNotes(false),600);});
  $('#b-notes-save').onclick=()=>saveNotes(true);
  window.addEventListener('keydown',(e)=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();saveNotes(true);}});

  $('#b-add-link').onclick=async()=>{const url=$('#b-url').value.trim(); const title=$('#b-title').value.trim(); if(!url) return; await fsMod.addDoc(col.biblio(uid),bDoc({url,title})); $('#b-url').value=''; $('#b-title').value='';};
  $('#b-open').onclick=async()=>{const id=$('#b-select').value; const item=bCache.find(x=>x.__id===id); if(!item) return; clearLocalURL(); setViewer(item.url);};
  $('#b-open-ext').onclick=()=>{const id=$('#b-select').value; const item=bCache.find(x=>x.__id===id); if(item?.url) window.open(item.url,'_blank','noopener');};
  $('#b-remove').onclick=async()=>{const id=$('#b-select').value; if(!id) return; await fsMod.deleteDoc(fsMod.doc(db,'users',uid,'biblioteca',id));};

  const viewer=$('#b-viewer').parentElement;
  const onDrop=async(e)=>{e.preventDefault(); const f=e.dataTransfer?.files?.[0]; if(!f||!f.type.includes('pdf')) return; clearLocalURL(); localObjectURL=URL.createObjectURL(f); setViewer(localObjectURL);};
  ['dragover','dragenter'].forEach(ev=>viewer.addEventListener(ev,(e)=>{e.preventDefault();},{passive:false}));
  viewer.addEventListener('drop',onDrop);

  $('#b-open-file').onclick=async()=>{try{const [h]=await showOpenFilePicker({types:[{description:'PDF',accept:{'application/pdf':['.pdf']}}]}); const f=await h.getFile(); clearLocalURL(); localObjectURL=URL.createObjectURL(f); setViewer(localObjectURL);}catch{}};
  $('#b-clear-view').onclick=()=>{clearLocalURL(); setViewer(null);};
  $('#b-export-links').onclick=async()=>{const snap=await fsMod.getDocs(fsMod.query(col.biblio(uid))); const out=snap.docs.map(d=>({id:d.id,...d.data()})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); await pickWriteBlob(blob,'biblioteca-links-'+todayISO()+'.json'); toast('Exportado');};
  $('#b-import-links').onclick=async()=>{try{const txt=await pickReadText(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON inv√°lido'); const snap=await fsMod.getDocs(col.biblio(uid)); const key=o=>(String(o.title||'').trim()+'|'+String(o.url||'').trim()).toLowerCase(); const set=new Set(snap.docs.map(d=>key(d.data()))); const ops=[]; for(const o of arr){const k=key(o); if(!set.has(k)) ops.push(fsMod.addDoc(col.biblio(uid), bDoc(o)));} await Promise.all(ops); toast('Importado ('+ops.length+')');}catch(e){toast(e.message||String(e));}};
  const u=fsMod.onSnapshot(fsMod.query(col.biblio(uid)),(s)=>{bCache=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; bCache.push(x);}); renderBiblioSelect();}); unsubs.push(u);
}

/* ===== Emergencias (selector con checkboxes + paginaci√≥n) ===== */
let emergency=[]; 
function renderEmergency(){
  const box=$('#fabList');
  box.innerHTML = emergency.length
    ? emergency.map(e=>`<div style="display:flex;align-items:center;gap:10px;margin:6px 0">
        <strong>${esc(e.name||'')}</strong>
        <a class="pill tel" href="tel:${String(e.tel||'').replace(/[^\d+]/g,'')}" dir="ltr">${esc(e.tel||'')}</a>
        <button class="btn icon" title="Quitar">‚úñ</button>
      </div>`).join('')
    : '<p class="muted">A√±ade accesos r√°pidos desde ‚öô.</p>';
  if(emergency.length){
    [...box.querySelectorAll('.btn.icon')].forEach((btn,i)=>btn.onclick=async()=>{const id=emergency[i]?.__id; if(id) await fsMod.deleteDoc(fsMod.doc(db,'users',currentUid(),'emergencias',id));});
  }
}
$('#fab').onclick=()=>{const p=$('#fabPanel'); const open=p.style.display!=='block'; p.style.display=open?'block':'none'; $('#fab').setAttribute('aria-expanded',String(open));};

function openEmergencyConfig(){
  const dlg=document.createElement('dialog'); dlg.style.padding='0'; dlg.style.border='1px solid var(--border)'; dlg.style.borderRadius='14px'; dlg.style.boxShadow='var(--shadow-2)'; dlg.style.maxWidth='min(780px,96vw)'; dlg.style.width='100%';
  dlg.innerHTML=`
    <div class="card">
      <div class="card-h h-extra"><h2>Configurar emergencias</h2></div>
      <div class="card-b" style="display:grid;gap:12px;grid-template-columns:1fr 2fr">
        <div>
          <h3 style="margin:.2rem 0">A√±adir manual</h3>
          <label>Nombre</label><input id="e_name" placeholder="Urgencias, UCI, ...">
          <label>Tel√©fono</label><input id="e_tel" placeholder="+34 968‚Ä¶">
          <div class="toolbar" style="margin-top:8px"><button id="e_add" class="btn primary">A√±adir</button></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
          <div class="chip">Consejo: usa la selecci√≥n m√∫ltiple para a√±adir varios contactos del Directorio a la vez.</div>
        </div>
        <div>
          <h3 style="margin:.2rem 0">Desde directorio</h3>
          <label>B√∫squeda</label><input id="e_q" placeholder="Nombre o secci√≥n">
          <div class="toolbar" style="margin:.5rem 0; gap:6px; flex-wrap:wrap">
            <button id="e_sel_all" class="btn">Seleccionar todo (p√°gina)</button>
            <button id="e_sel_none" class="btn">Ninguno</button>
            <div class="chip"><span id="e_sel_count">0</span> seleccionados</div>
            <div class="grow"></div>
            <button id="e_prev" class="btn">‚óÄ</button>
            <span class="chip" id="e_page">1</span>
            <button id="e_next" class="btn">‚ñ∂</button>
            <button id="e_add_batch" class="btn primary">A√±adir seleccionados</button>
          </div>
          <div id="e_list" style="max-height:48vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px"></div>
        </div>
      </div>
      <div class="card-b" style="display:flex;justify-content:flex-end;gap:8px">
        <button id="e_close" class="btn">Cerrar</button>
      </div>
    </div>`;
  document.body.appendChild(dlg);
  const close=()=>{dlg.close(); dlg.remove();}
  dlg.querySelector('#e_close').onclick=close;

  // Estado de selecci√≥n/paginaci√≥n
  const pageSize=50; let page=1; let filter=''; const selected=new Set(); // guarda __id de directorio
  const hasTel=(x)=>String(x.telefono||'').trim().length>0;
  const notInEmergency=(x)=>!emergency.some(e=>String(e.tel||'').replace(/[^\d+]/g,'')===String((x.telefono||'').split(/[,;\n]/)[0]).replace(/[^\d+]/g,''));

  const paint=()=>{
    const list=dlg.querySelector('#e_list');
    const v=norm(filter);
    const src=dirCache
      .filter(x=>[x.nombre,x.seccion,x.telefono].some(y=>norm(y).includes(v)))
      .filter(hasTel);

    const totalPages=Math.max(1, Math.ceil(src.length/pageSize));
    page=Math.min(page,totalPages);
    const start=(page-1)*pageSize, end=start+pageSize;
    const slice=src.slice(start,end);

    list.innerHTML=slice.map(x=>{
      const id=x.__id, phone=String(x.telefono||'').split(/[,;\n]/)[0].trim();
      const checked=selected.has(id) ? 'checked' : '';
      const disabled = notInEmergency(x) ? '' : 'disabled';
      return `<label style="display:flex;align-items:center;gap:10px;padding:6px;border-bottom:1px solid var(--border);${disabled?'opacity:.6;':''}">
        <input type="checkbox" data-id="${id}" ${checked} ${disabled}/>
        <div style="flex:1 1 auto">
          <strong>${esc(x.nombre)}</strong> ‚Äî <span class="muted">${esc(x.seccion)}</span>
          <div>${phonesToChips(phone)}</div>
        </div>
      </label>`;
    }).join('');

    // Wire checkboxes
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.onchange=()=>{ const id=cb.getAttribute('data-id'); if(cb.checked) selected.add(id); else selected.delete(id); updateSelCount(); };
    });

    dlg.querySelector('#e_page').textContent=`${page}/${totalPages}`;
    updateSelCount();
  };

  const updateSelCount=()=>dlg.querySelector('#e_sel_count').textContent=String(selected.size);

  // Controles
  dlg.querySelector('#e_q').addEventListener('input',(e)=>{filter=e.target.value; page=1; paint();},{passive:true});
  dlg.querySelector('#e_prev').onclick=()=>{ if(page>1){page--; paint();}};
  dlg.querySelector('#e_next').onclick=()=>{ page++; paint(); };
  dlg.querySelector('#e_sel_all').onclick=()=>{ dlg.querySelectorAll('#e_list input[type="checkbox"]:not(:disabled)').forEach(cb=>{cb.checked=true; selected.add(cb.getAttribute('data-id'));}); updateSelCount(); };
  dlg.querySelector('#e_sel_none').onclick=()=>{ dlg.querySelectorAll('#e_list input[type="checkbox"]').forEach(cb=>{cb.checked=false;}); selected.clear(); updateSelCount(); };

  dlg.querySelector('#e_add_batch').onclick=async()=>{
    if(!selected.size) return;
    const toAdd=[];
    for(const id of selected){
      const x=dirCache.find(y=>y.__id===id);
      if(x && hasTel(x) && notInEmergency(x)){
        const tel=String(x.telefono).split(/[,;\n]/)[0].trim();
        toAdd.push(fsMod.addDoc(col.emerg(currentUid()),{name:x.nombre,tel,createdAt:serverTS(),updatedAt:serverTS()}));
      }
    }
    await Promise.all(toAdd);
    toast(`A√±adidos ${toAdd.length} contactos`);
    selected.clear(); paint();
  };

  dlg.querySelector('#e_add').onclick=async()=>{
    const name=dlg.querySelector('#e_name').value.trim(), tel=dlg.querySelector('#e_tel').value.trim(); if(!name||!tel) return;
    await fsMod.addDoc(col.emerg(currentUid()),{name,tel,createdAt:serverTS(),updatedAt:serverTS()});
    toast('A√±adido'); dlg.querySelector('#e_name').value=''; dlg.querySelector('#e_tel').value='';
  };

  paint(); dlg.showModal();
}
$('#fab-config').onclick=openEmergencyConfig;

function setupEmergency(uid){
  const u=fsMod.onSnapshot(fsMod.query(col.emerg(uid)),(s)=>{emergency=[]; s.forEach(d=>{const x=d.data(); x.__id=d.id; emergency.push(x);}); renderEmergency();});
  unsubs.push(u);
}

/* ===== Modal simple ===== */
function openEdit(fields,onOk){
  const dlg=document.createElement('dialog'); dlg.style.padding='16px'; dlg.style.border='1px solid var(--border)'; dlg.style.borderRadius='14px'; dlg.style.boxShadow='var(--shadow-2)';
  const h=document.createElement('h3'); h.textContent='Editar'; h.style.margin='0 0 8px 0'; dlg.appendChild(h);
  const body=document.createElement('div'); body.style.display='grid'; body.style.gap='8px';
  fields.forEach(f=>{ const w=document.createElement('div'); w.innerHTML=`<label for="${f.id}" style="display:block;font-size:12px;color:#777">${f.l}</label><input id="${f.id}" value="${esc(f.v||'')}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px">`; body.append(w); });
  dlg.appendChild(body);
  const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.justifyContent='flex-end'; row.style.marginTop='12px';
  const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Cancelar'; b1.onclick=()=>dlg.close();
  const b2=document.createElement('button'); b2.className='btn primary'; b2.textContent='Guardar'; b2.onclick=async()=>{await onOk(); dlg.close();};
  row.append(b1,b2); dlg.appendChild(row); document.body.appendChild(dlg); dlg.showModal(); dlg.addEventListener('close',()=>dlg.remove(),{once:true});
}

/* ===== Pickers ===== */
async function pickReadText(){ if('showOpenFilePicker' in window){ const [h]=await showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const f=await h.getFile(); return await f.text(); } return await new Promise((res,rej)=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=()=>{ const f=i.files?.[0]; if(!f) return rej(new Error('Cancelado')); const r=new FileReader(); r.onload=()=>res(String(r.result||'')); r.onerror=()=>rej(new Error('Error leyendo')); r.readAsText(f); }; i.click(); }); }
async function pickWriteBlob(blob,name){ if('showSaveFilePicker' in window){ const h=await showSaveFilePicker({suggestedName:name,types:[{description:'JSON',accept:{'application/json':['.json']}}]}); const w=await h.createWritable(); await w.write(blob); await w.close(); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

/* ===== PWA ===== */
let deferredPrompt=null;
addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;$('#installBanner').style.display='inline-flex';});
$('#installAction').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBanner').style.display='none'; } };
$('#installBtn').onclick=()=>$('#installAction').click();
if('serviceWorker' in navigator){
  const reg=await navigator.serviceWorker.register(BASE+'sw.js');
  navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
  const showUpdate=()=>{$('#updateBanner').style.display='inline-flex'; $('#reloadNow').onclick=()=>reg.waiting?.postMessage({type:'SKIP_WAITING'});};
  if(reg.waiting) showUpdate();
  reg.addEventListener('updatefound',()=>{const sw=reg.installing; sw?.addEventListener('statechange',()=>{if(sw.state==='installed'&&navigator.serviceWorker.controller) showUpdate();});});
}

/* ===== Montaje ===== */
function mount(uid){
  setupPlanta(uid); setupTareas(uid); setupDir(uid); setupBiblio(uid); setupEmergency(uid);
  const first=location.hash?.slice(1); if(mapTabs[first]) selectTab(first); else selectTab(localStorage.getItem('tab')||'planta');
}
</script>
</body>
</html>
